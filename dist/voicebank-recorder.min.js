/*!
 * voicebank-recorder v1.0.0
 * è·¨å¹³å°éŸ³è¨ŠéŒ„éŸ³åº«ï¼Œæ”¯æ´ Browser/Electron/Capacitor
 * 
 * Includes RecordRTC v5.6.2 (https://github.com/muaz-khan/RecordRTC)
 * RecordRTC License: MIT
 * 
 * @license MIT
 * @author VoiceBank Team
 * @repository https://github.com/cychiang-ntpu/simple-recordrtc-example.git
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).VoiceBankRecorder={})}(this,function(t){"use strict";class e{constructor(t,e){this.canvas=t,this.canvasContext=t.getContext("2d"),this.analyser=e,this.mediaStreamSource=null,this.animationId=null,this.isRunning=!1,this.width=t.width,this.height=t.height,this.bufferLength=0,this.dataArray=null,this.amplification=3,this._lastDataArray=null,this._verticalScrollOffset=0}start(t,e,i){if(this.isRunning||!e||!this.analyser)return void console.warn("LiveWaveform.start() æ¢ä»¶ä¸æ»¿è¶³:",{isRunning:this.isRunning,hasAudioContext:!!e,hasAnalyser:!!this.analyser});console.log("âœ… LiveWaveform é–‹å§‹å•Ÿå‹•..."),this.isRunning=!0;const s=this;let a=Promise.resolve();"suspended"===e.state&&(a=e.resume().catch(function(t){console.warn("Unable to resume AudioContext:",t)})),a.then(function(){if(s.mediaStreamSource&&s.mediaStreamSource.disconnect(),s.mediaStreamSource=e.createMediaStreamSource(t),i)try{s.mediaStreamSource.connect(i)}catch(t){console.warn("connect preGainNode failed",t)}else s.mediaStreamSource.connect(s.analyser);s.analyser.fftSize=1024,s.bufferLength=s.analyser.fftSize,s.dataArray=new Uint8Array(s.bufferLength),console.log("âœ… LiveWaveform éŸ³è¨Šé€£æ¥å®Œæˆï¼Œé–‹å§‹ç¹ªè£½"),s.draw(!1)})}stop(){this.isRunning&&(this.isRunning=!1,this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.canvasContext.clearRect(0,0,this.width,this.height))}draw(t=!1){if(this.isRunning&&this.analyser&&this.dataArray)if(this.animationId=requestAnimationFrame(()=>this.draw(t)),this.analyser.getByteTimeDomainData(this.dataArray),t){const t=2;this._verticalScrollOffset+=t,this._verticalScrollOffset>=this.height&&(this._verticalScrollOffset=0,this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height)),this.canvasContext.lineWidth=1.5,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const e=this.height/this.bufferLength;let i=0;for(let t=0;t<this.bufferLength;t++){const s=(this.dataArray[t]/128-1)*this.amplification*this.width/2+this.width/2;0===t?this.canvasContext.moveTo(s,i):this.canvasContext.lineTo(s,i),i+=e}this.canvasContext.stroke()}else{this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=2,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const t=this.width/this.bufferLength;let e=0;for(let i=0;i<this.bufferLength;i++){const s=(this.dataArray[i]/128-1)*this.amplification*this.height/2+this.height/2;0===i?this.canvasContext.moveTo(e,s):this.canvasContext.lineTo(e,s),e+=t}this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke()}}}class i{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.analyser=e,this.bufferLength=2048,this.timeData=new Float32Array(this.bufferLength),this.levelDb=-90,this.peakDb=-90,this.holdPeakDb=-90,this.lastPeakTime=0,this.peakHoldMillis=1500,this.fallRateDbPerSec=20,this.minDb=-90,this.maxDb=0,this.animationId=null,this.lastClipTime=0,this.clipHoldMillis=2e3,this._lastLogTime=0}_computeLevels(){if(!this.analyser)return{rmsDb:this.minDb,peakDb:this.minDb};const t=this.analyser.fftSize||this.bufferLength;this.timeData.length!==t&&(this.bufferLength=t,this.timeData=new Float32Array(t)),this.analyser.getFloatTimeDomainData(this.timeData);let e=0,i=0,s=!1;for(let t=0;t<this.bufferLength;t++){let a=this.timeData[t];a>1?a=1:a<-1&&(a=-1),e+=a*a;const o=Math.abs(a);o>i&&(i=o),o>=.995&&(s=!0)}const a=Math.sqrt(e/this.bufferLength);let o=a>0?20*Math.log10(a):-1/0,r=i>0?20*Math.log10(i):-1/0;return o<this.minDb&&(o=this.minDb),o>this.maxDb&&(o=this.maxDb),r<this.minDb&&(r=this.minDb),r>this.maxDb&&(r=this.maxDb),s&&(this.lastClipTime=performance.now?performance.now():Date.now()),{rmsDb:o,peakDb:r}}resize(){this.clear()}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(t){const e=this.ctx,i=this.canvas.width,s=this.canvas.height;e.clearRect(0,0,i,s);const a=e.createLinearGradient(0,0,i,0);a.addColorStop(0,"#2d3748"),a.addColorStop(1,"#1a202c"),e.fillStyle=a,e.fillRect(0,0,i,s);let o=(t-this.minDb)/(this.maxDb-this.minDb);o<0&&(o=0),o>1&&(o=1);const r=e.createLinearGradient(0,0,i,0);r.addColorStop(0,"#38a169"),r.addColorStop(.6,"#d69e2e"),r.addColorStop(.85,"#dd6b20"),r.addColorStop(1,"#c53030"),e.fillStyle=r;const n=Math.round(i*o);e.fillRect(0,0,n,s),e.save(),e.strokeStyle="rgba(255,255,255,0.15)",e.lineWidth=1,e.beginPath();for(let t=this.minDb;t<=this.maxDb;t+=10){const a=(t-this.minDb)/(this.maxDb-this.minDb),o=Math.round(i*a)+.5;if(0===t?(e.strokeStyle="rgba(255,255,255,0.35)",e.beginPath(),e.moveTo(o,0),e.lineTo(o,s),e.stroke(),e.strokeStyle="rgba(255,255,255,0.15)"):(e.moveTo(o,0),e.lineTo(o,.4*s),e.moveTo(o,s),e.lineTo(o,.6*s)),t%20==0||-10===t){const i=t.toString();e.fillStyle=0===t?"#ffffff":-10===t?"#ffeb3b":"#cbd5e0",e.font="10px -apple-system,Segoe UI,sans-serif",e.textAlign="center",e.textBaseline="top",e.fillText(i,o,1)}}e.restore();const l=(-10-this.minDb)/(this.maxDb-this.minDb);if(l>0&&l<1){const t=Math.round(i*l);e.save(),e.fillStyle="rgba(255,235,59,0.08)",e.fillRect(t-2,0,4,s),e.restore()}let c=(this.holdPeakDb-this.minDb)/(this.maxDb-this.minDb);c<0&&(c=0),c>1&&(c=1);const h=Math.round(i*c);e.strokeStyle="#ffffff",e.lineWidth=2,e.beginPath(),e.moveTo(h+.5,0),e.lineTo(h+.5,s),e.stroke(),e.fillStyle="#f0f0f0",e.font="bold 12px -apple-system,Segoe UI,sans-serif",e.textAlign="left",e.textBaseline="middle";const d=`RMS ${t<=this.minDb?"-âˆ":t.toFixed(1)} dBFS   Peak ${this.peakDb<=this.minDb?"-âˆ":this.peakDb.toFixed(1)} dBFS`;e.fillText(d,8,s/2);const u=performance.now?performance.now():Date.now();if(this.lastClipTime&&u-this.lastClipTime<this.clipHoldMillis){e.save(),e.fillStyle="#B00020";const t=42,s=18;e.fillRect(i-t-8,4,t,s),e.fillStyle="#fff",e.font="bold 12px -apple-system,Segoe UI,sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillText("CLIP",i-t/2-8,4+s/2+.5),e.restore()}}update(){const t=this._computeLevels();this.levelDb=t.rmsDb,this.peakDb=t.peakDb;const e=performance.now();if(this.peakDb>this.holdPeakDb+.5)this.holdPeakDb=this.peakDb,this.lastPeakTime=e;else{const t=e-this.lastPeakTime;if(t>this.peakHoldMillis){const e=(t-this.peakHoldMillis)/1e3,i=this.fallRateDbPerSec*e;this.holdPeakDb=Math.max(this.peakDb,this.holdPeakDb-i)}}this.draw(this.levelDb)}start(){if(this.stop(),this.analyser){const t=this.analyser.fftSize||2048;this.timeData.length!==t&&(this.bufferLength=t,this.timeData=new Float32Array(t))}const t=this;!function e(){t.update(),t.animationId=requestAnimationFrame(e)}()}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clear()}}class s{constructor(t,e={}){if(this.canvas=t,this.canvasContext=null,this.width=t.width,this.height=t.height,this.targetSampleRate=5e3,this.sourceSampleRate=48e3,this.decimationFactor=10,this.sampleMin=[],this.sampleMax=[],this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.playbackPosition=0,this.isPlaying=!1,this.playbackStartTime=0,this.playbackStartSample=0,this.rawZoomMode=!1,this.rawViewStart=0,this.rawVisibleRaw=0,this._useWorker=!1!==e.useWorker,this._worker=null,this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1,this.lastDetail=null,this.lastDensity=null,this._useWorker&&t.transferControlToOffscreen&&"undefined"!=typeof Worker)try{const i=t.transferControlToOffscreen();this._worker=new Worker(e.workerPath||"workers/wf-worker.js"),this._worker.postMessage({type:"init",canvas:i,width:this.width,height:this.height,verticalMode:!1,showClipMarks:!1!==e.showClipMarks,sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor},[i]);const s=this;this._worker.onmessage=function(t){const e=t.data;e&&"detailUpdate"===e.type&&(s.lastDetail=e.detail,s.lastDensity=e.density)}}catch(t){console.warn("OffscreenCanvas åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨ä¸»ç·šç¨‹ç¹ªè£½:",t),this._useWorker=!1}else this._useWorker=!1;if(!this._useWorker)try{this.canvasContext=t.getContext("2d")}catch(t){console.warn("ç„¡æ³•ç²å– canvas context:",t)}this._setupMouseInteraction(),this.clear()}_setupMouseInteraction(){if(!this.canvas)return;let t=!1,e=0,i=0;this.canvas.addEventListener("mousedown",s=>{t=!0,e=s.offsetX,i=this.viewStart,this.isAutoScroll=!1,this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("mousemove",s=>{if(!t)return;const a=s.offsetX-e,o=this.getVisibleSamples().visible/this.width,r=Math.round(-a*o);this.viewStart=i+r,this._enforceViewBounds(),this.draw()}),this.canvas.addEventListener("mouseup",()=>{t&&(t=!1,this.canvas.style.cursor="grab")}),this.canvas.addEventListener("mouseleave",()=>{t&&(t=!1,this.canvas.style.cursor="default")}),this.canvas.addEventListener("wheel",t=>{t.preventDefault();const e=this.canvas.getBoundingClientRect(),i=(t.clientX-e.left)/this.width,s=t.deltaY>0?-1:1;this.zoomBySteps(s,i)}),this.canvas.addEventListener("click",e=>{if(t)return;const i=this.getVisibleSamples(),s=e.offsetX/this.width,a=Math.floor(i.start+s*i.visible),o=new CustomEvent("waveform-seek",{detail:{sample:a,time:a/this.sourceSampleRate}});this.canvas.dispatchEvent(o)}),this.canvas.style.cursor="grab"}clear(){this._useWorker&&this._worker?this._worker.postMessage({type:"reset"}):this.canvasContext&&(this.canvasContext.clearRect(0,0,this.width,this.height),this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=1,this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.beginPath(),this.canvasContext.moveTo(0,this.height/2),this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke())}reset(){this.sampleMin.length=0,this.sampleMax.length=0,this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.clear()}append(t){if(!t||!t.length)return;const e=this.decimationFactor,i=t.length,s=[],a=[];this._lastAppendLog||(this._lastAppendLog=0);const o=Date.now();o-this._lastAppendLog>1e3&&(console.log("ğŸ“ˆ AccumulatedWaveform.append():",i,"æ¨£æœ¬ â†’",Math.floor(i/e),"å€å¡Š"),this._lastAppendLog=o);for(let o=0;o<i;o+=e){let r=1,n=-1,l=0,c=0;for(let s=0;s<e&&o+s<i;s++){l+=t[o+s],c++}const h=c?l/c:0;for(let e=0;e<c;e++){const i=t[o+e]-h;i<r&&(r=i),i>n&&(n=i)}c&&(r>n&&(r=n=0),this.sampleMin.push(r),this.sampleMax.push(n),s.push(r),a.push(n),this.sampleCount++)}if(this.isAutoScroll?this.scrollToLatest():this._enforceViewBounds(),this._useWorker&&this._worker&&(this._appendBatchMin.push(...s),this._appendBatchMax.push(...a),!this._appendFlushScheduled)){this._appendFlushScheduled=!0;const t=this,e=()=>t._flushAppendBatch();"function"==typeof requestAnimationFrame?requestAnimationFrame(e):setTimeout(e,32)}this.draw()}_flushAppendBatch(){this._worker&&0!==this._appendBatchMin.length?(this._worker.postMessage({type:"append",minArr:this._appendBatchMin,maxArr:this._appendBatchMax}),this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1):this._appendFlushScheduled=!1}draw(){if(this._useWorker&&this._worker)return void this._worker.postMessage({type:"draw",zoomFactor:this.zoomFactor,viewStart:this.viewStart,playbackPosition:this.playbackPosition,isPlaying:this.isPlaying});if(!this.canvasContext)return;this.clear();const t=this.sampleMin.length;if(!t)return;const e=Math.min(t,Math.round(t/this.zoomFactor)),i=Math.min(this.viewStart,Math.max(0,t-e)),s=Math.min(t,i+e),a=this.height/2;this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.lineWidth=1,this.canvasContext.beginPath();for(let t=i;t<s;t++){const s=Math.floor((t-i)/e*this.width)+.5,o=Math.floor(a-this.sampleMax[t]*a*.95),r=Math.floor(a-this.sampleMin[t]*a*.95);this.canvasContext.moveTo(s,o),this.canvasContext.lineTo(s,r)}this.canvasContext.stroke(),this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.lineWidth=1,this.canvasContext.beginPath(),this.canvasContext.moveTo(0,a+.5),this.canvasContext.lineTo(this.width,a+.5),this.canvasContext.stroke()}getVisibleSamples(){const t=this.sampleCount;if(0===t)return{start:0,end:0,visible:0};const e=this._getMinVisibleSamples(t);let i=Math.max(e,Math.round(t/this.zoomFactor));i>t&&(i=t);let s=this.viewStart;s+i>t&&(s=t-i),s<0&&(s=0);return{start:s,end:Math.min(t,s+i),visible:i}}_getMinVisibleSamples(t){return Math.max(1,Math.floor(this.width/2))}_enforceViewBounds(){const t=this.getVisibleSamples();this.viewStart=t.start}scrollToLatest(){const t=this.sampleCount;if(0===t)return;const e=this._getMinVisibleSamples(t);let i=Math.max(e,Math.round(t/this.zoomFactor));i>t&&(i=t),this.viewStart=t-i,this.viewStart<0&&(this.viewStart=0)}setZoom(t,e){t<1&&(t=1);const i=Math.max(1,this.sampleCount/this._getMinVisibleSamples(this.sampleCount));t>i&&(t=i);const s=this.getVisibleSamples();this.zoomFactor=t;const a=this.getVisibleSamples();if("number"==typeof e&&e>=0){const t=e-(e-s.start)/s.visible*a.visible;this.viewStart=Math.max(0,Math.min(this.sampleCount-a.visible,t))}this._enforceViewBounds(),this.draw()}zoomBySteps(t,e=.5){if(0===t)return;const i=this.getVisibleSamples(),s=i.start+e*i.visible;let a=this.zoomFactor;t>0?a*=Math.pow(1.2,t):a/=Math.pow(1.2,-t),this.setZoom(a,s)}panBySamples(t){0!==t&&(this.isAutoScroll=!1,this.viewStart+=t,this._enforceViewBounds(),this.draw())}panByPixels(t){if(0===t)return;const e=t*(this.getVisibleSamples().visible/this.width)+this._panRemainder,i=Math.round(e);this._panRemainder=e-i,this.panBySamples(i)}resetView(){this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.scrollToLatest(),this.draw()}setSourceSampleRate(t){this.sourceSampleRate=t||48e3,this.decimationFactor=Math.max(1,Math.round(this.sourceSampleRate/this.targetSampleRate)),this._worker&&this._worker.postMessage({type:"setSampleRate",sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor})}_getSamplePair(t){return t<0||t>=this.sampleCount?{min:0,max:0}:{min:this.sampleMin[t],max:this.sampleMax[t]}}setPlaybackPosition(t){this.playbackPosition=t,this.draw()}setRawZoomMode(t){this.rawZoomMode=!!t}startPlayback(t,e){this.isPlaying=!0,this.playbackStartSample=t||0,this.playbackStartTime=performance.now?performance.now():Date.now(),this.playbackPosition=this.playbackStartSample;const i=this,s=e||this.sourceSampleRate;requestAnimationFrame(function t(){if(!i.isPlaying)return;const e=((performance.now?performance.now():Date.now())-i.playbackStartTime)/1e3*s,a=i.playbackStartSample+Math.floor(e/i.decimationFactor);i.playbackPosition=a,i.draw(),requestAnimationFrame(t)})}stopPlayback(){this.isPlaying=!1,this.playbackPosition=0,this.draw()}_updatePlaybackPosition(){if(!this.isPlaying)return;const t=((performance.now?performance.now():Date.now())-this.playbackStartTime)/1e3*this.sourceSampleRate,e=this.playbackStartSample+Math.floor(t/this.decimationFactor);this.playbackPosition=e}}class a{constructor(t,e){this.canvas=t,this.ctx=t.getContext("2d"),this.accumulatedWaveform=e,this.width=t.width,this.height=t.height,this._useWorker=!1,this._workerRef=null,this._warnedNoData=!1,this._lastTotal=0,this._setupMouseInteraction()}_setupMouseInteraction(){if(!this.canvas)return;let t=!1;this.canvas.addEventListener("mousedown",e=>{const i=this.accumulatedWaveform;i&&0!==i.sampleCount&&(t=!0,this._handleSeek(e.offsetX),this.canvas.style.cursor="grabbing")}),this.canvas.addEventListener("mousemove",e=>{t&&this._handleSeek(e.offsetX)}),this.canvas.addEventListener("mouseup",()=>{t=!1,this.canvas.style.cursor="pointer"}),this.canvas.addEventListener("mouseleave",()=>{t&&(t=!1,this.canvas.style.cursor="pointer")}),this.canvas.style.cursor="pointer"}_handleSeek(t){const e=this.accumulatedWaveform;if(!e||0===e.sampleCount)return;const i=e.sampleCount,s=Math.max(0,Math.min(1,t/this.width)),a=Math.floor(s*i),o=e.getVisibleSamples(),r=Math.floor(o.visible/2);e.viewStart=Math.max(0,Math.min(i-o.visible,a-r)),e.isAutoScroll=!1,e._enforceViewBounds(),e.draw(),this.draw();const n=new CustomEvent("overview-seek",{detail:{sample:a,time:a/e.sourceSampleRate}});this.canvas.dispatchEvent(n)}clear(){this._useWorker&&this._workerRef?this._workerRef.postMessage({type:"clearOverview"}):(this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#f5f5f5",this.ctx.fillRect(0,0,this.width,this.height))}draw(){if(this._useWorker&&this._workerRef)return;this.clear();const t=this.accumulatedWaveform;if(!t||0===t.sampleCount)return void console.log("âš ï¸ OverviewWaveform: æ²’æœ‰æ•¸æ“šå¯é¡¯ç¤º",{hasAcc:!!t,sampleCount:t?t.sampleCount:0});const e=t.sampleCount,i=t.getVisibleSamples();console.log("ğŸ“Š OverviewWaveform ç¹ªè£½:",{total:e,visibleStart:i.start,visibleEnd:i.end,canvasWidth:this.width,canvasHeight:this.height}),this.ctx.strokeStyle="#64b5f6",this.ctx.lineWidth=1;const s=e/this.width;for(let i=0;i<this.width;i++){const a=Math.floor(i*s);if(a>=e)break;const o=t._getSamplePair(a),r=this.height/2,n=Math.floor(r-o.max*r*.9),l=Math.floor(r-o.min*r*.9);this.ctx.beginPath(),this.ctx.moveTo(i,n),this.ctx.lineTo(i,l),this.ctx.stroke()}this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.height/2),this.ctx.lineTo(this.width,this.height/2),this.ctx.stroke();const a=Math.floor(i.start/e*this.width),o=Math.floor(i.end/e*this.width),r=Math.max(2,o-a);this.ctx.fillStyle="rgba(33, 150, 243, 0.15)",this.ctx.fillRect(a,0,r,this.height),this.ctx.strokeStyle="#2196F3",this.ctx.lineWidth=2,this.ctx.strokeRect(a,0,r,this.height),console.log("âœ… OverviewWaveform ç¹ªè£½å®Œæˆ")}}class o{async save(t,e,i={}){throw new Error("save() must be implemented by subclass")}async load(t){throw new Error("load() must be implemented by subclass")}async delete(t){throw new Error("delete() must be implemented by subclass")}async list(){throw new Error("list() must be implemented by subclass")}async exists(t){try{return await this.load(t),!0}catch(t){return!1}}async clear(){const t=await this.list();let e=0;for(const i of t)try{await this.delete(i.id||i.filename),e++}catch(t){console.error("Failed to delete file:",i,t)}return e}}class r{constructor(t={}){this.options=this.mergeOptions(t),this.initialized=!1,this.storage=this.createStorageAdapter(this.options.storage),this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.options.container&&this.initializeUI()}mergeOptions(t){const e={container:null,layout:"auto",theme:"light",audio:{sampleRate:48e3,channels:1,agc:!1,gain:1},waveform:{showOverview:!0,showAccumulated:!0,showLive:!0,decimation:10,colors:{waveform:"#1E88E5",selection:"#4CAF50",playback:"#FF0000"}},storage:{type:"auto"},callbacks:{onRecordStart:()=>{},onRecordStop:()=>{},onRecordPause:()=>{},onRecordResume:()=>{},onPlayStart:()=>{},onPlayStop:()=>{},onError:t=>console.error("VoiceBankRecorder error:",t)}};return this.deepMerge(e,t)}deepMerge(t,e){const i={...t};for(const t in e)e[t]instanceof Object&&!Array.isArray(e[t])?i[t]=this.deepMerge(i[t]||{},e[t]):i[t]=e[t];return i}createStorageAdapter(t){const{StorageFactory:e}=require("./storage/index.js");return e.create({type:t.type||"auto",options:t})}initializeUI(){console.log("UI initialization - to be implemented")}async startRecording(){try{if(this.isRecording)throw new Error("Already recording");this.isRecording=!0,this.options.callbacks.onRecordStart(),console.log("Recording started")}catch(t){throw this.options.callbacks.onError(t),t}}async stopRecording(){try{if(!this.isRecording)throw new Error("Not recording");return this.isRecording=!1,this.currentBlob=null,this.options.callbacks.onRecordStop(this.currentBlob),console.log("Recording stopped"),this.currentBlob}catch(t){throw this.options.callbacks.onError(t),t}}async pauseRecording(){try{if(!this.isRecording||this.isPaused)throw new Error("Cannot pause");this.isPaused=!0,this.options.callbacks.onRecordPause(),console.log("Recording paused")}catch(t){throw this.options.callbacks.onError(t),t}}async resumeRecording(){try{if(!this.isRecording||!this.isPaused)throw new Error("Cannot resume");this.isPaused=!1,this.options.callbacks.onRecordResume(),console.log("Recording resumed")}catch(t){throw this.options.callbacks.onError(t),t}}async play(){try{this.options.callbacks.onPlayStart(),console.log("Playback started")}catch(t){throw this.options.callbacks.onError(t),t}}async stop(){try{this.options.callbacks.onPlayStop(),console.log("Playback stopped")}catch(t){throw this.options.callbacks.onError(t),t}}async saveRecording(t=null,e=null,i={}){try{const s=t||this.currentBlob;if(!s)throw new Error("No recording to save");const a=e||`recording-${Date.now()}.wav`,o=await this.storage.save(s,a,i);return console.log("Recording saved:",o),o}catch(t){throw this.options.callbacks.onError(t),t}}async loadRecording(t){try{const e=await this.storage.load(t);return this.currentBlob=e,console.log("Recording loaded:",t),e}catch(t){throw this.options.callbacks.onError(t),t}}async deleteRecording(t){try{const e=await this.storage.delete(t);return console.log("Recording deleted:",t),e}catch(t){throw this.options.callbacks.onError(t),t}}async listRecordings(){try{const t=await this.storage.list();return console.log("Recordings listed:",t.length),t}catch(t){throw this.options.callbacks.onError(t),t}}getCurrentBlob(){return this.currentBlob}destroy(){this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.storage&&"function"==typeof this.storage.close&&this.storage.close(),console.log("VoiceBankRecorder destroyed")}}const n="1.0.0",l={version:n,date:(new Date).toISOString(),name:"VoiceBank Recorder"};t.AudioEngine=class{constructor(t={}){this.config={sampleRate:t.sampleRate||48e3,autoGainControl:void 0!==t.autoGainControl&&t.autoGainControl,echoCancellation:void 0!==t.echoCancellation&&t.echoCancellation,noiseSuppression:void 0!==t.noiseSuppression&&t.noiseSuppression,micGain:t.micGain||1,deviceId:t.deviceId||null,workletPath:t.workletPath||"assets/js/worklet/pcm-collector.js",preferWorklet:void 0===t.preferWorklet||t.preferWorklet},this.audioContext=null,this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.workletSupported=!1,this.workletLoaded=!1,this.pcmCollectorNode=null,this.usingWorklet=!1,this.pcmChunks=[],this.pcmTotalSamples=0,this.recorder=null,this._pcmCaptureInterval=null,this.micStream=null,this.isRecording=!1,this.isPaused=!1,this.isInitialized=!1,this.recordStartTime=0,this.recordStopTime=0,this.recordWallStartMs=0,this.recordWallStopMs=0,this.latestBlob=null,this.latestUrl=null,this._eventListeners={}}async initialize(){if(!this.isInitialized)try{const t=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new t({sampleRate:this.config.sampleRate}),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.preGainNode=this.audioContext.createGain(),this.preGainNode.gain.value=this.config.micGain,this.mediaDest=this.audioContext.createMediaStreamDestination(),this.preGainNode.connect(this.analyser),this.preGainNode.connect(this.mediaDest),this.analyserSilencer=this.audioContext.createGain(),this.analyserSilencer.gain.value=0,this.analyser.connect(this.analyserSilencer),this.analyserSilencer.connect(this.audioContext.destination),this.workletSupported=!(!this.audioContext.audioWorklet||!window.AudioWorkletNode),this.workletSupported&&this.config.preferWorklet)try{await this.audioContext.audioWorklet.addModule(this.config.workletPath),this.workletLoaded=!0,this._emit("worklet-loaded",{path:this.config.workletPath})}catch(t){console.warn("è¼‰å…¥ AudioWorklet æ¨¡çµ„å¤±æ•—ï¼Œå°‡å›é€€åˆ° RecordRTC:",t),this.workletLoaded=!1,this._emit("worklet-load-failed",{error:t})}"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isInitialized=!0,this._emit("initialized",{sampleRate:this.audioContext.sampleRate,state:this.audioContext.state,workletSupported:this.workletSupported,workletLoaded:this.workletLoaded})}catch(t){throw this._emit("error",{stage:"initialize",error:t}),t}}async startRecording(){if(!this.isInitialized)throw new Error("AudioEngine å°šæœªåˆå§‹åŒ–ï¼Œè«‹å…ˆèª¿ç”¨ initialize()");if(this.isRecording)throw new Error("å·²ç¶“åœ¨éŒ„éŸ³ä¸­");try{"suspended"===this.audioContext.state&&await this.audioContext.resume(),await this._captureMicrophone(),this.pcmChunks=[],this.pcmTotalSamples=0,this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.latestBlob=null,this.recordStartTime=Date.now(),this.recordWallStartMs=performance.now(),this.recordStopTime=0,this.recordWallStopMs=0;const t=this.workletLoaded&&this.config.preferWorklet;t?await this._startWorkletRecording():await this._startRecordRTCRecording(),this.isRecording=!0,this.isPaused=!1,this._emit("recording-start",{timestamp:this.recordStartTime,mode:t?"worklet":"recordrtc",sampleRate:this.audioContext.sampleRate})}catch(t){throw this._emit("error",{stage:"start-recording",error:t}),t}}async stopRecording(){if(!this.isRecording)throw new Error("ç›®å‰æ²’æœ‰åœ¨éŒ„éŸ³");try{let t;if(this.isRecording=!1,this.recordStopTime=Date.now(),this.recordWallStopMs=performance.now(),this.usingWorklet)t=await this._stopWorkletRecording();else{if(!this.recorder)throw new Error("æ²’æœ‰å¯ç”¨çš„éŒ„éŸ³å™¨");t=await this._stopRecordRTCRecording()}this._stopMicrophone(),this.latestBlob=t,this.latestUrl=URL.createObjectURL(t);const e=(this.recordStopTime-this.recordStartTime)/1e3;return this._emit("recording-stop",{blob:t,url:this.latestUrl,duration:e,samples:this.pcmTotalSamples,sampleRate:this.audioContext.sampleRate}),t}catch(t){throw this._emit("error",{stage:"stop-recording",error:t}),t}}pauseRecording(){if(!this.isRecording)throw new Error("ç›®å‰æ²’æœ‰åœ¨éŒ„éŸ³");if(this.usingWorklet)throw new Error("AudioWorklet æ¨¡å¼ä¸æ”¯æ´æš«åœåŠŸèƒ½");if(!this.recorder||"function"!=typeof this.recorder.pauseRecording)throw new Error("æš«åœåŠŸèƒ½ä¸å¯ç”¨");this.recorder.pauseRecording(),this.isPaused=!0,this._emit("recording-paused",{timestamp:Date.now()})}resumeRecording(){if(!this.isPaused)throw new Error("éŒ„éŸ³æ²’æœ‰æš«åœ");if(!this.recorder||"function"!=typeof this.recorder.resumeRecording)throw new Error("ç¹¼çºŒéŒ„éŸ³åŠŸèƒ½ä¸å¯ç”¨");this.recorder.resumeRecording(),this.isPaused=!1,this._emit("recording-resumed",{timestamp:Date.now()})}getLatestRecording(){return{blob:this.latestBlob,url:this.latestUrl,duration:this.latestBlob?(this.recordStopTime-this.recordStartTime)/1e3:0,samples:this.pcmTotalSamples,sampleRate:this.audioContext?this.audioContext.sampleRate:0}}getPcmWindow(t,e){if(!this.usingWorklet||!this.pcmChunks.length)return null;t<0&&(t=0);const i=this.pcmTotalSamples;if(t>=i)return new Float32Array(0);const s=Math.min(i,t+e),a=new Float32Array(s-t);let o=0,r=0;for(let e=0;e<this.pcmChunks.length&&r<s;e++){const i=this.pcmChunks[e];if(!i||!i.length)continue;const n=r,l=r+i.length;if(l<=t){r=l;continue}const c=Math.max(t,n),h=Math.min(s,l);if(h>c){const t=c-n,e=i.subarray(t,t+(h-c));a.set(e,o),o+=e.length}if(r=l,h>=s)break}return a}getAnalyser(){return this.analyser}getAudioContext(){return this.audioContext}get microphoneStream(){return this.micStream}setMicGain(t){t=Math.max(1,Math.min(6,t)),this.config.micGain=t,this.preGainNode&&(this.preGainNode.gain.value=t),this._emit("mic-gain-changed",{gain:t})}dispose(){this.isRecording&&this.stopRecording().catch(console.error),this._stopMicrophone(),this._stopPcmCapture(),this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null),this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.pcmCollectorNode=null,this.recorder=null,this.pcmChunks=[],this.pcmTotalSamples=0,this.isInitialized=!1,this._emit("disposed")}on(t,e){this._eventListeners[t]||(this._eventListeners[t]=[]),this._eventListeners[t].push(e)}off(t,e){if(!this._eventListeners[t])return;const i=this._eventListeners[t].indexOf(e);i>-1&&this._eventListeners[t].splice(i,1)}_emit(t,e){this._eventListeners[t]&&this._eventListeners[t].forEach(i=>{try{i(e)}catch(e){console.error(`äº‹ä»¶è™•ç†å™¨éŒ¯èª¤ [${t}]:`,e)}})}async _captureMicrophone(){const t={audio:{echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl},video:!1};this.config.deviceId&&(t.audio.deviceId={exact:this.config.deviceId});try{this.micStream=await navigator.mediaDevices.getUserMedia(t),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode),this._emit("microphone-captured",{deviceId:this.config.deviceId,constraints:t})}catch(e){if("OverconstrainedError"!==e.name&&"NotFoundError"!==e.name)throw e;console.warn("æŒ‡å®šçš„éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œå˜—è©¦é è¨­è¨­å‚™"),delete t.audio.deviceId,this.micStream=await navigator.mediaDevices.getUserMedia(t),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode),this._emit("microphone-captured-fallback",{constraints:t})}}_stopMicrophone(){this.micStream&&(this.micStream.getTracks().forEach(t=>{try{t.stop()}catch(t){console.warn("åœæ­¢éº¥å…‹é¢¨è»Œé“å¤±æ•—:",t)}}),this.micStream=null)}_applyIOSMicGainAdjustment(){try{const t=navigator.userAgent||"";/iphone|ipad|ipod/i.test(t)&&!this.config.autoGainControl&&Math.abs(this.config.micGain-1)<1e-4&&(this.setMicGain(3.5),this._emit("ios-gain-adjusted",{gain:3.5}))}catch(t){console.warn("iOS å¢ç›Šèª¿æ•´å¤±æ•—:",t)}}async _startWorkletRecording(){try{this.pcmCollectorNode=new AudioWorkletNode(this.audioContext,"pcm-collector-processor"),this.pcmCollectorNode.port.onmessage=t=>{const{type:e,pcmData:i}=t.data;"pcm-data"===e&&i&&(this.pcmChunks.push(new Float32Array(i)),this.pcmTotalSamples+=i.length,this._emit("data-available",{pcmData:new Float32Array(i),totalSamples:this.pcmTotalSamples,mode:"worklet"}))},this.preGainNode.connect(this.pcmCollectorNode),this.pcmCollectorNode.connect(this.audioContext.destination),this.usingWorklet=!0}catch(t){console.error("AudioWorklet å•Ÿå‹•å¤±æ•—ï¼Œå›é€€åˆ° RecordRTC:",t),this.usingWorklet=!1,await this._startRecordRTCRecording()}}async _stopWorkletRecording(){try{if(this.pcmCollectorNode&&(this.pcmCollectorNode.port.onmessage=null,this.preGainNode.disconnect(this.pcmCollectorNode),this.pcmCollectorNode.disconnect(),this.pcmCollectorNode=null),0===this.pcmChunks.length)throw new Error("æ²’æœ‰éŒ„éŸ³æ•¸æ“š");const t=new Float32Array(this.pcmTotalSamples);let e=0;for(const i of this.pcmChunks)t.set(i,e),e+=i.length;const i=this._buildWavFromFloat32Mono(t,this.audioContext.sampleRate),s=new Blob([i],{type:"audio/wav"});return this.usingWorklet=!1,s}catch(t){throw console.error("AudioWorklet åœæ­¢å¤±æ•—:",t),t}}async _startRecordRTCRecording(){return new Promise((t,e)=>{try{if("undefined"==typeof RecordRTC)return void e(new Error("RecordRTC æœªè¼‰å…¥"));const i=this.mediaDest.stream||this.micStream;this.recorder=RecordRTC(i,{type:"audio",mimeType:"audio/wav",recorderType:StereoAudioRecorder,numberOfAudioChannels:1,bufferSize:4096,timeSlice:100,ondataavailable:t=>{this._emit("data-available",{blob:t,mode:"recordrtc"})}}),this.recorder.startRecording(),this.usingWorklet=!1,this._startPcmCapture(),t()}catch(t){e(t)}})}async _stopRecordRTCRecording(){return new Promise((t,e)=>{try{if(!this.recorder)return void e(new Error("RecordRTC éŒ„éŸ³å™¨ä¸å­˜åœ¨"));this._stopPcmCapture(),this.recorder.stopRecording(()=>{try{const e=this.recorder.getBlob();this.recorder=null,t(e)}catch(t){e(t)}})}catch(t){e(t)}})}_startPcmCapture(){if(!this.analyser)return;const t=this.analyser.fftSize,e=new Float32Array(t);this._pcmCaptureInterval=setInterval(()=>{if(!this.isRecording||!this.analyser)return;this.analyser.getFloatTimeDomainData(e);const t=new Float32Array(e);this.pcmChunks.push(t),this.pcmTotalSamples+=t.length,this._emit("data-available",{pcmData:t,totalSamples:this.pcmTotalSamples,mode:"recordrtc-pcm"})},100)}_stopPcmCapture(){this._pcmCaptureInterval&&(clearInterval(this._pcmCaptureInterval),this._pcmCaptureInterval=null)}_buildWavFromFloat32Mono(t,e){const i=t.length,s=new ArrayBuffer(44+2*i),a=new DataView(s);this._writeString(a,0,"RIFF"),a.setUint32(4,36+2*i,!0),this._writeString(a,8,"WAVE"),this._writeString(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,e,!0),a.setUint32(28,2*e,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),this._writeString(a,36,"data"),a.setUint32(40,2*i,!0);let o=44;for(let e=0;e<i;e++){const i=Math.max(-1,Math.min(1,t[e])),s=i<0?32768*i:32767*i;a.setInt16(o,s,!0),o+=2}return s}_writeString(t,e,i){for(let s=0;s<i.length;s++)t.setUint8(e+s,i.charCodeAt(s))}},t.BUILD_INFO=l,t.CapacitorAdapter=class extends o{constructor(t="recordings"){if(super(),this.directory=t,"undefined"==typeof window||!window.Capacitor)throw new Error("Capacitor not available. Make sure Capacitor is properly initialized.");this.Capacitor=window.Capacitor,this.initialized=!1}async initialize(){if(!this.initialized)try{const{Filesystem:t,Directory:e}=this.Capacitor.Plugins;try{await t.readdir({path:this.directory,directory:e.Documents})}catch(i){await t.mkdir({path:this.directory,directory:e.Documents,recursive:!0})}this.initialized=!0}catch(t){throw console.error("Capacitor initialization error:",t),t}}async save(t,e,i={}){await this.initialize();try{const{Filesystem:s,Directory:a}=this.Capacitor.Plugins,o=await this.blobToBase64(t);if(await s.writeFile({path:`${this.directory}/${e}`,data:o,directory:a.Documents}),i&&Object.keys(i).length>0){const o={...i,size:t.size,type:t.type,timestamp:Date.now()};await s.writeFile({path:`${this.directory}/${e}.meta.json`,data:JSON.stringify(o),directory:a.Documents,encoding:"utf8"})}return e}catch(t){throw console.error("Capacitor save error:",t),t}}async load(t){await this.initialize();try{const{Filesystem:e,Directory:i}=this.Capacitor.Plugins,s=await e.readFile({path:`${this.directory}/${t}`,directory:i.Documents});return this.base64ToBlob(s.data,"audio/wav")}catch(t){throw console.error("Capacitor load error:",t),t}}async delete(t){await this.initialize();try{const{Filesystem:e,Directory:i}=this.Capacitor.Plugins;await e.deleteFile({path:`${this.directory}/${t}`,directory:i.Documents});try{await e.deleteFile({path:`${this.directory}/${t}.meta.json`,directory:i.Documents})}catch(t){}return!0}catch(t){throw console.error("Capacitor delete error:",t),t}}async list(){await this.initialize();try{const{Filesystem:t,Directory:e}=this.Capacitor.Plugins,i=(await t.readdir({path:this.directory,directory:e.Documents})).files.filter(t=>!t.endsWith(".meta.json")),s=await Promise.all(i.map(async i=>{let s={};try{const a=await t.readFile({path:`${this.directory}/${i}.meta.json`,directory:e.Documents,encoding:"utf8"});s=JSON.parse(a.data)}catch(t){}return{id:i,filename:i,metadata:s,timestamp:s.timestamp||0,date:s.timestamp?new Date(s.timestamp):null,size:s.size||0,type:s.type||"audio/wav"}}));return s.sort((t,e)=>e.timestamp-t.timestamp),s}catch(t){return console.error("Capacitor list error:",t),[]}}async getUri(t){await this.initialize();try{const{Filesystem:e,Directory:i}=this.Capacitor.Plugins;return(await e.getUri({path:`${this.directory}/${t}`,directory:i.Documents})).uri}catch(t){throw console.error("Capacitor getUri error:",t),t}}blobToBase64(t){return new Promise((e,i)=>{const s=new FileReader;s.onloadend=()=>{const t=s.result.split(",")[1];e(t)},s.onerror=i,s.readAsDataURL(t)})}base64ToBlob(t,e="audio/wav"){const i=atob(t),s=new Array(i.length);for(let t=0;t<i.length;t++)s[t]=i.charCodeAt(t);const a=new Uint8Array(s);return new Blob([a],{type:e})}async getStorageInfo(){const t=await this.list(),e=t.reduce((t,e)=>t+(e.size||0),0);return{count:t.length,totalSize:e,totalSizeMB:(e/1048576).toFixed(2),recordings:t}}},t.ElectronAdapter=class extends o{constructor(t="recordings"){if(super(),this.savePath=t,"undefined"==typeof window||!window.electronAPI)throw new Error("Electron API not available. Make sure preload script is properly configured.");this.electronAPI=window.electronAPI}async save(t,e,i={}){try{const s=await t.arrayBuffer(),a=Array.from(new Uint8Array(s)),o=await this.electronAPI.saveRecording({filename:e,buffer:a,metadata:{...i,size:t.size,type:t.type,timestamp:Date.now()}});if(o.success)return o.id||o.path;throw new Error(o.error||"Save failed")}catch(t){throw console.error("Electron save error:",t),t}}async load(t){try{const e=await this.electronAPI.loadRecording(t),i=new Uint8Array(e);return new Blob([i],{type:"audio/wav"})}catch(t){throw console.error("Electron load error:",t),t}}async delete(t){try{return(await this.electronAPI.deleteRecording(t)).success}catch(t){throw console.error("Electron delete error:",t),t}}async list(t=null){try{return await this.electronAPI.listRecordings(t)||[]}catch(t){return console.error("Electron list error:",t),[]}}async openFile(){try{if(this.electronAPI.openFile)return await this.electronAPI.openFile();throw new Error("openFile API not available")}catch(t){return console.error("Electron openFile error:",t),null}}async saveAs(t,e="recording.wav"){try{const i=await t.arrayBuffer(),s=Array.from(new Uint8Array(i));if(this.electronAPI.saveAs){const t=await this.electronAPI.saveAs({filename:e,buffer:s});return t.success?t.path:null}return await this.save(t,e)}catch(t){return console.error("Electron saveAs error:",t),null}}async showInFolder(t){try{return!!this.electronAPI.showInFolder&&(await this.electronAPI.showInFolder(t),!0)}catch(t){return console.error("Electron showInFolder error:",t),!1}}},t.IndexedDBAdapter=class extends o{constructor(t="VoiceBankDB",e="recordings",i=1){super(),this.dbName=t,this.storeName=e,this.version=i,this.db=null}async initialize(){return this.db?this.db:new Promise((t,e)=>{const i=indexedDB.open(this.dbName,this.version);i.onerror=()=>{e(new Error(`Failed to open IndexedDB: ${i.error}`))},i.onsuccess=()=>{this.db=i.result,t(this.db)},i.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains(this.storeName)){const t=e.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});t.createIndex("filename","filename",{unique:!1}),t.createIndex("timestamp","timestamp",{unique:!1}),t.createIndex("duration","duration",{unique:!1})}}})}async save(t,e,i={}){return await this.initialize(),new Promise((s,a)=>{const o=this.db.transaction([this.storeName],"readwrite"),r=o.objectStore(this.storeName),n={filename:e,blob:t,size:t.size,type:t.type,timestamp:Date.now(),metadata:i},l=r.add(n);l.onsuccess=()=>{s(String(l.result))},l.onerror=()=>{a(new Error(`Failed to save recording: ${l.error}`))},o.onerror=()=>{a(new Error(`Transaction failed: ${o.error}`))}})}async load(t){return await this.initialize(),new Promise((e,i)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(Number(t));s.onsuccess=()=>{const a=s.result;a&&a.blob?e(a.blob):i(new Error(`Recording not found: ${t}`))},s.onerror=()=>{i(new Error(`Failed to load recording: ${s.error}`))}})}async delete(t){return await this.initialize(),new Promise((e,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(Number(t));s.onsuccess=()=>{e(!0)},s.onerror=()=>{i(new Error(`Failed to delete recording: ${s.error}`))}})}async list(){return await this.initialize(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onsuccess=()=>{const e=i.result.map(t=>({id:String(t.id),filename:t.filename,size:t.size,type:t.type,timestamp:t.timestamp,date:new Date(t.timestamp),metadata:t.metadata||{}}));t(e)},i.onerror=()=>{e(new Error(`Failed to list recordings: ${i.error}`))}})}async searchByFilename(t){return(await this.list()).filter(e=>e.filename.toLowerCase().includes(t.toLowerCase()))}async getStorageInfo(){const t=await this.list(),e=t.reduce((t,e)=>t+e.size,0);return{count:t.length,totalSize:e,totalSizeMB:(e/1048576).toFixed(2),records:t}}async clear(){return await this.initialize(),new Promise((t,e)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),s=i.count();s.onsuccess=()=>{const a=s.result,o=i.clear();o.onsuccess=()=>{t(a)},o.onerror=()=>{e(new Error(`Failed to clear recordings: ${o.error}`))}},s.onerror=()=>{e(new Error(`Failed to count recordings: ${s.error}`))}})}async getStorageEstimate(){if("storage"in navigator&&"estimate"in navigator.storage)try{const t=await navigator.storage.estimate();return{usage:t.usage,quota:t.quota,usageMB:(t.usage/1048576).toFixed(2),quotaMB:(t.quota/1048576).toFixed(2),usagePercent:(t.usage/t.quota*100).toFixed(2)}}catch(t){return console.warn("Failed to get storage estimate:",t),null}return null}close(){this.db&&(this.db.close(),this.db=null)}},t.PlatformDetector=class{static detect(){return"undefined"!=typeof window&&window.electronAPI||"undefined"!=typeof process&&process.versions&&process.versions.electron?"electron":"undefined"!=typeof window&&window.Capacitor?"capacitor":"browser"}static isElectron(){return"electron"===this.detect()}static isCapacitor(){return"capacitor"===this.detect()}static isBrowser(){return"browser"===this.detect()}static isMobile(){return!("undefined"==typeof window||!window.navigator)&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)}static supportsAudioWorklet(){if("undefined"==typeof window||!window.AudioContext)return!1;return"audioWorklet"in(window.AudioContext||window.webkitAudioContext).prototype}static supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}static getInfo(){return{platform:this.detect(),isElectron:this.isElectron(),isCapacitor:this.isCapacitor(),isBrowser:this.isBrowser(),isMobile:this.isMobile(),supportsAudioWorklet:this.supportsAudioWorklet(),supportsOffscreenCanvas:this.supportsOffscreenCanvas(),userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown"}}},t.RecorderUI=class{constructor(t,e={}){if(this.container="string"==typeof t?document.querySelector(t):t,!this.container)throw new Error("Container element not found");this.audioEngine=e.audioEngine,this.waveformRenderer=e.waveformRenderer,this.options={layout:e.layout||"auto",theme:e.theme||"light",showOverview:!1!==e.showOverview,...e},this.callbacks={onRecordStart:e.onRecordStart||(()=>{}),onRecordStop:e.onRecordStop||(()=>{}),onPlayStart:e.onPlayStart||(()=>{}),onPlayStop:e.onPlayStop||(()=>{}),onError:e.onError||(t=>console.error("UI Error:",t)),...e.callbacks},this.elements={},this.state={isRecording:!1,isPlaying:!1,isPaused:!1,hasRecording:!1,duration:0,sampleCount:0},this.controlPanel=null,this.playbackController=null,this.layoutManager=null}async initialize(){try{this.renderUI(),this.cacheElements(),this.bindEvents(),this.initializeSubControllers(),this.applyInitialSettings(),this.connectCoreModules(),console.log("âœ… RecorderUI initialized")}catch(t){throw this.callbacks.onError(t),t}}renderUI(){this.container.innerHTML=`\n      <div class="voicebank-recorder" data-layout="${this.options.layout}" data-theme="${this.options.theme}">\n        \x3c!-- æ§åˆ¶é¢æ¿ --\x3e\n        <div class="recorder-controls">\n          <button id="vbr-btn-record" class="btn-record">\n            <span class="icon">â—</span>\n            <span class="label">é–‹å§‹éŒ„éŸ³</span>\n          </button>\n          \n          <div class="recording-info">\n            <span id="vbr-recording-duration">00:00.0</span>\n            <span id="vbr-sample-count">0 samples</span>\n          </div>\n        </div>\n        \n        \x3c!-- æ³¢å½¢å®¹å™¨ --\x3e\n        <div class="waveform-wrapper" id="vbr-waveform-wrapper">\n          \x3c!-- å³æ™‚æ³¢å½¢ --\x3e\n          <div class="waveform-section">\n            <label>å³æ™‚æ³¢å½¢</label>\n            <canvas id="vbr-live-waveform" width="800" height="120"></canvas>\n          </div>\n          \n          \x3c!-- VU Meter --\x3e\n          <div class="waveform-section">\n            <label>éŸ³é‡è¡¨</label>\n            <canvas id="vbr-vu-meter" width="800" height="50"></canvas>\n          </div>\n          \n          \x3c!-- ç´¯ç©æ³¢å½¢ --\x3e\n          <div class="waveform-section">\n            <label>ç´¯ç©æ³¢å½¢</label>\n            <canvas id="vbr-accumulated-waveform" width="800" height="200"></canvas>\n          </div>\n          \n          \x3c!-- æ¦‚è¦½æ³¢å½¢ --\x3e\n          ${this.options.showOverview?'\n          <div class="waveform-section">\n            <label>æ¦‚è¦½æ³¢å½¢</label>\n            <canvas id="vbr-overview-waveform" width="800" height="80"></canvas>\n          </div>\n          ':""}\n        </div>\n        \n        \x3c!-- æ’­æ”¾æ§åˆ¶ --\x3e\n        <div class="playback-controls">\n          <button id="vbr-btn-play" class="btn-play" disabled>\n            <span class="icon">â–¶</span>\n            <span class="label">æ’­æ”¾</span>\n          </button>\n          <button id="vbr-btn-pause" class="btn-pause" disabled>\n            <span class="icon">â¸</span>\n            <span class="label">æš«åœ</span>\n          </button>\n          <button id="vbr-btn-stop" class="btn-stop" disabled>\n            <span class="icon">â¹</span>\n            <span class="label">åœæ­¢</span>\n          </button>\n        </div>\n        \n        \x3c!-- å·¥å…·åˆ— --\x3e\n        <div class="toolbar">\n          <button id="vbr-btn-save" class="btn-save" disabled>\n            <span class="icon">ğŸ’¾</span>\n            <span class="label">å„²å­˜</span>\n          </button>\n          <button id="vbr-btn-clear" class="btn-clear" disabled>\n            <span class="icon">ğŸ—‘ï¸</span>\n            <span class="label">æ¸…é™¤</span>\n          </button>\n          <button id="vbr-btn-layout-toggle" class="btn-layout-toggle">\n            <span class="icon">ğŸ”„</span>\n            <span class="label">åˆ‡æ›ä½ˆå±€</span>\n          </button>\n        </div>\n      </div>\n    `}cacheElements(){this.elements={btnRecord:document.getElementById("vbr-btn-record"),btnPlay:document.getElementById("vbr-btn-play"),btnPause:document.getElementById("vbr-btn-pause"),btnStop:document.getElementById("vbr-btn-stop"),btnSave:document.getElementById("vbr-btn-save"),btnClear:document.getElementById("vbr-btn-clear"),btnLayoutToggle:document.getElementById("vbr-btn-layout-toggle"),recordingDuration:document.getElementById("vbr-recording-duration"),sampleCount:document.getElementById("vbr-sample-count"),waveformWrapper:document.getElementById("vbr-waveform-wrapper"),liveCanvas:document.getElementById("vbr-live-waveform"),vuMeterCanvas:document.getElementById("vbr-vu-meter"),accumulatedCanvas:document.getElementById("vbr-accumulated-waveform"),overviewCanvas:document.getElementById("vbr-overview-waveform")}}bindEvents(){this.elements.btnRecord&&this.elements.btnRecord.addEventListener("click",()=>{this.handleRecordToggle()}),this.elements.btnPlay&&this.elements.btnPlay.addEventListener("click",()=>{this.handlePlay()}),this.elements.btnPause&&this.elements.btnPause.addEventListener("click",()=>{this.handlePause()}),this.elements.btnStop&&this.elements.btnStop.addEventListener("click",()=>{this.handleStop()}),this.elements.btnSave&&this.elements.btnSave.addEventListener("click",()=>{this.handleSave()}),this.elements.btnClear&&this.elements.btnClear.addEventListener("click",()=>{this.handleClear()}),this.elements.btnLayoutToggle&&this.elements.btnLayoutToggle.addEventListener("click",()=>{this.handleLayoutToggle()}),window.addEventListener("resize",()=>{this.handleResize()})}initializeSubControllers(){}applyInitialSettings(){this.applyLayout(this.options.layout),this.applyTheme(this.options.theme),this.updateButtonStates()}connectCoreModules(){this.audioEngine&&this.waveformRenderer?(this.audioEngine.on("recording-start",()=>{this.onRecordingStart()}),this.audioEngine.on("recording-stop",t=>{this.onRecordingStop(t)}),this.audioEngine.on("data-available",t=>{this.onDataAvailable(t)}),this.audioEngine.on("error",t=>{this.onAudioError(t)})):console.warn("Core modules not provided, UI will have limited functionality")}async handleRecordToggle(){try{this.state.isRecording?await this.audioEngine.stopRecording():await this.audioEngine.startRecording()}catch(t){this.callbacks.onError(t),this.showError("éŒ„éŸ³æ“ä½œå¤±æ•—ï¼š"+t.message)}}async handlePlay(){try{console.log("Play recording"),this.callbacks.onPlayStart()}catch(t){this.callbacks.onError(t)}}async handlePause(){try{console.log("Pause playback")}catch(t){this.callbacks.onError(t)}}async handleStop(){try{console.log("Stop playback"),this.callbacks.onPlayStop()}catch(t){this.callbacks.onError(t)}}async handleSave(){try{console.log("Save recording")}catch(t){this.callbacks.onError(t)}}async handleClear(){if(confirm("ç¢ºå®šè¦æ¸…é™¤ç•¶å‰éŒ„éŸ³å—ï¼Ÿ"))try{this.waveformRenderer&&this.waveformRenderer.reset(),this.state.hasRecording=!1,this.state.duration=0,this.state.sampleCount=0,this.updateDurationDisplay(),this.updateButtonStates(),console.log("Recording cleared")}catch(t){this.callbacks.onError(t)}}handleLayoutToggle(){const t="horizontal"===this.container.dataset.layout?"vertical":"horizontal";this.applyLayout(t)}handleResize(){this.waveformRenderer&&this.waveformRenderer.resize()}onRecordingStart(){this.state.isRecording=!0,this.state.hasRecording=!0,this.setRecordingState(!0),this.updateButtonStates(),this.waveformRenderer,this.callbacks.onRecordStart(),console.log("ğŸ™ï¸ Recording started")}onRecordingStop(t){this.state.isRecording=!1,this.setRecordingState(!1),this.updateButtonStates(),this.callbacks.onRecordStop(t),console.log("â¹ï¸ Recording stopped",t)}onDataAvailable(t){void 0!==t.duration&&(this.state.duration=t.duration),void 0!==t.sampleCount&&(this.state.sampleCount=t.sampleCount),this.updateDurationDisplay()}onAudioError(t){this.showError("éŸ³è¨ŠéŒ¯èª¤ï¼š"+t.message),this.callbacks.onError(t)}setRecordingState(t){const e=this.elements.btnRecord;e&&(t?(e.classList.add("recording"),e.querySelector(".icon").textContent="â¹",e.querySelector(".label").textContent="åœæ­¢éŒ„éŸ³"):(e.classList.remove("recording"),e.querySelector(".icon").textContent="â—",e.querySelector(".label").textContent="é–‹å§‹éŒ„éŸ³"))}updateButtonStates(){const{isRecording:t,isPlaying:e,isPaused:i,hasRecording:s}=this.state;this.elements.btnRecord&&(this.elements.btnRecord.disabled=e),this.elements.btnPlay&&(this.elements.btnPlay.disabled=!s||t||e),this.elements.btnPause&&(this.elements.btnPause.disabled=!e||i),this.elements.btnStop&&(this.elements.btnStop.disabled=!e&&!i),this.elements.btnSave&&(this.elements.btnSave.disabled=!s||t),this.elements.btnClear&&(this.elements.btnClear.disabled=!s||t)}updateDurationDisplay(){this.elements.recordingDuration&&(this.elements.recordingDuration.textContent=this.formatDuration(this.state.duration)),this.elements.sampleCount&&(this.elements.sampleCount.textContent=`${this.state.sampleCount.toLocaleString()} samples`)}formatDuration(t){const e=Math.floor(t/60),i=Math.floor(t%60),s=Math.floor(t%1*10);return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${s}`}applyLayout(t){"auto"===t&&(t=window.innerWidth>window.innerHeight?"horizontal":"vertical"),this.container.dataset.layout=t,this.options.layout=t,this.waveformRenderer&&this.waveformRenderer.setVerticalMode("vertical"===t),console.log(`ğŸ“ Layout changed to: ${t}`)}applyTheme(t){this.container.dataset.theme=t,this.options.theme=t,console.log(`ğŸ¨ Theme changed to: ${t}`)}showError(t){alert("éŒ¯èª¤ï¼š"+t)}showNotice(t,e=3e3){console.log("ğŸ“¢ Notice:",t)}getState(){return{...this.state}}setOptions(t){this.options={...this.options,...t},t.layout&&this.applyLayout(t.layout),t.theme&&this.applyTheme(t.theme)}destroy(){this.container&&(this.container.innerHTML=""),this.elements={},this.audioEngine=null,this.waveformRenderer=null,console.log("ğŸ—‘ï¸ RecorderUI destroyed")}},t.ServerAdapter=class extends o{constructor(t={}){super(),this.baseURL=t.baseURL||"",this.saveEndpoint=t.saveEndpoint||"/backend/save.php",this.loadEndpoint=t.loadEndpoint||"/public/uploads/",this.deleteEndpoint=t.deleteEndpoint||"/backend/delete.php",this.listEndpoint=t.listEndpoint||"/api/recordings",this.headers=t.headers||{}}async save(t,e,i={}){const s=new FormData;s.append("audio-blob",t),s.append("audio-filename",e),i&&Object.keys(i).length>0&&s.append("metadata",JSON.stringify(i));try{const t=await fetch(this.baseURL+this.saveEndpoint,{method:"POST",body:s,headers:this.headers});if(!t.ok)throw new Error(`Upload failed: ${t.status} ${t.statusText}`);const i=await t.text();if(i.toLowerCase().includes("success"))return e;throw new Error(`Server error: ${i}`)}catch(t){throw console.error("Save error:",t),t}}async load(t){try{const e=this.baseURL+this.loadEndpoint+t,i=await fetch(e,{headers:this.headers});if(!i.ok)throw new Error(`Load failed: ${i.status} ${i.statusText}`);return await i.blob()}catch(t){throw console.error("Load error:",t),t}}async delete(t){try{const e=await fetch(this.baseURL+this.deleteEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.headers},body:JSON.stringify({filename:t})});if(!e.ok)throw new Error(`Delete failed: ${e.status} ${e.statusText}`);return(await e.text()).toLowerCase().includes("success")}catch(t){throw console.error("Delete error:",t),t}}async list(){try{const t=await fetch(this.baseURL+this.listEndpoint,{headers:this.headers});if(!t.ok)throw new Error(`List failed: ${t.status} ${t.statusText}`);const e=await t.json();return Array.isArray(e)?e:[]}catch(t){return console.error("List error:",t),[]}}async saveWithProgress(t,e,i={},s=null){return new Promise((a,o)=>{const r=new FormData;r.append("audio-blob",t),r.append("audio-filename",e),i&&Object.keys(i).length>0&&r.append("metadata",JSON.stringify(i));const n=new XMLHttpRequest;s&&n.upload.addEventListener("progress",t=>{if(t.lengthComputable){const e=t.loaded/t.total*100;s(e)}}),n.addEventListener("load",()=>{if(n.status>=200&&n.status<300){const t=n.responseText;t.toLowerCase().includes("success")?a(e):o(new Error(`Server error: ${t}`))}else o(new Error(`Upload failed: ${n.status} ${n.statusText}`))}),n.addEventListener("error",()=>{o(new Error("Network error during upload"))}),n.addEventListener("abort",()=>{o(new Error("Upload cancelled"))}),n.open("POST",this.baseURL+this.saveEndpoint),Object.keys(this.headers).forEach(t=>{n.setRequestHeader(t,this.headers[t])}),n.send(r)})}},t.StorageAdapter=o,t.StorageFactory=class{static create(t={}){const e=t.type||"auto",i=t.options||{};if("auto"===e)return this.createAuto(i);switch(e.toLowerCase()){case"browser":case"indexeddb":const{IndexedDBAdapter:t}=require("./IndexedDBAdapter.js");return new t(i.dbName,i.storeName,i.version);case"electron":const{ElectronAdapter:s}=require("./ElectronAdapter.js");return new s(i.savePath);case"capacitor":const{CapacitorAdapter:a}=require("./CapacitorAdapter.js");return new a(i.directory);case"server":case"php":case"nodejs":const{ServerAdapter:o}=require("./ServerAdapter.js");return new o(i);default:throw new Error(`Unknown storage type: ${e}`)}}static createAuto(t={}){if("undefined"!=typeof window&&window.electronAPI){const{ElectronAdapter:e}=require("./ElectronAdapter.js");return new e(t.savePath)}if("undefined"!=typeof window&&window.Capacitor){const{CapacitorAdapter:e}=require("./CapacitorAdapter.js");return new e(t.directory)}const{IndexedDBAdapter:e}=require("./IndexedDBAdapter.js");return new e(t.dbName,t.storeName,t.version)}},t.VERSION=n,t.VoiceBankRecorder=r,t.WaveformRenderer=class{constructor(t={}){this.options={workerPath:t.workerPath||"workers/wf-worker.js",useWorker:!1!==t.useWorker,showClipMarks:!1!==t.showClipMarks,...t},this.audioEngine=t.audioEngine,this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null,this.isVerticalMode=!1,this._overviewUpdateScheduled=!1,this.audioEngine&&this._setupAudioEngineListeners()}_setupAudioEngineListeners(){this.audioEngine&&(this.audioEngine.on("recording-start",()=>{this.start()}),this.audioEngine.on("recording-stop",()=>{this.stopLive()}),this.audioEngine.on("data-available",t=>{t.pcmData&&this.accumulatedWaveform&&this.appendPCM(t.pcmData)}))}async initialize(){const{liveCanvas:t,vuMeterCanvas:o,accumulatedCanvas:r,overviewCanvas:n}=this.options;let l=this.options.analyserNode;!l&&this.audioEngine&&"function"==typeof this.audioEngine.getAnalyser&&(l=this.audioEngine.getAnalyser()),t&&l&&(this.liveWaveform=new e(t,l)),o&&l&&(this.vuMeter=new i(o,l)),r&&(this.accumulatedWaveform=new s(r,{workerPath:this.options.workerPath,useWorker:this.options.useWorker,showClipMarks:this.options.showClipMarks})),n&&this.accumulatedWaveform&&(this.overviewWaveform=new a(n,this.accumulatedWaveform))}startLive(t,e,i){this.liveWaveform&&this.liveWaveform.start(t,e,i),this.vuMeter&&this.vuMeter.start()}start(){if(!this.audioEngine)return void console.warn("No audioEngine provided, cannot start waveform rendering");const t=this.audioEngine.microphoneStream,e=this.audioEngine.audioContext,i=this.audioEngine.preGainNode;t&&e&&this.startLive(t,e,i)}stopLive(){this.liveWaveform&&this.liveWaveform.stop(),this.vuMeter&&this.vuMeter.stop()}appendPCM(t){this.accumulatedWaveform&&(this.accumulatedWaveform.append(t),this.overviewWaveform&&(this._overviewUpdateScheduled||(this._overviewUpdateScheduled=!0,requestAnimationFrame(()=>{this.overviewWaveform&&this.overviewWaveform.draw(),this._overviewUpdateScheduled=!1}))))}reset(){this.accumulatedWaveform&&this.accumulatedWaveform.reset(),this.overviewWaveform&&this.overviewWaveform.clear()}clear(){this.liveWaveform&&this.liveWaveform.canvasContext.clearRect(0,0,this.liveWaveform.width,this.liveWaveform.height),this.vuMeter&&this.vuMeter.clear(),this.accumulatedWaveform&&this.accumulatedWaveform.clear(),this.overviewWaveform&&this.overviewWaveform.clear()}setVerticalMode(t){this.isVerticalMode=t,this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"setVerticalMode",verticalMode:t})}resize(){this.liveWaveform&&(this.liveWaveform.width=this.liveWaveform.canvas.width,this.liveWaveform.height=this.liveWaveform.canvas.height),this.vuMeter&&this.vuMeter.resize(),this.accumulatedWaveform&&(this.accumulatedWaveform.width=this.accumulatedWaveform.canvas.width,this.accumulatedWaveform.height=this.accumulatedWaveform.canvas.height,this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"resize",width:this.accumulatedWaveform.width,height:this.accumulatedWaveform.height}),this.accumulatedWaveform.draw()),this.overviewWaveform&&(this.overviewWaveform.width=this.overviewWaveform.canvas.width,this.overviewWaveform.height=this.overviewWaveform.canvas.height,this.overviewWaveform.draw())}destroy(){this.stopLive(),this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.terminate(),this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null}},t.default=r,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=voicebank-recorder.min.js.map
