/*!
 * voicebank-recorder v1.0.0
 * è·¨å¹³å°éŸ³è¨ŠéŒ„éŸ³åº«ï¼Œæ”¯æ´ Browser/Electron/Capacitor
 * 
 * Includes RecordRTC v5.6.2 (https://github.com/muaz-khan/RecordRTC)
 * RecordRTC License: MIT
 * 
 * @license MIT
 * @author VoiceBank Team
 * @repository https://github.com/cychiang-ntpu/simple-recordrtc-example.git
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VoiceBankRecorder={})}(this,function(e){"use strict";class t{constructor(e={}){this.options={micStorageKey:"preferredMicDeviceId",outputStorageKey:"preferredOutputDeviceId",autoLoadPreferences:!0,autoRequestPermission:!0,...e},this.microphoneDevices=[],this.outputDevices=[],this.selectedMicDeviceId="",this.selectedOutputDeviceId="default",this._eventListeners={devicechange:[],micchange:[],outputchange:[]},this._deviceChangeListener=null,this.options.autoLoadPreferences&&this.loadPreferences()}loadPreferences(){console.log("[DeviceManager] loadPreferences è¢«å‘¼å«");try{const e=localStorage.getItem(this.options.micStorageKey),t=localStorage.getItem(this.options.outputStorageKey);console.log("[DeviceManager] localStorage ä¸­çš„å€¼:"),console.log(`  - ${this.options.micStorageKey}: "${e}"`),console.log(`  - ${this.options.outputStorageKey}: "${t}"`),e?(this.selectedMicDeviceId=e,console.log(`[DeviceManager] å·²è¼‰å…¥éº¥å…‹é¢¨åå¥½: ${e}`)):console.log("[DeviceManager] æ²’æœ‰å„²å­˜çš„éº¥å…‹é¢¨åå¥½"),t?(this.selectedOutputDeviceId=t,console.log(`[DeviceManager] å·²è¼‰å…¥è¼¸å‡ºè£ç½®åå¥½: ${t}`)):console.log("[DeviceManager] æ²’æœ‰å„²å­˜çš„è¼¸å‡ºè£ç½®åå¥½ï¼Œä½¿ç”¨ default")}catch(e){console.warn("[DeviceManager] Failed to load device preferences:",e)}}savePreference(e,t){try{"microphone"===e?(localStorage.setItem(this.options.micStorageKey,t),this.selectedMicDeviceId=t):"output"===e&&(localStorage.setItem(this.options.outputStorageKey,t),this.selectedOutputDeviceId=t)}catch(e){console.warn("Failed to save device preference:",e)}}isSupported(){return!(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)}async requestMicrophonePermission(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia is not supported in this browser");try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch(e){throw new Error(`Failed to request microphone permission: ${e.message}`)}}async enumerateMicrophones(e=this.options.autoRequestPermission){if(!this.isSupported())throw new Error("Device enumeration is not supported in this browser");try{if(e)try{await this.requestMicrophonePermission()}catch(e){console.warn("Permission request failed, continuing anyway:",e)}const t=await navigator.mediaDevices.enumerateDevices();return this.microphoneDevices=t.filter(e=>"audioinput"===e.kind),this.microphoneDevices}catch(e){throw new Error(`Failed to enumerate microphones: ${e.message}`)}}async enumerateOutputDevices(){if(!this.isSupported())throw new Error("Device enumeration is not supported in this browser");try{const e=await navigator.mediaDevices.enumerateDevices();return this.outputDevices=e.filter(e=>"audiooutput"===e.kind),this.outputDevices}catch(e){throw new Error(`Failed to enumerate output devices: ${e.message}`)}}async enumerateAllDevices(e=this.options.autoRequestPermission){const[t,i]=await Promise.all([this.enumerateMicrophones(e),this.enumerateOutputDevices()]);return{microphones:t,outputs:i}}selectMicrophone(e,t=!0){console.log("[DeviceManager] selectMicrophone è¢«å‘¼å«:",{deviceId:e,save:t}),console.log(`[DeviceManager] è®Šæ›´å‰: selectedMicDeviceId = "${this.selectedMicDeviceId}"`),this.selectedMicDeviceId=e,console.log(`[DeviceManager] è®Šæ›´å¾Œ: selectedMicDeviceId = "${this.selectedMicDeviceId}"`),t&&(this.savePreference("microphone",e),console.log(`[DeviceManager] å·²å„²å­˜è‡³ localStorage (${this.options.micStorageKey})`)),this._emit("micchange",{deviceId:e})}selectOutputDevice(e,t=!0){this.selectedOutputDeviceId=e,t&&this.savePreference("output",e),this._emit("outputchange",{deviceId:e})}getSelectedMicrophoneId(){return this.selectedMicDeviceId}getSelectedOutputDeviceId(){return this.selectedOutputDeviceId}getSelectedMicrophone(){return this.microphoneDevices.find(e=>e.deviceId===this.selectedMicDeviceId)||null}getSelectedOutputDevice(){return this.outputDevices.find(e=>e.deviceId===this.selectedOutputDeviceId)||null}getMicrophoneConstraints(e={}){console.log("[DeviceManager] getMicrophoneConstraints è¢«å‘¼å«"),console.log(`[DeviceManager] ç•¶å‰ selectedMicDeviceId = "${this.selectedMicDeviceId}"`);const t={audio:{...e},video:!1};return this.selectedMicDeviceId?(t.audio.deviceId={exact:this.selectedMicDeviceId},console.log(`[DeviceManager] å·²åŠ å…¥ deviceId ç´„æŸ: ${this.selectedMicDeviceId}`)):console.log("[DeviceManager] æ²’æœ‰é¸æ“‡ç‰¹å®šè£ç½®ï¼Œä½¿ç”¨ç³»çµ±é è¨­"),t}async setAudioOutputDevice(e,t){const i=t||this.selectedOutputDeviceId;if("function"==typeof e.setSinkId)try{await e.setSinkId(i)}catch(e){throw new Error(`Failed to set audio output device: ${e.message}`)}else console.warn("setSinkId is not supported in this browser")}isDeviceAvailable(e,t){return("microphone"===t?this.microphoneDevices:this.outputDevices).some(t=>t.deviceId===e)}startDeviceChangeMonitoring(){navigator.mediaDevices&&!this._deviceChangeListener&&(this._deviceChangeListener=async()=>{try{await this.enumerateAllDevices(!1),this._emit("devicechange",{microphones:this.microphoneDevices,outputs:this.outputDevices})}catch(e){console.error("Device change enumeration failed:",e)}},navigator.mediaDevices.addEventListener("devicechange",this._deviceChangeListener))}stopDeviceChangeMonitoring(){this._deviceChangeListener&&navigator.mediaDevices&&(navigator.mediaDevices.removeEventListener("devicechange",this._deviceChangeListener),this._deviceChangeListener=null)}on(e,t){this._eventListeners[e]?this._eventListeners[e].push(t):console.warn(`Unknown event: ${e}`)}off(e,t){if(!this._eventListeners[e])return;const i=this._eventListeners[e].indexOf(t);i>-1&&this._eventListeners[e].splice(i,1)}_emit(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(i=>{try{i(t)}catch(t){console.error(`Error in ${e} event handler:`,t)}})}destroy(){this.stopDeviceChangeMonitoring(),this._eventListeners={devicechange:[],micchange:[],outputchange:[]},this.microphoneDevices=[],this.outputDevices=[]}}class i{constructor(e={}){this.config={sampleRate:e.sampleRate||48e3,autoGainControl:void 0!==e.autoGainControl&&e.autoGainControl,echoCancellation:void 0!==e.echoCancellation&&e.echoCancellation,noiseSuppression:void 0!==e.noiseSuppression&&e.noiseSuppression,micGain:e.micGain||1,deviceId:e.deviceId||null,workletPath:e.workletPath||"assets/js/worklet/pcm-collector.js",preferWorklet:void 0===e.preferWorklet||e.preferWorklet,autoManageDevices:void 0===e.autoManageDevices||e.autoManageDevices},e.deviceManager?(this.deviceManager=e.deviceManager,this._ownDeviceManager=!1):this.config.autoManageDevices?(this.deviceManager=new t,this._ownDeviceManager=!0):(this.deviceManager=null,this._ownDeviceManager=!1),this.audioContext=null,this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.workletSupported=!1,this.workletLoaded=!1,this.pcmCollectorNode=null,this.usingWorklet=!1,this.pcmChunks=[],this.pcmTotalSamples=0,this.recorder=null,this._pcmCaptureInterval=null,this.micStream=null,this.isRecording=!1,this.isPaused=!1,this.isInitialized=!1,this.recordStartTime=0,this.recordStopTime=0,this.recordWallStartMs=0,this.recordWallStopMs=0,this.latestBlob=null,this.latestUrl=null,this._eventListeners={}}async initialize(){if(!this.isInitialized)try{const e=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new e,console.log(`[AudioEngine] AudioContext æ¡æ¨£ç‡: ${this.audioContext.sampleRate} Hz`),console.log(`[AudioEngine] é…ç½®è¦æ±‚çš„æ¡æ¨£ç‡: ${this.config.sampleRate} Hz`),this.audioContext.sampleRate!==this.config.sampleRate&&console.warn(`[AudioEngine] æ³¨æ„ï¼šå¯¦éš›æ¡æ¨£ç‡ (${this.audioContext.sampleRate}) èˆ‡é…ç½® (${this.config.sampleRate}) ä¸åŒ`),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.preGainNode=this.audioContext.createGain(),this.preGainNode.gain.value=this.config.micGain,this.mediaDest=this.audioContext.createMediaStreamDestination(),this.preGainNode.connect(this.analyser),this.preGainNode.connect(this.mediaDest),this.analyserSilencer=this.audioContext.createGain(),this.analyserSilencer.gain.value=0,this.analyser.connect(this.analyserSilencer),this.analyserSilencer.connect(this.audioContext.destination),this.workletSupported=!(!this.audioContext.audioWorklet||!window.AudioWorkletNode),this.workletSupported&&this.config.preferWorklet)try{await this.audioContext.audioWorklet.addModule(this.config.workletPath),this.workletLoaded=!0,this._emit("worklet-loaded",{path:this.config.workletPath})}catch(e){console.warn("è¼‰å…¥ AudioWorklet æ¨¡çµ„å¤±æ•—ï¼Œå°‡å›é€€åˆ° RecordRTC:",e),this.workletLoaded=!1,this._emit("worklet-load-failed",{error:e})}"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isInitialized=!0,this._emit("initialized",{sampleRate:this.audioContext.sampleRate,state:this.audioContext.state,workletSupported:this.workletSupported,workletLoaded:this.workletLoaded})}catch(e){throw this._emit("error",{stage:"initialize",error:e}),e}}async startRecording(){if(!this.isInitialized)throw new Error("AudioEngine å°šæœªåˆå§‹åŒ–ï¼Œè«‹å…ˆèª¿ç”¨ initialize()");if(this.isRecording)throw new Error("å·²ç¶“åœ¨éŒ„éŸ³ä¸­");try{"suspended"===this.audioContext.state&&await this.audioContext.resume(),this._stopMicrophone(),await this._captureMicrophone(),this.pcmChunks=[],this.pcmTotalSamples=0,this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.latestBlob=null,this.recordStartTime=Date.now(),this.recordWallStartMs=performance.now(),this.recordStopTime=0,this.recordWallStopMs=0;const e=this.workletLoaded&&this.config.preferWorklet;e?await this._startWorkletRecording():await this._startRecordRTCRecording(),this.isRecording=!0,this.isPaused=!1,this._emit("recording-start",{timestamp:this.recordStartTime,mode:e?"worklet":"recordrtc",sampleRate:this.audioContext.sampleRate})}catch(e){throw this._emit("error",{stage:"start-recording",error:e}),e}}async stopRecording(){if(!this.isRecording)throw new Error("ç›®å‰æ²’æœ‰åœ¨éŒ„éŸ³");try{let e;if(this.isRecording=!1,this.recordStopTime=Date.now(),this.recordWallStopMs=performance.now(),this.usingWorklet)e=await this._stopWorkletRecording();else{if(!this.recorder)throw new Error("æ²’æœ‰å¯ç”¨çš„éŒ„éŸ³å™¨");e=await this._stopRecordRTCRecording()}this._stopMicrophone(),this.latestBlob=e,this.latestUrl=URL.createObjectURL(e);const t=(this.recordStopTime-this.recordStartTime)/1e3;return this._emit("recording-stop",{blob:e,url:this.latestUrl,duration:t,samples:this.pcmTotalSamples,sampleRate:this.audioContext.sampleRate}),e}catch(e){throw this._emit("error",{stage:"stop-recording",error:e}),e}}pauseRecording(){if(!this.isRecording)throw new Error("ç›®å‰æ²’æœ‰åœ¨éŒ„éŸ³");if(this.usingWorklet)throw new Error("AudioWorklet æ¨¡å¼ä¸æ”¯æ´æš«åœåŠŸèƒ½");if(!this.recorder||"function"!=typeof this.recorder.pauseRecording)throw new Error("æš«åœåŠŸèƒ½ä¸å¯ç”¨");this.recorder.pauseRecording(),this.isPaused=!0,this._emit("recording-paused",{timestamp:Date.now()})}resumeRecording(){if(!this.isPaused)throw new Error("éŒ„éŸ³æ²’æœ‰æš«åœ");if(!this.recorder||"function"!=typeof this.recorder.resumeRecording)throw new Error("ç¹¼çºŒéŒ„éŸ³åŠŸèƒ½ä¸å¯ç”¨");this.recorder.resumeRecording(),this.isPaused=!1,this._emit("recording-resumed",{timestamp:Date.now()})}getLatestRecording(){return{blob:this.latestBlob,url:this.latestUrl,duration:this.latestBlob?(this.recordStopTime-this.recordStartTime)/1e3:0,samples:this.pcmTotalSamples,sampleRate:this.audioContext?this.audioContext.sampleRate:0}}getPcmWindow(e,t){if(!this.usingWorklet||!this.pcmChunks.length)return null;e<0&&(e=0);const i=this.pcmTotalSamples;if(e>=i)return new Float32Array(0);const s=Math.min(i,e+t),n=new Float32Array(s-e);let a=0,o=0;for(let t=0;t<this.pcmChunks.length&&o<s;t++){const i=this.pcmChunks[t];if(!i||!i.length)continue;const r=o,c=o+i.length;if(c<=e){o=c;continue}const l=Math.max(e,r),h=Math.min(s,c);if(h>l){const e=l-r,t=i.subarray(e,e+(h-l));n.set(t,a),a+=t.length}if(o=c,h>=s)break}return n}getAnalyser(){return this.analyser}getAudioContext(){return this.audioContext}get microphoneStream(){return this.micStream}setMicGain(e){e=Math.max(1,Math.min(6,e)),this.config.micGain=e,this.preGainNode&&(this.preGainNode.gain.value=e),this._emit("mic-gain-changed",{gain:e})}dispose(){this.isRecording&&this.stopRecording().catch(console.error),this._stopMicrophone(),this._stopPcmCapture(),this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null),this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.pcmCollectorNode=null,this.recorder=null,this.pcmChunks=[],this.pcmTotalSamples=0,this.isInitialized=!1,this._emit("disposed")}on(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)}off(e,t){if(!this._eventListeners[e])return;const i=this._eventListeners[e].indexOf(t);i>-1&&this._eventListeners[e].splice(i,1)}_emit(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(i=>{try{i(t)}catch(t){console.error(`äº‹ä»¶è™•ç†å™¨éŒ¯èª¤ [${e}]:`,t)}})}async _captureMicrophone(){let e;if(this.deviceManager){e=this.deviceManager.getMicrophoneConstraints({echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl});const t=this.deviceManager.getSelectedMicrophoneId();console.log("[AudioEngine] ä½¿ç”¨ DeviceManager é¸æ“‡çš„éº¥å…‹é¢¨:",t),console.log("[AudioEngine] ç´„æŸæ¢ä»¶:",JSON.stringify(e,null,2))}else e={audio:{echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl},video:!1},this.config.deviceId&&(e.audio.deviceId={exact:this.config.deviceId}),console.log("[AudioEngine] ä½¿ç”¨å‚³çµ±æ¨¡å¼ï¼Œç´„æŸæ¢ä»¶:",JSON.stringify(e,null,2));try{this.micStream=await navigator.mediaDevices.getUserMedia(e),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode);const t=this.deviceManager?this.deviceManager.getSelectedMicrophoneId():this.config.deviceId,i=this.micStream.getAudioTracks();if(i.length>0){const e=i[0].label;console.log("[AudioEngine] å¯¦éš›ä½¿ç”¨çš„éº¥å…‹é¢¨:",e)}this._emit("microphone-captured",{deviceId:t,constraints:e})}catch(t){if("OverconstrainedError"!==t.name&&"NotFoundError"!==t.name)throw t;console.warn("æŒ‡å®šçš„éº¥å…‹é¢¨ç„¡æ³•ä½¿ç”¨ï¼Œå˜—è©¦é è¨­è¨­å‚™"),delete e.audio.deviceId,this.micStream=await navigator.mediaDevices.getUserMedia(e),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode),this._emit("microphone-captured-fallback",{constraints:e})}}_stopMicrophone(){this.micStream&&(this.micStream.getTracks().forEach(e=>{try{e.stop()}catch(e){console.warn("åœæ­¢éº¥å…‹é¢¨è»Œé“å¤±æ•—:",e)}}),this.micStream=null)}_applyIOSMicGainAdjustment(){try{const e=navigator.userAgent||"";/iphone|ipad|ipod/i.test(e)&&!this.config.autoGainControl&&Math.abs(this.config.micGain-1)<1e-4&&(this.setMicGain(3.5),this._emit("ios-gain-adjusted",{gain:3.5}))}catch(e){console.warn("iOS å¢ç›Šèª¿æ•´å¤±æ•—:",e)}}async _startWorkletRecording(){try{this.pcmCollectorNode=new AudioWorkletNode(this.audioContext,"pcm-collector-processor"),this.pcmCollectorNode.port.onmessage=e=>{const{type:t,pcmData:i}=e.data;"pcm-data"===t&&i&&(this.pcmChunks.push(new Float32Array(i)),this.pcmTotalSamples+=i.length,this._emit("data-available",{pcmData:new Float32Array(i),totalSamples:this.pcmTotalSamples,mode:"worklet"}))},this.preGainNode.connect(this.pcmCollectorNode),this.pcmCollectorNode.connect(this.audioContext.destination),this.usingWorklet=!0}catch(e){console.error("AudioWorklet å•Ÿå‹•å¤±æ•—ï¼Œå›é€€åˆ° RecordRTC:",e),this.usingWorklet=!1,await this._startRecordRTCRecording()}}async _stopWorkletRecording(){try{if(this.pcmCollectorNode&&(this.pcmCollectorNode.port.onmessage=null,this.preGainNode.disconnect(this.pcmCollectorNode),this.pcmCollectorNode.disconnect(),this.pcmCollectorNode=null),0===this.pcmChunks.length)throw new Error("æ²’æœ‰éŒ„éŸ³æ•¸æ“š");const e=new Float32Array(this.pcmTotalSamples);let t=0;for(const i of this.pcmChunks)e.set(i,t),t+=i.length;const i=this._buildWavFromFloat32Mono(e,this.audioContext.sampleRate),s=new Blob([i],{type:"audio/wav"});return this.usingWorklet=!1,s}catch(e){throw console.error("AudioWorklet åœæ­¢å¤±æ•—:",e),e}}async _startRecordRTCRecording(){return new Promise((e,t)=>{try{if("undefined"==typeof RecordRTC)return void t(new Error("RecordRTC æœªè¼‰å…¥"));const i=this.mediaDest.stream||this.micStream;this.recorder=RecordRTC(i,{type:"audio",mimeType:"audio/wav",recorderType:StereoAudioRecorder,numberOfAudioChannels:1,bufferSize:4096,timeSlice:100,ondataavailable:e=>{this._emit("data-available",{blob:e,mode:"recordrtc"})}}),this.recorder.startRecording(),this.usingWorklet=!1,this._startPcmCapture(),e()}catch(e){t(e)}})}async _stopRecordRTCRecording(){return new Promise((e,t)=>{try{if(!this.recorder)return void t(new Error("RecordRTC éŒ„éŸ³å™¨ä¸å­˜åœ¨"));this._stopPcmCapture(),this.recorder.stopRecording(()=>{try{const t=this.recorder.getBlob();this.recorder=null,e(t)}catch(e){t(e)}})}catch(e){t(e)}})}_startPcmCapture(){if(!this.analyser)return;const e=this.analyser.fftSize,t=new Float32Array(e);this._pcmCaptureInterval=setInterval(()=>{if(!this.isRecording||!this.analyser)return;this.analyser.getFloatTimeDomainData(t);const e=new Float32Array(t);this.pcmChunks.push(e),this.pcmTotalSamples+=e.length,this._emit("data-available",{pcmData:e,totalSamples:this.pcmTotalSamples,mode:"recordrtc-pcm"})},100)}_stopPcmCapture(){this._pcmCaptureInterval&&(clearInterval(this._pcmCaptureInterval),this._pcmCaptureInterval=null)}_buildWavFromFloat32Mono(e,t){const i=e.length,s=new ArrayBuffer(44+2*i),n=new DataView(s);this._writeString(n,0,"RIFF"),n.setUint32(4,36+2*i,!0),this._writeString(n,8,"WAVE"),this._writeString(n,12,"fmt "),n.setUint32(16,16,!0),n.setUint16(20,1,!0),n.setUint16(22,1,!0),n.setUint32(24,t,!0),n.setUint32(28,2*t,!0),n.setUint16(32,2,!0),n.setUint16(34,16,!0),this._writeString(n,36,"data"),n.setUint32(40,2*i,!0);let a=44;for(let t=0;t<i;t++){const i=Math.max(-1,Math.min(1,e[t])),s=i<0?32768*i:32767*i;n.setInt16(a,s,!0),a+=2}return s}_writeString(e,t,i){for(let s=0;s<i.length;s++)e.setUint8(t+s,i.charCodeAt(s))}destroy(){this.isRecording&&this.stopRecording().catch(e=>{console.warn("åœæ­¢éŒ„éŸ³å¤±æ•—:",e)}),this._stopMicrophone(),this._stopPcmCapture(),this.pcmCollectorNode&&(this.pcmCollectorNode.disconnect(),this.pcmCollectorNode=null),this.audioContext&&(this.audioContext.close().catch(e=>{console.warn("é—œé–‰ AudioContext å¤±æ•—:",e)}),this.audioContext=null),this._ownDeviceManager&&this.deviceManager&&(this.deviceManager.destroy(),this.deviceManager=null),this._eventListeners={},this.isInitialized=!1,this.isRecording=!1}}class s{constructor(e={}){this.options={workerPath:e.workerPath||"workers/wf-worker.js",useWorker:!1!==e.useWorker,showClipMarks:!1!==e.showClipMarks,...e},this.audioEngine=e.audioEngine,this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null,this.isVerticalMode=!1,this._overviewUpdateScheduled=!1,this.audioEngine&&this._setupAudioEngineListeners()}_setupAudioEngineListeners(){this.audioEngine&&(this.audioEngine.on("recording-start",()=>{this.start()}),this.audioEngine.on("recording-stop",()=>{this.stopLive()}),this.audioEngine.on("data-available",e=>{e.pcmData&&this.accumulatedWaveform&&this.appendPCM(e.pcmData)}))}async initialize(){const{liveCanvas:e,vuMeterCanvas:t,accumulatedCanvas:i,overviewCanvas:s}=this.options;let c=this.options.analyserNode;!c&&this.audioEngine&&"function"==typeof this.audioEngine.getAnalyser&&(c=this.audioEngine.getAnalyser()),e&&c&&(this.liveWaveform=new n(e,c)),t&&c&&(this.vuMeter=new a(t,c)),i&&(this.accumulatedWaveform=new o(i,{workerPath:this.options.workerPath,useWorker:this.options.useWorker,showClipMarks:this.options.showClipMarks})),s&&this.accumulatedWaveform&&(this.overviewWaveform=new r(s,this.accumulatedWaveform),this.accumulatedWaveform.overviewWaveform=this.overviewWaveform)}startLive(e,t,i){this.liveWaveform&&this.liveWaveform.start(e,t,i),this.vuMeter&&this.vuMeter.start()}start(){if(!this.audioEngine)return void console.warn("No audioEngine provided, cannot start waveform rendering");const e=this.audioEngine.microphoneStream,t=this.audioEngine.audioContext,i=this.audioEngine.preGainNode;e&&t&&this.startLive(e,t,i)}stopLive(){this.liveWaveform&&this.liveWaveform.stop(),this.vuMeter&&this.vuMeter.stop()}appendPCM(e){this.accumulatedWaveform&&(this.accumulatedWaveform.append(e),this.overviewWaveform&&(this._overviewUpdateScheduled||(this._overviewUpdateScheduled=!0,requestAnimationFrame(()=>{this.overviewWaveform&&this.overviewWaveform.draw(),this._overviewUpdateScheduled=!1}))))}reset(){this.accumulatedWaveform&&this.accumulatedWaveform.reset(),this.overviewWaveform&&this.overviewWaveform.clear()}clear(){this.liveWaveform&&this.liveWaveform.canvasContext.clearRect(0,0,this.liveWaveform.width,this.liveWaveform.height),this.vuMeter&&this.vuMeter.clear(),this.accumulatedWaveform&&this.accumulatedWaveform.clear(),this.overviewWaveform&&this.overviewWaveform.clear()}setVerticalMode(e){this.isVerticalMode=e,this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"setVerticalMode",verticalMode:e})}resize(){this.liveWaveform&&(this.liveWaveform.width=this.liveWaveform.canvas.width,this.liveWaveform.height=this.liveWaveform.canvas.height),this.vuMeter&&this.vuMeter.resize(),this.accumulatedWaveform&&(this.accumulatedWaveform.width=this.accumulatedWaveform.canvas.width,this.accumulatedWaveform.height=this.accumulatedWaveform.canvas.height,this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"resize",width:this.accumulatedWaveform.width,height:this.accumulatedWaveform.height}),this.accumulatedWaveform.draw()),this.overviewWaveform&&(this.overviewWaveform.width=this.overviewWaveform.canvas.width,this.overviewWaveform.height=this.overviewWaveform.canvas.height,this.overviewWaveform.draw())}destroy(){this.stopLive(),this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.terminate(),this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null}}class n{constructor(e,t){this.canvas=e,this.canvasContext=e.getContext("2d"),this.analyser=t,this.mediaStreamSource=null,this.animationId=null,this.isRunning=!1,this.width=e.width,this.height=e.height,this.bufferLength=0,this.dataArray=null,this.amplification=3,this._lastDataArray=null,this._verticalScrollOffset=0}start(e,t,i){if(this.isRunning||!t||!this.analyser)return void console.warn("LiveWaveform.start() æ¢ä»¶ä¸æ»¿è¶³:",{isRunning:this.isRunning,hasAudioContext:!!t,hasAnalyser:!!this.analyser});console.log("âœ… LiveWaveform é–‹å§‹å•Ÿå‹•..."),this.isRunning=!0;const s=this;let n=Promise.resolve();"suspended"===t.state&&(n=t.resume().catch(function(e){console.warn("Unable to resume AudioContext:",e)})),n.then(function(){if(s.mediaStreamSource&&s.mediaStreamSource.disconnect(),s.mediaStreamSource=t.createMediaStreamSource(e),i)try{s.mediaStreamSource.connect(i)}catch(e){console.warn("connect preGainNode failed",e)}else s.mediaStreamSource.connect(s.analyser);s.analyser.fftSize=1024,s.bufferLength=s.analyser.fftSize,s.dataArray=new Uint8Array(s.bufferLength),console.log("âœ… LiveWaveform éŸ³è¨Šé€£æ¥å®Œæˆï¼Œé–‹å§‹ç¹ªè£½"),s.draw(!1)})}stop(){this.isRunning&&(this.isRunning=!1,this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.canvasContext.clearRect(0,0,this.width,this.height))}draw(e=!1){if(this.isRunning&&this.analyser&&this.dataArray)if(this.animationId=requestAnimationFrame(()=>this.draw(e)),this.analyser.getByteTimeDomainData(this.dataArray),e){const e=2;this._verticalScrollOffset+=e,this._verticalScrollOffset>=this.height&&(this._verticalScrollOffset=0,this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height)),this.canvasContext.lineWidth=1.5,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const t=this.height/this.bufferLength;let i=0;for(let e=0;e<this.bufferLength;e++){const s=(this.dataArray[e]/128-1)*this.amplification*this.width/2+this.width/2;0===e?this.canvasContext.moveTo(s,i):this.canvasContext.lineTo(s,i),i+=t}this.canvasContext.stroke()}else{this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=2,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const e=this.width/this.bufferLength;let t=0;for(let i=0;i<this.bufferLength;i++){const s=(this.dataArray[i]/128-1)*this.amplification*this.height/2+this.height/2;0===i?this.canvasContext.moveTo(t,s):this.canvasContext.lineTo(t,s),t+=e}this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke()}}}class a{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.analyser=t,this.bufferLength=2048,this.timeData=new Float32Array(this.bufferLength),this.levelDb=-90,this.peakDb=-90,this.holdPeakDb=-90,this.lastPeakTime=0,this.peakHoldMillis=1500,this.fallRateDbPerSec=20,this.minDb=-90,this.maxDb=0,this.animationId=null,this.lastClipTime=0,this.clipHoldMillis=2e3,this._lastLogTime=0}_computeLevels(){if(!this.analyser)return{rmsDb:this.minDb,peakDb:this.minDb};const e=this.analyser.fftSize||this.bufferLength;this.timeData.length!==e&&(this.bufferLength=e,this.timeData=new Float32Array(e)),this.analyser.getFloatTimeDomainData(this.timeData);let t=0,i=0,s=!1;for(let e=0;e<this.bufferLength;e++){let n=this.timeData[e];n>1?n=1:n<-1&&(n=-1),t+=n*n;const a=Math.abs(n);a>i&&(i=a),a>=.995&&(s=!0)}const n=Math.sqrt(t/this.bufferLength);let a=n>0?20*Math.log10(n):-1/0,o=i>0?20*Math.log10(i):-1/0;return a<this.minDb&&(a=this.minDb),a>this.maxDb&&(a=this.maxDb),o<this.minDb&&(o=this.minDb),o>this.maxDb&&(o=this.maxDb),s&&(this.lastClipTime=performance.now?performance.now():Date.now()),{rmsDb:a,peakDb:o}}resize(){this.clear()}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(e){const t=this.ctx,i=this.canvas.width,s=this.canvas.height;t.clearRect(0,0,i,s);const n=t.createLinearGradient(0,0,i,0);n.addColorStop(0,"#2d3748"),n.addColorStop(1,"#1a202c"),t.fillStyle=n,t.fillRect(0,0,i,s);let a=(e-this.minDb)/(this.maxDb-this.minDb);a<0&&(a=0),a>1&&(a=1);const o=t.createLinearGradient(0,0,i,0);o.addColorStop(0,"#38a169"),o.addColorStop(.6,"#d69e2e"),o.addColorStop(.85,"#dd6b20"),o.addColorStop(1,"#c53030"),t.fillStyle=o;const r=Math.round(i*a);t.fillRect(0,0,r,s),t.save(),t.strokeStyle="rgba(255,255,255,0.15)",t.lineWidth=1,t.beginPath();for(let e=this.minDb;e<=this.maxDb;e+=10){const n=(e-this.minDb)/(this.maxDb-this.minDb),a=Math.round(i*n)+.5;if(0===e?(t.strokeStyle="rgba(255,255,255,0.35)",t.beginPath(),t.moveTo(a,0),t.lineTo(a,s),t.stroke(),t.strokeStyle="rgba(255,255,255,0.15)"):(t.moveTo(a,0),t.lineTo(a,.4*s),t.moveTo(a,s),t.lineTo(a,.6*s)),e%20==0||-10===e){const i=e.toString();t.fillStyle=0===e?"#ffffff":-10===e?"#ffeb3b":"#cbd5e0",t.font="10px -apple-system,Segoe UI,sans-serif",t.textAlign="center",t.textBaseline="top",t.fillText(i,a,1)}}t.restore();const c=(-10-this.minDb)/(this.maxDb-this.minDb);if(c>0&&c<1){const e=Math.round(i*c);t.save(),t.fillStyle="rgba(255,235,59,0.08)",t.fillRect(e-2,0,4,s),t.restore()}let l=(this.holdPeakDb-this.minDb)/(this.maxDb-this.minDb);l<0&&(l=0),l>1&&(l=1);const h=Math.round(i*l);t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(h+.5,0),t.lineTo(h+.5,s),t.stroke(),t.fillStyle="#f0f0f0",t.font="bold 12px -apple-system,Segoe UI,sans-serif",t.textAlign="left",t.textBaseline="middle";const d=`RMS ${e<=this.minDb?"-âˆ":e.toFixed(1)} dBFS   Peak ${this.peakDb<=this.minDb?"-âˆ":this.peakDb.toFixed(1)} dBFS`;t.fillText(d,8,s/2);const u=performance.now?performance.now():Date.now();if(this.lastClipTime&&u-this.lastClipTime<this.clipHoldMillis){t.save(),t.fillStyle="#B00020";const e=42,s=18;t.fillRect(i-e-8,4,e,s),t.fillStyle="#fff",t.font="bold 12px -apple-system,Segoe UI,sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("CLIP",i-e/2-8,4+s/2+.5),t.restore()}}update(){const e=this._computeLevels();this.levelDb=e.rmsDb,this.peakDb=e.peakDb;const t=performance.now();if(this.peakDb>this.holdPeakDb+.5)this.holdPeakDb=this.peakDb,this.lastPeakTime=t;else{const e=t-this.lastPeakTime;if(e>this.peakHoldMillis){const t=(e-this.peakHoldMillis)/1e3,i=this.fallRateDbPerSec*t;this.holdPeakDb=Math.max(this.peakDb,this.holdPeakDb-i)}}this.draw(this.levelDb)}start(){if(this.stop(),this.analyser){const e=this.analyser.fftSize||2048;this.timeData.length!==e&&(this.bufferLength=e,this.timeData=new Float32Array(e))}const e=this;!function t(){e.update(),e.animationId=requestAnimationFrame(t)}()}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clear()}}class o{constructor(e,t={}){if(this.canvas=e,this.canvasContext=null,this.width=e.width,this.height=e.height,this.targetSampleRate=5e3,this.sourceSampleRate=48e3,this.decimationFactor=10,this.sampleMin=[],this.sampleMax=[],this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.playbackPosition=0,this.isPlaying=!1,this.playbackStartTime=0,this.playbackStartSample=0,this.rawZoomMode=!1,this.rawViewStart=0,this.rawVisibleRaw=0,this.overviewWaveform=null,this._useWorker=!1!==t.useWorker,this._worker=null,this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1,this.lastDetail=null,this.lastDensity=null,this._useWorker&&e.transferControlToOffscreen&&"undefined"!=typeof Worker)try{const i=e.transferControlToOffscreen();this._worker=new Worker(t.workerPath||"workers/wf-worker.js"),this._worker.postMessage({type:"init",canvas:i,width:this.width,height:this.height,verticalMode:!1,showClipMarks:!1!==t.showClipMarks,sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor},[i]);const s=this;this._worker.onmessage=function(e){const t=e.data;t&&"detailUpdate"===t.type&&(s.lastDetail=t.detail,s.lastDensity=t.density)}}catch(e){console.warn("OffscreenCanvas åˆå§‹åŒ–å¤±æ•—ï¼Œä½¿ç”¨ä¸»ç·šç¨‹ç¹ªè£½:",e),this._useWorker=!1}else this._useWorker=!1;if(!this._useWorker)try{this.canvasContext=e.getContext("2d")}catch(e){console.warn("ç„¡æ³•ç²å– canvas context:",e)}this._setupMouseInteraction(),this.clear()}_setupMouseInteraction(){if(!this.canvas)return;let e=!1,t=0,i=0;this.canvas.addEventListener("mousedown",s=>{e=!0,t=s.offsetX,i=this.viewStart,this.isAutoScroll=!1,this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("mousemove",s=>{if(!e)return;const n=s.offsetX-t,a=this.getVisibleSamples().visible/this.width,o=Math.round(-n*a);this.viewStart=i+o,this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}),this.canvas.addEventListener("mouseup",()=>{e&&(e=!1,this.canvas.style.cursor="grab")}),this.canvas.addEventListener("mouseleave",()=>{e&&(e=!1,this.canvas.style.cursor="default")}),this.canvas.addEventListener("wheel",e=>{e.preventDefault();const t=this.canvas.getBoundingClientRect(),i=(e.clientX-t.left)/this.width,s=e.deltaY>0?-1:1;this.zoomBySteps(s,i)}),this.canvas.addEventListener("click",t=>{if(e)return;const i=this.getVisibleSamples(),s=t.offsetX/this.width,n=Math.floor(i.start+s*i.visible),a=new CustomEvent("waveform-seek",{detail:{sample:n,time:n/this.sourceSampleRate}});this.canvas.dispatchEvent(a)}),this.canvas.style.cursor="grab"}clear(){this._useWorker&&this._worker?this._worker.postMessage({type:"reset"}):this.canvasContext&&(this.canvasContext.clearRect(0,0,this.width,this.height),this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=1,this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.beginPath(),this.canvasContext.moveTo(0,this.height/2),this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke())}reset(){this.sampleMin.length=0,this.sampleMax.length=0,this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.clear()}append(e){if(!e||!e.length)return;const t=this.decimationFactor,i=e.length,s=[],n=[];this._lastAppendLog||(this._lastAppendLog=0);const a=Date.now();a-this._lastAppendLog>1e3&&(console.log("ğŸ“ˆ AccumulatedWaveform.append():",i,"æ¨£æœ¬ â†’",Math.floor(i/t),"å€å¡Š"),this._lastAppendLog=a);for(let a=0;a<i;a+=t){let o=0,r=0;for(let s=0;s<t&&a+s<i;s++){o+=e[a+s],r++}if(!r)continue;const c=o/r;let l=1,h=-1;for(let t=0;t<r;t++){const i=e[a+t]-c;i<l&&(l=i),i>h&&(h=i)}l>h&&(l=h=0),this.sampleMin.push(l),this.sampleMax.push(h),s.push(l),n.push(h),this.sampleCount++}if(this.isAutoScroll?this.scrollToLatest():this._enforceViewBounds(),this._useWorker&&this._worker&&(this._appendBatchMin.push(...s),this._appendBatchMax.push(...n),!this._appendFlushScheduled)){this._appendFlushScheduled=!0;const e=this,t=()=>e._flushAppendBatch();"function"==typeof requestAnimationFrame?requestAnimationFrame(t):setTimeout(t,32)}this.draw()}_flushAppendBatch(){this._worker&&0!==this._appendBatchMin.length?(this._worker.postMessage({type:"append",minArr:this._appendBatchMin,maxArr:this._appendBatchMax}),this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1):this._appendFlushScheduled=!1}draw(){if(this._useWorker&&this._worker)return void this._worker.postMessage({type:"draw",zoomFactor:this.zoomFactor,viewStart:this.viewStart,playbackPosition:this.playbackPosition,isPlaying:this.isPlaying});if(!this.canvasContext)return;if(this.clear(),0===this.sampleCount)return;const e=this.getVisibleSamples(),{start:t,end:i,visible:s}=e;if(0===s||t>=i)return;const n=this.height/2;this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.lineWidth=1.5,this.canvasContext.lineJoin="round",this.canvasContext.lineCap="round",this.canvasContext.beginPath();let a=!1;for(let e=t;e<i;e++){const i=(e-t)/s*this.width,o=n-this.sampleMax[e]*n*.95;a?this.canvasContext.lineTo(i,o):(this.canvasContext.moveTo(i,o),a=!0)}this.canvasContext.stroke(),this.canvasContext.beginPath(),a=!1;for(let e=t;e<i;e++){const i=(e-t)/s*this.width,o=n-this.sampleMin[e]*n*.95;a?this.canvasContext.lineTo(i,o):(this.canvasContext.moveTo(i,o),a=!0)}this.canvasContext.stroke(),this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.lineWidth=1,this.canvasContext.beginPath(),this.canvasContext.moveTo(0,n+.5),this.canvasContext.lineTo(this.width,n+.5),this.canvasContext.stroke()}getVisibleSamples(){const e=this.sampleCount;if(0===e)return{start:0,end:0,visible:0};const t=this._getMinVisibleSamples(e);let i=Math.max(t,Math.round(e/this.zoomFactor));i>e&&(i=e);let s=this.viewStart;s+i>e&&(s=e-i),s<0&&(s=0);return{start:s,end:Math.min(e,s+i),visible:i}}_getMinVisibleSamples(e){return Math.max(10,Math.floor(this.width/10))}_enforceViewBounds(){if(0===this.sampleCount)return void(this.viewStart=0);const e=this.getVisibleSamples();this.viewStart=e.start,this.viewStart<0&&(this.viewStart=0);const t=Math.max(0,this.sampleCount-e.visible);this.viewStart>t&&(this.viewStart=t)}scrollToLatest(){const e=this.sampleCount;if(0===e)return;const t=this._getMinVisibleSamples(e);let i=Math.max(t,Math.round(e/this.zoomFactor));i>e&&(i=e),this.viewStart=e-i,this.viewStart<0&&(this.viewStart=0)}setZoom(e,t){if(0===this.sampleCount)return;e<1&&(e=1);const i=Math.max(1,this.sampleCount/this._getMinVisibleSamples(this.sampleCount));e>i&&(e=i);const s=this.getVisibleSamples();this.zoomFactor=e;const n=this.getVisibleSamples();if("number"==typeof t&&t>=0&&s.visible>0){const e=t-(t-s.start)/s.visible*n.visible;this.viewStart=Math.max(0,Math.min(this.sampleCount-n.visible,Math.floor(e)))}else{const e=s.start+s.visible/2-n.visible/2;this.viewStart=Math.max(0,Math.min(this.sampleCount-n.visible,Math.floor(e)))}this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}zoomBySteps(e,t=.5){if(0===e||0===this.sampleCount)return;const i=this.getVisibleSamples();let s;s=i.visible>0?i.start+t*i.visible:0;let n=this.zoomFactor;e>0?n*=Math.pow(1.5,e):n/=Math.pow(1.5,-e),this.setZoom(n,s)}panBySamples(e){0!==e&&(this.isAutoScroll=!1,this.viewStart+=e,this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw())}panByPixels(e){if(0===e)return;const t=e*(this.getVisibleSamples().visible/this.width)+this._panRemainder,i=Math.round(t);this._panRemainder=t-i,this.panBySamples(i)}resetView(){this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.scrollToLatest(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}setSourceSampleRate(e){this.sourceSampleRate=e||48e3,this.decimationFactor=Math.max(1,Math.round(this.sourceSampleRate/this.targetSampleRate)),this._worker&&this._worker.postMessage({type:"setSampleRate",sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor})}_getSamplePair(e){return e<0||e>=this.sampleCount?{min:0,max:0}:{min:this.sampleMin[e],max:this.sampleMax[e]}}setPlaybackPosition(e){this.playbackPosition=e,this.draw()}setRawZoomMode(e){this.rawZoomMode=!!e}startPlayback(e,t){this.isPlaying=!0,this.playbackStartSample=e||0,this.playbackStartTime=performance.now?performance.now():Date.now(),this.playbackPosition=this.playbackStartSample;const i=this,s=t||this.sourceSampleRate;requestAnimationFrame(function e(){if(!i.isPlaying)return;const t=((performance.now?performance.now():Date.now())-i.playbackStartTime)/1e3*s,n=i.playbackStartSample+Math.floor(t/i.decimationFactor);i.playbackPosition=n,i.draw(),requestAnimationFrame(e)})}stopPlayback(){this.isPlaying=!1,this.playbackPosition=0,this.draw()}_updatePlaybackPosition(){if(!this.isPlaying)return;const e=((performance.now?performance.now():Date.now())-this.playbackStartTime)/1e3*this.sourceSampleRate,t=this.playbackStartSample+Math.floor(e/this.decimationFactor);this.playbackPosition=t}}class r{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.accumulatedWaveform=t,this.width=e.width,this.height=e.height,this._useWorker=!1,this._workerRef=null,this._warnedNoData=!1,this._lastTotal=0,this._setupMouseInteraction()}_setupMouseInteraction(){if(!this.canvas)return;let e=!1,t=0,i=0;this.canvas.addEventListener("mousedown",s=>{const n=this.accumulatedWaveform;if(!n||0===n.sampleCount)return;e=!0,s.offsetX,n.viewStart;const a=n.sampleCount,o=n.getVisibleSamples();i=o.visible;const r=Math.floor(o.start/a*this.width),c=s.offsetX-r;t=c,this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("mousemove",s=>{if(!e)return;const n=this.accumulatedWaveform;if(!n||0===n.sampleCount)return;const a=n.sampleCount,o=s.offsetX-t,r=Math.floor(o/this.width*a),c=Math.max(0,a-i),l=Math.max(0,Math.min(c,r));n.viewStart=l,n.isAutoScroll=!1,n._enforceViewBounds(),n.draw(),this.draw()}),this.canvas.addEventListener("mouseup",()=>{e=!1,this.canvas.style.cursor="pointer"}),this.canvas.addEventListener("mouseleave",()=>{e&&(e=!1,this.canvas.style.cursor="pointer")}),this.canvas.style.cursor="pointer"}_handleSeek(e){const t=this.accumulatedWaveform;if(!t||0===t.sampleCount)return;const i=t.sampleCount,s=Math.max(0,Math.min(1,e/this.width)),n=Math.floor(s*i),a=t.zoomFactor,o=t._getMinVisibleSamples(i);let r=Math.max(o,Math.round(i/a));r>i&&(r=i);const c=Math.floor(r/2);let l=n-c;const h=Math.max(0,i-r);l=Math.max(0,Math.min(h,l)),console.log("ğŸ¯ OverviewWaveform å°èˆª:",{clickX:e,clickRatio:s.toFixed(3),targetSample:n,total:i,visibleSamples:r,halfVisible:c,newViewStart:l,maxViewStart:h,zoomFactor:a}),t.viewStart=l,t.isAutoScroll=!1,t._enforceViewBounds(),t.draw(),this.draw();const d=new CustomEvent("overview-seek",{detail:{sample:n,time:n/t.sourceSampleRate}});this.canvas.dispatchEvent(d)}clear(){this._useWorker&&this._workerRef?this._workerRef.postMessage({type:"clearOverview"}):(this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#f5f5f5",this.ctx.fillRect(0,0,this.width,this.height))}draw(){if(this._useWorker&&this._workerRef)return;this.clear();const e=this.accumulatedWaveform;if(!e||0===e.sampleCount)return void console.log("âš ï¸ OverviewWaveform: æ²’æœ‰æ•¸æ“šå¯é¡¯ç¤º",{hasAcc:!!e,sampleCount:e?e.sampleCount:0});const t=e.sampleCount,i=e.getVisibleSamples();console.log("ğŸ“Š OverviewWaveform ç¹ªè£½:",{total:t,visibleStart:i.start,visibleEnd:i.end,canvasWidth:this.width,canvasHeight:this.height}),this.ctx.strokeStyle="#64b5f6",this.ctx.lineWidth=1;const s=t/this.width;for(let i=0;i<this.width;i++){const n=Math.floor(i*s);if(n>=t)break;const a=e._getSamplePair(n),o=this.height/2,r=Math.floor(o-a.max*o*.9),c=Math.floor(o-a.min*o*.9);this.ctx.beginPath(),this.ctx.moveTo(i,r),this.ctx.lineTo(i,c),this.ctx.stroke()}this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.height/2),this.ctx.lineTo(this.width,this.height/2),this.ctx.stroke();const n=Math.floor(i.start/t*this.width),a=Math.floor(i.end/t*this.width),o=Math.max(2,a-n);this.ctx.fillStyle="rgba(33, 150, 243, 0.15)",this.ctx.fillRect(n,0,o,this.height),this.ctx.strokeStyle="#2196F3",this.ctx.lineWidth=2,this.ctx.strokeRect(n,0,o,this.height),console.log("âœ… OverviewWaveform ç¹ªè£½å®Œæˆ")}}class c{async save(e,t,i={}){throw new Error("save() must be implemented by subclass")}async load(e){throw new Error("load() must be implemented by subclass")}async delete(e){throw new Error("delete() must be implemented by subclass")}async list(){throw new Error("list() must be implemented by subclass")}async exists(e){try{return await this.load(e),!0}catch(e){return!1}}async clear(){const e=await this.list();let t=0;for(const i of e)try{await this.delete(i.id||i.filename),t++}catch(e){console.error("Failed to delete file:",i,e)}return t}}class l{constructor(e={}){this.options=this.mergeOptions(e),this.initialized=!1,this.storage=this.createStorageAdapter(this.options.storage),this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.options.container&&this.initializeUI()}mergeOptions(e){const t={container:null,layout:"auto",theme:"light",audio:{sampleRate:48e3,channels:1,agc:!1,gain:1},waveform:{showOverview:!0,showAccumulated:!0,showLive:!0,decimation:10,colors:{waveform:"#1E88E5",selection:"#4CAF50",playback:"#FF0000"}},storage:{type:"auto"},callbacks:{onRecordStart:()=>{},onRecordStop:()=>{},onRecordPause:()=>{},onRecordResume:()=>{},onPlayStart:()=>{},onPlayStop:()=>{},onError:e=>console.error("VoiceBankRecorder error:",e)}};return this.deepMerge(t,e)}deepMerge(e,t){const i={...e};for(const e in t)t[e]instanceof Object&&!Array.isArray(t[e])?i[e]=this.deepMerge(i[e]||{},t[e]):i[e]=t[e];return i}createStorageAdapter(e){const{StorageFactory:t}=require("./storage/index.js");return t.create({type:e.type||"auto",options:e})}initializeUI(){console.log("UI initialization - to be implemented")}async startRecording(){try{if(this.isRecording)throw new Error("Already recording");this.isRecording=!0,this.options.callbacks.onRecordStart(),console.log("Recording started")}catch(e){throw this.options.callbacks.onError(e),e}}async stopRecording(){try{if(!this.isRecording)throw new Error("Not recording");return this.isRecording=!1,this.currentBlob=null,this.options.callbacks.onRecordStop(this.currentBlob),console.log("Recording stopped"),this.currentBlob}catch(e){throw this.options.callbacks.onError(e),e}}async pauseRecording(){try{if(!this.isRecording||this.isPaused)throw new Error("Cannot pause");this.isPaused=!0,this.options.callbacks.onRecordPause(),console.log("Recording paused")}catch(e){throw this.options.callbacks.onError(e),e}}async resumeRecording(){try{if(!this.isRecording||!this.isPaused)throw new Error("Cannot resume");this.isPaused=!1,this.options.callbacks.onRecordResume(),console.log("Recording resumed")}catch(e){throw this.options.callbacks.onError(e),e}}async play(){try{this.options.callbacks.onPlayStart(),console.log("Playback started")}catch(e){throw this.options.callbacks.onError(e),e}}async stop(){try{this.options.callbacks.onPlayStop(),console.log("Playback stopped")}catch(e){throw this.options.callbacks.onError(e),e}}async saveRecording(e=null,t=null,i={}){try{const s=e||this.currentBlob;if(!s)throw new Error("No recording to save");const n=t||`recording-${Date.now()}.wav`,a=await this.storage.save(s,n,i);return console.log("Recording saved:",a),a}catch(e){throw this.options.callbacks.onError(e),e}}async loadRecording(e){try{const t=await this.storage.load(e);return this.currentBlob=t,console.log("Recording loaded:",e),t}catch(e){throw this.options.callbacks.onError(e),e}}async deleteRecording(e){try{const t=await this.storage.delete(e);return console.log("Recording deleted:",e),t}catch(e){throw this.options.callbacks.onError(e),e}}async listRecordings(){try{const e=await this.storage.list();return console.log("Recordings listed:",e.length),e}catch(e){throw this.options.callbacks.onError(e),e}}getCurrentBlob(){return this.currentBlob}destroy(){this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.storage&&"function"==typeof this.storage.close&&this.storage.close(),console.log("VoiceBankRecorder destroyed")}}const h="1.0.0",d={version:h,date:(new Date).toISOString(),name:"VoiceBank Recorder"};e.AudioEngine=i,e.BUILD_INFO=d,e.CapacitorAdapter=class extends c{constructor(e="recordings"){if(super(),this.directory=e,"undefined"==typeof window||!window.Capacitor)throw new Error("Capacitor not available. Make sure Capacitor is properly initialized.");this.Capacitor=window.Capacitor,this.initialized=!1}async initialize(){if(!this.initialized)try{const{Filesystem:e,Directory:t}=this.Capacitor.Plugins;try{await e.readdir({path:this.directory,directory:t.Documents})}catch(i){await e.mkdir({path:this.directory,directory:t.Documents,recursive:!0})}this.initialized=!0}catch(e){throw console.error("Capacitor initialization error:",e),e}}async save(e,t,i={}){await this.initialize();try{const{Filesystem:s,Directory:n}=this.Capacitor.Plugins,a=await this.blobToBase64(e);if(await s.writeFile({path:`${this.directory}/${t}`,data:a,directory:n.Documents}),i&&Object.keys(i).length>0){const a={...i,size:e.size,type:e.type,timestamp:Date.now()};await s.writeFile({path:`${this.directory}/${t}.meta.json`,data:JSON.stringify(a),directory:n.Documents,encoding:"utf8"})}return t}catch(e){throw console.error("Capacitor save error:",e),e}}async load(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins,s=await t.readFile({path:`${this.directory}/${e}`,directory:i.Documents});return this.base64ToBlob(s.data,"audio/wav")}catch(e){throw console.error("Capacitor load error:",e),e}}async delete(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins;await t.deleteFile({path:`${this.directory}/${e}`,directory:i.Documents});try{await t.deleteFile({path:`${this.directory}/${e}.meta.json`,directory:i.Documents})}catch(e){}return!0}catch(e){throw console.error("Capacitor delete error:",e),e}}async list(){await this.initialize();try{const{Filesystem:e,Directory:t}=this.Capacitor.Plugins,i=(await e.readdir({path:this.directory,directory:t.Documents})).files.filter(e=>!e.endsWith(".meta.json")),s=await Promise.all(i.map(async i=>{let s={};try{const n=await e.readFile({path:`${this.directory}/${i}.meta.json`,directory:t.Documents,encoding:"utf8"});s=JSON.parse(n.data)}catch(e){}return{id:i,filename:i,metadata:s,timestamp:s.timestamp||0,date:s.timestamp?new Date(s.timestamp):null,size:s.size||0,type:s.type||"audio/wav"}}));return s.sort((e,t)=>t.timestamp-e.timestamp),s}catch(e){return console.error("Capacitor list error:",e),[]}}async getUri(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins;return(await t.getUri({path:`${this.directory}/${e}`,directory:i.Documents})).uri}catch(e){throw console.error("Capacitor getUri error:",e),e}}blobToBase64(e){return new Promise((t,i)=>{const s=new FileReader;s.onloadend=()=>{const e=s.result.split(",")[1];t(e)},s.onerror=i,s.readAsDataURL(e)})}base64ToBlob(e,t="audio/wav"){const i=atob(e),s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]=i.charCodeAt(e);const n=new Uint8Array(s);return new Blob([n],{type:t})}async getStorageInfo(){const e=await this.list(),t=e.reduce((e,t)=>e+(t.size||0),0);return{count:e.length,totalSize:t,totalSizeMB:(t/1048576).toFixed(2),recordings:e}}},e.DeviceManager=t,e.ElectronAdapter=class extends c{constructor(e="recordings"){if(super(),this.savePath=e,"undefined"==typeof window||!window.electronAPI)throw new Error("Electron API not available. Make sure preload script is properly configured.");this.electronAPI=window.electronAPI}async save(e,t,i={}){try{const s=await e.arrayBuffer(),n=Array.from(new Uint8Array(s)),a=await this.electronAPI.saveRecording({filename:t,buffer:n,metadata:{...i,size:e.size,type:e.type,timestamp:Date.now()}});if(a.success)return a.id||a.path;throw new Error(a.error||"Save failed")}catch(e){throw console.error("Electron save error:",e),e}}async load(e){try{const t=await this.electronAPI.loadRecording(e),i=new Uint8Array(t);return new Blob([i],{type:"audio/wav"})}catch(e){throw console.error("Electron load error:",e),e}}async delete(e){try{return(await this.electronAPI.deleteRecording(e)).success}catch(e){throw console.error("Electron delete error:",e),e}}async list(e=null){try{return await this.electronAPI.listRecordings(e)||[]}catch(e){return console.error("Electron list error:",e),[]}}async openFile(){try{if(this.electronAPI.openFile)return await this.electronAPI.openFile();throw new Error("openFile API not available")}catch(e){return console.error("Electron openFile error:",e),null}}async saveAs(e,t="recording.wav"){try{const i=await e.arrayBuffer(),s=Array.from(new Uint8Array(i));if(this.electronAPI.saveAs){const e=await this.electronAPI.saveAs({filename:t,buffer:s});return e.success?e.path:null}return await this.save(e,t)}catch(e){return console.error("Electron saveAs error:",e),null}}async showInFolder(e){try{return!!this.electronAPI.showInFolder&&(await this.electronAPI.showInFolder(e),!0)}catch(e){return console.error("Electron showInFolder error:",e),!1}}},e.IndexedDBAdapter=class extends c{constructor(e="VoiceBankDB",t="recordings",i=1){super(),this.dbName=e,this.storeName=t,this.version=i,this.db=null}async initialize(){return this.db?this.db:new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.version);i.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${i.error}`))},i.onsuccess=()=>{this.db=i.result,e(this.db)},i.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});e.createIndex("filename","filename",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("duration","duration",{unique:!1})}}})}async save(e,t,i={}){return await this.initialize(),new Promise((s,n)=>{const a=this.db.transaction([this.storeName],"readwrite"),o=a.objectStore(this.storeName),r={filename:t,blob:e,size:e.size,type:e.type,timestamp:Date.now(),metadata:i},c=o.add(r);c.onsuccess=()=>{s(String(c.result))},c.onerror=()=>{n(new Error(`Failed to save recording: ${c.error}`))},a.onerror=()=>{n(new Error(`Transaction failed: ${a.error}`))}})}async load(e){return await this.initialize(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(Number(e));s.onsuccess=()=>{const n=s.result;n&&n.blob?t(n.blob):i(new Error(`Recording not found: ${e}`))},s.onerror=()=>{i(new Error(`Failed to load recording: ${s.error}`))}})}async delete(e){return await this.initialize(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(Number(e));s.onsuccess=()=>{t(!0)},s.onerror=()=>{i(new Error(`Failed to delete recording: ${s.error}`))}})}async list(){return await this.initialize(),new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onsuccess=()=>{const t=i.result.map(e=>({id:String(e.id),filename:e.filename,size:e.size,type:e.type,timestamp:e.timestamp,date:new Date(e.timestamp),metadata:e.metadata||{}}));e(t)},i.onerror=()=>{t(new Error(`Failed to list recordings: ${i.error}`))}})}async searchByFilename(e){return(await this.list()).filter(t=>t.filename.toLowerCase().includes(e.toLowerCase()))}async getStorageInfo(){const e=await this.list(),t=e.reduce((e,t)=>e+t.size,0);return{count:e.length,totalSize:t,totalSizeMB:(t/1048576).toFixed(2),records:e}}async clear(){return await this.initialize(),new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),s=i.count();s.onsuccess=()=>{const n=s.result,a=i.clear();a.onsuccess=()=>{e(n)},a.onerror=()=>{t(new Error(`Failed to clear recordings: ${a.error}`))}},s.onerror=()=>{t(new Error(`Failed to count recordings: ${s.error}`))}})}async getStorageEstimate(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{usage:e.usage,quota:e.quota,usageMB:(e.usage/1048576).toFixed(2),quotaMB:(e.quota/1048576).toFixed(2),usagePercent:(e.usage/e.quota*100).toFixed(2)}}catch(e){return console.warn("Failed to get storage estimate:",e),null}return null}close(){this.db&&(this.db.close(),this.db=null)}},e.PlatformDetector=class{static detect(){return"undefined"!=typeof window&&window.electronAPI||"undefined"!=typeof process&&process.versions&&process.versions.electron?"electron":"undefined"!=typeof window&&window.Capacitor?"capacitor":"browser"}static isElectron(){return"electron"===this.detect()}static isCapacitor(){return"capacitor"===this.detect()}static isBrowser(){return"browser"===this.detect()}static isMobile(){return!("undefined"==typeof window||!window.navigator)&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)}static supportsAudioWorklet(){if("undefined"==typeof window||!window.AudioContext)return!1;return"audioWorklet"in(window.AudioContext||window.webkitAudioContext).prototype}static supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}static getInfo(){return{platform:this.detect(),isElectron:this.isElectron(),isCapacitor:this.isCapacitor(),isBrowser:this.isBrowser(),isMobile:this.isMobile(),supportsAudioWorklet:this.supportsAudioWorklet(),supportsOffscreenCanvas:this.supportsOffscreenCanvas(),userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown"}}},e.ServerAdapter=class extends c{constructor(e={}){super(),this.baseURL=e.baseURL||"",this.saveEndpoint=e.saveEndpoint||"/backend/save.php",this.loadEndpoint=e.loadEndpoint||"/public/uploads/",this.deleteEndpoint=e.deleteEndpoint||"/backend/delete.php",this.listEndpoint=e.listEndpoint||"/api/recordings",this.headers=e.headers||{}}async save(e,t,i={}){const s=new FormData;s.append("audio-blob",e),s.append("audio-filename",t),i&&Object.keys(i).length>0&&s.append("metadata",JSON.stringify(i));try{const e=await fetch(this.baseURL+this.saveEndpoint,{method:"POST",body:s,headers:this.headers});if(!e.ok)throw new Error(`Upload failed: ${e.status} ${e.statusText}`);const i=await e.text();if(i.toLowerCase().includes("success"))return t;throw new Error(`Server error: ${i}`)}catch(e){throw console.error("Save error:",e),e}}async load(e){try{const t=this.baseURL+this.loadEndpoint+e,i=await fetch(t,{headers:this.headers});if(!i.ok)throw new Error(`Load failed: ${i.status} ${i.statusText}`);return await i.blob()}catch(e){throw console.error("Load error:",e),e}}async delete(e){try{const t=await fetch(this.baseURL+this.deleteEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.headers},body:JSON.stringify({filename:e})});if(!t.ok)throw new Error(`Delete failed: ${t.status} ${t.statusText}`);return(await t.text()).toLowerCase().includes("success")}catch(e){throw console.error("Delete error:",e),e}}async list(){try{const e=await fetch(this.baseURL+this.listEndpoint,{headers:this.headers});if(!e.ok)throw new Error(`List failed: ${e.status} ${e.statusText}`);const t=await e.json();return Array.isArray(t)?t:[]}catch(e){return console.error("List error:",e),[]}}async saveWithProgress(e,t,i={},s=null){return new Promise((n,a)=>{const o=new FormData;o.append("audio-blob",e),o.append("audio-filename",t),i&&Object.keys(i).length>0&&o.append("metadata",JSON.stringify(i));const r=new XMLHttpRequest;s&&r.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;s(t)}}),r.addEventListener("load",()=>{if(r.status>=200&&r.status<300){const e=r.responseText;e.toLowerCase().includes("success")?n(t):a(new Error(`Server error: ${e}`))}else a(new Error(`Upload failed: ${r.status} ${r.statusText}`))}),r.addEventListener("error",()=>{a(new Error("Network error during upload"))}),r.addEventListener("abort",()=>{a(new Error("Upload cancelled"))}),r.open("POST",this.baseURL+this.saveEndpoint),Object.keys(this.headers).forEach(e=>{r.setRequestHeader(e,this.headers[e])}),r.send(o)})}},e.StorageAdapter=c,e.StorageFactory=class{static create(e={}){const t=e.type||"auto",i=e.options||{};if("auto"===t)return this.createAuto(i);switch(t.toLowerCase()){case"browser":case"indexeddb":const{IndexedDBAdapter:e}=require("./IndexedDBAdapter.js");return new e(i.dbName,i.storeName,i.version);case"electron":const{ElectronAdapter:s}=require("./ElectronAdapter.js");return new s(i.savePath);case"capacitor":const{CapacitorAdapter:n}=require("./CapacitorAdapter.js");return new n(i.directory);case"server":case"php":case"nodejs":const{ServerAdapter:a}=require("./ServerAdapter.js");return new a(i);default:throw new Error(`Unknown storage type: ${t}`)}}static createAuto(e={}){if("undefined"!=typeof window&&window.electronAPI){const{ElectronAdapter:t}=require("./ElectronAdapter.js");return new t(e.savePath)}if("undefined"!=typeof window&&window.Capacitor){const{CapacitorAdapter:t}=require("./CapacitorAdapter.js");return new t(e.directory)}const{IndexedDBAdapter:t}=require("./IndexedDBAdapter.js");return new t(e.dbName,e.storeName,e.version)}},e.VERSION=h,e.VoiceBankRecorder=l,e.VoiceBankRecorderUI=class{constructor(e={}){if(this.options={showAdvancedOptions:!0,showStatusLog:!0,theme:{primaryColor:"#667eea",secondaryColor:"#764ba2",successColor:"#10b981",errorColor:"#ef4444",warningColor:"#f59e0b"},...e},"string"==typeof e.container?this.container=document.querySelector(e.container):this.container=e.container,!this.container)throw new Error("Container element not found");this.audioEngine=null,this.waveformRenderer=null,this.deviceManager=null,this.elements={},this.audioPlayer=null,this.recordedBlob=null,this.recordedUrl=null,this.isInitialized=!1}async initialize(){this.isInitialized?console.warn("VoiceBankRecorderUI already initialized"):(this._generateHTML(),this._injectStyles(),this._cacheElements(),await this._initializeAudioEngine(),await this._initializeWaveformRenderer(),this._bindEvents(),await this._initializeDevices(),this.isInitialized=!0,this._log("âœ“ VoiceBank Recorder UI åˆå§‹åŒ–å®Œæˆ","success"))}_generateHTML(){this.container.innerHTML=`\n            <div class="voicebank-recorder-ui">\n                \x3c!-- éŒ„éŸ³æ§åˆ¶æŒ‰éˆ• --\x3e\n                <div class="vbr-controls">\n                    <button class="vbr-btn vbr-btn-record" data-action="record">\n                        <span class="vbr-icon">ğŸ™ï¸</span>\n                        <span class="vbr-text">é–‹å§‹éŒ„éŸ³</span>\n                    </button>\n                    <button class="vbr-btn vbr-btn-stop" data-action="stop" disabled>\n                        <span class="vbr-icon">â¹ï¸</span>\n                        <span class="vbr-text">åœæ­¢éŒ„éŸ³</span>\n                    </button>\n                </div>\n                \n                \x3c!-- æ³¢å½¢é¡¯ç¤ºå€ --\x3e\n                <div class="vbr-waveforms">\n                    \x3c!-- å³æ™‚æ³¢å½¢ --\x3e\n                    <div class="vbr-waveform-section">\n                        <h3 class="vbr-section-title">å³æ™‚æ³¢å½¢</h3>\n                        <canvas class="vbr-canvas" data-canvas="live" width="800" height="120"></canvas>\n                    </div>\n                    \n                    \x3c!-- VU Meter --\x3e\n                    <div class="vbr-waveform-section">\n                        <h3 class="vbr-section-title">éŸ³é‡è¡¨ (VU Meter)</h3>\n                        <canvas class="vbr-canvas" data-canvas="vu" width="800" height="50"></canvas>\n                    </div>\n                    \n                    \x3c!-- ç´¯ç©æ³¢å½¢ --\x3e\n                    <div class="vbr-waveform-section">\n                        <h3 class="vbr-section-title">ç´¯ç©æ³¢å½¢ï¼ˆå¯æ‹–æ›³å¹³ç§»ã€æ»¾è¼ªç¸®æ”¾ã€é»æ“Šå®šä½ï¼‰</h3>\n                        <canvas class="vbr-canvas" data-canvas="accumulated" width="800" height="200"></canvas>\n                        <div class="vbr-toolbar">\n                            <button class="vbr-toolbar-btn" data-action="zoom-in" disabled>\n                                <span>ğŸ”+</span>\n                            </button>\n                            <button class="vbr-toolbar-btn" data-action="zoom-out" disabled>\n                                <span>ğŸ”-</span>\n                            </button>\n                            <button class="vbr-toolbar-btn" data-action="zoom-reset" disabled>\n                                <span>ğŸ”„ é‡ç½®è¦–åœ–</span>\n                            </button>\n                            <button class="vbr-toolbar-btn" data-action="pan-left" disabled>\n                                <span>â—€ å‘å·¦</span>\n                            </button>\n                            <button class="vbr-toolbar-btn" data-action="pan-right" disabled>\n                                <span>å‘å³ â–¶</span>\n                            </button>\n                            <label class="vbr-checkbox-label">\n                                <input type="checkbox" data-check="auto-scroll" checked>\n                                <span>è‡ªå‹•æ²å‹•</span>\n                            </label>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- æ¦‚è¦½æ³¢å½¢ --\x3e\n                    <div class="vbr-waveform-section">\n                        <h3 class="vbr-section-title">æ¦‚è¦½æ³¢å½¢ï¼ˆé»æ“Šæˆ–æ‹–æ›³å¯å¿«é€Ÿå°èˆªï¼‰</h3>\n                        <canvas class="vbr-canvas" data-canvas="overview" width="800" height="80"></canvas>\n                    </div>\n                </div>\n                \n                \x3c!-- è¨­å®šå€ --\x3e\n                <div class="vbr-settings">\n                    \x3c!-- è£ç½®è¨­å®š --\x3e\n                    <div class="vbr-settings-section">\n                        <h3 class="vbr-settings-title">è£ç½®è¨­å®š</h3>\n                        <div class="vbr-device-row">\n                            <label class="vbr-label">éº¥å…‹é¢¨ï¼š</label>\n                            <div class="vbr-device-select-group">\n                                <select class="vbr-select" data-select="microphone" disabled>\n                                    <option>è¼‰å…¥ä¸­...</option>\n                                </select>\n                                <button class="vbr-refresh-btn" data-action="refresh-mic" title="é‡æ–°æ•´ç†éº¥å…‹é¢¨æ¸…å–®">ğŸ”„</button>\n                            </div>\n                            <small class="vbr-hint" data-hint="microphone">é¸æ“‡è¦ä½¿ç”¨çš„éº¥å…‹é¢¨è£ç½®</small>\n                        </div>\n                        <div class="vbr-device-row">\n                            <label class="vbr-label">è¼¸å‡ºè£ç½®ï¼š</label>\n                            <div class="vbr-device-select-group">\n                                <select class="vbr-select" data-select="output" disabled>\n                                    <option value="default">ç³»çµ±é è¨­è¼¸å‡º</option>\n                                </select>\n                                <button class="vbr-refresh-btn" data-action="refresh-output" title="é‡æ–°æ•´ç†è¼¸å‡ºè£ç½®æ¸…å–®">ğŸ”„</button>\n                            </div>\n                            <small class="vbr-hint" data-hint="output">éƒ¨åˆ†ç€è¦½å™¨éœ€ HTTPS æ‰å¯åˆ‡æ›è¼¸å‡ºè£ç½®</small>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- é€²éšé¸é … --\x3e\n                    ${this.options.showAdvancedOptions?'\n                    <div class="vbr-settings-section">\n                        <h3 class="vbr-settings-title">é€²éšé¸é …</h3>\n                        <div class="vbr-slider-row">\n                            <label class="vbr-label">éº¥å…‹é¢¨å¢ç›Šï¼š</label>\n                            <input type="range" class="vbr-slider" data-slider="gain" min="1" max="6" step="0.1" value="1.0">\n                            <span class="vbr-slider-value" data-value="gain">1.0x</span>\n                        </div>\n                        <div class="vbr-checkbox-row">\n                            <label class="vbr-checkbox-label">\n                                <input type="checkbox" data-check="agc">\n                                <span>è‡ªå‹•å¢ç›Šæ§åˆ¶ (AGC)</span>\n                            </label>\n                            <label class="vbr-checkbox-label">\n                                <input type="checkbox" data-check="echo-cancel">\n                                <span>å›éŸ³æ¶ˆé™¤</span>\n                            </label>\n                            <label class="vbr-checkbox-label">\n                                <input type="checkbox" data-check="noise-suppress">\n                                <span>èƒŒæ™¯é™å™ª</span>\n                            </label>\n                        </div>\n                    </div>\n                    ':""}\n                    \n                    \x3c!-- éŒ„éŸ³è³‡è¨Š --\x3e\n                    <div class="vbr-info-section" data-section="recording-info" style="display: none;">\n                        <h3 class="vbr-settings-title">éŒ„éŸ³è³‡è¨Š</h3>\n                        <div class="vbr-info-grid">\n                            <div>æ™‚é•·ï¼š<span data-info="duration">00:00.000</span></div>\n                            <div>æ¨£æœ¬æ•¸ï¼š<span data-info="samples">0</span></div>\n                            <div>æ¡æ¨£ç‡ï¼š<span data-info="samplerate">48000</span> Hz</div>\n                            <div>æª”æ¡ˆå¤§å°ï¼š<span data-info="filesize">0</span> KB</div>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- æ’­æ”¾æ§åˆ¶ --\x3e\n                <div class="vbr-playback">\n                    <button class="vbr-btn vbr-btn-play" data-action="play" disabled>\n                        <span class="vbr-icon">â–¶</span>\n                        <span class="vbr-text">æ’­æ”¾</span>\n                    </button>\n                    <button class="vbr-btn vbr-btn-pause" data-action="pause" disabled>\n                        <span class="vbr-icon">â¸</span>\n                        <span class="vbr-text">æš«åœ</span>\n                    </button>\n                    <button class="vbr-btn vbr-btn-download" data-action="download" disabled>\n                        <span class="vbr-icon">ğŸ’¾</span>\n                        <span class="vbr-text">ä¸‹è¼‰éŒ„éŸ³</span>\n                    </button>\n                </div>\n                \n                \x3c!-- ç‹€æ…‹æ—¥èªŒ --\x3e\n                ${this.options.showStatusLog?`\n                <div class="vbr-status-log" data-log="status">\n                    <div class="vbr-log-entry">\n                        <span class="vbr-log-time">[${this._getTimeString()}]</span>\n                        <span class="vbr-log-text">æº–å‚™å°±ç·’</span>\n                    </div>\n                </div>\n                `:""}\n            </div>\n        `}_injectStyles(){const e="voicebank-recorder-ui-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent=this._getStyles(),document.head.appendChild(t)}_getStyles(){const e=this.options.theme;return`\n            .voicebank-recorder-ui {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n                line-height: 1.6;\n                color: #333;\n                max-width: 900px;\n                margin: 0 auto;\n            }\n            \n            /* éŒ„éŸ³æ§åˆ¶æŒ‰éˆ• */\n            .vbr-controls {\n                display: flex;\n                gap: 15px;\n                justify-content: center;\n                margin-bottom: 30px;\n                padding: 20px;\n                background: #f9fafb;\n                border-radius: 10px;\n            }\n            \n            .vbr-btn {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 16px;\n                padding: 12px 30px;\n                border: none;\n                border-radius: 8px;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                font-weight: 600;\n                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n            }\n            \n            .vbr-btn:disabled {\n                opacity: 0.5;\n                cursor: not-allowed;\n            }\n            \n            .vbr-btn-record {\n                background: ${e.errorColor};\n                color: white;\n            }\n            \n            .vbr-btn-record:hover:not(:disabled) {\n                background: #dc2626;\n                transform: translateY(-2px);\n                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);\n            }\n            \n            .vbr-btn-stop {\n                background: #9ca3af;\n                color: white;\n            }\n            \n            .vbr-btn-stop:hover:not(:disabled) {\n                background: #6b7280;\n                transform: translateY(-2px);\n                box-shadow: 0 4px 12px rgba(156, 163, 175, 0.3);\n            }\n            \n            .vbr-btn-play {\n                background: ${e.primaryColor};\n                color: white;\n            }\n            \n            .vbr-btn-play:hover:not(:disabled) {\n                background: #5568d3;\n                transform: translateY(-2px);\n            }\n            \n            .vbr-btn-pause {\n                background: ${e.warningColor};\n                color: white;\n            }\n            \n            .vbr-btn-pause:hover:not(:disabled) {\n                background: #d97706;\n                transform: translateY(-2px);\n            }\n            \n            .vbr-btn-download {\n                background: ${e.primaryColor};\n                color: white;\n            }\n            \n            .vbr-btn-download:hover:not(:disabled) {\n                background: #5568d3;\n                transform: translateY(-2px);\n            }\n            \n            /* æ³¢å½¢å€åŸŸ */\n            .vbr-waveforms {\n                margin-bottom: 30px;\n            }\n            \n            .vbr-waveform-section {\n                margin-bottom: 20px;\n            }\n            \n            .vbr-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                color: #555;\n                margin-bottom: 8px;\n            }\n            \n            .vbr-canvas {\n                display: block;\n                width: 100%;\n                border: 2px solid #e5e7eb;\n                border-radius: 8px;\n                background: #f9fafb;\n            }\n            \n            .vbr-toolbar {\n                display: flex;\n                gap: 10px;\n                margin-top: 10px;\n                flex-wrap: wrap;\n                align-items: center;\n            }\n            \n            .vbr-toolbar-btn {\n                padding: 8px 16px;\n                border: 1px solid #d0d0d0;\n                border-radius: 6px;\n                background: white;\n                cursor: pointer;\n                font-size: 13px;\n                font-weight: 500;\n                color: #555;\n                transition: all 0.2s ease;\n            }\n            \n            .vbr-toolbar-btn:hover:not(:disabled) {\n                border-color: ${e.primaryColor};\n                color: ${e.primaryColor};\n                background: #f0f4ff;\n            }\n            \n            .vbr-toolbar-btn:disabled {\n                opacity: 0.4;\n                cursor: not-allowed;\n            }\n            \n            .vbr-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                font-size: 13px;\n                color: #555;\n                cursor: pointer;\n            }\n            \n            /* è¨­å®šå€åŸŸ */\n            .vbr-settings {\n                margin-bottom: 30px;\n            }\n            \n            .vbr-settings-section {\n                background: #f9fafb;\n                padding: 20px;\n                border-radius: 10px;\n                margin-bottom: 20px;\n            }\n            \n            .vbr-settings-title {\n                font-size: 16px;\n                font-weight: 600;\n                color: ${e.primaryColor};\n                margin-bottom: 15px;\n            }\n            \n            .vbr-device-row {\n                margin-bottom: 15px;\n            }\n            \n            .vbr-label {\n                display: block;\n                font-size: 14px;\n                font-weight: 500;\n                color: #555;\n                margin-bottom: 5px;\n            }\n            \n            .vbr-device-select-group {\n                display: flex;\n                gap: 10px;\n            }\n            \n            .vbr-select {\n                flex: 1;\n                padding: 8px;\n                border: 1px solid #d0d0d0;\n                border-radius: 6px;\n                font-size: 14px;\n            }\n            \n            .vbr-refresh-btn {\n                padding: 8px 12px;\n                background: ${e.primaryColor};\n                color: white;\n                border: none;\n                border-radius: 6px;\n                cursor: pointer;\n                font-size: 13px;\n            }\n            \n            .vbr-hint {\n                display: block;\n                color: #666;\n                font-size: 12px;\n                margin-top: 5px;\n            }\n            \n            .vbr-slider-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n            \n            .vbr-slider {\n                flex: 1;\n            }\n            \n            .vbr-slider-value {\n                min-width: 50px;\n                font-weight: 600;\n            }\n            \n            .vbr-checkbox-row {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 15px;\n            }\n            \n            .vbr-info-section {\n                background: #f0f4ff;\n                padding: 20px;\n                border-radius: 10px;\n                border-left: 4px solid ${e.primaryColor};\n            }\n            \n            .vbr-info-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                gap: 10px;\n                font-size: 14px;\n            }\n            \n            .vbr-info-grid span {\n                font-weight: 600;\n                color: ${e.primaryColor};\n            }\n            \n            /* æ’­æ”¾æ§åˆ¶ */\n            .vbr-playback {\n                display: flex;\n                gap: 15px;\n                justify-content: center;\n                margin-bottom: 30px;\n            }\n            \n            /* ç‹€æ…‹æ—¥èªŒ */\n            .vbr-status-log {\n                background: #1f2937;\n                color: ${e.successColor};\n                padding: 20px;\n                border-radius: 10px;\n                font-family: 'Courier New', monospace;\n                font-size: 13px;\n                line-height: 1.8;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n            \n            .vbr-log-entry {\n                margin-bottom: 5px;\n            }\n            \n            .vbr-log-time {\n                color: #6b7280;\n                margin-right: 10px;\n            }\n            \n            .vbr-log-error {\n                color: ${e.errorColor};\n            }\n            \n            .vbr-log-warning {\n                color: ${e.warningColor};\n            }\n            \n            .vbr-log-success {\n                color: ${e.successColor};\n            }\n        `}_cacheElements(){const e=this.container.querySelector(".voicebank-recorder-ui");this.elements.recordBtn=e.querySelector('[data-action="record"]'),this.elements.stopBtn=e.querySelector('[data-action="stop"]'),this.elements.playBtn=e.querySelector('[data-action="play"]'),this.elements.pauseBtn=e.querySelector('[data-action="pause"]'),this.elements.downloadBtn=e.querySelector('[data-action="download"]'),this.elements.zoomInBtn=e.querySelector('[data-action="zoom-in"]'),this.elements.zoomOutBtn=e.querySelector('[data-action="zoom-out"]'),this.elements.zoomResetBtn=e.querySelector('[data-action="zoom-reset"]'),this.elements.panLeftBtn=e.querySelector('[data-action="pan-left"]'),this.elements.panRightBtn=e.querySelector('[data-action="pan-right"]'),this.elements.autoScrollCheck=e.querySelector('[data-check="auto-scroll"]'),this.elements.liveCanvas=e.querySelector('[data-canvas="live"]'),this.elements.vuCanvas=e.querySelector('[data-canvas="vu"]'),this.elements.accumulatedCanvas=e.querySelector('[data-canvas="accumulated"]'),this.elements.overviewCanvas=e.querySelector('[data-canvas="overview"]'),this.elements.micSelect=e.querySelector('[data-select="microphone"]'),this.elements.outputSelect=e.querySelector('[data-select="output"]'),this.elements.refreshMicBtn=e.querySelector('[data-action="refresh-mic"]'),this.elements.refreshOutputBtn=e.querySelector('[data-action="refresh-output"]'),this.options.showAdvancedOptions&&(this.elements.gainSlider=e.querySelector('[data-slider="gain"]'),this.elements.gainValue=e.querySelector('[data-value="gain"]'),this.elements.agcCheck=e.querySelector('[data-check="agc"]'),this.elements.echoCancelCheck=e.querySelector('[data-check="echo-cancel"]'),this.elements.noiseSuppressCheck=e.querySelector('[data-check="noise-suppress"]')),this.elements.recordingInfo=e.querySelector('[data-section="recording-info"]'),this.elements.durationInfo=e.querySelector('[data-info="duration"]'),this.elements.samplesInfo=e.querySelector('[data-info="samples"]'),this.elements.samplerateInfo=e.querySelector('[data-info="samplerate"]'),this.elements.filesizeInfo=e.querySelector('[data-info="filesize"]'),this.options.showStatusLog&&(this.elements.statusLog=e.querySelector('[data-log="status"]'))}async _initializeAudioEngine(){const e={sampleRate:48e3,echoCancellation:!1,noiseSuppression:!1,autoGainControl:!1,autoManageDevices:!0,...this.options.audioConfig};this.audioEngine=new i(e),await this.audioEngine.initialize(),this.deviceManager=this.audioEngine.deviceManager,this._log("éŸ³è¨Šå¼•æ“åˆå§‹åŒ–å®Œæˆ","info")}async _initializeWaveformRenderer(){const e={liveCanvas:this.elements.liveCanvas,vuMeterCanvas:this.elements.vuCanvas,accumulatedCanvas:this.elements.accumulatedCanvas,overviewCanvas:this.elements.overviewCanvas,audioEngine:this.audioEngine,useWorker:!1,showClipMarks:!0,...this.options.waveformConfig};this.waveformRenderer=new s(e),await this.waveformRenderer.initialize(),this._log("æ³¢å½¢æ¸²æŸ“å™¨åˆå§‹åŒ–å®Œæˆ","info")}_bindEvents(){this.elements.recordBtn.addEventListener("click",()=>this._handleRecord()),this.elements.stopBtn.addEventListener("click",()=>this._handleStop()),this.elements.playBtn.addEventListener("click",()=>this._handlePlay()),this.elements.pauseBtn.addEventListener("click",()=>this._handlePause()),this.elements.downloadBtn.addEventListener("click",()=>this._handleDownload()),this.elements.zoomInBtn.addEventListener("click",()=>this._handleZoomIn()),this.elements.zoomOutBtn.addEventListener("click",()=>this._handleZoomOut()),this.elements.zoomResetBtn.addEventListener("click",()=>this._handleZoomReset()),this.elements.panLeftBtn.addEventListener("click",()=>this._handlePanLeft()),this.elements.panRightBtn.addEventListener("click",()=>this._handlePanRight()),this.elements.autoScrollCheck.addEventListener("change",e=>this._handleAutoScrollChange(e)),this.elements.micSelect.addEventListener("change",e=>this._handleMicChange(e)),this.elements.outputSelect.addEventListener("change",e=>this._handleOutputChange(e)),this.elements.refreshMicBtn.addEventListener("click",()=>this._refreshMicrophones()),this.elements.refreshOutputBtn.addEventListener("click",()=>this._refreshOutputDevices()),this.options.showAdvancedOptions&&(this.elements.gainSlider.addEventListener("input",e=>this._handleGainChange(e)),this.elements.agcCheck.addEventListener("change",e=>this._handleAGCChange(e)),this.elements.echoCancelCheck.addEventListener("change",e=>this._handleEchoCancelChange(e)),this.elements.noiseSuppressCheck.addEventListener("change",e=>this._handleNoiseSuppressChange(e)))}async _initializeDevices(){this.deviceManager?(await this._refreshMicrophones(),await this._refreshOutputDevices()):this._log("âŒ DeviceManager å°šæœªåˆå§‹åŒ–","error")}async _refreshMicrophones(){if(!this.deviceManager)return this._log("âŒ DeviceManager å°šæœªåˆå§‹åŒ–","error"),this.elements.micSelect.innerHTML="<option>åˆå§‹åŒ–å¤±æ•—</option>",void(this.elements.micSelect.disabled=!0);try{this._log("ğŸ” æ­£åœ¨åˆ—èˆ‰éº¥å…‹é¢¨è£ç½®...","info");const e=await this.deviceManager.enumerateMicrophones();if(this.elements.micSelect.innerHTML="",0===e.length)return this.elements.micSelect.innerHTML="<option>æœªåµæ¸¬åˆ°éº¥å…‹é¢¨</option>",this.elements.micSelect.disabled=!0,void this._log("âš ï¸ æœªåµæ¸¬åˆ°éº¥å…‹é¢¨è£ç½®","warning");e.forEach((e,t)=>{const i=document.createElement("option");i.value=e.deviceId,i.textContent=e.label||`éº¥å…‹é¢¨ ${t+1}`,this.elements.micSelect.appendChild(i)});const t=this.deviceManager.getSelectedMicrophoneId();t&&this.deviceManager.isDeviceAvailable(t,"microphone")?this.elements.micSelect.value=t:e.length>0&&(this.deviceManager.selectMicrophone(e[0].deviceId,!0),this.elements.micSelect.value=e[0].deviceId),this.elements.micSelect.disabled=!1,this._log(`âœ… æ‰¾åˆ° ${e.length} å€‹éº¥å…‹é¢¨è£ç½®`,"success")}catch(e){this._log(`âŒ åˆ—èˆ‰éº¥å…‹é¢¨å¤±æ•—: ${e.message}`,"error"),console.error("åˆ—èˆ‰éº¥å…‹é¢¨è©³ç´°éŒ¯èª¤:",e),this.elements.micSelect.innerHTML="<option>éœ€è¦éº¥å…‹é¢¨æ¬Šé™</option>",this.elements.micSelect.disabled=!0}}async _refreshOutputDevices(){if(!this.deviceManager)return this._log("âŒ DeviceManager å°šæœªåˆå§‹åŒ–","error"),this.elements.outputSelect.innerHTML='<option value="default">ç³»çµ±é è¨­è¼¸å‡º</option>',void(this.elements.outputSelect.disabled=!0);if(!this.deviceManager.isSupported())return this.elements.outputSelect.innerHTML='<option value="default">ç³»çµ±é è¨­è¼¸å‡º</option>',this.elements.outputSelect.disabled=!0,void this._log("â„¹ï¸ æ­¤ç€è¦½å™¨ä¸æ”¯æ´è¼¸å‡ºè£ç½®åˆ‡æ›","info");try{this._log("ğŸ” æ­£åœ¨åˆ—èˆ‰è¼¸å‡ºè£ç½®...","info");const e=await this.deviceManager.enumerateOutputDevices();if(this.elements.outputSelect.innerHTML='<option value="default">ç³»çµ±é è¨­è¼¸å‡º</option>',0===e.length)return this.elements.outputSelect.disabled=!0,void this._log("â„¹ï¸ æœªåµæ¸¬åˆ°è¼¸å‡ºè£ç½®","info");this.elements.outputSelect.disabled=!1,e.forEach((e,t)=>{const i=document.createElement("option");i.value=e.deviceId,i.textContent=e.label||`æšè²å™¨ ${t+1}`,this.elements.outputSelect.appendChild(i)});const t=this.deviceManager.getSelectedOutputDeviceId();t&&"default"!==t&&(this.elements.outputSelect.value=t),this._log(`âœ… æ‰¾åˆ° ${e.length} å€‹è¼¸å‡ºè£ç½®`,"success")}catch(e){this._log(`âŒ åˆ—èˆ‰è¼¸å‡ºè£ç½®å¤±æ•—: ${e.message}`,"error"),console.error("åˆ—èˆ‰è¼¸å‡ºè£ç½®è©³ç´°éŒ¯èª¤:",e)}}async _handleRecord(){try{this._log("é–‹å§‹éŒ„éŸ³...","info"),await this.audioEngine.startRecording(),this.elements.recordBtn.disabled=!0,this.elements.stopBtn.disabled=!1,this.elements.zoomInBtn.disabled=!0,this.elements.zoomOutBtn.disabled=!0,this.elements.zoomResetBtn.disabled=!0,this.elements.panLeftBtn.disabled=!0,this.elements.panRightBtn.disabled=!0,this._log("âœ“ éŒ„éŸ³å·²é–‹å§‹","success")}catch(e){this._log(`âŒ éŒ„éŸ³å¤±æ•—: ${e.message}`,"error"),console.error("Recording Error:",e)}}async _handleStop(){try{this._log("åœæ­¢éŒ„éŸ³...","info");const e=await this.audioEngine.stopRecording();this.elements.recordBtn.disabled=!1,this.elements.stopBtn.disabled=!0,this.elements.playBtn.disabled=!1,this.elements.downloadBtn.disabled=!1,this.elements.zoomInBtn.disabled=!1,this.elements.zoomOutBtn.disabled=!1,this.elements.zoomResetBtn.disabled=!1,this.elements.panLeftBtn.disabled=!1,this.elements.panRightBtn.disabled=!1,this._log(`âœ“ éŒ„éŸ³å·²åœæ­¢ - ${(e.size/1024).toFixed(2)} KB`,"success"),this._updateRecordingInfo(e),this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.src="",this.audioPlayer=null),this.recordedUrl&&URL.revokeObjectURL(this.recordedUrl),this.recordedBlob=e,this.recordedUrl=URL.createObjectURL(e)}catch(e){this._log(`âŒ åœæ­¢å¤±æ•—: ${e.message}`,"error"),console.error("Stop Error:",e)}}async _handlePlay(){try{if(!this.recordedUrl)return void this._log("âŒ æ²’æœ‰å¯æ’­æ”¾çš„éŒ„éŸ³","error");if(this._log("æ’­æ”¾éŒ„éŸ³...","info"),this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.src="",this.audioPlayer=null),this.audioPlayer=new Audio(this.recordedUrl),this.audioPlayer.addEventListener("ended",()=>{this.elements.playBtn.disabled=!1,this.elements.pauseBtn.disabled=!0,this._log("âœ“ æ’­æ”¾å®Œæˆ","info")}),this.deviceManager)try{await this.deviceManager.setAudioOutputDevice(this.audioPlayer)}catch(e){console.warn("è¨­ç½®è¼¸å‡ºè£ç½®å¤±æ•—:",e)}await this.audioPlayer.play(),this.elements.playBtn.disabled=!0,this.elements.pauseBtn.disabled=!1,this._log("âœ“ æ’­æ”¾ä¸­","info")}catch(e){this._log(`âŒ æ’­æ”¾å¤±æ•—: ${e.message}`,"error"),console.error("Play Error:",e)}}_handlePause(){try{if(!this.audioPlayer)return void this._log("âŒ æ²’æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³è¨Š","error");this._log("æš«åœæ’­æ”¾...","info"),this.audioPlayer.pause(),this.elements.playBtn.disabled=!1,this.elements.pauseBtn.disabled=!0,this._log("âœ“ å·²æš«åœ","info")}catch(e){this._log(`âŒ æš«åœå¤±æ•—: ${e.message}`,"error"),console.error("Pause Error:",e)}}_handleDownload(){try{if(!this.recordedBlob)return void this._log("âŒ æ²’æœ‰å¯ä¸‹è¼‰çš„éŒ„éŸ³","error");const e=`voicebank-recording-${(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19)}.wav`,t=document.createElement("a");t.href=this.recordedUrl,t.download=e,t.click(),this._log(`ğŸ’¾ å·²ä¸‹è¼‰: ${e}`,"success")}catch(e){this._log(`âŒ ä¸‹è¼‰å¤±æ•—: ${e.message}`,"error"),console.error("Download Error:",e)}}_handleZoomIn(){this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform&&(this.waveformRenderer.accumulatedWaveform.zoomBySteps(1,.5),this._log("ğŸ” æ”¾å¤§æ³¢å½¢","info"))}_handleZoomOut(){this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform&&(this.waveformRenderer.accumulatedWaveform.zoomBySteps(-1,.5),this._log("ğŸ” ç¸®å°æ³¢å½¢","info"))}_handleZoomReset(){this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform&&(this.waveformRenderer.accumulatedWaveform.setZoom(1),this.waveformRenderer.accumulatedWaveform.isAutoScroll=!0,this.elements.autoScrollCheck.checked=!0,this._log("ğŸ”„ é‡ç½®è¦–åœ–","info"))}_handlePanLeft(){if(this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform){const e=this.waveformRenderer.accumulatedWaveform.getVisibleSamples();this.waveformRenderer.accumulatedWaveform.panBySamples(-Math.floor(.2*e.visible)),this._log("â—€ å‘å·¦ç§»å‹•","info")}}_handlePanRight(){if(this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform){const e=this.waveformRenderer.accumulatedWaveform.getVisibleSamples();this.waveformRenderer.accumulatedWaveform.panBySamples(Math.floor(.2*e.visible)),this._log("â–¶ å‘å³ç§»å‹•","info")}}_handleAutoScrollChange(e){this.waveformRenderer&&this.waveformRenderer.accumulatedWaveform&&(this.waveformRenderer.accumulatedWaveform.isAutoScroll=e.target.checked,this._log(e.target.checked?"âœ“ å•Ÿç”¨è‡ªå‹•æ²å‹•":"âœ— åœç”¨è‡ªå‹•æ²å‹•","info"))}_handleMicChange(e){const t=e.target.value,i=e.target.options[e.target.selectedIndex].text;this.deviceManager.selectMicrophone(t,!0),this._log(`ğŸ¤ å·²é¸æ“‡éº¥å…‹é¢¨: ${i}`,"info")}_handleOutputChange(e){const t=e.target.value,i=e.target.options[e.target.selectedIndex].text;this.deviceManager.selectOutputDevice(t,!0),this._log(`ğŸ”Š å·²é¸æ“‡è¼¸å‡ºè£ç½®: ${i}`,"info")}_handleGainChange(e){const t=parseFloat(e.target.value);this.elements.gainValue.textContent=t.toFixed(1)+"x",this.audioEngine&&this.audioEngine.setMicGain&&(this.audioEngine.setMicGain(t),this._log(`ğŸšï¸ å¢ç›Šèª¿æ•´ç‚º ${t.toFixed(1)}x`,"info"))}_handleAGCChange(e){this._log(`AGC ${e.target.checked?"å·²å•Ÿç”¨":"å·²åœç”¨"}ï¼ˆå°‡åœ¨ä¸‹æ¬¡éŒ„éŸ³æ™‚ç”Ÿæ•ˆï¼‰`,"info")}_handleEchoCancelChange(e){this._log(`å›éŸ³æ¶ˆé™¤ ${e.target.checked?"å·²å•Ÿç”¨":"å·²åœç”¨"}ï¼ˆå°‡åœ¨ä¸‹æ¬¡éŒ„éŸ³æ™‚ç”Ÿæ•ˆï¼‰`,"info")}_handleNoiseSuppressChange(e){this._log(`èƒŒæ™¯é™å™ª ${e.target.checked?"å·²å•Ÿç”¨":"å·²åœç”¨"}ï¼ˆå°‡åœ¨ä¸‹æ¬¡éŒ„éŸ³æ™‚ç”Ÿæ•ˆï¼‰`,"info")}_updateRecordingInfo(e){const t=(this.audioEngine.recordStopTime-this.audioEngine.recordStartTime)/1e3,i=this.audioEngine.pcmTotalSamples||0,s=this.audioEngine.audioContext.sampleRate;this.elements.durationInfo.textContent=this._formatDuration(t),this.elements.samplesInfo.textContent=i.toLocaleString(),this.elements.samplerateInfo.textContent=s.toLocaleString(),this.elements.filesizeInfo.textContent=(e.size/1024).toFixed(2),this.elements.recordingInfo.style.display="block"}_formatDuration(e){const t=Math.floor(e/60),i=Math.floor(e%60),s=Math.floor(e%1*1e3);return`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}.${String(s).padStart(3,"0")}`}_getTimeString(){const e=new Date;return`${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}_log(e,t="info"){if(!this.options.showStatusLog||!this.elements.statusLog)return;const i=document.createElement("div");i.className="vbr-log-entry";const s=document.createElement("span");s.className="vbr-log-time",s.textContent=`[${this._getTimeString()}]`;const n=document.createElement("span");n.className=`vbr-log-text vbr-log-${t}`,n.textContent=e,i.appendChild(s),i.appendChild(n),this.elements.statusLog.appendChild(i),this.elements.statusLog.scrollTop=this.elements.statusLog.scrollHeight}destroy(){this.audioEngine&&this.audioEngine.isRecording&&this.audioEngine.stopRecording(),this.audioPlayer&&(this.audioPlayer.pause(),this.audioPlayer.src="",this.audioPlayer=null),this.recordedUrl&&(URL.revokeObjectURL(this.recordedUrl),this.recordedUrl=null),this.waveformRenderer&&(this.waveformRenderer.destroy(),this.waveformRenderer=null),this.audioEngine&&(this.audioEngine.destroy(),this.audioEngine=null),this.container.innerHTML="",this.isInitialized=!1,this._log("VoiceBank Recorder UI å·²éŠ·æ¯€","info")}},e.WaveformRenderer=s,e.default=l,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=voicebank-recorder.min.js.map
