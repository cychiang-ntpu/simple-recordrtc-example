/*!
 * voicebank-recorder v1.0.0
 * Ë∑®Âπ≥Âè∞Èü≥Ë®äÈåÑÈü≥Â∫´ÔºåÊîØÊè¥ Browser/Electron/Capacitor
 * 
 * Includes RecordRTC v5.6.2 (https://github.com/muaz-khan/RecordRTC)
 * RecordRTC License: MIT
 * 
 * @license MIT
 * @author VoiceBank Team
 * @repository https://github.com/cychiang-ntpu/simple-recordrtc-example.git
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).VoiceBankRecorder={})}(this,function(e){"use strict";class t{constructor(e={}){this.options={micStorageKey:"preferredMicDeviceId",outputStorageKey:"preferredOutputDeviceId",autoLoadPreferences:!0,autoRequestPermission:!0,...e},this.microphoneDevices=[],this.outputDevices=[],this.selectedMicDeviceId="",this.selectedOutputDeviceId="default",this._eventListeners={devicechange:[],micchange:[],outputchange:[]},this._deviceChangeListener=null,this.options.autoLoadPreferences&&this.loadPreferences()}loadPreferences(){console.log("[DeviceManager] loadPreferences Ë¢´ÂëºÂè´");try{const e=localStorage.getItem(this.options.micStorageKey),t=localStorage.getItem(this.options.outputStorageKey);console.log("[DeviceManager] localStorage ‰∏≠ÁöÑÂÄº:"),console.log(`  - ${this.options.micStorageKey}: "${e}"`),console.log(`  - ${this.options.outputStorageKey}: "${t}"`),e?(this.selectedMicDeviceId=e,console.log(`[DeviceManager] Â∑≤ËºâÂÖ•È∫•ÂÖãÈ¢®ÂÅèÂ•Ω: ${e}`)):console.log("[DeviceManager] Ê≤íÊúâÂÑ≤Â≠òÁöÑÈ∫•ÂÖãÈ¢®ÂÅèÂ•Ω"),t?(this.selectedOutputDeviceId=t,console.log(`[DeviceManager] Â∑≤ËºâÂÖ•Ëº∏Âá∫Ë£ùÁΩÆÂÅèÂ•Ω: ${t}`)):console.log("[DeviceManager] Ê≤íÊúâÂÑ≤Â≠òÁöÑËº∏Âá∫Ë£ùÁΩÆÂÅèÂ•ΩÔºå‰ΩøÁî® default")}catch(e){console.warn("[DeviceManager] Failed to load device preferences:",e)}}savePreference(e,t){try{"microphone"===e?(localStorage.setItem(this.options.micStorageKey,t),this.selectedMicDeviceId=t):"output"===e&&(localStorage.setItem(this.options.outputStorageKey,t),this.selectedOutputDeviceId=t)}catch(e){console.warn("Failed to save device preference:",e)}}isSupported(){return!(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)}async requestMicrophonePermission(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia is not supported in this browser");try{(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop())}catch(e){throw new Error(`Failed to request microphone permission: ${e.message}`)}}async enumerateMicrophones(e=this.options.autoRequestPermission){if(!this.isSupported())throw new Error("Device enumeration is not supported in this browser");try{if(e)try{await this.requestMicrophonePermission()}catch(e){console.warn("Permission request failed, continuing anyway:",e)}const t=await navigator.mediaDevices.enumerateDevices();return this.microphoneDevices=t.filter(e=>"audioinput"===e.kind),this.microphoneDevices}catch(e){throw new Error(`Failed to enumerate microphones: ${e.message}`)}}async enumerateOutputDevices(){if(!this.isSupported())throw new Error("Device enumeration is not supported in this browser");try{const e=await navigator.mediaDevices.enumerateDevices();return this.outputDevices=e.filter(e=>"audiooutput"===e.kind),this.outputDevices}catch(e){throw new Error(`Failed to enumerate output devices: ${e.message}`)}}async enumerateAllDevices(e=this.options.autoRequestPermission){const[t,i]=await Promise.all([this.enumerateMicrophones(e),this.enumerateOutputDevices()]);return{microphones:t,outputs:i}}selectMicrophone(e,t=!0){console.log("[DeviceManager] selectMicrophone Ë¢´ÂëºÂè´:",{deviceId:e,save:t}),console.log(`[DeviceManager] ËÆäÊõ¥Ââç: selectedMicDeviceId = "${this.selectedMicDeviceId}"`),this.selectedMicDeviceId=e,console.log(`[DeviceManager] ËÆäÊõ¥Âæå: selectedMicDeviceId = "${this.selectedMicDeviceId}"`),t&&(this.savePreference("microphone",e),console.log(`[DeviceManager] Â∑≤ÂÑ≤Â≠òËá≥ localStorage (${this.options.micStorageKey})`)),this._emit("micchange",{deviceId:e})}selectOutputDevice(e,t=!0){this.selectedOutputDeviceId=e,t&&this.savePreference("output",e),this._emit("outputchange",{deviceId:e})}getSelectedMicrophoneId(){return this.selectedMicDeviceId}getSelectedOutputDeviceId(){return this.selectedOutputDeviceId}getSelectedMicrophone(){return this.microphoneDevices.find(e=>e.deviceId===this.selectedMicDeviceId)||null}getSelectedOutputDevice(){return this.outputDevices.find(e=>e.deviceId===this.selectedOutputDeviceId)||null}getMicrophoneConstraints(e={}){console.log("[DeviceManager] getMicrophoneConstraints Ë¢´ÂëºÂè´"),console.log(`[DeviceManager] Áï∂Ââç selectedMicDeviceId = "${this.selectedMicDeviceId}"`);const t={audio:{...e},video:!1};return this.selectedMicDeviceId?(t.audio.deviceId={exact:this.selectedMicDeviceId},console.log(`[DeviceManager] Â∑≤Âä†ÂÖ• deviceId Á¥ÑÊùü: ${this.selectedMicDeviceId}`)):console.log("[DeviceManager] Ê≤íÊúâÈÅ∏ÊìáÁâπÂÆöË£ùÁΩÆÔºå‰ΩøÁî®Á≥ªÁµ±È†êË®≠"),t}async setAudioOutputDevice(e,t){const i=t||this.selectedOutputDeviceId;if("function"==typeof e.setSinkId)try{await e.setSinkId(i)}catch(e){throw new Error(`Failed to set audio output device: ${e.message}`)}else console.warn("setSinkId is not supported in this browser")}isDeviceAvailable(e,t){return("microphone"===t?this.microphoneDevices:this.outputDevices).some(t=>t.deviceId===e)}startDeviceChangeMonitoring(){navigator.mediaDevices&&!this._deviceChangeListener&&(this._deviceChangeListener=async()=>{try{await this.enumerateAllDevices(!1),this._emit("devicechange",{microphones:this.microphoneDevices,outputs:this.outputDevices})}catch(e){console.error("Device change enumeration failed:",e)}},navigator.mediaDevices.addEventListener("devicechange",this._deviceChangeListener))}stopDeviceChangeMonitoring(){this._deviceChangeListener&&navigator.mediaDevices&&(navigator.mediaDevices.removeEventListener("devicechange",this._deviceChangeListener),this._deviceChangeListener=null)}on(e,t){this._eventListeners[e]?this._eventListeners[e].push(t):console.warn(`Unknown event: ${e}`)}off(e,t){if(!this._eventListeners[e])return;const i=this._eventListeners[e].indexOf(t);i>-1&&this._eventListeners[e].splice(i,1)}_emit(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(i=>{try{i(t)}catch(t){console.error(`Error in ${e} event handler:`,t)}})}destroy(){this.stopDeviceChangeMonitoring(),this._eventListeners={devicechange:[],micchange:[],outputchange:[]},this.microphoneDevices=[],this.outputDevices=[]}}class i{constructor(e,t){this.canvas=e,this.canvasContext=e.getContext("2d"),this.analyser=t,this.mediaStreamSource=null,this.animationId=null,this.isRunning=!1,this.width=e.width,this.height=e.height,this.bufferLength=0,this.dataArray=null,this.amplification=3,this._lastDataArray=null,this._verticalScrollOffset=0}start(e,t,i){if(this.isRunning||!t||!this.analyser)return void console.warn("LiveWaveform.start() Ê¢ù‰ª∂‰∏çÊªøË∂≥:",{isRunning:this.isRunning,hasAudioContext:!!t,hasAnalyser:!!this.analyser});console.log("‚úÖ LiveWaveform ÈñãÂßãÂïüÂãï..."),this.isRunning=!0;const s=this;let a=Promise.resolve();"suspended"===t.state&&(a=t.resume().catch(function(e){console.warn("Unable to resume AudioContext:",e)})),a.then(function(){if(s.mediaStreamSource&&s.mediaStreamSource.disconnect(),s.mediaStreamSource=t.createMediaStreamSource(e),i)try{s.mediaStreamSource.connect(i)}catch(e){console.warn("connect preGainNode failed",e)}else s.mediaStreamSource.connect(s.analyser);s.analyser.fftSize=1024,s.bufferLength=s.analyser.fftSize,s.dataArray=new Uint8Array(s.bufferLength),console.log("‚úÖ LiveWaveform Èü≥Ë®äÈÄ£Êé•ÂÆåÊàêÔºåÈñãÂßãÁπ™Ë£Ω"),s.draw(!1)})}stop(){this.isRunning&&(this.isRunning=!1,this.mediaStreamSource&&(this.mediaStreamSource.disconnect(),this.mediaStreamSource=null),this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.canvasContext.clearRect(0,0,this.width,this.height))}draw(e=!1){if(this.isRunning&&this.analyser&&this.dataArray)if(this.animationId=requestAnimationFrame(()=>this.draw(e)),this.analyser.getByteTimeDomainData(this.dataArray),e){const e=2;this._verticalScrollOffset+=e,this._verticalScrollOffset>=this.height&&(this._verticalScrollOffset=0,this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height)),this.canvasContext.lineWidth=1.5,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const t=this.height/this.bufferLength;let i=0;for(let e=0;e<this.bufferLength;e++){const s=(this.dataArray[e]/128-1)*this.amplification*this.width/2+this.width/2;0===e?this.canvasContext.moveTo(s,i):this.canvasContext.lineTo(s,i),i+=t}this.canvasContext.stroke()}else{this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=2,this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.beginPath();const e=this.width/this.bufferLength;let t=0;for(let i=0;i<this.bufferLength;i++){const s=(this.dataArray[i]/128-1)*this.amplification*this.height/2+this.height/2;0===i?this.canvasContext.moveTo(t,s):this.canvasContext.lineTo(t,s),t+=e}this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke()}}}class s{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.analyser=t,this.bufferLength=2048,this.timeData=new Float32Array(this.bufferLength),this.levelDb=-90,this.peakDb=-90,this.holdPeakDb=-90,this.lastPeakTime=0,this.peakHoldMillis=1500,this.fallRateDbPerSec=20,this.minDb=-90,this.maxDb=0,this.animationId=null,this.lastClipTime=0,this.clipHoldMillis=2e3,this._lastLogTime=0}_computeLevels(){if(!this.analyser)return{rmsDb:this.minDb,peakDb:this.minDb};const e=this.analyser.fftSize||this.bufferLength;this.timeData.length!==e&&(this.bufferLength=e,this.timeData=new Float32Array(e)),this.analyser.getFloatTimeDomainData(this.timeData);let t=0,i=0,s=!1;for(let e=0;e<this.bufferLength;e++){let a=this.timeData[e];a>1?a=1:a<-1&&(a=-1),t+=a*a;const o=Math.abs(a);o>i&&(i=o),o>=.995&&(s=!0)}const a=Math.sqrt(t/this.bufferLength);let o=a>0?20*Math.log10(a):-1/0,r=i>0?20*Math.log10(i):-1/0;return o<this.minDb&&(o=this.minDb),o>this.maxDb&&(o=this.maxDb),r<this.minDb&&(r=this.minDb),r>this.maxDb&&(r=this.maxDb),s&&(this.lastClipTime=performance.now?performance.now():Date.now()),{rmsDb:o,peakDb:r}}resize(){this.clear()}clear(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(e){const t=this.ctx,i=this.canvas.width,s=this.canvas.height;t.clearRect(0,0,i,s);const a=t.createLinearGradient(0,0,i,0);a.addColorStop(0,"#2d3748"),a.addColorStop(1,"#1a202c"),t.fillStyle=a,t.fillRect(0,0,i,s);let o=(e-this.minDb)/(this.maxDb-this.minDb);o<0&&(o=0),o>1&&(o=1);const r=t.createLinearGradient(0,0,i,0);r.addColorStop(0,"#38a169"),r.addColorStop(.6,"#d69e2e"),r.addColorStop(.85,"#dd6b20"),r.addColorStop(1,"#c53030"),t.fillStyle=r;const n=Math.round(i*o);t.fillRect(0,0,n,s),t.save(),t.strokeStyle="rgba(255,255,255,0.15)",t.lineWidth=1,t.beginPath();for(let e=this.minDb;e<=this.maxDb;e+=10){const a=(e-this.minDb)/(this.maxDb-this.minDb),o=Math.round(i*a)+.5;if(0===e?(t.strokeStyle="rgba(255,255,255,0.35)",t.beginPath(),t.moveTo(o,0),t.lineTo(o,s),t.stroke(),t.strokeStyle="rgba(255,255,255,0.15)"):(t.moveTo(o,0),t.lineTo(o,.4*s),t.moveTo(o,s),t.lineTo(o,.6*s)),e%20==0||-10===e){const i=e.toString();t.fillStyle=0===e?"#ffffff":-10===e?"#ffeb3b":"#cbd5e0",t.font="10px -apple-system,Segoe UI,sans-serif",t.textAlign="center",t.textBaseline="top",t.fillText(i,o,1)}}t.restore();const c=(-10-this.minDb)/(this.maxDb-this.minDb);if(c>0&&c<1){const e=Math.round(i*c);t.save(),t.fillStyle="rgba(255,235,59,0.08)",t.fillRect(e-2,0,4,s),t.restore()}let h=(this.holdPeakDb-this.minDb)/(this.maxDb-this.minDb);h<0&&(h=0),h>1&&(h=1);const l=Math.round(i*h);t.strokeStyle="#ffffff",t.lineWidth=2,t.beginPath(),t.moveTo(l+.5,0),t.lineTo(l+.5,s),t.stroke(),t.fillStyle="#f0f0f0",t.font="bold 12px -apple-system,Segoe UI,sans-serif",t.textAlign="left",t.textBaseline="middle";const d=`RMS ${e<=this.minDb?"-‚àû":e.toFixed(1)} dBFS   Peak ${this.peakDb<=this.minDb?"-‚àû":this.peakDb.toFixed(1)} dBFS`;t.fillText(d,8,s/2);const u=performance.now?performance.now():Date.now();if(this.lastClipTime&&u-this.lastClipTime<this.clipHoldMillis){t.save(),t.fillStyle="#B00020";const e=42,s=18;t.fillRect(i-e-8,4,e,s),t.fillStyle="#fff",t.font="bold 12px -apple-system,Segoe UI,sans-serif",t.textAlign="center",t.textBaseline="middle",t.fillText("CLIP",i-e/2-8,4+s/2+.5),t.restore()}}update(){const e=this._computeLevels();this.levelDb=e.rmsDb,this.peakDb=e.peakDb;const t=performance.now();if(this.peakDb>this.holdPeakDb+.5)this.holdPeakDb=this.peakDb,this.lastPeakTime=t;else{const e=t-this.lastPeakTime;if(e>this.peakHoldMillis){const t=(e-this.peakHoldMillis)/1e3,i=this.fallRateDbPerSec*t;this.holdPeakDb=Math.max(this.peakDb,this.holdPeakDb-i)}}this.draw(this.levelDb)}start(){if(this.stop(),this.analyser){const e=this.analyser.fftSize||2048;this.timeData.length!==e&&(this.bufferLength=e,this.timeData=new Float32Array(e))}const e=this;!function t(){e.update(),e.animationId=requestAnimationFrame(t)}()}stop(){this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.clear()}}class a{constructor(e,t={}){if(this.canvas=e,this.canvasContext=null,this.width=e.width,this.height=e.height,this.targetSampleRate=5e3,this.sourceSampleRate=48e3,this.decimationFactor=10,this.sampleMin=[],this.sampleMax=[],this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.playbackPosition=0,this.isPlaying=!1,this.playbackStartTime=0,this.playbackStartSample=0,this.rawZoomMode=!1,this.rawViewStart=0,this.rawVisibleRaw=0,this.overviewWaveform=null,this._useWorker=!1!==t.useWorker,this._worker=null,this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1,this.lastDetail=null,this.lastDensity=null,this._useWorker&&e.transferControlToOffscreen&&"undefined"!=typeof Worker)try{const i=e.transferControlToOffscreen();this._worker=new Worker(t.workerPath||"workers/wf-worker.js"),this._worker.postMessage({type:"init",canvas:i,width:this.width,height:this.height,verticalMode:!1,showClipMarks:!1!==t.showClipMarks,sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor},[i]);const s=this;this._worker.onmessage=function(e){const t=e.data;t&&"detailUpdate"===t.type&&(s.lastDetail=t.detail,s.lastDensity=t.density)}}catch(e){console.warn("OffscreenCanvas ÂàùÂßãÂåñÂ§±ÊïóÔºå‰ΩøÁî®‰∏ªÁ∑öÁ®ãÁπ™Ë£Ω:",e),this._useWorker=!1}else this._useWorker=!1;if(!this._useWorker)try{this.canvasContext=e.getContext("2d")}catch(e){console.warn("ÁÑ°Ê≥ïÁç≤Âèñ canvas context:",e)}this._setupMouseInteraction(),this.clear()}_setupMouseInteraction(){if(!this.canvas)return;let e=!1,t=0,i=0;this.canvas.addEventListener("mousedown",s=>{e=!0,t=s.offsetX,i=this.viewStart,this.isAutoScroll=!1,this.canvas.style.cursor="grabbing"}),this.canvas.addEventListener("mousemove",s=>{if(!e)return;const a=s.offsetX-t,o=this.getVisibleSamples().visible/this.width,r=Math.round(-a*o);this.viewStart=i+r,this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}),this.canvas.addEventListener("mouseup",()=>{e&&(e=!1,this.canvas.style.cursor="grab")}),this.canvas.addEventListener("mouseleave",()=>{e&&(e=!1,this.canvas.style.cursor="default")}),this.canvas.addEventListener("wheel",e=>{e.preventDefault();const t=this.canvas.getBoundingClientRect(),i=(e.clientX-t.left)/this.width,s=e.deltaY>0?-1:1;this.zoomBySteps(s,i)}),this.canvas.addEventListener("click",t=>{if(e)return;const i=this.getVisibleSamples(),s=t.offsetX/this.width,a=Math.floor(i.start+s*i.visible),o=new CustomEvent("waveform-seek",{detail:{sample:a,time:a/this.sourceSampleRate}});this.canvas.dispatchEvent(o)}),this.canvas.style.cursor="grab"}clear(){this._useWorker&&this._worker?this._worker.postMessage({type:"reset"}):this.canvasContext&&(this.canvasContext.clearRect(0,0,this.width,this.height),this.canvasContext.fillStyle="#f0f0f0",this.canvasContext.fillRect(0,0,this.width,this.height),this.canvasContext.lineWidth=1,this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.beginPath(),this.canvasContext.moveTo(0,this.height/2),this.canvasContext.lineTo(this.width,this.height/2),this.canvasContext.stroke())}reset(){this.sampleMin.length=0,this.sampleMax.length=0,this.sampleCount=0,this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.clear()}append(e){if(!e||!e.length)return;const t=this.decimationFactor,i=e.length,s=[],a=[];this._lastAppendLog||(this._lastAppendLog=0);const o=Date.now();o-this._lastAppendLog>1e3&&(console.log("üìà AccumulatedWaveform.append():",i,"Ê®£Êú¨ ‚Üí",Math.floor(i/t),"ÂçÄÂ°ä"),this._lastAppendLog=o);for(let o=0;o<i;o+=t){let r=0,n=0;for(let s=0;s<t&&o+s<i;s++){r+=e[o+s],n++}if(!n)continue;const c=r/n;let h=1,l=-1;for(let t=0;t<n;t++){const i=e[o+t]-c;i<h&&(h=i),i>l&&(l=i)}h>l&&(h=l=0),this.sampleMin.push(h),this.sampleMax.push(l),s.push(h),a.push(l),this.sampleCount++}if(this.isAutoScroll?this.scrollToLatest():this._enforceViewBounds(),this._useWorker&&this._worker&&(this._appendBatchMin.push(...s),this._appendBatchMax.push(...a),!this._appendFlushScheduled)){this._appendFlushScheduled=!0;const e=this,t=()=>e._flushAppendBatch();"function"==typeof requestAnimationFrame?requestAnimationFrame(t):setTimeout(t,32)}this.draw()}_flushAppendBatch(){this._worker&&0!==this._appendBatchMin.length?(this._worker.postMessage({type:"append",minArr:this._appendBatchMin,maxArr:this._appendBatchMax}),this._appendBatchMin=[],this._appendBatchMax=[],this._appendFlushScheduled=!1):this._appendFlushScheduled=!1}draw(){if(this._useWorker&&this._worker)return void this._worker.postMessage({type:"draw",zoomFactor:this.zoomFactor,viewStart:this.viewStart,playbackPosition:this.playbackPosition,isPlaying:this.isPlaying});if(!this.canvasContext)return;if(this.clear(),0===this.sampleCount)return;const e=this.getVisibleSamples(),{start:t,end:i,visible:s}=e;if(0===s||t>=i)return;const a=this.height/2;this.canvasContext.strokeStyle="#1E88E5",this.canvasContext.lineWidth=1.5,this.canvasContext.lineJoin="round",this.canvasContext.lineCap="round",this.canvasContext.beginPath();let o=!1;for(let e=t;e<i;e++){const i=(e-t)/s*this.width,r=a-this.sampleMax[e]*a*.95;o?this.canvasContext.lineTo(i,r):(this.canvasContext.moveTo(i,r),o=!0)}this.canvasContext.stroke(),this.canvasContext.beginPath(),o=!1;for(let e=t;e<i;e++){const i=(e-t)/s*this.width,r=a-this.sampleMin[e]*a*.95;o?this.canvasContext.lineTo(i,r):(this.canvasContext.moveTo(i,r),o=!0)}this.canvasContext.stroke(),this.canvasContext.strokeStyle="#d0d0d0",this.canvasContext.lineWidth=1,this.canvasContext.beginPath(),this.canvasContext.moveTo(0,a+.5),this.canvasContext.lineTo(this.width,a+.5),this.canvasContext.stroke()}getVisibleSamples(){const e=this.sampleCount;if(0===e)return{start:0,end:0,visible:0};const t=this._getMinVisibleSamples(e);let i=Math.max(t,Math.round(e/this.zoomFactor));i>e&&(i=e);let s=this.viewStart;s+i>e&&(s=e-i),s<0&&(s=0);return{start:s,end:Math.min(e,s+i),visible:i}}_getMinVisibleSamples(e){return Math.max(10,Math.floor(this.width/10))}_enforceViewBounds(){if(0===this.sampleCount)return void(this.viewStart=0);const e=this.getVisibleSamples();this.viewStart=e.start,this.viewStart<0&&(this.viewStart=0);const t=Math.max(0,this.sampleCount-e.visible);this.viewStart>t&&(this.viewStart=t)}scrollToLatest(){const e=this.sampleCount;if(0===e)return;const t=this._getMinVisibleSamples(e);let i=Math.max(t,Math.round(e/this.zoomFactor));i>e&&(i=e),this.viewStart=e-i,this.viewStart<0&&(this.viewStart=0)}setZoom(e,t){if(0===this.sampleCount)return;e<1&&(e=1);const i=Math.max(1,this.sampleCount/this._getMinVisibleSamples(this.sampleCount));e>i&&(e=i);const s=this.getVisibleSamples();this.zoomFactor=e;const a=this.getVisibleSamples();if("number"==typeof t&&t>=0&&s.visible>0){const e=t-(t-s.start)/s.visible*a.visible;this.viewStart=Math.max(0,Math.min(this.sampleCount-a.visible,Math.floor(e)))}else{const e=s.start+s.visible/2-a.visible/2;this.viewStart=Math.max(0,Math.min(this.sampleCount-a.visible,Math.floor(e)))}this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}zoomBySteps(e,t=.5){if(0===e||0===this.sampleCount)return;const i=this.getVisibleSamples();let s;s=i.visible>0?i.start+t*i.visible:0;let a=this.zoomFactor;e>0?a*=Math.pow(1.5,e):a/=Math.pow(1.5,-e),this.setZoom(a,s)}panBySamples(e){0!==e&&(this.isAutoScroll=!1,this.viewStart+=e,this._enforceViewBounds(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw())}panByPixels(e){if(0===e)return;const t=e*(this.getVisibleSamples().visible/this.width)+this._panRemainder,i=Math.round(t);this._panRemainder=t-i,this.panBySamples(i)}resetView(){this.zoomFactor=1,this.viewStart=0,this.isAutoScroll=!0,this._panRemainder=0,this.scrollToLatest(),this.draw(),this.overviewWaveform&&this.overviewWaveform.draw()}setSourceSampleRate(e){this.sourceSampleRate=e||48e3,this.decimationFactor=Math.max(1,Math.round(this.sourceSampleRate/this.targetSampleRate)),this._worker&&this._worker.postMessage({type:"setSampleRate",sourceSampleRate:this.sourceSampleRate,decimationFactor:this.decimationFactor})}_getSamplePair(e){return e<0||e>=this.sampleCount?{min:0,max:0}:{min:this.sampleMin[e],max:this.sampleMax[e]}}setPlaybackPosition(e){this.playbackPosition=e,this.draw()}setRawZoomMode(e){this.rawZoomMode=!!e}startPlayback(e,t){this.isPlaying=!0,this.playbackStartSample=e||0,this.playbackStartTime=performance.now?performance.now():Date.now(),this.playbackPosition=this.playbackStartSample;const i=this,s=t||this.sourceSampleRate;requestAnimationFrame(function e(){if(!i.isPlaying)return;const t=((performance.now?performance.now():Date.now())-i.playbackStartTime)/1e3*s,a=i.playbackStartSample+Math.floor(t/i.decimationFactor);i.playbackPosition=a,i.draw(),requestAnimationFrame(e)})}stopPlayback(){this.isPlaying=!1,this.playbackPosition=0,this.draw()}_updatePlaybackPosition(){if(!this.isPlaying)return;const e=((performance.now?performance.now():Date.now())-this.playbackStartTime)/1e3*this.sourceSampleRate,t=this.playbackStartSample+Math.floor(e/this.decimationFactor);this.playbackPosition=t}}class o{constructor(e,t){this.canvas=e,this.ctx=e.getContext("2d"),this.accumulatedWaveform=t,this.width=e.width,this.height=e.height,this._useWorker=!1,this._workerRef=null,this._warnedNoData=!1,this._lastTotal=0,this._setupMouseInteraction()}_setupMouseInteraction(){if(!this.canvas)return;let e=!1;this.canvas.addEventListener("mousedown",t=>{const i=this.accumulatedWaveform;i&&0!==i.sampleCount&&(e=!0,this._handleSeek(t.offsetX),this.canvas.style.cursor="grabbing")}),this.canvas.addEventListener("mousemove",t=>{e&&this._handleSeek(t.offsetX)}),this.canvas.addEventListener("mouseup",()=>{e=!1,this.canvas.style.cursor="pointer"}),this.canvas.addEventListener("mouseleave",()=>{e&&(e=!1,this.canvas.style.cursor="pointer")}),this.canvas.style.cursor="pointer"}_handleSeek(e){const t=this.accumulatedWaveform;if(!t||0===t.sampleCount)return;const i=t.sampleCount,s=Math.max(0,Math.min(1,e/this.width)),a=Math.floor(s*i),o=t.getVisibleSamples(),r=Math.floor(o.visible/2);t.viewStart=Math.max(0,Math.min(i-o.visible,a-r)),t.isAutoScroll=!1,t._enforceViewBounds(),t.draw(),this.draw();const n=new CustomEvent("overview-seek",{detail:{sample:a,time:a/t.sourceSampleRate}});this.canvas.dispatchEvent(n)}clear(){this._useWorker&&this._workerRef?this._workerRef.postMessage({type:"clearOverview"}):(this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle="#f5f5f5",this.ctx.fillRect(0,0,this.width,this.height))}draw(){if(this._useWorker&&this._workerRef)return;this.clear();const e=this.accumulatedWaveform;if(!e||0===e.sampleCount)return void console.log("‚ö†Ô∏è OverviewWaveform: Ê≤íÊúâÊï∏ÊìöÂèØÈ°ØÁ§∫",{hasAcc:!!e,sampleCount:e?e.sampleCount:0});const t=e.sampleCount,i=e.getVisibleSamples();console.log("üìä OverviewWaveform Áπ™Ë£Ω:",{total:t,visibleStart:i.start,visibleEnd:i.end,canvasWidth:this.width,canvasHeight:this.height}),this.ctx.strokeStyle="#64b5f6",this.ctx.lineWidth=1;const s=t/this.width;for(let i=0;i<this.width;i++){const a=Math.floor(i*s);if(a>=t)break;const o=e._getSamplePair(a),r=this.height/2,n=Math.floor(r-o.max*r*.9),c=Math.floor(r-o.min*r*.9);this.ctx.beginPath(),this.ctx.moveTo(i,n),this.ctx.lineTo(i,c),this.ctx.stroke()}this.ctx.strokeStyle="#e0e0e0",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.moveTo(0,this.height/2),this.ctx.lineTo(this.width,this.height/2),this.ctx.stroke();const a=Math.floor(i.start/t*this.width),o=Math.floor(i.end/t*this.width),r=Math.max(2,o-a);this.ctx.fillStyle="rgba(33, 150, 243, 0.15)",this.ctx.fillRect(a,0,r,this.height),this.ctx.strokeStyle="#2196F3",this.ctx.lineWidth=2,this.ctx.strokeRect(a,0,r,this.height),console.log("‚úÖ OverviewWaveform Áπ™Ë£ΩÂÆåÊàê")}}class r{async save(e,t,i={}){throw new Error("save() must be implemented by subclass")}async load(e){throw new Error("load() must be implemented by subclass")}async delete(e){throw new Error("delete() must be implemented by subclass")}async list(){throw new Error("list() must be implemented by subclass")}async exists(e){try{return await this.load(e),!0}catch(e){return!1}}async clear(){const e=await this.list();let t=0;for(const i of e)try{await this.delete(i.id||i.filename),t++}catch(e){console.error("Failed to delete file:",i,e)}return t}}class n{constructor(e={}){this.options=this.mergeOptions(e),this.initialized=!1,this.storage=this.createStorageAdapter(this.options.storage),this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.options.container&&this.initializeUI()}mergeOptions(e){const t={container:null,layout:"auto",theme:"light",audio:{sampleRate:48e3,channels:1,agc:!1,gain:1},waveform:{showOverview:!0,showAccumulated:!0,showLive:!0,decimation:10,colors:{waveform:"#1E88E5",selection:"#4CAF50",playback:"#FF0000"}},storage:{type:"auto"},callbacks:{onRecordStart:()=>{},onRecordStop:()=>{},onRecordPause:()=>{},onRecordResume:()=>{},onPlayStart:()=>{},onPlayStop:()=>{},onError:e=>console.error("VoiceBankRecorder error:",e)}};return this.deepMerge(t,e)}deepMerge(e,t){const i={...e};for(const e in t)t[e]instanceof Object&&!Array.isArray(t[e])?i[e]=this.deepMerge(i[e]||{},t[e]):i[e]=t[e];return i}createStorageAdapter(e){const{StorageFactory:t}=require("./storage/index.js");return t.create({type:e.type||"auto",options:e})}initializeUI(){console.log("UI initialization - to be implemented")}async startRecording(){try{if(this.isRecording)throw new Error("Already recording");this.isRecording=!0,this.options.callbacks.onRecordStart(),console.log("Recording started")}catch(e){throw this.options.callbacks.onError(e),e}}async stopRecording(){try{if(!this.isRecording)throw new Error("Not recording");return this.isRecording=!1,this.currentBlob=null,this.options.callbacks.onRecordStop(this.currentBlob),console.log("Recording stopped"),this.currentBlob}catch(e){throw this.options.callbacks.onError(e),e}}async pauseRecording(){try{if(!this.isRecording||this.isPaused)throw new Error("Cannot pause");this.isPaused=!0,this.options.callbacks.onRecordPause(),console.log("Recording paused")}catch(e){throw this.options.callbacks.onError(e),e}}async resumeRecording(){try{if(!this.isRecording||!this.isPaused)throw new Error("Cannot resume");this.isPaused=!1,this.options.callbacks.onRecordResume(),console.log("Recording resumed")}catch(e){throw this.options.callbacks.onError(e),e}}async play(){try{this.options.callbacks.onPlayStart(),console.log("Playback started")}catch(e){throw this.options.callbacks.onError(e),e}}async stop(){try{this.options.callbacks.onPlayStop(),console.log("Playback stopped")}catch(e){throw this.options.callbacks.onError(e),e}}async saveRecording(e=null,t=null,i={}){try{const s=e||this.currentBlob;if(!s)throw new Error("No recording to save");const a=t||`recording-${Date.now()}.wav`,o=await this.storage.save(s,a,i);return console.log("Recording saved:",o),o}catch(e){throw this.options.callbacks.onError(e),e}}async loadRecording(e){try{const t=await this.storage.load(e);return this.currentBlob=t,console.log("Recording loaded:",e),t}catch(e){throw this.options.callbacks.onError(e),e}}async deleteRecording(e){try{const t=await this.storage.delete(e);return console.log("Recording deleted:",e),t}catch(e){throw this.options.callbacks.onError(e),e}}async listRecordings(){try{const e=await this.storage.list();return console.log("Recordings listed:",e.length),e}catch(e){throw this.options.callbacks.onError(e),e}}getCurrentBlob(){return this.currentBlob}destroy(){this.isRecording=!1,this.isPaused=!1,this.currentBlob=null,this.storage&&"function"==typeof this.storage.close&&this.storage.close(),console.log("VoiceBankRecorder destroyed")}}const c="1.0.0",h={version:c,date:(new Date).toISOString(),name:"VoiceBank Recorder"};e.AudioEngine=class{constructor(e={}){this.config={sampleRate:e.sampleRate||48e3,autoGainControl:void 0!==e.autoGainControl&&e.autoGainControl,echoCancellation:void 0!==e.echoCancellation&&e.echoCancellation,noiseSuppression:void 0!==e.noiseSuppression&&e.noiseSuppression,micGain:e.micGain||1,deviceId:e.deviceId||null,workletPath:e.workletPath||"assets/js/worklet/pcm-collector.js",preferWorklet:void 0===e.preferWorklet||e.preferWorklet,autoManageDevices:void 0===e.autoManageDevices||e.autoManageDevices},e.deviceManager?(this.deviceManager=e.deviceManager,this._ownDeviceManager=!1):this.config.autoManageDevices?(this.deviceManager=new t,this._ownDeviceManager=!0):(this.deviceManager=null,this._ownDeviceManager=!1),this.audioContext=null,this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.workletSupported=!1,this.workletLoaded=!1,this.pcmCollectorNode=null,this.usingWorklet=!1,this.pcmChunks=[],this.pcmTotalSamples=0,this.recorder=null,this._pcmCaptureInterval=null,this.micStream=null,this.isRecording=!1,this.isPaused=!1,this.isInitialized=!1,this.recordStartTime=0,this.recordStopTime=0,this.recordWallStartMs=0,this.recordWallStopMs=0,this.latestBlob=null,this.latestUrl=null,this._eventListeners={}}async initialize(){if(!this.isInitialized)try{const e=window.AudioContext||window.webkitAudioContext;if(this.audioContext=new e({sampleRate:this.config.sampleRate}),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=256,this.preGainNode=this.audioContext.createGain(),this.preGainNode.gain.value=this.config.micGain,this.mediaDest=this.audioContext.createMediaStreamDestination(),this.preGainNode.connect(this.analyser),this.preGainNode.connect(this.mediaDest),this.analyserSilencer=this.audioContext.createGain(),this.analyserSilencer.gain.value=0,this.analyser.connect(this.analyserSilencer),this.analyserSilencer.connect(this.audioContext.destination),this.workletSupported=!(!this.audioContext.audioWorklet||!window.AudioWorkletNode),this.workletSupported&&this.config.preferWorklet)try{await this.audioContext.audioWorklet.addModule(this.config.workletPath),this.workletLoaded=!0,this._emit("worklet-loaded",{path:this.config.workletPath})}catch(e){console.warn("ËºâÂÖ• AudioWorklet Ê®°ÁµÑÂ§±ÊïóÔºåÂ∞áÂõûÈÄÄÂà∞ RecordRTC:",e),this.workletLoaded=!1,this._emit("worklet-load-failed",{error:e})}"suspended"===this.audioContext.state&&await this.audioContext.resume(),this.isInitialized=!0,this._emit("initialized",{sampleRate:this.audioContext.sampleRate,state:this.audioContext.state,workletSupported:this.workletSupported,workletLoaded:this.workletLoaded})}catch(e){throw this._emit("error",{stage:"initialize",error:e}),e}}async startRecording(){if(!this.isInitialized)throw new Error("AudioEngine Â∞öÊú™ÂàùÂßãÂåñÔºåË´ãÂÖàË™øÁî® initialize()");if(this.isRecording)throw new Error("Â∑≤Á∂ìÂú®ÈåÑÈü≥‰∏≠");try{"suspended"===this.audioContext.state&&await this.audioContext.resume(),this._stopMicrophone(),await this._captureMicrophone(),this.pcmChunks=[],this.pcmTotalSamples=0,this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.latestBlob=null,this.recordStartTime=Date.now(),this.recordWallStartMs=performance.now(),this.recordStopTime=0,this.recordWallStopMs=0;const e=this.workletLoaded&&this.config.preferWorklet;e?await this._startWorkletRecording():await this._startRecordRTCRecording(),this.isRecording=!0,this.isPaused=!1,this._emit("recording-start",{timestamp:this.recordStartTime,mode:e?"worklet":"recordrtc",sampleRate:this.audioContext.sampleRate})}catch(e){throw this._emit("error",{stage:"start-recording",error:e}),e}}async stopRecording(){if(!this.isRecording)throw new Error("ÁõÆÂâçÊ≤íÊúâÂú®ÈåÑÈü≥");try{let e;if(this.isRecording=!1,this.recordStopTime=Date.now(),this.recordWallStopMs=performance.now(),this.usingWorklet)e=await this._stopWorkletRecording();else{if(!this.recorder)throw new Error("Ê≤íÊúâÂèØÁî®ÁöÑÈåÑÈü≥Âô®");e=await this._stopRecordRTCRecording()}this._stopMicrophone(),this.latestBlob=e,this.latestUrl=URL.createObjectURL(e);const t=(this.recordStopTime-this.recordStartTime)/1e3;return this._emit("recording-stop",{blob:e,url:this.latestUrl,duration:t,samples:this.pcmTotalSamples,sampleRate:this.audioContext.sampleRate}),e}catch(e){throw this._emit("error",{stage:"stop-recording",error:e}),e}}pauseRecording(){if(!this.isRecording)throw new Error("ÁõÆÂâçÊ≤íÊúâÂú®ÈåÑÈü≥");if(this.usingWorklet)throw new Error("AudioWorklet Ê®°Âºè‰∏çÊîØÊè¥Êö´ÂÅúÂäüËÉΩ");if(!this.recorder||"function"!=typeof this.recorder.pauseRecording)throw new Error("Êö´ÂÅúÂäüËÉΩ‰∏çÂèØÁî®");this.recorder.pauseRecording(),this.isPaused=!0,this._emit("recording-paused",{timestamp:Date.now()})}resumeRecording(){if(!this.isPaused)throw new Error("ÈåÑÈü≥Ê≤íÊúâÊö´ÂÅú");if(!this.recorder||"function"!=typeof this.recorder.resumeRecording)throw new Error("ÁπºÁ∫åÈåÑÈü≥ÂäüËÉΩ‰∏çÂèØÁî®");this.recorder.resumeRecording(),this.isPaused=!1,this._emit("recording-resumed",{timestamp:Date.now()})}getLatestRecording(){return{blob:this.latestBlob,url:this.latestUrl,duration:this.latestBlob?(this.recordStopTime-this.recordStartTime)/1e3:0,samples:this.pcmTotalSamples,sampleRate:this.audioContext?this.audioContext.sampleRate:0}}getPcmWindow(e,t){if(!this.usingWorklet||!this.pcmChunks.length)return null;e<0&&(e=0);const i=this.pcmTotalSamples;if(e>=i)return new Float32Array(0);const s=Math.min(i,e+t),a=new Float32Array(s-e);let o=0,r=0;for(let t=0;t<this.pcmChunks.length&&r<s;t++){const i=this.pcmChunks[t];if(!i||!i.length)continue;const n=r,c=r+i.length;if(c<=e){r=c;continue}const h=Math.max(e,n),l=Math.min(s,c);if(l>h){const e=h-n,t=i.subarray(e,e+(l-h));a.set(t,o),o+=t.length}if(r=c,l>=s)break}return a}getAnalyser(){return this.analyser}getAudioContext(){return this.audioContext}get microphoneStream(){return this.micStream}setMicGain(e){e=Math.max(1,Math.min(6,e)),this.config.micGain=e,this.preGainNode&&(this.preGainNode.gain.value=e),this._emit("mic-gain-changed",{gain:e})}dispose(){this.isRecording&&this.stopRecording().catch(console.error),this._stopMicrophone(),this._stopPcmCapture(),this.latestUrl&&(URL.revokeObjectURL(this.latestUrl),this.latestUrl=null),this.audioContext&&(this.audioContext.close().catch(console.error),this.audioContext=null),this.analyser=null,this.preGainNode=null,this.mediaDest=null,this.analyserSilencer=null,this.pcmCollectorNode=null,this.recorder=null,this.pcmChunks=[],this.pcmTotalSamples=0,this.isInitialized=!1,this._emit("disposed")}on(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)}off(e,t){if(!this._eventListeners[e])return;const i=this._eventListeners[e].indexOf(t);i>-1&&this._eventListeners[e].splice(i,1)}_emit(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(i=>{try{i(t)}catch(t){console.error(`‰∫ã‰ª∂ËôïÁêÜÂô®ÈåØË™§ [${e}]:`,t)}})}async _captureMicrophone(){let e;if(this.deviceManager){e=this.deviceManager.getMicrophoneConstraints({echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl});const t=this.deviceManager.getSelectedMicrophoneId();console.log("[AudioEngine] ‰ΩøÁî® DeviceManager ÈÅ∏ÊìáÁöÑÈ∫•ÂÖãÈ¢®:",t),console.log("[AudioEngine] Á¥ÑÊùüÊ¢ù‰ª∂:",JSON.stringify(e,null,2))}else e={audio:{echoCancellation:this.config.echoCancellation,noiseSuppression:this.config.noiseSuppression,autoGainControl:this.config.autoGainControl},video:!1},this.config.deviceId&&(e.audio.deviceId={exact:this.config.deviceId}),console.log("[AudioEngine] ‰ΩøÁî®ÂÇ≥Áµ±Ê®°ÂºèÔºåÁ¥ÑÊùüÊ¢ù‰ª∂:",JSON.stringify(e,null,2));try{this.micStream=await navigator.mediaDevices.getUserMedia(e),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode);const t=this.deviceManager?this.deviceManager.getSelectedMicrophoneId():this.config.deviceId,i=this.micStream.getAudioTracks();if(i.length>0){const e=i[0].label;console.log("[AudioEngine] ÂØ¶Èöõ‰ΩøÁî®ÁöÑÈ∫•ÂÖãÈ¢®:",e)}this._emit("microphone-captured",{deviceId:t,constraints:e})}catch(t){if("OverconstrainedError"!==t.name&&"NotFoundError"!==t.name)throw t;console.warn("ÊåáÂÆöÁöÑÈ∫•ÂÖãÈ¢®ÁÑ°Ê≥ï‰ΩøÁî®ÔºåÂòóË©¶È†êË®≠Ë®≠ÂÇô"),delete e.audio.deviceId,this.micStream=await navigator.mediaDevices.getUserMedia(e),this._applyIOSMicGainAdjustment();this.audioContext.createMediaStreamSource(this.micStream).connect(this.preGainNode),this._emit("microphone-captured-fallback",{constraints:e})}}_stopMicrophone(){this.micStream&&(this.micStream.getTracks().forEach(e=>{try{e.stop()}catch(e){console.warn("ÂÅúÊ≠¢È∫•ÂÖãÈ¢®ËªåÈÅìÂ§±Êïó:",e)}}),this.micStream=null)}_applyIOSMicGainAdjustment(){try{const e=navigator.userAgent||"";/iphone|ipad|ipod/i.test(e)&&!this.config.autoGainControl&&Math.abs(this.config.micGain-1)<1e-4&&(this.setMicGain(3.5),this._emit("ios-gain-adjusted",{gain:3.5}))}catch(e){console.warn("iOS Â¢ûÁõäË™øÊï¥Â§±Êïó:",e)}}async _startWorkletRecording(){try{this.pcmCollectorNode=new AudioWorkletNode(this.audioContext,"pcm-collector-processor"),this.pcmCollectorNode.port.onmessage=e=>{const{type:t,pcmData:i}=e.data;"pcm-data"===t&&i&&(this.pcmChunks.push(new Float32Array(i)),this.pcmTotalSamples+=i.length,this._emit("data-available",{pcmData:new Float32Array(i),totalSamples:this.pcmTotalSamples,mode:"worklet"}))},this.preGainNode.connect(this.pcmCollectorNode),this.pcmCollectorNode.connect(this.audioContext.destination),this.usingWorklet=!0}catch(e){console.error("AudioWorklet ÂïüÂãïÂ§±ÊïóÔºåÂõûÈÄÄÂà∞ RecordRTC:",e),this.usingWorklet=!1,await this._startRecordRTCRecording()}}async _stopWorkletRecording(){try{if(this.pcmCollectorNode&&(this.pcmCollectorNode.port.onmessage=null,this.preGainNode.disconnect(this.pcmCollectorNode),this.pcmCollectorNode.disconnect(),this.pcmCollectorNode=null),0===this.pcmChunks.length)throw new Error("Ê≤íÊúâÈåÑÈü≥Êï∏Êìö");const e=new Float32Array(this.pcmTotalSamples);let t=0;for(const i of this.pcmChunks)e.set(i,t),t+=i.length;const i=this._buildWavFromFloat32Mono(e,this.audioContext.sampleRate),s=new Blob([i],{type:"audio/wav"});return this.usingWorklet=!1,s}catch(e){throw console.error("AudioWorklet ÂÅúÊ≠¢Â§±Êïó:",e),e}}async _startRecordRTCRecording(){return new Promise((e,t)=>{try{if("undefined"==typeof RecordRTC)return void t(new Error("RecordRTC Êú™ËºâÂÖ•"));const i=this.mediaDest.stream||this.micStream;this.recorder=RecordRTC(i,{type:"audio",mimeType:"audio/wav",recorderType:StereoAudioRecorder,numberOfAudioChannels:1,bufferSize:4096,timeSlice:100,ondataavailable:e=>{this._emit("data-available",{blob:e,mode:"recordrtc"})}}),this.recorder.startRecording(),this.usingWorklet=!1,this._startPcmCapture(),e()}catch(e){t(e)}})}async _stopRecordRTCRecording(){return new Promise((e,t)=>{try{if(!this.recorder)return void t(new Error("RecordRTC ÈåÑÈü≥Âô®‰∏çÂ≠òÂú®"));this._stopPcmCapture(),this.recorder.stopRecording(()=>{try{const t=this.recorder.getBlob();this.recorder=null,e(t)}catch(e){t(e)}})}catch(e){t(e)}})}_startPcmCapture(){if(!this.analyser)return;const e=this.analyser.fftSize,t=new Float32Array(e);this._pcmCaptureInterval=setInterval(()=>{if(!this.isRecording||!this.analyser)return;this.analyser.getFloatTimeDomainData(t);const e=new Float32Array(t);this.pcmChunks.push(e),this.pcmTotalSamples+=e.length,this._emit("data-available",{pcmData:e,totalSamples:this.pcmTotalSamples,mode:"recordrtc-pcm"})},100)}_stopPcmCapture(){this._pcmCaptureInterval&&(clearInterval(this._pcmCaptureInterval),this._pcmCaptureInterval=null)}_buildWavFromFloat32Mono(e,t){const i=e.length,s=new ArrayBuffer(44+2*i),a=new DataView(s);this._writeString(a,0,"RIFF"),a.setUint32(4,36+2*i,!0),this._writeString(a,8,"WAVE"),this._writeString(a,12,"fmt "),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,1,!0),a.setUint32(24,t,!0),a.setUint32(28,2*t,!0),a.setUint16(32,2,!0),a.setUint16(34,16,!0),this._writeString(a,36,"data"),a.setUint32(40,2*i,!0);let o=44;for(let t=0;t<i;t++){const i=Math.max(-1,Math.min(1,e[t])),s=i<0?32768*i:32767*i;a.setInt16(o,s,!0),o+=2}return s}_writeString(e,t,i){for(let s=0;s<i.length;s++)e.setUint8(t+s,i.charCodeAt(s))}destroy(){this.isRecording&&this.stopRecording().catch(e=>{console.warn("ÂÅúÊ≠¢ÈåÑÈü≥Â§±Êïó:",e)}),this._stopMicrophone(),this._stopPcmCapture(),this.pcmCollectorNode&&(this.pcmCollectorNode.disconnect(),this.pcmCollectorNode=null),this.audioContext&&(this.audioContext.close().catch(e=>{console.warn("ÈóúÈñâ AudioContext Â§±Êïó:",e)}),this.audioContext=null),this._ownDeviceManager&&this.deviceManager&&(this.deviceManager.destroy(),this.deviceManager=null),this._eventListeners={},this.isInitialized=!1,this.isRecording=!1}},e.BUILD_INFO=h,e.CapacitorAdapter=class extends r{constructor(e="recordings"){if(super(),this.directory=e,"undefined"==typeof window||!window.Capacitor)throw new Error("Capacitor not available. Make sure Capacitor is properly initialized.");this.Capacitor=window.Capacitor,this.initialized=!1}async initialize(){if(!this.initialized)try{const{Filesystem:e,Directory:t}=this.Capacitor.Plugins;try{await e.readdir({path:this.directory,directory:t.Documents})}catch(i){await e.mkdir({path:this.directory,directory:t.Documents,recursive:!0})}this.initialized=!0}catch(e){throw console.error("Capacitor initialization error:",e),e}}async save(e,t,i={}){await this.initialize();try{const{Filesystem:s,Directory:a}=this.Capacitor.Plugins,o=await this.blobToBase64(e);if(await s.writeFile({path:`${this.directory}/${t}`,data:o,directory:a.Documents}),i&&Object.keys(i).length>0){const o={...i,size:e.size,type:e.type,timestamp:Date.now()};await s.writeFile({path:`${this.directory}/${t}.meta.json`,data:JSON.stringify(o),directory:a.Documents,encoding:"utf8"})}return t}catch(e){throw console.error("Capacitor save error:",e),e}}async load(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins,s=await t.readFile({path:`${this.directory}/${e}`,directory:i.Documents});return this.base64ToBlob(s.data,"audio/wav")}catch(e){throw console.error("Capacitor load error:",e),e}}async delete(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins;await t.deleteFile({path:`${this.directory}/${e}`,directory:i.Documents});try{await t.deleteFile({path:`${this.directory}/${e}.meta.json`,directory:i.Documents})}catch(e){}return!0}catch(e){throw console.error("Capacitor delete error:",e),e}}async list(){await this.initialize();try{const{Filesystem:e,Directory:t}=this.Capacitor.Plugins,i=(await e.readdir({path:this.directory,directory:t.Documents})).files.filter(e=>!e.endsWith(".meta.json")),s=await Promise.all(i.map(async i=>{let s={};try{const a=await e.readFile({path:`${this.directory}/${i}.meta.json`,directory:t.Documents,encoding:"utf8"});s=JSON.parse(a.data)}catch(e){}return{id:i,filename:i,metadata:s,timestamp:s.timestamp||0,date:s.timestamp?new Date(s.timestamp):null,size:s.size||0,type:s.type||"audio/wav"}}));return s.sort((e,t)=>t.timestamp-e.timestamp),s}catch(e){return console.error("Capacitor list error:",e),[]}}async getUri(e){await this.initialize();try{const{Filesystem:t,Directory:i}=this.Capacitor.Plugins;return(await t.getUri({path:`${this.directory}/${e}`,directory:i.Documents})).uri}catch(e){throw console.error("Capacitor getUri error:",e),e}}blobToBase64(e){return new Promise((t,i)=>{const s=new FileReader;s.onloadend=()=>{const e=s.result.split(",")[1];t(e)},s.onerror=i,s.readAsDataURL(e)})}base64ToBlob(e,t="audio/wav"){const i=atob(e),s=new Array(i.length);for(let e=0;e<i.length;e++)s[e]=i.charCodeAt(e);const a=new Uint8Array(s);return new Blob([a],{type:t})}async getStorageInfo(){const e=await this.list(),t=e.reduce((e,t)=>e+(t.size||0),0);return{count:e.length,totalSize:t,totalSizeMB:(t/1048576).toFixed(2),recordings:e}}},e.DeviceManager=t,e.ElectronAdapter=class extends r{constructor(e="recordings"){if(super(),this.savePath=e,"undefined"==typeof window||!window.electronAPI)throw new Error("Electron API not available. Make sure preload script is properly configured.");this.electronAPI=window.electronAPI}async save(e,t,i={}){try{const s=await e.arrayBuffer(),a=Array.from(new Uint8Array(s)),o=await this.electronAPI.saveRecording({filename:t,buffer:a,metadata:{...i,size:e.size,type:e.type,timestamp:Date.now()}});if(o.success)return o.id||o.path;throw new Error(o.error||"Save failed")}catch(e){throw console.error("Electron save error:",e),e}}async load(e){try{const t=await this.electronAPI.loadRecording(e),i=new Uint8Array(t);return new Blob([i],{type:"audio/wav"})}catch(e){throw console.error("Electron load error:",e),e}}async delete(e){try{return(await this.electronAPI.deleteRecording(e)).success}catch(e){throw console.error("Electron delete error:",e),e}}async list(e=null){try{return await this.electronAPI.listRecordings(e)||[]}catch(e){return console.error("Electron list error:",e),[]}}async openFile(){try{if(this.electronAPI.openFile)return await this.electronAPI.openFile();throw new Error("openFile API not available")}catch(e){return console.error("Electron openFile error:",e),null}}async saveAs(e,t="recording.wav"){try{const i=await e.arrayBuffer(),s=Array.from(new Uint8Array(i));if(this.electronAPI.saveAs){const e=await this.electronAPI.saveAs({filename:t,buffer:s});return e.success?e.path:null}return await this.save(e,t)}catch(e){return console.error("Electron saveAs error:",e),null}}async showInFolder(e){try{return!!this.electronAPI.showInFolder&&(await this.electronAPI.showInFolder(e),!0)}catch(e){return console.error("Electron showInFolder error:",e),!1}}},e.IndexedDBAdapter=class extends r{constructor(e="VoiceBankDB",t="recordings",i=1){super(),this.dbName=e,this.storeName=t,this.version=i,this.db=null}async initialize(){return this.db?this.db:new Promise((e,t)=>{const i=indexedDB.open(this.dbName,this.version);i.onerror=()=>{t(new Error(`Failed to open IndexedDB: ${i.error}`))},i.onsuccess=()=>{this.db=i.result,e(this.db)},i.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(this.storeName)){const e=t.createObjectStore(this.storeName,{keyPath:"id",autoIncrement:!0});e.createIndex("filename","filename",{unique:!1}),e.createIndex("timestamp","timestamp",{unique:!1}),e.createIndex("duration","duration",{unique:!1})}}})}async save(e,t,i={}){return await this.initialize(),new Promise((s,a)=>{const o=this.db.transaction([this.storeName],"readwrite"),r=o.objectStore(this.storeName),n={filename:t,blob:e,size:e.size,type:e.type,timestamp:Date.now(),metadata:i},c=r.add(n);c.onsuccess=()=>{s(String(c.result))},c.onerror=()=>{a(new Error(`Failed to save recording: ${c.error}`))},o.onerror=()=>{a(new Error(`Transaction failed: ${o.error}`))}})}async load(e){return await this.initialize(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(Number(e));s.onsuccess=()=>{const a=s.result;a&&a.blob?t(a.blob):i(new Error(`Recording not found: ${e}`))},s.onerror=()=>{i(new Error(`Failed to load recording: ${s.error}`))}})}async delete(e){return await this.initialize(),new Promise((t,i)=>{const s=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(Number(e));s.onsuccess=()=>{t(!0)},s.onerror=()=>{i(new Error(`Failed to delete recording: ${s.error}`))}})}async list(){return await this.initialize(),new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();i.onsuccess=()=>{const t=i.result.map(e=>({id:String(e.id),filename:e.filename,size:e.size,type:e.type,timestamp:e.timestamp,date:new Date(e.timestamp),metadata:e.metadata||{}}));e(t)},i.onerror=()=>{t(new Error(`Failed to list recordings: ${i.error}`))}})}async searchByFilename(e){return(await this.list()).filter(t=>t.filename.toLowerCase().includes(e.toLowerCase()))}async getStorageInfo(){const e=await this.list(),t=e.reduce((e,t)=>e+t.size,0);return{count:e.length,totalSize:t,totalSizeMB:(t/1048576).toFixed(2),records:e}}async clear(){return await this.initialize(),new Promise((e,t)=>{const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName),s=i.count();s.onsuccess=()=>{const a=s.result,o=i.clear();o.onsuccess=()=>{e(a)},o.onerror=()=>{t(new Error(`Failed to clear recordings: ${o.error}`))}},s.onerror=()=>{t(new Error(`Failed to count recordings: ${s.error}`))}})}async getStorageEstimate(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{usage:e.usage,quota:e.quota,usageMB:(e.usage/1048576).toFixed(2),quotaMB:(e.quota/1048576).toFixed(2),usagePercent:(e.usage/e.quota*100).toFixed(2)}}catch(e){return console.warn("Failed to get storage estimate:",e),null}return null}close(){this.db&&(this.db.close(),this.db=null)}},e.PlatformDetector=class{static detect(){return"undefined"!=typeof window&&window.electronAPI||"undefined"!=typeof process&&process.versions&&process.versions.electron?"electron":"undefined"!=typeof window&&window.Capacitor?"capacitor":"browser"}static isElectron(){return"electron"===this.detect()}static isCapacitor(){return"capacitor"===this.detect()}static isBrowser(){return"browser"===this.detect()}static isMobile(){return!("undefined"==typeof window||!window.navigator)&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(window.navigator.userAgent)}static supportsAudioWorklet(){if("undefined"==typeof window||!window.AudioContext)return!1;return"audioWorklet"in(window.AudioContext||window.webkitAudioContext).prototype}static supportsOffscreenCanvas(){return"undefined"!=typeof OffscreenCanvas}static getInfo(){return{platform:this.detect(),isElectron:this.isElectron(),isCapacitor:this.isCapacitor(),isBrowser:this.isBrowser(),isMobile:this.isMobile(),supportsAudioWorklet:this.supportsAudioWorklet(),supportsOffscreenCanvas:this.supportsOffscreenCanvas(),userAgent:"undefined"!=typeof navigator?navigator.userAgent:"unknown"}}},e.RecorderUI=class{constructor(e,t={}){if(this.container="string"==typeof e?document.querySelector(e):e,!this.container)throw new Error("Container element not found");this.audioEngine=t.audioEngine,this.waveformRenderer=t.waveformRenderer,this.options={layout:t.layout||"auto",theme:t.theme||"light",showOverview:!1!==t.showOverview,...t},this.callbacks={onRecordStart:t.onRecordStart||(()=>{}),onRecordStop:t.onRecordStop||(()=>{}),onPlayStart:t.onPlayStart||(()=>{}),onPlayStop:t.onPlayStop||(()=>{}),onError:t.onError||(e=>console.error("UI Error:",e)),...t.callbacks},this.elements={},this.state={isRecording:!1,isPlaying:!1,isPaused:!1,hasRecording:!1,duration:0,sampleCount:0},this.controlPanel=null,this.playbackController=null,this.layoutManager=null}async initialize(){try{this.renderUI(),this.cacheElements(),this.bindEvents(),this.initializeSubControllers(),this.applyInitialSettings(),this.connectCoreModules(),console.log("‚úÖ RecorderUI initialized")}catch(e){throw this.callbacks.onError(e),e}}renderUI(){this.container.innerHTML=`\n      <div class="voicebank-recorder" data-layout="${this.options.layout}" data-theme="${this.options.theme}">\n        \x3c!-- ÊéßÂà∂Èù¢Êùø --\x3e\n        <div class="recorder-controls">\n          <button id="vbr-btn-record" class="btn-record">\n            <span class="icon">‚óè</span>\n            <span class="label">ÈñãÂßãÈåÑÈü≥</span>\n          </button>\n          \n          <div class="recording-info">\n            <span id="vbr-recording-duration">00:00.0</span>\n            <span id="vbr-sample-count">0 samples</span>\n          </div>\n        </div>\n        \n        \x3c!-- Ê≥¢ÂΩ¢ÂÆπÂô® --\x3e\n        <div class="waveform-wrapper" id="vbr-waveform-wrapper">\n          \x3c!-- Âç≥ÊôÇÊ≥¢ÂΩ¢ --\x3e\n          <div class="waveform-section">\n            <label>Âç≥ÊôÇÊ≥¢ÂΩ¢</label>\n            <canvas id="vbr-live-waveform" width="800" height="120"></canvas>\n          </div>\n          \n          \x3c!-- VU Meter --\x3e\n          <div class="waveform-section">\n            <label>Èü≥ÈáèË°®</label>\n            <canvas id="vbr-vu-meter" width="800" height="50"></canvas>\n          </div>\n          \n          \x3c!-- Á¥ØÁ©çÊ≥¢ÂΩ¢ --\x3e\n          <div class="waveform-section">\n            <label>Á¥ØÁ©çÊ≥¢ÂΩ¢</label>\n            <canvas id="vbr-accumulated-waveform" width="800" height="200"></canvas>\n          </div>\n          \n          \x3c!-- Ê¶ÇË¶ΩÊ≥¢ÂΩ¢ --\x3e\n          ${this.options.showOverview?'\n          <div class="waveform-section">\n            <label>Ê¶ÇË¶ΩÊ≥¢ÂΩ¢</label>\n            <canvas id="vbr-overview-waveform" width="800" height="80"></canvas>\n          </div>\n          ':""}\n        </div>\n        \n        \x3c!-- Êí≠ÊîæÊéßÂà∂ --\x3e\n        <div class="playback-controls">\n          <button id="vbr-btn-play" class="btn-play" disabled>\n            <span class="icon">‚ñ∂</span>\n            <span class="label">Êí≠Êîæ</span>\n          </button>\n          <button id="vbr-btn-pause" class="btn-pause" disabled>\n            <span class="icon">‚è∏</span>\n            <span class="label">Êö´ÂÅú</span>\n          </button>\n          <button id="vbr-btn-stop" class="btn-stop" disabled>\n            <span class="icon">‚èπ</span>\n            <span class="label">ÂÅúÊ≠¢</span>\n          </button>\n        </div>\n        \n        \x3c!-- Â∑•ÂÖ∑Âàó --\x3e\n        <div class="toolbar">\n          <button id="vbr-btn-save" class="btn-save" disabled>\n            <span class="icon">üíæ</span>\n            <span class="label">ÂÑ≤Â≠ò</span>\n          </button>\n          <button id="vbr-btn-clear" class="btn-clear" disabled>\n            <span class="icon">üóëÔ∏è</span>\n            <span class="label">Ê∏ÖÈô§</span>\n          </button>\n          <button id="vbr-btn-layout-toggle" class="btn-layout-toggle">\n            <span class="icon">üîÑ</span>\n            <span class="label">ÂàáÊèõ‰ΩàÂ±Ä</span>\n          </button>\n        </div>\n      </div>\n    `}cacheElements(){this.elements={btnRecord:document.getElementById("vbr-btn-record"),btnPlay:document.getElementById("vbr-btn-play"),btnPause:document.getElementById("vbr-btn-pause"),btnStop:document.getElementById("vbr-btn-stop"),btnSave:document.getElementById("vbr-btn-save"),btnClear:document.getElementById("vbr-btn-clear"),btnLayoutToggle:document.getElementById("vbr-btn-layout-toggle"),recordingDuration:document.getElementById("vbr-recording-duration"),sampleCount:document.getElementById("vbr-sample-count"),waveformWrapper:document.getElementById("vbr-waveform-wrapper"),liveCanvas:document.getElementById("vbr-live-waveform"),vuMeterCanvas:document.getElementById("vbr-vu-meter"),accumulatedCanvas:document.getElementById("vbr-accumulated-waveform"),overviewCanvas:document.getElementById("vbr-overview-waveform")}}bindEvents(){this.elements.btnRecord&&this.elements.btnRecord.addEventListener("click",()=>{this.handleRecordToggle()}),this.elements.btnPlay&&this.elements.btnPlay.addEventListener("click",()=>{this.handlePlay()}),this.elements.btnPause&&this.elements.btnPause.addEventListener("click",()=>{this.handlePause()}),this.elements.btnStop&&this.elements.btnStop.addEventListener("click",()=>{this.handleStop()}),this.elements.btnSave&&this.elements.btnSave.addEventListener("click",()=>{this.handleSave()}),this.elements.btnClear&&this.elements.btnClear.addEventListener("click",()=>{this.handleClear()}),this.elements.btnLayoutToggle&&this.elements.btnLayoutToggle.addEventListener("click",()=>{this.handleLayoutToggle()}),window.addEventListener("resize",()=>{this.handleResize()})}initializeSubControllers(){}applyInitialSettings(){this.applyLayout(this.options.layout),this.applyTheme(this.options.theme),this.updateButtonStates()}connectCoreModules(){this.audioEngine&&this.waveformRenderer?(this.audioEngine.on("recording-start",()=>{this.onRecordingStart()}),this.audioEngine.on("recording-stop",e=>{this.onRecordingStop(e)}),this.audioEngine.on("data-available",e=>{this.onDataAvailable(e)}),this.audioEngine.on("error",e=>{this.onAudioError(e)})):console.warn("Core modules not provided, UI will have limited functionality")}async handleRecordToggle(){try{this.state.isRecording?await this.audioEngine.stopRecording():await this.audioEngine.startRecording()}catch(e){this.callbacks.onError(e),this.showError("ÈåÑÈü≥Êìç‰ΩúÂ§±ÊïóÔºö"+e.message)}}async handlePlay(){try{console.log("Play recording"),this.callbacks.onPlayStart()}catch(e){this.callbacks.onError(e)}}async handlePause(){try{console.log("Pause playback")}catch(e){this.callbacks.onError(e)}}async handleStop(){try{console.log("Stop playback"),this.callbacks.onPlayStop()}catch(e){this.callbacks.onError(e)}}async handleSave(){try{console.log("Save recording")}catch(e){this.callbacks.onError(e)}}async handleClear(){if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§Áï∂ÂâçÈåÑÈü≥ÂóéÔºü"))try{this.waveformRenderer&&this.waveformRenderer.reset(),this.state.hasRecording=!1,this.state.duration=0,this.state.sampleCount=0,this.updateDurationDisplay(),this.updateButtonStates(),console.log("Recording cleared")}catch(e){this.callbacks.onError(e)}}handleLayoutToggle(){const e="horizontal"===this.container.dataset.layout?"vertical":"horizontal";this.applyLayout(e)}handleResize(){this.waveformRenderer&&this.waveformRenderer.resize()}onRecordingStart(){this.state.isRecording=!0,this.state.hasRecording=!0,this.setRecordingState(!0),this.updateButtonStates(),this.waveformRenderer,this.callbacks.onRecordStart(),console.log("üéôÔ∏è Recording started")}onRecordingStop(e){this.state.isRecording=!1,this.setRecordingState(!1),this.updateButtonStates(),this.callbacks.onRecordStop(e),console.log("‚èπÔ∏è Recording stopped",e)}onDataAvailable(e){void 0!==e.duration&&(this.state.duration=e.duration),void 0!==e.sampleCount&&(this.state.sampleCount=e.sampleCount),this.updateDurationDisplay()}onAudioError(e){this.showError("Èü≥Ë®äÈåØË™§Ôºö"+e.message),this.callbacks.onError(e)}setRecordingState(e){const t=this.elements.btnRecord;t&&(e?(t.classList.add("recording"),t.querySelector(".icon").textContent="‚èπ",t.querySelector(".label").textContent="ÂÅúÊ≠¢ÈåÑÈü≥"):(t.classList.remove("recording"),t.querySelector(".icon").textContent="‚óè",t.querySelector(".label").textContent="ÈñãÂßãÈåÑÈü≥"))}updateButtonStates(){const{isRecording:e,isPlaying:t,isPaused:i,hasRecording:s}=this.state;this.elements.btnRecord&&(this.elements.btnRecord.disabled=t),this.elements.btnPlay&&(this.elements.btnPlay.disabled=!s||e||t),this.elements.btnPause&&(this.elements.btnPause.disabled=!t||i),this.elements.btnStop&&(this.elements.btnStop.disabled=!t&&!i),this.elements.btnSave&&(this.elements.btnSave.disabled=!s||e),this.elements.btnClear&&(this.elements.btnClear.disabled=!s||e)}updateDurationDisplay(){this.elements.recordingDuration&&(this.elements.recordingDuration.textContent=this.formatDuration(this.state.duration)),this.elements.sampleCount&&(this.elements.sampleCount.textContent=`${this.state.sampleCount.toLocaleString()} samples`)}formatDuration(e){const t=Math.floor(e/60),i=Math.floor(e%60),s=Math.floor(e%1*10);return`${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}.${s}`}applyLayout(e){"auto"===e&&(e=window.innerWidth>window.innerHeight?"horizontal":"vertical"),this.container.dataset.layout=e,this.options.layout=e,this.waveformRenderer&&this.waveformRenderer.setVerticalMode("vertical"===e),console.log(`üìê Layout changed to: ${e}`)}applyTheme(e){this.container.dataset.theme=e,this.options.theme=e,console.log(`üé® Theme changed to: ${e}`)}showError(e){alert("ÈåØË™§Ôºö"+e)}showNotice(e,t=3e3){console.log("üì¢ Notice:",e)}getState(){return{...this.state}}setOptions(e){this.options={...this.options,...e},e.layout&&this.applyLayout(e.layout),e.theme&&this.applyTheme(e.theme)}destroy(){this.container&&(this.container.innerHTML=""),this.elements={},this.audioEngine=null,this.waveformRenderer=null,console.log("üóëÔ∏è RecorderUI destroyed")}},e.ServerAdapter=class extends r{constructor(e={}){super(),this.baseURL=e.baseURL||"",this.saveEndpoint=e.saveEndpoint||"/backend/save.php",this.loadEndpoint=e.loadEndpoint||"/public/uploads/",this.deleteEndpoint=e.deleteEndpoint||"/backend/delete.php",this.listEndpoint=e.listEndpoint||"/api/recordings",this.headers=e.headers||{}}async save(e,t,i={}){const s=new FormData;s.append("audio-blob",e),s.append("audio-filename",t),i&&Object.keys(i).length>0&&s.append("metadata",JSON.stringify(i));try{const e=await fetch(this.baseURL+this.saveEndpoint,{method:"POST",body:s,headers:this.headers});if(!e.ok)throw new Error(`Upload failed: ${e.status} ${e.statusText}`);const i=await e.text();if(i.toLowerCase().includes("success"))return t;throw new Error(`Server error: ${i}`)}catch(e){throw console.error("Save error:",e),e}}async load(e){try{const t=this.baseURL+this.loadEndpoint+e,i=await fetch(t,{headers:this.headers});if(!i.ok)throw new Error(`Load failed: ${i.status} ${i.statusText}`);return await i.blob()}catch(e){throw console.error("Load error:",e),e}}async delete(e){try{const t=await fetch(this.baseURL+this.deleteEndpoint,{method:"POST",headers:{"Content-Type":"application/json",...this.headers},body:JSON.stringify({filename:e})});if(!t.ok)throw new Error(`Delete failed: ${t.status} ${t.statusText}`);return(await t.text()).toLowerCase().includes("success")}catch(e){throw console.error("Delete error:",e),e}}async list(){try{const e=await fetch(this.baseURL+this.listEndpoint,{headers:this.headers});if(!e.ok)throw new Error(`List failed: ${e.status} ${e.statusText}`);const t=await e.json();return Array.isArray(t)?t:[]}catch(e){return console.error("List error:",e),[]}}async saveWithProgress(e,t,i={},s=null){return new Promise((a,o)=>{const r=new FormData;r.append("audio-blob",e),r.append("audio-filename",t),i&&Object.keys(i).length>0&&r.append("metadata",JSON.stringify(i));const n=new XMLHttpRequest;s&&n.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=e.loaded/e.total*100;s(t)}}),n.addEventListener("load",()=>{if(n.status>=200&&n.status<300){const e=n.responseText;e.toLowerCase().includes("success")?a(t):o(new Error(`Server error: ${e}`))}else o(new Error(`Upload failed: ${n.status} ${n.statusText}`))}),n.addEventListener("error",()=>{o(new Error("Network error during upload"))}),n.addEventListener("abort",()=>{o(new Error("Upload cancelled"))}),n.open("POST",this.baseURL+this.saveEndpoint),Object.keys(this.headers).forEach(e=>{n.setRequestHeader(e,this.headers[e])}),n.send(r)})}},e.StorageAdapter=r,e.StorageFactory=class{static create(e={}){const t=e.type||"auto",i=e.options||{};if("auto"===t)return this.createAuto(i);switch(t.toLowerCase()){case"browser":case"indexeddb":const{IndexedDBAdapter:e}=require("./IndexedDBAdapter.js");return new e(i.dbName,i.storeName,i.version);case"electron":const{ElectronAdapter:s}=require("./ElectronAdapter.js");return new s(i.savePath);case"capacitor":const{CapacitorAdapter:a}=require("./CapacitorAdapter.js");return new a(i.directory);case"server":case"php":case"nodejs":const{ServerAdapter:o}=require("./ServerAdapter.js");return new o(i);default:throw new Error(`Unknown storage type: ${t}`)}}static createAuto(e={}){if("undefined"!=typeof window&&window.electronAPI){const{ElectronAdapter:t}=require("./ElectronAdapter.js");return new t(e.savePath)}if("undefined"!=typeof window&&window.Capacitor){const{CapacitorAdapter:t}=require("./CapacitorAdapter.js");return new t(e.directory)}const{IndexedDBAdapter:t}=require("./IndexedDBAdapter.js");return new t(e.dbName,e.storeName,e.version)}},e.VERSION=c,e.VoiceBankRecorder=n,e.WaveformRenderer=class{constructor(e={}){this.options={workerPath:e.workerPath||"workers/wf-worker.js",useWorker:!1!==e.useWorker,showClipMarks:!1!==e.showClipMarks,...e},this.audioEngine=e.audioEngine,this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null,this.isVerticalMode=!1,this._overviewUpdateScheduled=!1,this.audioEngine&&this._setupAudioEngineListeners()}_setupAudioEngineListeners(){this.audioEngine&&(this.audioEngine.on("recording-start",()=>{this.start()}),this.audioEngine.on("recording-stop",()=>{this.stopLive()}),this.audioEngine.on("data-available",e=>{e.pcmData&&this.accumulatedWaveform&&this.appendPCM(e.pcmData)}))}async initialize(){const{liveCanvas:e,vuMeterCanvas:t,accumulatedCanvas:r,overviewCanvas:n}=this.options;let c=this.options.analyserNode;!c&&this.audioEngine&&"function"==typeof this.audioEngine.getAnalyser&&(c=this.audioEngine.getAnalyser()),e&&c&&(this.liveWaveform=new i(e,c)),t&&c&&(this.vuMeter=new s(t,c)),r&&(this.accumulatedWaveform=new a(r,{workerPath:this.options.workerPath,useWorker:this.options.useWorker,showClipMarks:this.options.showClipMarks})),n&&this.accumulatedWaveform&&(this.overviewWaveform=new o(n,this.accumulatedWaveform),this.accumulatedWaveform.overviewWaveform=this.overviewWaveform)}startLive(e,t,i){this.liveWaveform&&this.liveWaveform.start(e,t,i),this.vuMeter&&this.vuMeter.start()}start(){if(!this.audioEngine)return void console.warn("No audioEngine provided, cannot start waveform rendering");const e=this.audioEngine.microphoneStream,t=this.audioEngine.audioContext,i=this.audioEngine.preGainNode;e&&t&&this.startLive(e,t,i)}stopLive(){this.liveWaveform&&this.liveWaveform.stop(),this.vuMeter&&this.vuMeter.stop()}appendPCM(e){this.accumulatedWaveform&&(this.accumulatedWaveform.append(e),this.overviewWaveform&&(this._overviewUpdateScheduled||(this._overviewUpdateScheduled=!0,requestAnimationFrame(()=>{this.overviewWaveform&&this.overviewWaveform.draw(),this._overviewUpdateScheduled=!1}))))}reset(){this.accumulatedWaveform&&this.accumulatedWaveform.reset(),this.overviewWaveform&&this.overviewWaveform.clear()}clear(){this.liveWaveform&&this.liveWaveform.canvasContext.clearRect(0,0,this.liveWaveform.width,this.liveWaveform.height),this.vuMeter&&this.vuMeter.clear(),this.accumulatedWaveform&&this.accumulatedWaveform.clear(),this.overviewWaveform&&this.overviewWaveform.clear()}setVerticalMode(e){this.isVerticalMode=e,this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"setVerticalMode",verticalMode:e})}resize(){this.liveWaveform&&(this.liveWaveform.width=this.liveWaveform.canvas.width,this.liveWaveform.height=this.liveWaveform.canvas.height),this.vuMeter&&this.vuMeter.resize(),this.accumulatedWaveform&&(this.accumulatedWaveform.width=this.accumulatedWaveform.canvas.width,this.accumulatedWaveform.height=this.accumulatedWaveform.canvas.height,this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.postMessage({type:"resize",width:this.accumulatedWaveform.width,height:this.accumulatedWaveform.height}),this.accumulatedWaveform.draw()),this.overviewWaveform&&(this.overviewWaveform.width=this.overviewWaveform.canvas.width,this.overviewWaveform.height=this.overviewWaveform.canvas.height,this.overviewWaveform.draw())}destroy(){this.stopLive(),this.accumulatedWaveform&&this.accumulatedWaveform._worker&&this.accumulatedWaveform._worker.terminate(),this.liveWaveform=null,this.vuMeter=null,this.accumulatedWaveform=null,this.overviewWaveform=null}},e.default=n,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=voicebank-recorder.min.js.map
