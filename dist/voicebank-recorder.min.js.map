{"version":3,"file":"voicebank-recorder.min.js","sources":["../src/core/DeviceManager.js","../src/core/AudioEngine.js","../src/core/WaveformRenderer.js","../src/storage/StorageAdapter.js","../src/index.js","../src/storage/CapacitorAdapter.js","../src/storage/ElectronAdapter.js","../src/storage/IndexedDBAdapter.js","../src/utils/PlatformDetector.js","../src/storage/ServerAdapter.js","../src/storage/index.js","../src/ui/VoiceBankRecorderUI.js"],"sourcesContent":["/**\n * DeviceManager.js\n * 音訊裝置管理模組 - 處理麥克風和輸出裝置的列舉、選擇、記憶\n * \n * @module DeviceManager\n * @description 提供完整的音訊裝置管理功能，包含：\n * - 裝置列舉 (enumerateDevices)\n * - 裝置選擇與記憶 (localStorage)\n * - 裝置變更偵測 (devicechange event)\n * - 跨平台相容性處理\n */\n\n/**\n * DeviceManager - 音訊裝置管理器\n * 統一管理麥克風和輸出裝置的列舉、選擇與持久化\n */\nexport class DeviceManager {\n    /**\n     * @param {Object} options - 配置選項\n     * @param {string} [options.micStorageKey='preferredMicDeviceId'] - 麥克風偏好設定的 localStorage key\n     * @param {string} [options.outputStorageKey='preferredOutputDeviceId'] - 輸出裝置偏好設定的 localStorage key\n     * @param {boolean} [options.autoLoadPreferences=true] - 是否自動載入上次的偏好設定\n     * @param {boolean} [options.autoRequestPermission=true] - 列舉前是否自動請求麥克風權限\n     */\n    constructor(options = {}) {\n        this.options = {\n            micStorageKey: 'preferredMicDeviceId',\n            outputStorageKey: 'preferredOutputDeviceId',\n            autoLoadPreferences: true,\n            autoRequestPermission: true,\n            ...options\n        };\n        \n        // 裝置清單\n        this.microphoneDevices = [];\n        this.outputDevices = [];\n        \n        // 當前選擇的裝置 ID\n        this.selectedMicDeviceId = '';\n        this.selectedOutputDeviceId = 'default';\n        \n        // 事件監聽器\n        this._eventListeners = {\n            'devicechange': [],\n            'micchange': [],\n            'outputchange': []\n        };\n        \n        // 裝置變更監聽器\n        this._deviceChangeListener = null;\n        \n        // 自動載入偏好設定\n        if (this.options.autoLoadPreferences) {\n            this.loadPreferences();\n        }\n    }\n    \n    /**\n     * 從 localStorage 載入上次的裝置偏好設定\n     */\n    loadPreferences() {\n        console.log('[DeviceManager] loadPreferences 被呼叫');\n        \n        try {\n            const savedMicId = localStorage.getItem(this.options.micStorageKey);\n            const savedOutputId = localStorage.getItem(this.options.outputStorageKey);\n            \n            console.log(`[DeviceManager] localStorage 中的值:`);\n            console.log(`  - ${this.options.micStorageKey}: \"${savedMicId}\"`);\n            console.log(`  - ${this.options.outputStorageKey}: \"${savedOutputId}\"`);\n            \n            if (savedMicId) {\n                this.selectedMicDeviceId = savedMicId;\n                console.log(`[DeviceManager] 已載入麥克風偏好: ${savedMicId}`);\n            } else {\n                console.log(`[DeviceManager] 沒有儲存的麥克風偏好`);\n            }\n            \n            if (savedOutputId) {\n                this.selectedOutputDeviceId = savedOutputId;\n                console.log(`[DeviceManager] 已載入輸出裝置偏好: ${savedOutputId}`);\n            } else {\n                console.log(`[DeviceManager] 沒有儲存的輸出裝置偏好，使用 default`);\n            }\n        } catch (error) {\n            console.warn('[DeviceManager] Failed to load device preferences:', error);\n        }\n    }\n    \n    /**\n     * 儲存裝置偏好設定到 localStorage\n     * @param {string} type - 'microphone' 或 'output'\n     * @param {string} deviceId - 裝置 ID\n     */\n    savePreference(type, deviceId) {\n        try {\n            if (type === 'microphone') {\n                localStorage.setItem(this.options.micStorageKey, deviceId);\n                this.selectedMicDeviceId = deviceId;\n            } else if (type === 'output') {\n                localStorage.setItem(this.options.outputStorageKey, deviceId);\n                this.selectedOutputDeviceId = deviceId;\n            }\n        } catch (error) {\n            console.warn('Failed to save device preference:', error);\n        }\n    }\n    \n    /**\n     * 檢查瀏覽器是否支援裝置列舉\n     * @returns {boolean}\n     */\n    isSupported() {\n        return !!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices);\n    }\n    \n    /**\n     * 請求麥克風權限（必要時）\n     * @returns {Promise<void>}\n     */\n    async requestMicrophonePermission() {\n        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {\n            throw new Error('getUserMedia is not supported in this browser');\n        }\n        \n        try {\n            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\n            // 立即停止所有 track，只是為了獲取權限\n            stream.getTracks().forEach(track => track.stop());\n        } catch (error) {\n            throw new Error(`Failed to request microphone permission: ${error.message}`);\n        }\n    }\n    \n    /**\n     * 列舉所有麥克風裝置\n     * @param {boolean} [requestPermission=true] - 是否先請求權限\n     * @returns {Promise<Array>} 麥克風裝置清單\n     */\n    async enumerateMicrophones(requestPermission = this.options.autoRequestPermission) {\n        if (!this.isSupported()) {\n            throw new Error('Device enumeration is not supported in this browser');\n        }\n        \n        try {\n            // 如果需要，先請求權限\n            if (requestPermission) {\n                try {\n                    await this.requestMicrophonePermission();\n                } catch (error) {\n                    // 忽略權限錯誤，繼續嘗試列舉（可能已經有權限）\n                    console.warn('Permission request failed, continuing anyway:', error);\n                }\n            }\n            \n            // 列舉所有裝置\n            const devices = await navigator.mediaDevices.enumerateDevices();\n            this.microphoneDevices = devices.filter(device => device.kind === 'audioinput');\n            \n            return this.microphoneDevices;\n        } catch (error) {\n            throw new Error(`Failed to enumerate microphones: ${error.message}`);\n        }\n    }\n    \n    /**\n     * 列舉所有輸出裝置\n     * @returns {Promise<Array>} 輸出裝置清單\n     */\n    async enumerateOutputDevices() {\n        if (!this.isSupported()) {\n            throw new Error('Device enumeration is not supported in this browser');\n        }\n        \n        try {\n            const devices = await navigator.mediaDevices.enumerateDevices();\n            this.outputDevices = devices.filter(device => device.kind === 'audiooutput');\n            \n            return this.outputDevices;\n        } catch (error) {\n            throw new Error(`Failed to enumerate output devices: ${error.message}`);\n        }\n    }\n    \n    /**\n     * 列舉所有裝置（麥克風 + 輸出）\n     * @param {boolean} [requestPermission=true] - 是否先請求麥克風權限\n     * @returns {Promise<Object>} { microphones, outputs }\n     */\n    async enumerateAllDevices(requestPermission = this.options.autoRequestPermission) {\n        const [microphones, outputs] = await Promise.all([\n            this.enumerateMicrophones(requestPermission),\n            this.enumerateOutputDevices()\n        ]);\n        \n        return { microphones, outputs };\n    }\n    \n    /**\n     * 選擇麥克風裝置\n     * @param {string} deviceId - 裝置 ID\n     * @param {boolean} [save=true] - 是否儲存偏好設定\n     */\n    selectMicrophone(deviceId, save = true) {\n        console.log(`[DeviceManager] selectMicrophone 被呼叫:`, { deviceId, save });\n        console.log(`[DeviceManager] 變更前: selectedMicDeviceId = \"${this.selectedMicDeviceId}\"`);\n        \n        this.selectedMicDeviceId = deviceId;\n        \n        console.log(`[DeviceManager] 變更後: selectedMicDeviceId = \"${this.selectedMicDeviceId}\"`);\n        \n        if (save) {\n            this.savePreference('microphone', deviceId);\n            console.log(`[DeviceManager] 已儲存至 localStorage (${this.options.micStorageKey})`);\n        }\n        \n        // 觸發 micchange 事件\n        this._emit('micchange', { deviceId });\n    }\n    \n    /**\n     * 選擇輸出裝置\n     * @param {string} deviceId - 裝置 ID\n     * @param {boolean} [save=true] - 是否儲存偏好設定\n     */\n    selectOutputDevice(deviceId, save = true) {\n        this.selectedOutputDeviceId = deviceId;\n        \n        if (save) {\n            this.savePreference('output', deviceId);\n        }\n        \n        // 觸發 outputchange 事件\n        this._emit('outputchange', { deviceId });\n    }\n    \n    /**\n     * 取得當前選擇的麥克風裝置 ID\n     * @returns {string}\n     */\n    getSelectedMicrophoneId() {\n        return this.selectedMicDeviceId;\n    }\n    \n    /**\n     * 取得當前選擇的輸出裝置 ID\n     * @returns {string}\n     */\n    getSelectedOutputDeviceId() {\n        return this.selectedOutputDeviceId;\n    }\n    \n    /**\n     * 取得當前選擇的麥克風裝置資訊\n     * @returns {MediaDeviceInfo|null}\n     */\n    getSelectedMicrophone() {\n        return this.microphoneDevices.find(device => device.deviceId === this.selectedMicDeviceId) || null;\n    }\n    \n    /**\n     * 取得當前選擇的輸出裝置資訊\n     * @returns {MediaDeviceInfo|null}\n     */\n    getSelectedOutputDevice() {\n        return this.outputDevices.find(device => device.deviceId === this.selectedOutputDeviceId) || null;\n    }\n    \n    /**\n     * 建立適用於 getUserMedia 的約束條件\n     * @param {Object} [additionalConstraints={}] - 額外的音訊約束\n     * @returns {Object} MediaStreamConstraints\n     */\n    getMicrophoneConstraints(additionalConstraints = {}) {\n        console.log(`[DeviceManager] getMicrophoneConstraints 被呼叫`);\n        console.log(`[DeviceManager] 當前 selectedMicDeviceId = \"${this.selectedMicDeviceId}\"`);\n        \n        const constraints = {\n            audio: {\n                ...additionalConstraints\n            },\n            video: false\n        };\n        \n        // 如果有選擇特定裝置，加入 deviceId 約束\n        if (this.selectedMicDeviceId) {\n            constraints.audio.deviceId = { exact: this.selectedMicDeviceId };\n            console.log(`[DeviceManager] 已加入 deviceId 約束: ${this.selectedMicDeviceId}`);\n        } else {\n            console.log(`[DeviceManager] 沒有選擇特定裝置，使用系統預設`);\n        }\n        \n        return constraints;\n    }\n    \n    /**\n     * 為 Audio 元素設定輸出裝置\n     * @param {HTMLAudioElement} audioElement - Audio 元素\n     * @param {string} [deviceId] - 裝置 ID（不提供則使用當前選擇的裝置）\n     * @returns {Promise<void>}\n     */\n    async setAudioOutputDevice(audioElement, deviceId) {\n        const targetDeviceId = deviceId || this.selectedOutputDeviceId;\n        \n        // 檢查瀏覽器是否支援 setSinkId\n        if (typeof audioElement.setSinkId !== 'function') {\n            console.warn('setSinkId is not supported in this browser');\n            return;\n        }\n        \n        try {\n            await audioElement.setSinkId(targetDeviceId);\n        } catch (error) {\n            throw new Error(`Failed to set audio output device: ${error.message}`);\n        }\n    }\n    \n    /**\n     * 檢查指定裝置是否仍然存在\n     * @param {string} deviceId - 裝置 ID\n     * @param {string} type - 'microphone' 或 'output'\n     * @returns {boolean}\n     */\n    isDeviceAvailable(deviceId, type) {\n        const devices = type === 'microphone' ? this.microphoneDevices : this.outputDevices;\n        return devices.some(device => device.deviceId === deviceId);\n    }\n    \n    /**\n     * 啟動裝置變更監聽\n     * 當裝置插拔時自動重新列舉\n     */\n    startDeviceChangeMonitoring() {\n        if (!navigator.mediaDevices || this._deviceChangeListener) {\n            return; // 不支援或已經在監聽\n        }\n        \n        this._deviceChangeListener = async () => {\n            try {\n                // 重新列舉裝置\n                await this.enumerateAllDevices(false); // 不需要重新請求權限\n                \n                // 觸發 devicechange 事件\n                this._emit('devicechange', {\n                    microphones: this.microphoneDevices,\n                    outputs: this.outputDevices\n                });\n            } catch (error) {\n                console.error('Device change enumeration failed:', error);\n            }\n        };\n        \n        navigator.mediaDevices.addEventListener('devicechange', this._deviceChangeListener);\n    }\n    \n    /**\n     * 停止裝置變更監聽\n     */\n    stopDeviceChangeMonitoring() {\n        if (this._deviceChangeListener && navigator.mediaDevices) {\n            navigator.mediaDevices.removeEventListener('devicechange', this._deviceChangeListener);\n            this._deviceChangeListener = null;\n        }\n    }\n    \n    /**\n     * 註冊事件監聽器\n     * @param {string} event - 事件名稱 ('devicechange', 'micchange', 'outputchange')\n     * @param {function} callback - 回調函數\n     */\n    on(event, callback) {\n        if (!this._eventListeners[event]) {\n            console.warn(`Unknown event: ${event}`);\n            return;\n        }\n        \n        this._eventListeners[event].push(callback);\n    }\n    \n    /**\n     * 移除事件監聽器\n     * @param {string} event - 事件名稱\n     * @param {function} callback - 回調函數\n     */\n    off(event, callback) {\n        if (!this._eventListeners[event]) {\n            return;\n        }\n        \n        const index = this._eventListeners[event].indexOf(callback);\n        if (index > -1) {\n            this._eventListeners[event].splice(index, 1);\n        }\n    }\n    \n    /**\n     * 觸發事件\n     * @private\n     */\n    _emit(event, data) {\n        if (!this._eventListeners[event]) {\n            return;\n        }\n        \n        this._eventListeners[event].forEach(callback => {\n            try {\n                callback(data);\n            } catch (error) {\n                console.error(`Error in ${event} event handler:`, error);\n            }\n        });\n    }\n    \n    /**\n     * 銷毀 DeviceManager，清理資源\n     */\n    destroy() {\n        this.stopDeviceChangeMonitoring();\n        this._eventListeners = {\n            'devicechange': [],\n            'micchange': [],\n            'outputchange': []\n        };\n        this.microphoneDevices = [];\n        this.outputDevices = [];\n    }\n}\n\nexport default DeviceManager;\n","import DeviceManager from './DeviceManager.js';\n\n/**\n * AudioEngine - 跨平台音訊錄音引擎\n * \n * 功能：\n * - 封裝 Web Audio API (AudioContext, AudioWorklet)\n * - 支援 RecordRTC 錄音 (WAV 格式)\n * - 自動處理 AudioWorklet 與 ScriptProcessor fallback\n * - 提供錄音控制 (開始/停止/暫停/繼續)\n * - 事件驅動架構 (recording-start, data-available, recording-stop 等)\n * - 麥克風輸入管理與前級增益控制\n * - 整合裝置管理 (DeviceManager)\n * \n * @example\n * const engine = new AudioEngine({\n *   sampleRate: 48000,\n *   autoGainControl: false,\n *   micGain: 1.0\n * });\n * \n * engine.on('recording-start', () => console.log('Started'));\n * engine.on('data-available', (pcmData) => console.log('PCM chunk', pcmData));\n * engine.on('recording-stop', (blob) => console.log('Finished', blob));\n * \n * await engine.initialize();\n * await engine.startRecording();\n * // ... 錄音中 ...\n * await engine.stopRecording();\n */\n\nexport class AudioEngine {\n    /**\n     * 創建 AudioEngine 實例\n     * @param {Object} options - 配置選項\n     * @param {number} [options.sampleRate=48000] - 採樣率\n     * @param {boolean} [options.autoGainControl=false] - 自動增益控制\n     * @param {boolean} [options.echoCancellation=false] - 回音消除\n     * @param {boolean} [options.noiseSuppression=false] - 噪音抑制\n     * @param {number} [options.micGain=1.0] - 前級增益 (1.0-6.0)\n     * @param {string} [options.deviceId] - 麥克風設備 ID\n     * @param {string} [options.workletPath='assets/js/worklet/pcm-collector.js'] - AudioWorklet 模組路徑\n     * @param {boolean} [options.preferWorklet=true] - 優先使用 AudioWorklet（支援時）\n     * @param {DeviceManager} [options.deviceManager] - 外部提供的 DeviceManager 實例（可選）\n     * @param {boolean} [options.autoManageDevices=true] - 是否自動創建和管理 DeviceManager\n     */\n    constructor(options = {}) {\n        // 配置選項\n        this.config = {\n            sampleRate: options.sampleRate || 48000,\n            autoGainControl: options.autoGainControl !== undefined ? options.autoGainControl : false,\n            echoCancellation: options.echoCancellation !== undefined ? options.echoCancellation : false,\n            noiseSuppression: options.noiseSuppression !== undefined ? options.noiseSuppression : false,\n            micGain: options.micGain || 1.0,\n            deviceId: options.deviceId || null,\n            workletPath: options.workletPath || 'assets/js/worklet/pcm-collector.js',\n            preferWorklet: options.preferWorklet !== undefined ? options.preferWorklet : true,\n            autoManageDevices: options.autoManageDevices !== undefined ? options.autoManageDevices : true\n        };\n        \n        // 裝置管理器\n        if (options.deviceManager) {\n            this.deviceManager = options.deviceManager;\n            this._ownDeviceManager = false;\n        } else if (this.config.autoManageDevices) {\n            this.deviceManager = new DeviceManager();\n            this._ownDeviceManager = true;\n        } else {\n            this.deviceManager = null;\n            this._ownDeviceManager = false;\n        }\n\n        // Web Audio API 物件\n        this.audioContext = null;\n        this.analyser = null;\n        this.preGainNode = null;\n        this.mediaDest = null;\n        this.analyserSilencer = null;\n\n        // AudioWorklet 相關\n        this.workletSupported = false;\n        this.workletLoaded = false;\n        this.pcmCollectorNode = null;\n        this.usingWorklet = false;\n\n        // PCM 數據收集 (AudioWorklet 模式)\n        this.pcmChunks = [];\n        this.pcmTotalSamples = 0;\n\n        // RecordRTC 錄音器\n        this.recorder = null;\n        \n        // RecordRTC 模式 PCM 採集\n        this._pcmCaptureInterval = null;\n\n        // 麥克風串流\n        this.micStream = null;\n\n        // 錄音狀態\n        this.isRecording = false;\n        this.isPaused = false;\n        this.isInitialized = false;\n\n        // 時間戳記\n        this.recordStartTime = 0;\n        this.recordStopTime = 0;\n        this.recordWallStartMs = 0;\n        this.recordWallStopMs = 0;\n\n        // 最後的錄音結果\n        this.latestBlob = null;\n        this.latestUrl = null;\n\n        // 事件監聽器\n        this._eventListeners = {};\n    }\n\n    /**\n     * 初始化音訊引擎\n     * 創建 AudioContext、Analyser、Gain 節點等\n     * @returns {Promise<void>}\n     */\n    async initialize() {\n        if (this.isInitialized) {\n            return;\n        }\n\n        try {\n            // 創建 AudioContext\n            // 注意：不指定 sampleRate，讓 AudioContext 使用硬體預設值\n            // 這樣可以避免 \"different sample-rate\" 錯誤\n            const AudioContextClass = window.AudioContext || window.webkitAudioContext;\n            this.audioContext = new AudioContextClass();\n            \n            // 記錄實際使用的採樣率\n            console.log(`[AudioEngine] AudioContext 採樣率: ${this.audioContext.sampleRate} Hz`);\n            console.log(`[AudioEngine] 配置要求的採樣率: ${this.config.sampleRate} Hz`);\n            if (this.audioContext.sampleRate !== this.config.sampleRate) {\n                console.warn(`[AudioEngine] 注意：實際採樣率 (${this.audioContext.sampleRate}) 與配置 (${this.config.sampleRate}) 不同`);\n            }\n\n            // 創建分析器節點\n            this.analyser = this.audioContext.createAnalyser();\n            this.analyser.fftSize = 256;\n\n            // 創建前級增益節點\n            this.preGainNode = this.audioContext.createGain();\n            this.preGainNode.gain.value = this.config.micGain;\n\n            // 創建 MediaStreamDestination（供 RecordRTC 使用）\n            this.mediaDest = this.audioContext.createMediaStreamDestination();\n\n            // 連接節點：preGain -> analyser -> silencer -> destination\n            this.preGainNode.connect(this.analyser);\n            this.preGainNode.connect(this.mediaDest);\n\n            // 創建靜音節點（避免回授）\n            this.analyserSilencer = this.audioContext.createGain();\n            this.analyserSilencer.gain.value = 0;\n            this.analyser.connect(this.analyserSilencer);\n            this.analyserSilencer.connect(this.audioContext.destination);\n\n            // 檢測 AudioWorklet 支援\n            this.workletSupported = !!(\n                this.audioContext.audioWorklet && \n                window.AudioWorkletNode\n            );\n\n            // 載入 AudioWorklet 模組（如果支援且偏好使用）\n            if (this.workletSupported && this.config.preferWorklet) {\n                try {\n                    await this.audioContext.audioWorklet.addModule(this.config.workletPath);\n                    this.workletLoaded = true;\n                    this._emit('worklet-loaded', { path: this.config.workletPath });\n                } catch (error) {\n                    console.warn('載入 AudioWorklet 模組失敗，將回退到 RecordRTC:', error);\n                    this.workletLoaded = false;\n                    this._emit('worklet-load-failed', { error });\n                }\n            }\n\n            // 恢復 AudioContext（如果暫停）\n            if (this.audioContext.state === 'suspended') {\n                await this.audioContext.resume();\n            }\n\n            this.isInitialized = true;\n            this._emit('initialized', {\n                sampleRate: this.audioContext.sampleRate,\n                state: this.audioContext.state,\n                workletSupported: this.workletSupported,\n                workletLoaded: this.workletLoaded\n            });\n\n        } catch (error) {\n            this._emit('error', { stage: 'initialize', error });\n            throw error;\n        }\n    }\n\n    /**\n     * 開始錄音\n     * @returns {Promise<void>}\n     */\n    async startRecording() {\n        if (!this.isInitialized) {\n            throw new Error('AudioEngine 尚未初始化，請先調用 initialize()');\n        }\n\n        if (this.isRecording) {\n            throw new Error('已經在錄音中');\n        }\n\n        try {\n            // 確保 AudioContext 是活躍狀態\n            if (this.audioContext.state === 'suspended') {\n                await this.audioContext.resume();\n            }\n\n            // 停止舊的麥克風串流（如果存在）\n            this._stopMicrophone();\n\n            // 獲取麥克風（會使用 DeviceManager 選擇的裝置）\n            await this._captureMicrophone();\n\n            // 重置 PCM 數據收集\n            this.pcmChunks = [];\n            this.pcmTotalSamples = 0;\n\n            // 清理舊的錄音結果\n            if (this.latestUrl) {\n                URL.revokeObjectURL(this.latestUrl);\n                this.latestUrl = null;\n            }\n            this.latestBlob = null;\n\n            // 記錄開始時間\n            this.recordStartTime = Date.now();\n            this.recordWallStartMs = performance.now();\n            this.recordStopTime = 0;\n            this.recordWallStopMs = 0;\n\n            // 決定使用 AudioWorklet 或 RecordRTC\n            const useWorklet = this.workletLoaded && this.config.preferWorklet;\n\n            if (useWorklet) {\n                await this._startWorkletRecording();\n            } else {\n                await this._startRecordRTCRecording();\n            }\n\n            this.isRecording = true;\n            this.isPaused = false;\n\n            this._emit('recording-start', {\n                timestamp: this.recordStartTime,\n                mode: useWorklet ? 'worklet' : 'recordrtc',\n                sampleRate: this.audioContext.sampleRate\n            });\n\n        } catch (error) {\n            this._emit('error', { stage: 'start-recording', error });\n            throw error;\n        }\n    }\n\n    /**\n     * 停止錄音\n     * @returns {Promise<Blob>} 錄音的 Blob\n     */\n    async stopRecording() {\n        if (!this.isRecording) {\n            throw new Error('目前沒有在錄音');\n        }\n\n        try {\n            this.isRecording = false;\n            this.recordStopTime = Date.now();\n            this.recordWallStopMs = performance.now();\n\n            let blob;\n\n            if (this.usingWorklet) {\n                blob = await this._stopWorkletRecording();\n            } else if (this.recorder) {\n                blob = await this._stopRecordRTCRecording();\n            } else {\n                throw new Error('沒有可用的錄音器');\n            }\n\n            // 停止麥克風\n            this._stopMicrophone();\n\n            // 儲存結果\n            this.latestBlob = blob;\n            this.latestUrl = URL.createObjectURL(blob);\n\n            const duration = (this.recordStopTime - this.recordStartTime) / 1000;\n\n            this._emit('recording-stop', {\n                blob,\n                url: this.latestUrl,\n                duration,\n                samples: this.pcmTotalSamples,\n                sampleRate: this.audioContext.sampleRate\n            });\n\n            return blob;\n\n        } catch (error) {\n            this._emit('error', { stage: 'stop-recording', error });\n            throw error;\n        }\n    }\n\n    /**\n     * 暫停錄音（僅 RecordRTC 模式支援）\n     */\n    pauseRecording() {\n        if (!this.isRecording) {\n            throw new Error('目前沒有在錄音');\n        }\n\n        if (this.usingWorklet) {\n            throw new Error('AudioWorklet 模式不支援暫停功能');\n        }\n\n        if (this.recorder && typeof this.recorder.pauseRecording === 'function') {\n            this.recorder.pauseRecording();\n            this.isPaused = true;\n            this._emit('recording-paused', { timestamp: Date.now() });\n        } else {\n            throw new Error('暫停功能不可用');\n        }\n    }\n\n    /**\n     * 繼續錄音（僅 RecordRTC 模式支援）\n     */\n    resumeRecording() {\n        if (!this.isPaused) {\n            throw new Error('錄音沒有暫停');\n        }\n\n        if (this.recorder && typeof this.recorder.resumeRecording === 'function') {\n            this.recorder.resumeRecording();\n            this.isPaused = false;\n            this._emit('recording-resumed', { timestamp: Date.now() });\n        } else {\n            throw new Error('繼續錄音功能不可用');\n        }\n    }\n\n    /**\n     * 取得最新的錄音數據\n     * @returns {Object} { blob, url, duration, samples }\n     */\n    getLatestRecording() {\n        return {\n            blob: this.latestBlob,\n            url: this.latestUrl,\n            duration: this.latestBlob ? (this.recordStopTime - this.recordStartTime) / 1000 : 0,\n            samples: this.pcmTotalSamples,\n            sampleRate: this.audioContext ? this.audioContext.sampleRate : 0\n        };\n    }\n\n    /**\n     * 取得 PCM 數據視窗（僅 AudioWorklet 模式）\n     * @param {number} start - 起始樣本索引\n     * @param {number} count - 樣本數量\n     * @returns {Float32Array|null}\n     */\n    getPcmWindow(start, count) {\n        if (!this.usingWorklet || !this.pcmChunks.length) {\n            return null;\n        }\n\n        if (start < 0) start = 0;\n        const total = this.pcmTotalSamples;\n        if (start >= total) return new Float32Array(0);\n\n        const end = Math.min(total, start + count);\n        const out = new Float32Array(end - start);\n        let offset = 0;\n        let passed = 0;\n\n        for (let i = 0; i < this.pcmChunks.length && passed < end; i++) {\n            const chunk = this.pcmChunks[i];\n            if (!chunk || !chunk.length) continue;\n\n            const cLen = chunk.length;\n            const cStart = passed;\n            const cEnd = passed + cLen;\n\n            if (cEnd <= start) {\n                passed = cEnd;\n                continue;\n            }\n\n            const segStart = Math.max(start, cStart);\n            const segEnd = Math.min(end, cEnd);\n\n            if (segEnd > segStart) {\n                const localStart = segStart - cStart;\n                const slice = chunk.subarray(localStart, localStart + (segEnd - segStart));\n                out.set(slice, offset);\n                offset += slice.length;\n            }\n\n            passed = cEnd;\n            if (segEnd >= end) break;\n        }\n\n        return out;\n    }\n\n    /**\n     * 取得 Analyser 節點（供外部波形顯示使用）\n     * @returns {AnalyserNode|null}\n     */\n    getAnalyser() {\n        return this.analyser;\n    }\n\n    /**\n     * 取得 AudioContext\n     * @returns {AudioContext|null}\n     */\n    getAudioContext() {\n        return this.audioContext;\n    }\n\n    /**\n     * 取得麥克風媒體流\n     * @returns {MediaStream|null}\n     */\n    get microphoneStream() {\n        return this.micStream;\n    }\n\n    /**\n     * 設定前級增益\n     * @param {number} gain - 增益值 (1.0-6.0)\n     */\n    setMicGain(gain) {\n        gain = Math.max(1.0, Math.min(6.0, gain));\n        this.config.micGain = gain;\n\n        if (this.preGainNode) {\n            this.preGainNode.gain.value = gain;\n        }\n\n        this._emit('mic-gain-changed', { gain });\n    }\n\n    /**\n     * 釋放資源\n     */\n    dispose() {\n        if (this.isRecording) {\n            this.stopRecording().catch(console.error);\n        }\n\n        this._stopMicrophone();\n        this._stopPcmCapture();\n\n        if (this.latestUrl) {\n            URL.revokeObjectURL(this.latestUrl);\n            this.latestUrl = null;\n        }\n\n        if (this.audioContext) {\n            this.audioContext.close().catch(console.error);\n            this.audioContext = null;\n        }\n\n        this.analyser = null;\n        this.preGainNode = null;\n        this.mediaDest = null;\n        this.analyserSilencer = null;\n        this.pcmCollectorNode = null;\n        this.recorder = null;\n\n        this.pcmChunks = [];\n        this.pcmTotalSamples = 0;\n\n        this.isInitialized = false;\n\n        this._emit('disposed');\n    }\n\n    // ============================================================\n    // 事件系統\n    // ============================================================\n\n    /**\n     * 註冊事件監聽器\n     * @param {string} event - 事件名稱\n     * @param {Function} handler - 處理函數\n     */\n    on(event, handler) {\n        if (!this._eventListeners[event]) {\n            this._eventListeners[event] = [];\n        }\n        this._eventListeners[event].push(handler);\n    }\n\n    /**\n     * 移除事件監聽器\n     * @param {string} event - 事件名稱\n     * @param {Function} handler - 處理函數\n     */\n    off(event, handler) {\n        if (!this._eventListeners[event]) return;\n\n        const index = this._eventListeners[event].indexOf(handler);\n        if (index > -1) {\n            this._eventListeners[event].splice(index, 1);\n        }\n    }\n\n    /**\n     * 觸發事件（內部使用）\n     * @private\n     */\n    _emit(event, data) {\n        if (!this._eventListeners[event]) return;\n\n        this._eventListeners[event].forEach(handler => {\n            try {\n                handler(data);\n            } catch (error) {\n                console.error(`事件處理器錯誤 [${event}]:`, error);\n            }\n        });\n    }\n\n    // ============================================================\n    // 私有方法 - 麥克風捕獲\n    // ============================================================\n\n    async _captureMicrophone() {\n        let constraints;\n        \n        // 如果有 DeviceManager，使用它來建立約束條件\n        if (this.deviceManager) {\n            constraints = this.deviceManager.getMicrophoneConstraints({\n                echoCancellation: this.config.echoCancellation,\n                noiseSuppression: this.config.noiseSuppression,\n                autoGainControl: this.config.autoGainControl\n            });\n            \n            // 記錄選擇的裝置\n            const selectedId = this.deviceManager.getSelectedMicrophoneId();\n            console.log('[AudioEngine] 使用 DeviceManager 選擇的麥克風:', selectedId);\n            console.log('[AudioEngine] 約束條件:', JSON.stringify(constraints, null, 2));\n        } else {\n            // 傳統模式：手動建立約束條件\n            constraints = {\n                audio: {\n                    echoCancellation: this.config.echoCancellation,\n                    noiseSuppression: this.config.noiseSuppression,\n                    autoGainControl: this.config.autoGainControl\n                },\n                video: false\n            };\n\n            // 加入設備 ID 限制（如果有指定）\n            if (this.config.deviceId) {\n                constraints.audio.deviceId = { exact: this.config.deviceId };\n            }\n            \n            console.log('[AudioEngine] 使用傳統模式，約束條件:', JSON.stringify(constraints, null, 2));\n        }\n\n        try {\n            this.micStream = await navigator.mediaDevices.getUserMedia(constraints);\n\n            // iOS 自動增益調整\n            this._applyIOSMicGainAdjustment();\n\n            // 連接麥克風到前級增益節點\n            const source = this.audioContext.createMediaStreamSource(this.micStream);\n            source.connect(this.preGainNode);\n\n            const usedDeviceId = this.deviceManager ? \n                this.deviceManager.getSelectedMicrophoneId() : \n                this.config.deviceId;\n            \n            // 取得實際使用的裝置資訊\n            const audioTracks = this.micStream.getAudioTracks();\n            if (audioTracks.length > 0) {\n                const actualDevice = audioTracks[0].label;\n                console.log('[AudioEngine] 實際使用的麥克風:', actualDevice);\n            }\n\n            this._emit('microphone-captured', {\n                deviceId: usedDeviceId,\n                constraints\n            });\n\n        } catch (error) {\n            // 如果指定設備失敗，嘗試使用預設設備\n            if (error.name === 'OverconstrainedError' || error.name === 'NotFoundError') {\n                console.warn('指定的麥克風無法使用，嘗試預設設備');\n\n                delete constraints.audio.deviceId;\n                this.micStream = await navigator.mediaDevices.getUserMedia(constraints);\n\n                this._applyIOSMicGainAdjustment();\n\n                const source = this.audioContext.createMediaStreamSource(this.micStream);\n                source.connect(this.preGainNode);\n\n                this._emit('microphone-captured-fallback', { constraints });\n            } else {\n                throw error;\n            }\n        }\n    }\n\n    _stopMicrophone() {\n        if (this.micStream) {\n            this.micStream.getTracks().forEach(track => {\n                try {\n                    track.stop();\n                } catch (error) {\n                    console.warn('停止麥克風軌道失敗:', error);\n                }\n            });\n            this.micStream = null;\n        }\n    }\n\n    _applyIOSMicGainAdjustment() {\n        // iOS 上 AGC 關閉時音量偏低，自動提升增益\n        try {\n            const ua = navigator.userAgent || '';\n            const isIOS = /iphone|ipad|ipod/i.test(ua);\n\n            if (isIOS && !this.config.autoGainControl) {\n                if (Math.abs(this.config.micGain - 1.0) < 0.0001) {\n                    this.setMicGain(3.5);\n                    this._emit('ios-gain-adjusted', { gain: 3.5 });\n                }\n            }\n        } catch (error) {\n            console.warn('iOS 增益調整失敗:', error);\n        }\n    }\n\n    // ============================================================\n    // 私有方法 - AudioWorklet 錄音\n    // ============================================================\n\n    async _startWorkletRecording() {\n        try {\n            // 創建 AudioWorkletNode\n            this.pcmCollectorNode = new AudioWorkletNode(\n                this.audioContext,\n                'pcm-collector-processor'\n            );\n\n            // 監聽 PCM 數據\n            this.pcmCollectorNode.port.onmessage = (event) => {\n                const { type, pcmData } = event.data;\n\n                if (type === 'pcm-data' && pcmData) {\n                    this.pcmChunks.push(new Float32Array(pcmData));\n                    this.pcmTotalSamples += pcmData.length;\n\n                    this._emit('data-available', {\n                        pcmData: new Float32Array(pcmData),\n                        totalSamples: this.pcmTotalSamples,\n                        mode: 'worklet'\n                    });\n                }\n            };\n\n            // 連接節點：preGain -> pcmCollector -> analyser\n            this.preGainNode.connect(this.pcmCollectorNode);\n            this.pcmCollectorNode.connect(this.audioContext.destination);\n\n            this.usingWorklet = true;\n\n        } catch (error) {\n            console.error('AudioWorklet 啟動失敗，回退到 RecordRTC:', error);\n            this.usingWorklet = false;\n            await this._startRecordRTCRecording();\n        }\n    }\n\n    async _stopWorkletRecording() {\n        try {\n            // 斷開 AudioWorkletNode\n            if (this.pcmCollectorNode) {\n                this.pcmCollectorNode.port.onmessage = null;\n                this.preGainNode.disconnect(this.pcmCollectorNode);\n                this.pcmCollectorNode.disconnect();\n                this.pcmCollectorNode = null;\n            }\n\n            // 合併 PCM 數據並轉換為 WAV\n            if (this.pcmChunks.length === 0) {\n                throw new Error('沒有錄音數據');\n            }\n\n            const merged = new Float32Array(this.pcmTotalSamples);\n            let offset = 0;\n\n            for (const chunk of this.pcmChunks) {\n                merged.set(chunk, offset);\n                offset += chunk.length;\n            }\n\n            // 轉換為 16-bit PCM WAV\n            const wavBuffer = this._buildWavFromFloat32Mono(\n                merged,\n                this.audioContext.sampleRate\n            );\n\n            const blob = new Blob([wavBuffer], { type: 'audio/wav' });\n\n            this.usingWorklet = false;\n\n            return blob;\n\n        } catch (error) {\n            console.error('AudioWorklet 停止失敗:', error);\n            throw error;\n        }\n    }\n\n    // ============================================================\n    // 私有方法 - RecordRTC 錄音\n    // ============================================================\n\n    async _startRecordRTCRecording() {\n        return new Promise((resolve, reject) => {\n            try {\n                // 檢查 RecordRTC 是否可用\n                if (typeof RecordRTC === 'undefined') {\n                    reject(new Error('RecordRTC 未載入'));\n                    return;\n                }\n\n                const recordStream = this.mediaDest.stream || this.micStream;\n\n                this.recorder = RecordRTC(recordStream, {\n                    type: 'audio',\n                    mimeType: 'audio/wav',\n                    recorderType: StereoAudioRecorder,\n                    numberOfAudioChannels: 1,\n                    bufferSize: 4096,\n                    timeSlice: 100,\n                    ondataavailable: (blob) => {\n                        this._emit('data-available', {\n                            blob,\n                            mode: 'recordrtc'\n                        });\n                    }\n                });\n\n                this.recorder.startRecording();\n                this.usingWorklet = false;\n\n                // 啟動 PCM 數據採集循環（用於累積波形）\n                this._startPcmCapture();\n\n                resolve();\n\n            } catch (error) {\n                reject(error);\n            }\n        });\n    }\n\n    async _stopRecordRTCRecording() {\n        return new Promise((resolve, reject) => {\n            try {\n                if (!this.recorder) {\n                    reject(new Error('RecordRTC 錄音器不存在'));\n                    return;\n                }\n\n                // 停止 PCM 數據採集循環\n                this._stopPcmCapture();\n\n                this.recorder.stopRecording(() => {\n                    try {\n                        const blob = this.recorder.getBlob();\n\n                        // 清理錄音器\n                        this.recorder = null;\n\n                        resolve(blob);\n                    } catch (error) {\n                        reject(error);\n                    }\n                });\n\n            } catch (error) {\n                reject(error);\n            }\n        });\n    }\n\n    /**\n     * 啟動 PCM 數據採集（RecordRTC 模式使用）\n     * @private\n     */\n    _startPcmCapture() {\n        if (!this.analyser) return;\n\n        const bufferLength = this.analyser.fftSize;\n        const dataArray = new Float32Array(bufferLength);\n        \n        // 每 100ms 採集一次 PCM 數據\n        this._pcmCaptureInterval = setInterval(() => {\n            if (!this.isRecording || !this.analyser) {\n                return;\n            }\n\n            // 從 AnalyserNode 讀取時域數據\n            this.analyser.getFloatTimeDomainData(dataArray);\n            \n            // 複製數據以避免被覆蓋\n            const pcmChunk = new Float32Array(dataArray);\n            \n            // 儲存到 pcmChunks\n            this.pcmChunks.push(pcmChunk);\n            this.pcmTotalSamples += pcmChunk.length;\n\n            // 發送事件給 WaveformRenderer\n            this._emit('data-available', {\n                pcmData: pcmChunk,\n                totalSamples: this.pcmTotalSamples,\n                mode: 'recordrtc-pcm'\n            });\n        }, 100);\n    }\n\n    /**\n     * 停止 PCM 數據採集\n     * @private\n     */\n    _stopPcmCapture() {\n        if (this._pcmCaptureInterval) {\n            clearInterval(this._pcmCaptureInterval);\n            this._pcmCaptureInterval = null;\n        }\n    }\n\n    // ============================================================\n    // 私有方法 - WAV 格式轉換\n    // ============================================================\n\n    _buildWavFromFloat32Mono(float32Data, sampleRate) {\n        const numSamples = float32Data.length;\n        const buffer = new ArrayBuffer(44 + numSamples * 2);\n        const view = new DataView(buffer);\n\n        // WAV Header\n        this._writeString(view, 0, 'RIFF');\n        view.setUint32(4, 36 + numSamples * 2, true);\n        this._writeString(view, 8, 'WAVE');\n        this._writeString(view, 12, 'fmt ');\n        view.setUint32(16, 16, true); // fmt chunk size\n        view.setUint16(20, 1, true);  // audio format (PCM)\n        view.setUint16(22, 1, true);  // number of channels\n        view.setUint32(24, sampleRate, true);\n        view.setUint32(28, sampleRate * 2, true); // byte rate\n        view.setUint16(32, 2, true);  // block align\n        view.setUint16(34, 16, true); // bits per sample\n        this._writeString(view, 36, 'data');\n        view.setUint32(40, numSamples * 2, true);\n\n        // PCM Data (float32 -> int16)\n        let offset = 44;\n        for (let i = 0; i < numSamples; i++) {\n            const sample = Math.max(-1, Math.min(1, float32Data[i]));\n            const int16 = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;\n            view.setInt16(offset, int16, true);\n            offset += 2;\n        }\n\n        return buffer;\n    }\n\n    _writeString(view, offset, string) {\n        for (let i = 0; i < string.length; i++) {\n            view.setUint8(offset + i, string.charCodeAt(i));\n        }\n    }\n    \n    /**\n     * 銷毀 AudioEngine，釋放所有資源\n     */\n    destroy() {\n        // 停止錄音（如果正在錄音）\n        if (this.isRecording) {\n            this.stopRecording().catch(err => {\n                console.warn('停止錄音失敗:', err);\n            });\n        }\n        \n        // 停止麥克風\n        this._stopMicrophone();\n        \n        // 停止 PCM 採集\n        this._stopPcmCapture();\n        \n        // 清理 AudioWorklet\n        if (this.pcmCollectorNode) {\n            this.pcmCollectorNode.disconnect();\n            this.pcmCollectorNode = null;\n        }\n        \n        // 關閉 AudioContext\n        if (this.audioContext) {\n            this.audioContext.close().catch(err => {\n                console.warn('關閉 AudioContext 失敗:', err);\n            });\n            this.audioContext = null;\n        }\n        \n        // 清理 DeviceManager（如果是自己創建的）\n        if (this._ownDeviceManager && this.deviceManager) {\n            this.deviceManager.destroy();\n            this.deviceManager = null;\n        }\n        \n        // 清理事件監聽器\n        this._eventListeners = {};\n        \n        // 重置狀態\n        this.isInitialized = false;\n        this.isRecording = false;\n    }\n}\n\nexport default AudioEngine;\n","/**\n * WaveformRenderer.js\n * 波形渲染模組 - 整合即時波形、累積波形、概覽波形和 VU Meter\n * \n * @module WaveformRenderer\n * @description 提供完整的波形可視化功能，包含：\n * - LiveWaveform: 即時波形顯示（從 AnalyserNode）\n * - VUMeter: 音量表顯示（RMS/Peak dBFS）\n * - AccumulatedWaveform: 累積波形（使用 Worker 加速）\n * - OverviewWaveform: 全局概覽波形\n */\n\n/**\n * WaveformRenderer - 波形渲染管理器\n * 統一管理所有波形組件的初始化、更新和銷毀\n */\nexport class WaveformRenderer {\n    /**\n     * @param {Object} options - 配置選項\n     * @param {HTMLCanvasElement} options.liveCanvas - 即時波形 Canvas\n     * @param {HTMLCanvasElement} options.vuMeterCanvas - VU Meter Canvas\n     * @param {HTMLCanvasElement} options.accumulatedCanvas - 累積波形 Canvas\n     * @param {HTMLCanvasElement} options.overviewCanvas - 概覽波形 Canvas\n     * @param {AnalyserNode} options.analyserNode - Web Audio AnalyserNode\n     * @param {Object} options.audioEngine - AudioEngine 實例（可選，會自動獲取 analyserNode）\n     * @param {string} [options.workerPath] - Worker 腳本路徑\n     * @param {boolean} [options.useWorker=true] - 是否使用 Worker\n     * @param {boolean} [options.showClipMarks=true] - 是否顯示削波標記\n     */\n    constructor(options = {}) {\n        this.options = {\n            workerPath: options.workerPath || 'workers/wf-worker.js',\n            useWorker: options.useWorker !== false,\n            showClipMarks: options.showClipMarks !== false,\n            ...options\n        };\n        \n        // 支援從 audioEngine 獲取 analyserNode\n        this.audioEngine = options.audioEngine;\n        \n        this.liveWaveform = null;\n        this.vuMeter = null;\n        this.accumulatedWaveform = null;\n        this.overviewWaveform = null;\n        \n        this.isVerticalMode = false;\n        this._overviewUpdateScheduled = false;\n        \n        // 如果提供了 audioEngine，監聽錄音事件\n        if (this.audioEngine) {\n            this._setupAudioEngineListeners();\n        }\n    }\n    \n    /**\n     * 設置 AudioEngine 事件監聽\n     * @private\n     */\n    _setupAudioEngineListeners() {\n        if (!this.audioEngine) return;\n        \n        // 錄音開始時自動啟動波形\n        this.audioEngine.on('recording-start', () => {\n            this.start();\n        });\n        \n        // 錄音停止時停止波形\n        this.audioEngine.on('recording-stop', () => {\n            this.stopLive();\n        });\n        \n        // PCM 數據到達時更新累積波形\n        this.audioEngine.on('data-available', (data) => {\n            if (data.pcmData && this.accumulatedWaveform) {\n                this.appendPCM(data.pcmData);\n            }\n        });\n    }\n    \n    /**\n     * 初始化所有波形組件\n     */\n    async initialize() {\n        const { liveCanvas, vuMeterCanvas, accumulatedCanvas, overviewCanvas } = this.options;\n        \n        // 從 audioEngine 或 options 獲取 analyserNode\n        let analyserNode = this.options.analyserNode;\n        if (!analyserNode && this.audioEngine && typeof this.audioEngine.getAnalyser === 'function') {\n            analyserNode = this.audioEngine.getAnalyser();\n        }\n        \n        // 初始化即時波形\n        if (liveCanvas && analyserNode) {\n            this.liveWaveform = new LiveWaveform(liveCanvas, analyserNode);\n        }\n        \n        // 初始化 VU Meter\n        if (vuMeterCanvas && analyserNode) {\n            this.vuMeter = new VUMeter(vuMeterCanvas, analyserNode);\n        }\n        \n        // 初始化累積波形\n        if (accumulatedCanvas) {\n            this.accumulatedWaveform = new AccumulatedWaveform(accumulatedCanvas, {\n                workerPath: this.options.workerPath,\n                useWorker: this.options.useWorker,\n                showClipMarks: this.options.showClipMarks\n            });\n        }\n        \n        // 初始化概覽波形\n        if (overviewCanvas && this.accumulatedWaveform) {\n            this.overviewWaveform = new OverviewWaveform(overviewCanvas, this.accumulatedWaveform);\n            // 建立雙向引用，讓累積波形可以通知概覽波形更新\n            this.accumulatedWaveform.overviewWaveform = this.overviewWaveform;\n        }\n    }\n    \n    /**\n     * 開始即時波形顯示\n     * @param {MediaStream} stream - 麥克風媒體流\n     * @param {AudioContext} audioContext - Web Audio Context\n     * @param {GainNode} [preGainNode] - 前級增益節點（可選）\n     */\n    startLive(stream, audioContext, preGainNode) {\n        if (this.liveWaveform) {\n            this.liveWaveform.start(stream, audioContext, preGainNode);\n        }\n        if (this.vuMeter) {\n            this.vuMeter.start();\n        }\n    }\n    \n    /**\n     * 開始波形顯示（簡化版，從 audioEngine 自動獲取資訊）\n     */\n    start() {\n        if (!this.audioEngine) {\n            console.warn('No audioEngine provided, cannot start waveform rendering');\n            return;\n        }\n        \n        // 獲取必要資訊\n        const stream = this.audioEngine.microphoneStream;\n        const audioContext = this.audioEngine.audioContext;\n        const preGainNode = this.audioEngine.preGainNode;\n        \n        if (stream && audioContext) {\n            this.startLive(stream, audioContext, preGainNode);\n        }\n    }\n    \n    /**\n     * 停止即時波形顯示\n     */\n    stopLive() {\n        if (this.liveWaveform) {\n            this.liveWaveform.stop();\n        }\n        if (this.vuMeter) {\n            this.vuMeter.stop();\n        }\n    }\n    \n    /**\n     * 附加 PCM 數據到累積波形\n     * @param {Float32Array} pcmData - PCM 音訊數據\n     */\n    appendPCM(pcmData) {\n        if (this.accumulatedWaveform) {\n            this.accumulatedWaveform.append(pcmData);\n            \n            // 同時更新 OverviewWaveform\n            if (this.overviewWaveform) {\n                // 使用 requestAnimationFrame 避免過度繪製\n                if (!this._overviewUpdateScheduled) {\n                    this._overviewUpdateScheduled = true;\n                    requestAnimationFrame(() => {\n                        if (this.overviewWaveform) {\n                            this.overviewWaveform.draw();\n                        }\n                        this._overviewUpdateScheduled = false;\n                    });\n                }\n            }\n        }\n    }\n    \n    /**\n     * 重置所有波形\n     */\n    reset() {\n        if (this.accumulatedWaveform) {\n            this.accumulatedWaveform.reset();\n        }\n        if (this.overviewWaveform) {\n            this.overviewWaveform.clear();\n        }\n    }\n    \n    /**\n     * 清除所有波形\n     */\n    clear() {\n        if (this.liveWaveform) {\n            this.liveWaveform.canvasContext.clearRect(0, 0, this.liveWaveform.width, this.liveWaveform.height);\n        }\n        if (this.vuMeter) {\n            this.vuMeter.clear();\n        }\n        if (this.accumulatedWaveform) {\n            this.accumulatedWaveform.clear();\n        }\n        if (this.overviewWaveform) {\n            this.overviewWaveform.clear();\n        }\n    }\n    \n    /**\n     * 設定垂直/水平模式\n     * @param {boolean} isVertical - 是否為垂直模式\n     */\n    setVerticalMode(isVertical) {\n        this.isVerticalMode = isVertical;\n        \n        // 通知 Worker 模式變更\n        if (this.accumulatedWaveform && this.accumulatedWaveform._worker) {\n            this.accumulatedWaveform._worker.postMessage({\n                type: 'setVerticalMode',\n                verticalMode: isVertical\n            });\n        }\n    }\n    \n    /**\n     * 調整 Canvas 尺寸\n     */\n    resize() {\n        if (this.liveWaveform) {\n            this.liveWaveform.width = this.liveWaveform.canvas.width;\n            this.liveWaveform.height = this.liveWaveform.canvas.height;\n        }\n        if (this.vuMeter) {\n            this.vuMeter.resize();\n        }\n        if (this.accumulatedWaveform) {\n            this.accumulatedWaveform.width = this.accumulatedWaveform.canvas.width;\n            this.accumulatedWaveform.height = this.accumulatedWaveform.canvas.height;\n            if (this.accumulatedWaveform._worker) {\n                this.accumulatedWaveform._worker.postMessage({\n                    type: 'resize',\n                    width: this.accumulatedWaveform.width,\n                    height: this.accumulatedWaveform.height\n                });\n            }\n            this.accumulatedWaveform.draw();\n        }\n        if (this.overviewWaveform) {\n            this.overviewWaveform.width = this.overviewWaveform.canvas.width;\n            this.overviewWaveform.height = this.overviewWaveform.canvas.height;\n            this.overviewWaveform.draw();\n        }\n    }\n    \n    /**\n     * 銷毀所有組件，釋放資源\n     */\n    destroy() {\n        this.stopLive();\n        \n        if (this.accumulatedWaveform && this.accumulatedWaveform._worker) {\n            this.accumulatedWaveform._worker.terminate();\n        }\n        \n        this.liveWaveform = null;\n        this.vuMeter = null;\n        this.accumulatedWaveform = null;\n        this.overviewWaveform = null;\n    }\n}\n\n/* ================================================================\n * LiveWaveform 類 - 即時波形顯示\n * 從 AnalyserNode 取得時域數據並即時繪製波形\n * 支援水平和垂直模式\n * ================================================================ */\nexport class LiveWaveform {\n    constructor(canvas, analyserNode) {\n        this.canvas = canvas;\n        this.canvasContext = canvas.getContext('2d');\n        this.analyser = analyserNode;\n        this.mediaStreamSource = null;\n        this.animationId = null;\n        this.isRunning = false;\n\n        this.width = canvas.width;\n        this.height = canvas.height;\n\n        this.bufferLength = 0;\n        this.dataArray = null;\n        \n        this.amplification = 3.0;\n\n        this._lastDataArray = null;\n        this._verticalScrollOffset = 0;\n    }\n\n    /**\n     * 開始即時波形顯示\n     * @param {MediaStream} stream - 麥克風媒體流\n     * @param {AudioContext} audioContext - Web Audio Context\n     * @param {GainNode} [preGainNode] - 前級增益節點（可選）\n     */\n    start(stream, audioContext, preGainNode) {\n        if (this.isRunning || !audioContext || !this.analyser) {\n            console.warn('LiveWaveform.start() 條件不滿足:', {\n                isRunning: this.isRunning,\n                hasAudioContext: !!audioContext,\n                hasAnalyser: !!this.analyser\n            });\n            return;\n        }\n\n        console.log('✅ LiveWaveform 開始啟動...');\n        this.isRunning = true;\n        \n        const self = this;\n\n        // 確保 AudioContext 處於運行狀態\n        let contextReady = Promise.resolve();\n        if (audioContext.state === 'suspended') {\n            contextReady = audioContext.resume().catch(function(err) {\n                console.warn('Unable to resume AudioContext:', err);\n            });\n        }\n\n        // 等待 AudioContext 就緒後再連接麥克風\n        contextReady.then(function() {\n            // 為避免重複連線先清除舊的 source\n            if (self.mediaStreamSource) {\n                self.mediaStreamSource.disconnect();\n            }\n\n            // 連接麥克風\n            self.mediaStreamSource = audioContext.createMediaStreamSource(stream);\n            if (preGainNode) {\n                try { \n                    self.mediaStreamSource.connect(preGainNode); \n                } catch(e) { \n                    console.warn('connect preGainNode failed', e); \n                }\n            } else {\n                self.mediaStreamSource.connect(self.analyser);\n            }\n\n            // 設定 FFT 參數\n            self.analyser.fftSize = 1024;\n            self.bufferLength = self.analyser.fftSize;\n            self.dataArray = new Uint8Array(self.bufferLength);\n\n            console.log('✅ LiveWaveform 音訊連接完成，開始繪製');\n            \n            // 立即開始繪製\n            self.draw(false); // false = 水平模式\n        });\n    }\n\n    /**\n     * 停止即時波形顯示\n     */\n    stop() {\n        if (!this.isRunning) return;\n        \n        this.isRunning = false;\n        \n        if (this.mediaStreamSource) {\n            this.mediaStreamSource.disconnect();\n            this.mediaStreamSource = null;\n        }\n\n        if (this.animationId) {\n            cancelAnimationFrame(this.animationId);\n            this.animationId = null;\n        }\n        \n        this.canvasContext.clearRect(0, 0, this.width, this.height);\n    }\n\n    /**\n     * 繪製波形（持續更新）\n     * @param {boolean} [isVertical=false] - 是否為垂直模式\n     */\n    draw(isVertical = false) {\n        if (!this.isRunning || !this.analyser || !this.dataArray) {\n            return;\n        }\n\n        this.animationId = requestAnimationFrame(() => this.draw(isVertical));\n\n        this.analyser.getByteTimeDomainData(this.dataArray);\n\n        if (!isVertical) {\n            // 水平模式\n            this.canvasContext.fillStyle = '#f0f0f0';\n            this.canvasContext.fillRect(0, 0, this.width, this.height);\n\n            this.canvasContext.lineWidth = 2;\n            this.canvasContext.strokeStyle = '#1E88E5';\n            this.canvasContext.beginPath();\n\n            const sliceWidth = this.width / this.bufferLength;\n            let x = 0;\n\n            for (let i = 0; i < this.bufferLength; i++) {\n                const v = (this.dataArray[i] / 128.0 - 1) * this.amplification;\n                const y = (v * this.height / 2) + (this.height / 2);\n\n                if (i === 0) {\n                    this.canvasContext.moveTo(x, y);\n                } else {\n                    this.canvasContext.lineTo(x, y);\n                }\n\n                x += sliceWidth;\n            }\n\n            this.canvasContext.lineTo(this.width, this.height / 2);\n            this.canvasContext.stroke();\n        } else {\n            // 垂直模式（滾動繪製）\n            const scrollSpeed = 2;\n            this._verticalScrollOffset += scrollSpeed;\n            \n            if (this._verticalScrollOffset >= this.height) {\n                this._verticalScrollOffset = 0;\n                this.canvasContext.fillStyle = '#f0f0f0';\n                this.canvasContext.fillRect(0, 0, this.width, this.height);\n            }\n\n            this.canvasContext.lineWidth = 1.5;\n            this.canvasContext.strokeStyle = '#1E88E5';\n            this.canvasContext.beginPath();\n\n            const sliceHeight = this.height / this.bufferLength;\n            let y = 0;\n\n            for (let i = 0; i < this.bufferLength; i++) {\n                const v = (this.dataArray[i] / 128.0 - 1) * this.amplification;\n                const x = (v * this.width / 2) + (this.width / 2);\n\n                if (i === 0) {\n                    this.canvasContext.moveTo(x, y);\n                } else {\n                    this.canvasContext.lineTo(x, y);\n                }\n\n                y += sliceHeight;\n            }\n\n            this.canvasContext.stroke();\n        }\n    }\n}\n\n/* ================================================================\n * VUMeter 類 - 即時音量 (RMS/Peak) 顯示\n * 計算 RMS 與 Peak，轉換為 dB 值 (-90dB ~ 0dB)\n * 提供 peak hold 功能：峰值維持一段時間後緩降\n * ================================================================ */\nexport class VUMeter {\n    constructor(canvas, analyserNode) {\n        this.canvas = canvas;\n        this.ctx = canvas.getContext('2d');\n        this.analyser = analyserNode;\n        this.bufferLength = 2048;\n        this.timeData = new Float32Array(this.bufferLength);\n        this.levelDb = -90;\n        this.peakDb = -90;\n        this.holdPeakDb = -90;\n        this.lastPeakTime = 0;\n        this.peakHoldMillis = 1500;\n        this.fallRateDbPerSec = 20;\n        this.minDb = -90;\n        this.maxDb = 0;\n        this.animationId = null;\n        this.lastClipTime = 0;\n        this.clipHoldMillis = 2000;\n        this._lastLogTime = 0;\n    }\n\n    _computeLevels() {\n        if (!this.analyser) return { rmsDb: this.minDb, peakDb: this.minDb };\n        \n        const required = this.analyser.fftSize || this.bufferLength;\n        if (this.timeData.length !== required) {\n            this.bufferLength = required;\n            this.timeData = new Float32Array(required);\n        }\n        \n        this.analyser.getFloatTimeDomainData(this.timeData);\n        let sumSquares = 0;\n        let peak = 0;\n        let clipped = false;\n        \n        for (let i = 0; i < this.bufferLength; i++) {\n            let v = this.timeData[i];\n            if (v > 1) v = 1;\n            else if (v < -1) v = -1;\n            sumSquares += v * v;\n            const absV = Math.abs(v);\n            if (absV > peak) peak = absV;\n            if (absV >= 0.995) clipped = true;\n        }\n        \n        const rms = Math.sqrt(sumSquares / this.bufferLength);\n        let rmsDb = rms > 0 ? 20 * Math.log10(rms) : -Infinity;\n        let peakDb = peak > 0 ? 20 * Math.log10(peak) : -Infinity;\n        \n        if (rmsDb < this.minDb) rmsDb = this.minDb;\n        if (rmsDb > this.maxDb) rmsDb = this.maxDb;\n        if (peakDb < this.minDb) peakDb = this.minDb;\n        if (peakDb > this.maxDb) peakDb = this.maxDb;\n        \n        if (clipped) {\n            this.lastClipTime = performance.now ? performance.now() : Date.now();\n        }\n        \n        return { rmsDb, peakDb };\n    }\n\n    resize() {\n        this.clear();\n    }\n\n    clear() {\n        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\n    }\n\n    draw(currentDb) {\n        const ctx = this.ctx;\n        const w = this.canvas.width;\n        const h = this.canvas.height;\n        \n        // 背景\n        ctx.clearRect(0, 0, w, h);\n        const grd = ctx.createLinearGradient(0, 0, w, 0);\n        grd.addColorStop(0, '#2d3748');\n        grd.addColorStop(1, '#1a202c');\n        ctx.fillStyle = grd;\n        ctx.fillRect(0, 0, w, h);\n\n        // dB 對應到 0~1\n        let norm = (currentDb - this.minDb) / (this.maxDb - this.minDb);\n        if (norm < 0) norm = 0;\n        if (norm > 1) norm = 1;\n\n        // 彩色漸層 (綠->黃->紅)\n        const barGrad = ctx.createLinearGradient(0, 0, w, 0);\n        barGrad.addColorStop(0, '#38a169');\n        barGrad.addColorStop(0.6, '#d69e2e');\n        barGrad.addColorStop(0.85, '#dd6b20');\n        barGrad.addColorStop(1, '#c53030');\n        ctx.fillStyle = barGrad;\n        const barWidth = Math.round(w * norm);\n        ctx.fillRect(0, 0, barWidth, h);\n\n        // 刻度線\n        ctx.save();\n        ctx.strokeStyle = 'rgba(255,255,255,0.15)';\n        ctx.lineWidth = 1;\n        ctx.beginPath();\n        \n        for (let db = this.minDb; db <= this.maxDb; db += 10) {\n            const posNorm = (db - this.minDb) / (this.maxDb - this.minDb);\n            const xPos = Math.round(w * posNorm) + 0.5;\n            \n            if (db === 0) {\n                ctx.strokeStyle = 'rgba(255,255,255,0.35)';\n                ctx.beginPath();\n                ctx.moveTo(xPos, 0);\n                ctx.lineTo(xPos, h);\n                ctx.stroke();\n                ctx.strokeStyle = 'rgba(255,255,255,0.15)';\n            } else {\n                ctx.moveTo(xPos, 0);\n                ctx.lineTo(xPos, h * 0.4);\n                ctx.moveTo(xPos, h);\n                ctx.lineTo(xPos, h * 0.6);\n            }\n            \n            if (db % 20 === 0 || db === -10) {\n                const label = db.toString();\n                ctx.fillStyle = (db === 0) ? '#ffffff' : (db === -10 ? '#ffeb3b' : '#cbd5e0');\n                ctx.font = '10px -apple-system,Segoe UI,sans-serif';\n                ctx.textAlign = 'center';\n                ctx.textBaseline = 'top';\n                ctx.fillText(label, xPos, 1);\n            }\n        }\n        ctx.restore();\n\n        // -10dBFS 區域高亮\n        const minus10Norm = (-10 - this.minDb) / (this.maxDb - this.minDb);\n        if (minus10Norm > 0 && minus10Norm < 1) {\n            const minus10X = Math.round(w * minus10Norm);\n            ctx.save();\n            ctx.fillStyle = 'rgba(255,235,59,0.08)';\n            ctx.fillRect(minus10X - 2, 0, 4, h);\n            ctx.restore();\n        }\n\n        // 峰值 hold 指示線\n        let holdNorm = (this.holdPeakDb - this.minDb) / (this.maxDb - this.minDb);\n        if (holdNorm < 0) holdNorm = 0;\n        if (holdNorm > 1) holdNorm = 1;\n        const holdX = Math.round(w * holdNorm);\n        ctx.strokeStyle = '#ffffff';\n        ctx.lineWidth = 2;\n        ctx.beginPath();\n        ctx.moveTo(holdX + 0.5, 0);\n        ctx.lineTo(holdX + 0.5, h);\n        ctx.stroke();\n\n        // 文字顯示\n        ctx.fillStyle = '#f0f0f0';\n        ctx.font = 'bold 12px -apple-system,Segoe UI,sans-serif';\n        ctx.textAlign = 'left';\n        ctx.textBaseline = 'middle';\n        const displayRms = currentDb <= this.minDb ? '-∞' : currentDb.toFixed(1);\n        const displayPeak = this.peakDb <= this.minDb ? '-∞' : this.peakDb.toFixed(1);\n        const txt = `RMS ${displayRms} dBFS   Peak ${displayPeak} dBFS`;\n        ctx.fillText(txt, 8, h / 2);\n\n        // CLIP 指示\n        const now = performance.now ? performance.now() : Date.now();\n        if (this.lastClipTime && (now - this.lastClipTime) < this.clipHoldMillis) {\n            ctx.save();\n            ctx.fillStyle = '#B00020';\n            const badgeW = 42, badgeH = 18;\n            ctx.fillRect(w - badgeW - 8, 4, badgeW, badgeH);\n            ctx.fillStyle = '#fff';\n            ctx.font = 'bold 12px -apple-system,Segoe UI,sans-serif';\n            ctx.textAlign = 'center';\n            ctx.textBaseline = 'middle';\n            ctx.fillText('CLIP', w - badgeW / 2 - 8, 4 + badgeH / 2 + 0.5);\n            ctx.restore();\n        }\n    }\n\n    update() {\n        const levels = this._computeLevels();\n        this.levelDb = levels.rmsDb;\n        this.peakDb = levels.peakDb;\n\n        const now = performance.now();\n        \n        // 更新 peak hold\n        if (this.peakDb > this.holdPeakDb + 0.5) {\n            this.holdPeakDb = this.peakDb;\n            this.lastPeakTime = now;\n        } else {\n            const elapsed = now - this.lastPeakTime;\n            if (elapsed > this.peakHoldMillis) {\n                const fallSeconds = (elapsed - this.peakHoldMillis) / 1000;\n                const fallAmount = this.fallRateDbPerSec * fallSeconds;\n                this.holdPeakDb = Math.max(this.peakDb, this.holdPeakDb - fallAmount);\n            }\n        }\n        \n        this.draw(this.levelDb);\n    }\n\n    start() {\n        this.stop();\n        \n        if (this.analyser) {\n            const required = this.analyser.fftSize || 2048;\n            if (this.timeData.length !== required) {\n                this.bufferLength = required;\n                this.timeData = new Float32Array(required);\n            }\n        }\n        \n        const self = this;\n        function loop() {\n            self.update();\n            self.animationId = requestAnimationFrame(loop);\n        }\n        loop();\n    }\n\n    stop() {\n        if (this.animationId) {\n            cancelAnimationFrame(this.animationId);\n            this.animationId = null;\n        }\n        this.clear();\n    }\n}\n\n/* ================================================================\n * AccumulatedWaveform 類 - 累積音訊波形顯示\n * 持續繪製目前錄製完成的音訊波形\n * 支援 OffscreenCanvas + Worker 加速\n * 支援縮放、平移、播放位置顯示\n * ================================================================ */\nexport class AccumulatedWaveform {\n    constructor(canvas, options = {}) {\n        this.canvas = canvas;\n        this.canvasContext = null;\n        this.width = canvas.width;\n        this.height = canvas.height;\n\n        this.targetSampleRate = 5000;\n        this.sourceSampleRate = 48000;\n        this.decimationFactor = 10;\n\n        this.sampleMin = [];\n        this.sampleMax = [];\n        this.sampleCount = 0;\n\n        this.zoomFactor = 1;\n        this.viewStart = 0;\n        this.isAutoScroll = true;\n        this._panRemainder = 0;\n        \n        this.playbackPosition = 0;\n        this.isPlaying = false;\n        this.playbackStartTime = 0;\n        this.playbackStartSample = 0;\n\n        this.rawZoomMode = false;\n        this.rawViewStart = 0;\n        this.rawVisibleRaw = 0;\n        \n        // 關聯的 OverviewWaveform（用於同步更新）\n        this.overviewWaveform = null;\n\n        this._useWorker = options.useWorker !== false;\n        this._worker = null;\n        this._appendBatchMin = [];\n        this._appendBatchMax = [];\n        this._appendFlushScheduled = false;\n        this.lastDetail = null;\n        this.lastDensity = null;\n        \n        // 嘗試使用 OffscreenCanvas + Worker\n        if (this._useWorker && canvas.transferControlToOffscreen && typeof Worker !== 'undefined') {\n            try {\n                const off = canvas.transferControlToOffscreen();\n                this._worker = new Worker(options.workerPath || 'workers/wf-worker.js');\n                \n                this._worker.postMessage({\n                    type: 'init',\n                    canvas: off,\n                    width: this.width,\n                    height: this.height,\n                    verticalMode: false,\n                    showClipMarks: options.showClipMarks !== false,\n                    sourceSampleRate: this.sourceSampleRate,\n                    decimationFactor: this.decimationFactor\n                }, [off]);\n                \n                const self = this;\n                this._worker.onmessage = function(ev) {\n                    const msg = ev.data;\n                    if (!msg) return;\n                    if (msg.type === 'detailUpdate') {\n                        self.lastDetail = msg.detail;\n                        self.lastDensity = msg.density;\n                    }\n                };\n            } catch(e) {\n                console.warn('OffscreenCanvas 初始化失敗，使用主線程繪製:', e);\n                this._useWorker = false;\n            }\n        } else {\n            this._useWorker = false;\n        }\n        \n        // 如果沒有使用 Worker，獲取 2D context\n        if (!this._useWorker) {\n            try {\n                this.canvasContext = canvas.getContext('2d');\n            } catch(e) {\n                console.warn('無法獲取 canvas context:', e);\n            }\n        }\n        \n        // 設置滑鼠互動\n        this._setupMouseInteraction();\n        \n        this.clear();\n    }\n    \n    /**\n     * 設置滑鼠互動（平移、縮放、點擊定位）\n     * @private\n     */\n    _setupMouseInteraction() {\n        if (!this.canvas) return;\n        \n        let isDragging = false;\n        let dragStartX = 0;\n        let dragStartViewStart = 0;\n        \n        // 滑鼠按下\n        this.canvas.addEventListener('mousedown', (e) => {\n            isDragging = true;\n            dragStartX = e.offsetX;\n            dragStartViewStart = this.viewStart;\n            this.isAutoScroll = false;\n            this.canvas.style.cursor = 'grabbing';\n        });\n        \n        // 滑鼠移動（拖曳）\n        this.canvas.addEventListener('mousemove', (e) => {\n            if (!isDragging) return;\n            \n            const deltaX = e.offsetX - dragStartX;\n            const info = this.getVisibleSamples();\n            const samplesPerPixel = info.visible / this.width;\n            const sampleDelta = Math.round(-deltaX * samplesPerPixel);\n            \n            this.viewStart = dragStartViewStart + sampleDelta;\n            this._enforceViewBounds();\n            this.draw();\n            \n            // 同步更新 OverviewWaveform\n            if (this.overviewWaveform) {\n                this.overviewWaveform.draw();\n            }\n        });\n        \n        // 滑鼠放開\n        this.canvas.addEventListener('mouseup', () => {\n            if (isDragging) {\n                isDragging = false;\n                this.canvas.style.cursor = 'grab';\n            }\n        });\n        \n        // 滑鼠離開 canvas\n        this.canvas.addEventListener('mouseleave', () => {\n            if (isDragging) {\n                isDragging = false;\n                this.canvas.style.cursor = 'default';\n            }\n        });\n        \n        // 滑鼠滾輪（縮放）\n        this.canvas.addEventListener('wheel', (e) => {\n            e.preventDefault();\n            \n            // 計算滑鼠位置相對於 canvas 的比例\n            const rect = this.canvas.getBoundingClientRect();\n            const x = e.clientX - rect.left;\n            const anchorRatio = x / this.width;\n            \n            // 根據滾輪方向縮放\n            const zoomSteps = e.deltaY > 0 ? -1 : 1;\n            this.zoomBySteps(zoomSteps, anchorRatio);\n        });\n        \n        // 點擊定位（跳到播放位置）\n        this.canvas.addEventListener('click', (e) => {\n            if (isDragging) return; // 如果是拖曳結束，不觸發點擊\n            \n            const info = this.getVisibleSamples();\n            const clickRatio = e.offsetX / this.width;\n            const clickedSample = Math.floor(info.start + clickRatio * info.visible);\n            \n            // 觸發自定義事件，讓外部處理播放跳轉\n            const event = new CustomEvent('waveform-seek', {\n                detail: {\n                    sample: clickedSample,\n                    time: clickedSample / this.sourceSampleRate\n                }\n            });\n            this.canvas.dispatchEvent(event);\n        });\n        \n        // 設置 cursor 樣式\n        this.canvas.style.cursor = 'grab';\n    }\n\n    clear() {\n        if (this._useWorker && this._worker) {\n            this._worker.postMessage({ type: 'reset' });\n            return;\n        }\n        if (!this.canvasContext) return;\n        \n        this.canvasContext.clearRect(0, 0, this.width, this.height);\n        this.canvasContext.fillStyle = '#f0f0f0';\n        this.canvasContext.fillRect(0, 0, this.width, this.height);\n        this.canvasContext.lineWidth = 1;\n        this.canvasContext.strokeStyle = '#d0d0d0';\n        this.canvasContext.beginPath();\n        this.canvasContext.moveTo(0, this.height / 2);\n        this.canvasContext.lineTo(this.width, this.height / 2);\n        this.canvasContext.stroke();\n    }\n\n    reset() {\n        this.sampleMin.length = 0;\n        this.sampleMax.length = 0;\n        this.sampleCount = 0;\n        this.zoomFactor = 1;\n        this.viewStart = 0;\n        this.isAutoScroll = true;\n        this._panRemainder = 0;\n        this.clear();\n    }\n\n    append(audioSamples) {\n        if (!audioSamples || !audioSamples.length) {\n            return;\n        }\n\n        const factor = this.decimationFactor;\n        const total = audioSamples.length;\n        const appendedMin = [];\n        const appendedMax = [];\n        \n        // 每秒記錄一次\n        if (!this._lastAppendLog) this._lastAppendLog = 0;\n        const now = Date.now();\n        if (now - this._lastAppendLog > 1000) {\n            console.log('📈 AccumulatedWaveform.append():', total, '樣本 →', \n                        Math.floor(total / factor), '區塊');\n            this._lastAppendLog = now;\n        }\n        \n        // 改進的演算法：DC Offset Removal（移除直流偏移）\n        // 先計算區塊平均值，再以此為中心計算 min/max\n        // 這樣可以讓波形更對稱、細緻\n        for (let i = 0; i < total; i += factor) {\n            let blockSum = 0;\n            let blockCount = 0;\n\n            // 第一階段：計算區塊平均值（DC offset）\n            for (let j = 0; j < factor && (i + j) < total; j++) {\n                const sample = audioSamples[i + j];\n                blockSum += sample;\n                blockCount++;\n            }\n\n            if (!blockCount) {\n                continue;\n            }\n\n            const blockMean = blockSum / blockCount;\n\n            // 第二階段：以區塊平均值為中心，計算去中心化的 min/max\n            let blockMin = 1.0;\n            let blockMax = -1.0;\n\n            for (let k = 0; k < blockCount; k++) {\n                const centeredSample = audioSamples[i + k] - blockMean;\n                if (centeredSample < blockMin) {\n                    blockMin = centeredSample;\n                }\n                if (centeredSample > blockMax) {\n                    blockMax = centeredSample;\n                }\n            }\n\n            // 防呆：確保 min <= max\n            if (blockMin > blockMax) {\n                blockMin = blockMax = 0;\n            }\n\n            this.sampleMin.push(blockMin);\n            this.sampleMax.push(blockMax);\n            appendedMin.push(blockMin);\n            appendedMax.push(blockMax);\n            this.sampleCount++;\n        }\n\n        if (this.isAutoScroll) {\n            this.scrollToLatest();\n        } else {\n            this._enforceViewBounds();\n        }\n\n        if (this._useWorker && this._worker) {\n            this._appendBatchMin.push(...appendedMin);\n            this._appendBatchMax.push(...appendedMax);\n            if (!this._appendFlushScheduled) {\n                this._appendFlushScheduled = true;\n                const self = this;\n                const flush = () => self._flushAppendBatch();\n                if (typeof requestAnimationFrame === 'function') {\n                    requestAnimationFrame(flush);\n                } else {\n                    setTimeout(flush, 32);\n                }\n            }\n        }\n        \n        this.draw();\n    }\n\n    _flushAppendBatch() {\n        if (!this._worker || this._appendBatchMin.length === 0) {\n            this._appendFlushScheduled = false;\n            return;\n        }\n        \n        this._worker.postMessage({\n            type: 'append',\n            minArr: this._appendBatchMin,\n            maxArr: this._appendBatchMax\n        });\n        \n        this._appendBatchMin = [];\n        this._appendBatchMax = [];\n        this._appendFlushScheduled = false;\n    }\n\n    draw() {\n        if (this._useWorker && this._worker) {\n            this._worker.postMessage({\n                type: 'draw',\n                zoomFactor: this.zoomFactor,\n                viewStart: this.viewStart,\n                playbackPosition: this.playbackPosition,\n                isPlaying: this.isPlaying\n            });\n            return;\n        }\n        \n        if (!this.canvasContext) return;\n        \n        // 主線程繪製\n        this.clear();\n        \n        if (this.sampleCount === 0) return;\n        \n        // 使用 getVisibleSamples() 獲取正確的可見範圍\n        const info = this.getVisibleSamples();\n        const { start, end, visible } = info;\n        \n        if (visible === 0 || start >= end) return;\n        \n        const centerY = this.height / 2;\n        \n        // 繪製波形 - 使用 sample 之間的連線\n        this.canvasContext.strokeStyle = '#1E88E5';\n        this.canvasContext.lineWidth = 1.5;\n        this.canvasContext.lineJoin = 'round';\n        this.canvasContext.lineCap = 'round';\n        \n        // 繪製上半部波形（最大值）\n        this.canvasContext.beginPath();\n        let hasFirstPoint = false;\n        for (let i = start; i < end; i++) {\n            const x = ((i - start) / visible) * this.width;\n            const y = centerY - (this.sampleMax[i] * centerY * 0.95);\n            \n            if (!hasFirstPoint) {\n                this.canvasContext.moveTo(x, y);\n                hasFirstPoint = true;\n            } else {\n                this.canvasContext.lineTo(x, y);\n            }\n        }\n        this.canvasContext.stroke();\n        \n        // 繪製下半部波形（最小值）\n        this.canvasContext.beginPath();\n        hasFirstPoint = false;\n        for (let i = start; i < end; i++) {\n            const x = ((i - start) / visible) * this.width;\n            const y = centerY - (this.sampleMin[i] * centerY * 0.95);\n            \n            if (!hasFirstPoint) {\n                this.canvasContext.moveTo(x, y);\n                hasFirstPoint = true;\n            } else {\n                this.canvasContext.lineTo(x, y);\n            }\n        }\n        this.canvasContext.stroke();\n        \n        // 繪製中線\n        this.canvasContext.strokeStyle = '#d0d0d0';\n        this.canvasContext.lineWidth = 1;\n        this.canvasContext.beginPath();\n        this.canvasContext.moveTo(0, centerY + 0.5);\n        this.canvasContext.lineTo(this.width, centerY + 0.5);\n        this.canvasContext.stroke();\n    }\n\n    getVisibleSamples() {\n        const total = this.sampleCount;\n        if (total === 0) return { start: 0, end: 0, visible: 0 };\n        \n        const minVis = this._getMinVisibleSamples(total);\n        let visible = Math.max(minVis, Math.round(total / this.zoomFactor));\n        if (visible > total) visible = total;\n        \n        let start = this.viewStart;\n        if (start + visible > total) start = total - visible;\n        if (start < 0) start = 0;\n        \n        const end = Math.min(total, start + visible);\n        return { start, end, visible };\n    }\n\n    _getMinVisibleSamples(total) {\n        // 允許放大到看到每個 sample\n        // 最小可見樣本數設為 canvas 寬度的 1/10，這樣每個 sample 可以占據約 10 個像素\n        return Math.max(10, Math.floor(this.width / 10));\n    }\n\n    _enforceViewBounds() {\n        if (this.sampleCount === 0) {\n            this.viewStart = 0;\n            return;\n        }\n        \n        const info = this.getVisibleSamples();\n        this.viewStart = info.start;\n        \n        // 確保 viewStart 在有效範圍內\n        if (this.viewStart < 0) {\n            this.viewStart = 0;\n        }\n        \n        const maxStart = Math.max(0, this.sampleCount - info.visible);\n        if (this.viewStart > maxStart) {\n            this.viewStart = maxStart;\n        }\n    }\n\n    scrollToLatest() {\n        const total = this.sampleCount;\n        if (total === 0) return;\n        \n        const minVis = this._getMinVisibleSamples(total);\n        let visible = Math.max(minVis, Math.round(total / this.zoomFactor));\n        if (visible > total) visible = total;\n        \n        this.viewStart = total - visible;\n        if (this.viewStart < 0) this.viewStart = 0;\n    }\n\n    setZoom(targetZoom, anchorSample) {\n        if (this.sampleCount === 0) return;\n        \n        if (targetZoom < 1) targetZoom = 1;\n        const maxZoom = Math.max(1, this.sampleCount / this._getMinVisibleSamples(this.sampleCount));\n        if (targetZoom > maxZoom) targetZoom = maxZoom;\n        \n        const oldInfo = this.getVisibleSamples();\n        this.zoomFactor = targetZoom;\n        const newInfo = this.getVisibleSamples();\n        \n        // 如果有錨點 sample，保持其視覺位置\n        if (typeof anchorSample === 'number' && anchorSample >= 0 && oldInfo.visible > 0) {\n            const oldRatio = (anchorSample - oldInfo.start) / oldInfo.visible;\n            const desiredStart = anchorSample - oldRatio * newInfo.visible;\n            this.viewStart = Math.max(0, Math.min(this.sampleCount - newInfo.visible, Math.floor(desiredStart)));\n        } else {\n            // 沒有錨點時，保持視圖中心\n            const oldCenter = oldInfo.start + oldInfo.visible / 2;\n            const desiredStart = oldCenter - newInfo.visible / 2;\n            this.viewStart = Math.max(0, Math.min(this.sampleCount - newInfo.visible, Math.floor(desiredStart)));\n        }\n        \n        this._enforceViewBounds();\n        this.draw();\n        \n        // 同步更新 OverviewWaveform\n        if (this.overviewWaveform) {\n            this.overviewWaveform.draw();\n        }\n    }\n\n    zoomBySteps(stepCount, anchorRatio = 0.5) {\n        if (stepCount === 0 || this.sampleCount === 0) return;\n        \n        // 增加縮放步進，從 1.2 改為 1.5，讓縮放更快\n        const zoomStep = 1.5;\n        const oldInfo = this.getVisibleSamples();\n        \n        // 確保 oldInfo.visible > 0 才計算錨點\n        let anchorSample;\n        if (oldInfo.visible > 0) {\n            anchorSample = oldInfo.start + anchorRatio * oldInfo.visible;\n        } else {\n            anchorSample = 0;\n        }\n        \n        let newZoom = this.zoomFactor;\n        if (stepCount > 0) {\n            newZoom *= Math.pow(zoomStep, stepCount);\n        } else {\n            newZoom /= Math.pow(zoomStep, -stepCount);\n        }\n        \n        this.setZoom(newZoom, anchorSample);\n    }\n\n    panBySamples(sampleDelta) {\n        if (sampleDelta === 0) return;\n        \n        this.isAutoScroll = false;\n        this.viewStart += sampleDelta;\n        this._enforceViewBounds();\n        this.draw();\n        \n        // 同步更新 OverviewWaveform\n        if (this.overviewWaveform) {\n            this.overviewWaveform.draw();\n        }\n    }\n\n    panByPixels(pixelDelta) {\n        if (pixelDelta === 0) return;\n        \n        const info = this.getVisibleSamples();\n        const samplesPerPixel = info.visible / this.width;\n        const totalDelta = pixelDelta * samplesPerPixel + this._panRemainder;\n        const intDelta = Math.round(totalDelta);\n        this._panRemainder = totalDelta - intDelta;\n        \n        this.panBySamples(intDelta);\n    }\n\n    resetView() {\n        this.zoomFactor = 1;\n        this.viewStart = 0;\n        this.isAutoScroll = true;\n        this._panRemainder = 0;\n        this.scrollToLatest();\n        this.draw();\n        \n        // 同步更新 OverviewWaveform\n        if (this.overviewWaveform) {\n            this.overviewWaveform.draw();\n        }\n    }\n\n    setSourceSampleRate(sampleRate) {\n        this.sourceSampleRate = sampleRate || 48000;\n        this.decimationFactor = Math.max(1, Math.round(this.sourceSampleRate / this.targetSampleRate));\n        \n        if (this._worker) {\n            this._worker.postMessage({\n                type: 'setSampleRate',\n                sourceSampleRate: this.sourceSampleRate,\n                decimationFactor: this.decimationFactor\n            });\n        }\n    }\n\n    _getSamplePair(index) {\n        if (index < 0 || index >= this.sampleCount) {\n            return { min: 0, max: 0 };\n        }\n        return {\n            min: this.sampleMin[index],\n            max: this.sampleMax[index]\n        };\n    }\n\n    setPlaybackPosition(sampleIndex) {\n        this.playbackPosition = sampleIndex;\n        this.draw();\n    }\n\n    setRawZoomMode(enabled) {\n        this.rawZoomMode = !!enabled;\n    }\n\n    startPlayback(startSample, sampleRate) {\n        this.isPlaying = true;\n        this.playbackStartSample = startSample || 0;\n        this.playbackStartTime = performance.now ? performance.now() : Date.now();\n        this.playbackPosition = this.playbackStartSample;\n        \n        const self = this;\n        const sr = sampleRate || this.sourceSampleRate;\n        \n        function updatePosition() {\n            if (!self.isPlaying) return;\n            \n            const now = performance.now ? performance.now() : Date.now();\n            const elapsed = (now - self.playbackStartTime) / 1000;\n            const rawSamples = elapsed * sr;\n            const decimatedPos = self.playbackStartSample + Math.floor(rawSamples / self.decimationFactor);\n            \n            self.playbackPosition = decimatedPos;\n            self.draw();\n            \n            requestAnimationFrame(updatePosition);\n        }\n        \n        requestAnimationFrame(updatePosition);\n    }\n\n    stopPlayback() {\n        this.isPlaying = false;\n        this.playbackPosition = 0;\n        this.draw();\n    }\n\n    _updatePlaybackPosition() {\n        if (!this.isPlaying) return;\n        \n        const now = performance.now ? performance.now() : Date.now();\n        const elapsed = (now - this.playbackStartTime) / 1000;\n        const rawSamples = elapsed * this.sourceSampleRate;\n        const decimatedPos = this.playbackStartSample + Math.floor(rawSamples / this.decimationFactor);\n        \n        this.playbackPosition = decimatedPos;\n    }\n}\n\n/* ================================================================\n * OverviewWaveform 類 - 全局波形概覽\n * 顯示整個錄音的波形概覽，並標示當前可視範圍\n * ================================================================ */\nexport class OverviewWaveform {\n    constructor(canvas, accumulatedWaveform) {\n        this.canvas = canvas;\n        this.ctx = canvas.getContext('2d');\n        this.accumulatedWaveform = accumulatedWaveform;\n        this.width = canvas.width;\n        this.height = canvas.height;\n        \n        // 暫時禁用 Worker 模式，使用主線程繪製\n        this._useWorker = false;\n        this._workerRef = null;\n        this._warnedNoData = false;\n        this._lastTotal = 0;\n        \n        // 設置滑鼠互動\n        this._setupMouseInteraction();\n        \n        // 注意：如果要啟用 Worker，需要確保 canvas 尚未獲取 context\n        // 且 accumulatedWaveform 已成功轉移其 canvas 控制權\n    }\n    \n    /**\n     * 設置滑鼠互動（點擊跳轉、拖曳可視範圍）\n     * @private\n     */\n    _setupMouseInteraction() {\n        if (!this.canvas) return;\n        \n        let isDragging = false;\n        let dragStartX = 0;\n        let dragStartViewStart = 0;\n        let dragClickedSample = 0; // 記錄點擊位置對應的絕對樣本位置\n        let dragVisibleSamples = 0; // 記錄拖曳開始時的可視範圍大小\n        \n        // 滑鼠按下 - 點擊或開始拖曳\n        this.canvas.addEventListener('mousedown', (e) => {\n            const acc = this.accumulatedWaveform;\n            if (!acc || acc.sampleCount === 0) return;\n            \n            isDragging = true;\n            dragStartX = e.offsetX;\n            dragStartViewStart = acc.viewStart;\n            \n            // 記錄拖曳開始時的狀態\n            const total = acc.sampleCount;\n            const info = acc.getVisibleSamples();\n            dragVisibleSamples = info.visible;\n            \n            // 計算點擊位置在可視範圍指示器內的偏移\n            // 使用與繪製時相同的座標映射邏輯\n            const viewStartX = Math.floor((info.start / total) * this.width);\n            const offsetInView = e.offsetX - viewStartX;\n            dragClickedSample = offsetInView; // 記錄在可視範圍內的像素偏移\n            \n            this.canvas.style.cursor = 'grabbing';\n        });\n        \n        // 滑鼠移動 - 拖曳更新\n        this.canvas.addEventListener('mousemove', (e) => {\n            if (!isDragging) return;\n            \n            const acc = this.accumulatedWaveform;\n            if (!acc || acc.sampleCount === 0) return;\n            \n            const total = acc.sampleCount;\n            \n            // 計算新的可視範圍起始位置（像素）\n            // 保持滑鼠在可視範圍內的相對位置不變\n            const targetViewStartX = e.offsetX - dragClickedSample;\n            \n            // 像素 → 樣本（使用反向映射）\n            const newViewStart = Math.floor((targetViewStartX / this.width) * total);\n            \n            // 確保 viewStart 在有效範圍內\n            const maxViewStart = Math.max(0, total - dragVisibleSamples);\n            const clampedViewStart = Math.max(0, Math.min(maxViewStart, newViewStart));\n            \n            // 更新視圖\n            acc.viewStart = clampedViewStart;\n            acc.isAutoScroll = false;\n            acc._enforceViewBounds();\n            acc.draw();\n            \n            // 重繪 overview\n            this.draw();\n        });\n        \n        // 滑鼠放開\n        this.canvas.addEventListener('mouseup', () => {\n            isDragging = false;\n            this.canvas.style.cursor = 'pointer';\n        });\n        \n        // 滑鼠離開\n        this.canvas.addEventListener('mouseleave', () => {\n            if (isDragging) {\n                isDragging = false;\n                this.canvas.style.cursor = 'pointer';\n            }\n        });\n        \n        // 設置 cursor 樣式\n        this.canvas.style.cursor = 'pointer';\n    }\n    \n    /**\n     * 處理點擊/拖曳跳轉\n     * @private\n     */\n    _handleSeek(clickX) {\n        const acc = this.accumulatedWaveform;\n        if (!acc || acc.sampleCount === 0) return;\n        \n        const total = acc.sampleCount;\n        const clickRatio = Math.max(0, Math.min(1, clickX / this.width));\n        const targetSample = Math.floor(clickRatio * total);\n        \n        // 獲取當前縮放級別下的可見樣本數\n        // 注意：這裡我們需要在設置 viewStart 之前就知道可見範圍\n        const currentZoom = acc.zoomFactor;\n        const minVis = acc._getMinVisibleSamples(total);\n        let visibleSamples = Math.max(minVis, Math.round(total / currentZoom));\n        if (visibleSamples > total) visibleSamples = total;\n        \n        // 計算新的 viewStart，讓 targetSample 位於可見範圍的中心\n        const halfVisible = Math.floor(visibleSamples / 2);\n        let newViewStart = targetSample - halfVisible;\n        \n        // 確保 viewStart 在有效範圍內\n        const maxViewStart = Math.max(0, total - visibleSamples);\n        newViewStart = Math.max(0, Math.min(maxViewStart, newViewStart));\n        \n        console.log('🎯 OverviewWaveform 導航:', {\n            clickX,\n            clickRatio: clickRatio.toFixed(3),\n            targetSample,\n            total,\n            visibleSamples,\n            halfVisible,\n            newViewStart,\n            maxViewStart,\n            zoomFactor: currentZoom\n        });\n        \n        // 更新 accumulated waveform 的視圖位置\n        acc.viewStart = newViewStart;\n        acc.isAutoScroll = false;\n        acc._enforceViewBounds();\n        acc.draw();\n        \n        // 重繪 overview 以更新可視範圍指示器\n        this.draw();\n        \n        // 觸發自定義事件\n        const event = new CustomEvent('overview-seek', {\n            detail: {\n                sample: targetSample,\n                time: targetSample / acc.sourceSampleRate\n            }\n        });\n        this.canvas.dispatchEvent(event);\n    }\n\n    clear() {\n        if (this._useWorker && this._workerRef) {\n            this._workerRef.postMessage({ type: 'clearOverview' });\n            return;\n        }\n        \n        this.ctx.clearRect(0, 0, this.width, this.height);\n        this.ctx.fillStyle = '#f5f5f5';\n        this.ctx.fillRect(0, 0, this.width, this.height);\n    }\n\n    draw() {\n        if (this._useWorker && this._workerRef) {\n            // Worker 會自動同步繪製 overview\n            return;\n        }\n        \n        // 主線程繪製\n        this.clear();\n        \n        const acc = this.accumulatedWaveform;\n        if (!acc || acc.sampleCount === 0) {\n            console.log('⚠️ OverviewWaveform: 沒有數據可顯示', {\n                hasAcc: !!acc,\n                sampleCount: acc ? acc.sampleCount : 0\n            });\n            return;\n        }\n        \n        const total = acc.sampleCount;\n        const info = acc.getVisibleSamples();\n        \n        console.log('📊 OverviewWaveform 繪製:', {\n            total,\n            visibleStart: info.start,\n            visibleEnd: info.end,\n            canvasWidth: this.width,\n            canvasHeight: this.height\n        });\n        \n        // 繪製全局波形\n        this.ctx.strokeStyle = '#64b5f6';\n        this.ctx.lineWidth = 1;\n        \n        const samplesPerPixel = total / this.width;\n        for (let x = 0; x < this.width; x++) {\n            const sampleIndex = Math.floor(x * samplesPerPixel);\n            if (sampleIndex >= total) break;\n            \n            const sample = acc._getSamplePair(sampleIndex);\n            const centerY = this.height / 2;\n            const yMin = Math.floor(centerY - (sample.max * centerY * 0.9));\n            const yMax = Math.floor(centerY - (sample.min * centerY * 0.9));\n            \n            // 繪製垂直線\n            this.ctx.beginPath();\n            this.ctx.moveTo(x, yMin);\n            this.ctx.lineTo(x, yMax);\n            this.ctx.stroke();\n        }\n        \n        // 繪製中線\n        this.ctx.strokeStyle = '#e0e0e0';\n        this.ctx.lineWidth = 1;\n        this.ctx.beginPath();\n        this.ctx.moveTo(0, this.height / 2);\n        this.ctx.lineTo(this.width, this.height / 2);\n        this.ctx.stroke();\n        \n        // 繪製可視範圍指示器\n        const viewStartX = Math.floor((info.start / total) * this.width);\n        const viewEndX = Math.floor((info.end / total) * this.width);\n        const viewWidth = Math.max(2, viewEndX - viewStartX);\n        \n        // 半透明覆蓋\n        this.ctx.fillStyle = 'rgba(33, 150, 243, 0.15)';\n        this.ctx.fillRect(viewStartX, 0, viewWidth, this.height);\n        \n        // 邊框\n        this.ctx.strokeStyle = '#2196F3';\n        this.ctx.lineWidth = 2;\n        this.ctx.strokeRect(viewStartX, 0, viewWidth, this.height);\n        \n        console.log('✅ OverviewWaveform 繪製完成');\n    }\n}\n\n// 導出所有類別\nexport default WaveformRenderer;\n","/**\n * StorageAdapter - 儲存適配器基類\n * 定義統一的儲存介面，支援多種儲存後端\n */\n\nexport class StorageAdapter {\n  /**\n   * 儲存音訊檔案\n   * @param {Blob} blob - 音訊 Blob 物件\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據（可選）\n   * @returns {Promise<string>} 檔案 ID 或 URL\n   */\n  async save(blob, filename, metadata = {}) {\n    throw new Error('save() must be implemented by subclass');\n  }\n  \n  /**\n   * 載入音訊檔案\n   * @param {string} id - 檔案 ID 或名稱\n   * @returns {Promise<Blob>} 音訊 Blob 物件\n   */\n  async load(id) {\n    throw new Error('load() must be implemented by subclass');\n  }\n  \n  /**\n   * 刪除音訊檔案\n   * @param {string} id - 檔案 ID 或名稱\n   * @returns {Promise<boolean>} 是否成功刪除\n   */\n  async delete(id) {\n    throw new Error('delete() must be implemented by subclass');\n  }\n  \n  /**\n   * 列出所有檔案\n   * @returns {Promise<Array>} 檔案列表\n   */\n  async list() {\n    throw new Error('list() must be implemented by subclass');\n  }\n  \n  /**\n   * 檢查檔案是否存在\n   * @param {string} id - 檔案 ID 或名稱\n   * @returns {Promise<boolean>}\n   */\n  async exists(id) {\n    try {\n      await this.load(id);\n      return true;\n    } catch (error) {\n      return false;\n    }\n  }\n  \n  /**\n   * 清空所有檔案（謹慎使用）\n   * @returns {Promise<number>} 刪除的檔案數量\n   */\n  async clear() {\n    const files = await this.list();\n    let count = 0;\n    \n    for (const file of files) {\n      try {\n        await this.delete(file.id || file.filename);\n        count++;\n      } catch (error) {\n        console.error('Failed to delete file:', file, error);\n      }\n    }\n    \n    return count;\n  }\n}\n\nexport default StorageAdapter;\n","/**\n * VoiceBank Recorder - 主入口點\n * 跨平台音訊錄音庫\n * \n * @version 1.0.0\n * @author VoiceBank Team\n * @license MIT\n */\n\n// 匯出核心模組\nexport { AudioEngine } from './core/AudioEngine.js';\nexport { WaveformRenderer } from './core/WaveformRenderer.js';\nexport { DeviceManager } from './core/DeviceManager.js';\n\n// 匯出 UI 模組\nexport { VoiceBankRecorderUI } from './ui/VoiceBankRecorderUI.js';\n\n// 匯出儲存模組\nexport {\n  StorageAdapter,\n  IndexedDBAdapter,\n  ServerAdapter,\n  ElectronAdapter,\n  CapacitorAdapter,\n  StorageFactory\n} from './storage/index.js';\n\n// 匯出工具模組\nexport { PlatformDetector } from './utils/PlatformDetector.js';\n\n/**\n * VoiceBankRecorder - 主類別\n * 提供統一的 API 介面\n */\nexport class VoiceBankRecorder {\n  /**\n   * 建構函數\n   * @param {Object} options - 配置選項\n   * @param {string|HTMLElement} options.container - 容器選擇器或元素\n   * @param {string} options.layout - 佈局模式 ('horizontal'|'vertical'|'auto')\n   * @param {string} options.theme - 主題 ('light'|'dark')\n   * @param {Object} options.audio - 音訊配置\n   * @param {Object} options.waveform - 波形配置\n   * @param {Object} options.storage - 儲存配置\n   * @param {Object} options.callbacks - 事件回調\n   */\n  constructor(options = {}) {\n    this.options = this.mergeOptions(options);\n    this.initialized = false;\n    \n    // 初始化儲存適配器\n    this.storage = this.createStorageAdapter(this.options.storage);\n    \n    // 狀態\n    this.isRecording = false;\n    this.isPaused = false;\n    this.currentBlob = null;\n    \n    // 如果提供了容器，初始化 UI\n    if (this.options.container) {\n      this.initializeUI();\n    }\n  }\n  \n  /**\n   * 合併配置選項\n   * @param {Object} options - 用戶選項\n   * @returns {Object} 合併後的選項\n   */\n  mergeOptions(options) {\n    const defaults = {\n      container: null,\n      layout: 'auto',\n      theme: 'light',\n      \n      audio: {\n        sampleRate: 48000,\n        channels: 1,\n        agc: false,\n        gain: 1.0\n      },\n      \n      waveform: {\n        showOverview: true,\n        showAccumulated: true,\n        showLive: true,\n        decimation: 10,\n        colors: {\n          waveform: '#1E88E5',\n          selection: '#4CAF50',\n          playback: '#FF0000'\n        }\n      },\n      \n      storage: {\n        type: 'auto'\n      },\n      \n      callbacks: {\n        onRecordStart: () => {},\n        onRecordStop: () => {},\n        onRecordPause: () => {},\n        onRecordResume: () => {},\n        onPlayStart: () => {},\n        onPlayStop: () => {},\n        onError: (error) => console.error('VoiceBankRecorder error:', error)\n      }\n    };\n    \n    // 深度合併\n    return this.deepMerge(defaults, options);\n  }\n  \n  /**\n   * 深度合併物件\n   * @param {Object} target - 目標物件\n   * @param {Object} source - 來源物件\n   * @returns {Object}\n   */\n  deepMerge(target, source) {\n    const result = { ...target };\n    \n    for (const key in source) {\n      if (source[key] instanceof Object && !Array.isArray(source[key])) {\n        result[key] = this.deepMerge(result[key] || {}, source[key]);\n      } else {\n        result[key] = source[key];\n      }\n    }\n    \n    return result;\n  }\n  \n  /**\n   * 創建儲存適配器\n   * @param {Object} storageConfig - 儲存配置\n   * @returns {StorageAdapter}\n   */\n  createStorageAdapter(storageConfig) {\n    const { StorageFactory } = require('./storage/index.js');\n    return StorageFactory.create({\n      type: storageConfig.type || 'auto',\n      options: storageConfig\n    });\n  }\n  \n  /**\n   * 初始化 UI\n   */\n  initializeUI() {\n    // TODO: 實作 UI 初始化\n    // 這將在後續階段實作\n    console.log('UI initialization - to be implemented');\n  }\n  \n  /**\n   * 開始錄音\n   * @returns {Promise<void>}\n   */\n  async startRecording() {\n    try {\n      if (this.isRecording) {\n        throw new Error('Already recording');\n      }\n      \n      // TODO: 實作錄音邏輯\n      this.isRecording = true;\n      this.options.callbacks.onRecordStart();\n      \n      console.log('Recording started');\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 停止錄音\n   * @returns {Promise<Blob>}\n   */\n  async stopRecording() {\n    try {\n      if (!this.isRecording) {\n        throw new Error('Not recording');\n      }\n      \n      // TODO: 實作停止錄音邏輯\n      this.isRecording = false;\n      \n      // 模擬返回 Blob（實際會從 AudioEngine 獲取）\n      this.currentBlob = null; // TODO: 實際的 Blob\n      \n      this.options.callbacks.onRecordStop(this.currentBlob);\n      \n      console.log('Recording stopped');\n      return this.currentBlob;\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 暫停錄音\n   * @returns {Promise<void>}\n   */\n  async pauseRecording() {\n    try {\n      if (!this.isRecording || this.isPaused) {\n        throw new Error('Cannot pause');\n      }\n      \n      this.isPaused = true;\n      this.options.callbacks.onRecordPause();\n      \n      console.log('Recording paused');\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 恢復錄音\n   * @returns {Promise<void>}\n   */\n  async resumeRecording() {\n    try {\n      if (!this.isRecording || !this.isPaused) {\n        throw new Error('Cannot resume');\n      }\n      \n      this.isPaused = false;\n      this.options.callbacks.onRecordResume();\n      \n      console.log('Recording resumed');\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 播放錄音\n   * @returns {Promise<void>}\n   */\n  async play() {\n    try {\n      // TODO: 實作播放邏輯\n      this.options.callbacks.onPlayStart();\n      \n      console.log('Playback started');\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 停止播放\n   * @returns {Promise<void>}\n   */\n  async stop() {\n    try {\n      // TODO: 實作停止播放邏輯\n      this.options.callbacks.onPlayStop();\n      \n      console.log('Playback stopped');\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 儲存錄音\n   * @param {Blob} blob - 音訊 Blob（可選，使用當前錄音）\n   * @param {string} filename - 檔案名稱（可選，自動生成）\n   * @param {Object} metadata - 元數據（可選）\n   * @returns {Promise<string>} 檔案 ID\n   */\n  async saveRecording(blob = null, filename = null, metadata = {}) {\n    try {\n      const blobToSave = blob || this.currentBlob;\n      \n      if (!blobToSave) {\n        throw new Error('No recording to save');\n      }\n      \n      const filenameToUse = filename || `recording-${Date.now()}.wav`;\n      \n      const id = await this.storage.save(blobToSave, filenameToUse, metadata);\n      \n      console.log('Recording saved:', id);\n      return id;\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 載入錄音\n   * @param {string} id - 檔案 ID\n   * @returns {Promise<Blob>}\n   */\n  async loadRecording(id) {\n    try {\n      const blob = await this.storage.load(id);\n      this.currentBlob = blob;\n      \n      console.log('Recording loaded:', id);\n      return blob;\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 刪除錄音\n   * @param {string} id - 檔案 ID\n   * @returns {Promise<boolean>}\n   */\n  async deleteRecording(id) {\n    try {\n      const result = await this.storage.delete(id);\n      \n      console.log('Recording deleted:', id);\n      return result;\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 列出所有錄音\n   * @returns {Promise<Array>}\n   */\n  async listRecordings() {\n    try {\n      const recordings = await this.storage.list();\n      \n      console.log('Recordings listed:', recordings.length);\n      return recordings;\n    } catch (error) {\n      this.options.callbacks.onError(error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 取得當前錄音 Blob\n   * @returns {Blob|null}\n   */\n  getCurrentBlob() {\n    return this.currentBlob;\n  }\n  \n  /**\n   * 銷毀實例\n   */\n  destroy() {\n    // TODO: 清理資源\n    this.isRecording = false;\n    this.isPaused = false;\n    this.currentBlob = null;\n    \n    if (this.storage && typeof this.storage.close === 'function') {\n      this.storage.close();\n    }\n    \n    console.log('VoiceBankRecorder destroyed');\n  }\n}\n\n// 預設導出\nexport default VoiceBankRecorder;\n\n/**\n * 版本資訊\n */\nexport const VERSION = '1.0.0';\n\n/**\n * 建置資訊\n */\nexport const BUILD_INFO = {\n  version: VERSION,\n  date: new Date().toISOString(),\n  name: 'VoiceBank Recorder'\n};\n","/**\n * CapacitorAdapter - Capacitor 檔案系統儲存適配器\n * 使用 Capacitor Filesystem Plugin 在移動裝置上儲存檔案\n */\n\nimport { StorageAdapter } from './StorageAdapter.js';\n\nexport class CapacitorAdapter extends StorageAdapter {\n  /**\n   * 建構函數\n   * @param {string} directory - 儲存目錄名稱\n   */\n  constructor(directory = 'recordings') {\n    super();\n    this.directory = directory;\n    \n    // 檢查 Capacitor 是否可用\n    if (typeof window === 'undefined' || !window.Capacitor) {\n      throw new Error('Capacitor not available. Make sure Capacitor is properly initialized.');\n    }\n    \n    this.Capacitor = window.Capacitor;\n    this.initialized = false;\n  }\n  \n  /**\n   * 初始化（確保目錄存在）\n   * @returns {Promise<void>}\n   */\n  async initialize() {\n    if (this.initialized) return;\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      // 嘗試讀取目錄，如果不存在則創建\n      try {\n        await Filesystem.readdir({\n          path: this.directory,\n          directory: Directory.Documents\n        });\n      } catch (e) {\n        // 目錄不存在，創建它\n        await Filesystem.mkdir({\n          path: this.directory,\n          directory: Directory.Documents,\n          recursive: true\n        });\n      }\n      \n      this.initialized = true;\n    } catch (error) {\n      console.error('Capacitor initialization error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 儲存音訊檔案\n   * @param {Blob} blob - 音訊 Blob\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據\n   * @returns {Promise<string>} 檔案名稱\n   */\n  async save(blob, filename, metadata = {}) {\n    await this.initialize();\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      // 轉換 Blob 為 base64\n      const base64Data = await this.blobToBase64(blob);\n      \n      // 儲存音訊檔案\n      await Filesystem.writeFile({\n        path: `${this.directory}/${filename}`,\n        data: base64Data,\n        directory: Directory.Documents\n      });\n      \n      // 儲存元數據\n      if (metadata && Object.keys(metadata).length > 0) {\n        const metadataWithDefaults = {\n          ...metadata,\n          size: blob.size,\n          type: blob.type,\n          timestamp: Date.now()\n        };\n        \n        await Filesystem.writeFile({\n          path: `${this.directory}/${filename}.meta.json`,\n          data: JSON.stringify(metadataWithDefaults),\n          directory: Directory.Documents,\n          encoding: 'utf8'\n        });\n      }\n      \n      return filename;\n    } catch (error) {\n      console.error('Capacitor save error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 載入音訊檔案\n   * @param {string} filename - 檔案名稱\n   * @returns {Promise<Blob>}\n   */\n  async load(filename) {\n    await this.initialize();\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      const result = await Filesystem.readFile({\n        path: `${this.directory}/${filename}`,\n        directory: Directory.Documents\n      });\n      \n      // 將 base64 轉換為 Blob\n      return this.base64ToBlob(result.data, 'audio/wav');\n    } catch (error) {\n      console.error('Capacitor load error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 刪除音訊檔案\n   * @param {string} filename - 檔案名稱\n   * @returns {Promise<boolean>}\n   */\n  async delete(filename) {\n    await this.initialize();\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      // 刪除音訊檔案\n      await Filesystem.deleteFile({\n        path: `${this.directory}/${filename}`,\n        directory: Directory.Documents\n      });\n      \n      // 嘗試刪除元數據（如果存在）\n      try {\n        await Filesystem.deleteFile({\n          path: `${this.directory}/${filename}.meta.json`,\n          directory: Directory.Documents\n        });\n      } catch (e) {\n        // 元數據可能不存在，忽略錯誤\n      }\n      \n      return true;\n    } catch (error) {\n      console.error('Capacitor delete error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 列出所有檔案\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    await this.initialize();\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      const result = await Filesystem.readdir({\n        path: this.directory,\n        directory: Directory.Documents\n      });\n      \n      // 過濾掉元數據檔案，只保留音訊檔案\n      const audioFiles = result.files.filter(f => !f.endsWith('.meta.json'));\n      \n      // 為每個檔案載入元數據\n      const recordings = await Promise.all(\n        audioFiles.map(async (filename) => {\n          let metadata = {};\n          \n          try {\n            const metaResult = await Filesystem.readFile({\n              path: `${this.directory}/${filename}.meta.json`,\n              directory: Directory.Documents,\n              encoding: 'utf8'\n            });\n            metadata = JSON.parse(metaResult.data);\n          } catch (e) {\n            // 沒有元數據\n          }\n          \n          return {\n            id: filename,\n            filename: filename,\n            metadata: metadata,\n            timestamp: metadata.timestamp || 0,\n            date: metadata.timestamp ? new Date(metadata.timestamp) : null,\n            size: metadata.size || 0,\n            type: metadata.type || 'audio/wav'\n          };\n        })\n      );\n      \n      // 按時間排序（最新的在前）\n      recordings.sort((a, b) => b.timestamp - a.timestamp);\n      \n      return recordings;\n    } catch (error) {\n      console.error('Capacitor list error:', error);\n      return [];\n    }\n  }\n  \n  /**\n   * 取得檔案的 URI（用於播放）\n   * @param {string} filename - 檔案名稱\n   * @returns {Promise<string>} 檔案 URI\n   */\n  async getUri(filename) {\n    await this.initialize();\n    \n    try {\n      const { Filesystem, Directory } = this.Capacitor.Plugins;\n      \n      const result = await Filesystem.getUri({\n        path: `${this.directory}/${filename}`,\n        directory: Directory.Documents\n      });\n      \n      return result.uri;\n    } catch (error) {\n      console.error('Capacitor getUri error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * Blob 轉 base64\n   * @param {Blob} blob\n   * @returns {Promise<string>}\n   */\n  blobToBase64(blob) {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onloadend = () => {\n        // 移除 data:audio/wav;base64, 前綴\n        const base64 = reader.result.split(',')[1];\n        resolve(base64);\n      };\n      reader.onerror = reject;\n      reader.readAsDataURL(blob);\n    });\n  }\n  \n  /**\n   * base64 轉 Blob\n   * @param {string} base64\n   * @param {string} mimeType\n   * @returns {Blob}\n   */\n  base64ToBlob(base64, mimeType = 'audio/wav') {\n    const byteCharacters = atob(base64);\n    const byteNumbers = new Array(byteCharacters.length);\n    \n    for (let i = 0; i < byteCharacters.length; i++) {\n      byteNumbers[i] = byteCharacters.charCodeAt(i);\n    }\n    \n    const byteArray = new Uint8Array(byteNumbers);\n    return new Blob([byteArray], { type: mimeType });\n  }\n  \n  /**\n   * 取得儲存空間資訊\n   * @returns {Promise<Object>}\n   */\n  async getStorageInfo() {\n    const recordings = await this.list();\n    const totalSize = recordings.reduce((sum, r) => sum + (r.size || 0), 0);\n    \n    return {\n      count: recordings.length,\n      totalSize: totalSize,\n      totalSizeMB: (totalSize / (1024 * 1024)).toFixed(2),\n      recordings: recordings\n    };\n  }\n}\n\nexport default CapacitorAdapter;\n","/**\n * ElectronAdapter - Electron 檔案系統儲存適配器\n * 使用 Electron 的 IPC 通訊與主進程進行檔案操作\n */\n\nimport { StorageAdapter } from './StorageAdapter.js';\n\nexport class ElectronAdapter extends StorageAdapter {\n  /**\n   * 建構函數\n   * @param {string} savePath - 預設儲存路徑（相對於用戶文件目錄）\n   */\n  constructor(savePath = 'recordings') {\n    super();\n    this.savePath = savePath;\n    \n    // 檢查 Electron API 是否可用\n    if (typeof window === 'undefined' || !window.electronAPI) {\n      throw new Error('Electron API not available. Make sure preload script is properly configured.');\n    }\n    \n    this.electronAPI = window.electronAPI;\n  }\n  \n  /**\n   * 儲存音訊檔案\n   * @param {Blob} blob - 音訊 Blob\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據\n   * @returns {Promise<string>} 檔案路徑\n   */\n  async save(blob, filename, metadata = {}) {\n    try {\n      // 將 Blob 轉換為 ArrayBuffer\n      const arrayBuffer = await blob.arrayBuffer();\n      \n      // 轉換為普通陣列（以便通過 IPC 傳遞）\n      const buffer = Array.from(new Uint8Array(arrayBuffer));\n      \n      // 呼叫 Electron API\n      const result = await this.electronAPI.saveRecording({\n        filename,\n        buffer,\n        metadata: {\n          ...metadata,\n          size: blob.size,\n          type: blob.type,\n          timestamp: Date.now()\n        }\n      });\n      \n      if (result.success) {\n        return result.id || result.path;\n      } else {\n        throw new Error(result.error || 'Save failed');\n      }\n    } catch (error) {\n      console.error('Electron save error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 載入音訊檔案\n   * @param {string} filePath - 檔案路徑\n   * @returns {Promise<Blob>}\n   */\n  async load(filePath) {\n    try {\n      // 從 Electron 讀取檔案\n      const buffer = await this.electronAPI.loadRecording(filePath);\n      \n      // 將 Buffer 轉換為 Blob\n      const uint8Array = new Uint8Array(buffer);\n      return new Blob([uint8Array], { type: 'audio/wav' });\n    } catch (error) {\n      console.error('Electron load error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 刪除音訊檔案\n   * @param {string} filePath - 檔案路徑\n   * @returns {Promise<boolean>}\n   */\n  async delete(filePath) {\n    try {\n      const result = await this.electronAPI.deleteRecording(filePath);\n      return result.success;\n    } catch (error) {\n      console.error('Electron delete error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 列出所有檔案\n   * @param {string} directory - 目錄路徑（可選）\n   * @returns {Promise<Array>}\n   */\n  async list(directory = null) {\n    try {\n      const recordings = await this.electronAPI.listRecordings(directory);\n      return recordings || [];\n    } catch (error) {\n      console.error('Electron list error:', error);\n      return [];\n    }\n  }\n  \n  /**\n   * 開啟檔案選擇對話框\n   * @returns {Promise<string|null>} 選擇的檔案路徑\n   */\n  async openFile() {\n    try {\n      if (this.electronAPI.openFile) {\n        return await this.electronAPI.openFile();\n      }\n      throw new Error('openFile API not available');\n    } catch (error) {\n      console.error('Electron openFile error:', error);\n      return null;\n    }\n  }\n  \n  /**\n   * 開啟另存為對話框\n   * @param {Blob} blob - 要儲存的 Blob\n   * @param {string} defaultFilename - 預設檔案名稱\n   * @returns {Promise<string|null>} 儲存的檔案路徑\n   */\n  async saveAs(blob, defaultFilename = 'recording.wav') {\n    try {\n      const arrayBuffer = await blob.arrayBuffer();\n      const buffer = Array.from(new Uint8Array(arrayBuffer));\n      \n      if (this.electronAPI.saveAs) {\n        const result = await this.electronAPI.saveAs({\n          filename: defaultFilename,\n          buffer\n        });\n        \n        return result.success ? result.path : null;\n      }\n      \n      // 如果沒有 saveAs API，使用預設的 save\n      return await this.save(blob, defaultFilename);\n    } catch (error) {\n      console.error('Electron saveAs error:', error);\n      return null;\n    }\n  }\n  \n  /**\n   * 在檔案管理器中顯示檔案\n   * @param {string} filePath - 檔案路徑\n   * @returns {Promise<boolean>}\n   */\n  async showInFolder(filePath) {\n    try {\n      if (this.electronAPI.showInFolder) {\n        await this.electronAPI.showInFolder(filePath);\n        return true;\n      }\n      return false;\n    } catch (error) {\n      console.error('Electron showInFolder error:', error);\n      return false;\n    }\n  }\n}\n\nexport default ElectronAdapter;\n","/**\n * IndexedDBAdapter - IndexedDB 儲存實現\n * 用於瀏覽器端本地儲存，無需伺服器\n */\n\nimport { StorageAdapter } from './StorageAdapter.js';\n\nexport class IndexedDBAdapter extends StorageAdapter {\n  /**\n   * 建構函數\n   * @param {string} dbName - 資料庫名稱\n   * @param {string} storeName - 儲存區名稱\n   * @param {number} version - 資料庫版本\n   */\n  constructor(dbName = 'VoiceBankDB', storeName = 'recordings', version = 1) {\n    super();\n    this.dbName = dbName;\n    this.storeName = storeName;\n    this.version = version;\n    this.db = null;\n  }\n  \n  /**\n   * 初始化資料庫\n   * @returns {Promise<IDBDatabase>}\n   */\n  async initialize() {\n    if (this.db) {\n      return this.db;\n    }\n    \n    return new Promise((resolve, reject) => {\n      const request = indexedDB.open(this.dbName, this.version);\n      \n      request.onerror = () => {\n        reject(new Error(`Failed to open IndexedDB: ${request.error}`));\n      };\n      \n      request.onsuccess = () => {\n        this.db = request.result;\n        resolve(this.db);\n      };\n      \n      request.onupgradeneeded = (event) => {\n        const db = event.target.result;\n        \n        // 創建物件儲存區（如果不存在）\n        if (!db.objectStoreNames.contains(this.storeName)) {\n          const store = db.createObjectStore(this.storeName, { \n            keyPath: 'id', \n            autoIncrement: true \n          });\n          \n          // 創建索引\n          store.createIndex('filename', 'filename', { unique: false });\n          store.createIndex('timestamp', 'timestamp', { unique: false });\n          store.createIndex('duration', 'duration', { unique: false });\n        }\n      };\n    });\n  }\n  \n  /**\n   * 儲存音訊檔案\n   * @param {Blob} blob - 音訊 Blob\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據\n   * @returns {Promise<string>} 檔案 ID\n   */\n  async save(blob, filename, metadata = {}) {\n    await this.initialize();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      \n      const record = {\n        filename: filename,\n        blob: blob,\n        size: blob.size,\n        type: blob.type,\n        timestamp: Date.now(),\n        metadata: metadata\n      };\n      \n      const request = store.add(record);\n      \n      request.onsuccess = () => {\n        resolve(String(request.result));\n      };\n      \n      request.onerror = () => {\n        reject(new Error(`Failed to save recording: ${request.error}`));\n      };\n      \n      transaction.onerror = () => {\n        reject(new Error(`Transaction failed: ${transaction.error}`));\n      };\n    });\n  }\n  \n  /**\n   * 載入音訊檔案\n   * @param {string} id - 檔案 ID\n   * @returns {Promise<Blob>}\n   */\n  async load(id) {\n    await this.initialize();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.get(Number(id));\n      \n      request.onsuccess = () => {\n        const record = request.result;\n        if (record && record.blob) {\n          resolve(record.blob);\n        } else {\n          reject(new Error(`Recording not found: ${id}`));\n        }\n      };\n      \n      request.onerror = () => {\n        reject(new Error(`Failed to load recording: ${request.error}`));\n      };\n    });\n  }\n  \n  /**\n   * 刪除音訊檔案\n   * @param {string} id - 檔案 ID\n   * @returns {Promise<boolean>}\n   */\n  async delete(id) {\n    await this.initialize();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.delete(Number(id));\n      \n      request.onsuccess = () => {\n        resolve(true);\n      };\n      \n      request.onerror = () => {\n        reject(new Error(`Failed to delete recording: ${request.error}`));\n      };\n    });\n  }\n  \n  /**\n   * 列出所有檔案\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    await this.initialize();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction([this.storeName], 'readonly');\n      const store = transaction.objectStore(this.storeName);\n      const request = store.getAll();\n      \n      request.onsuccess = () => {\n        const records = request.result.map(record => ({\n          id: String(record.id),\n          filename: record.filename,\n          size: record.size,\n          type: record.type,\n          timestamp: record.timestamp,\n          date: new Date(record.timestamp),\n          metadata: record.metadata || {}\n        }));\n        resolve(records);\n      };\n      \n      request.onerror = () => {\n        reject(new Error(`Failed to list recordings: ${request.error}`));\n      };\n    });\n  }\n  \n  /**\n   * 根據檔名搜尋\n   * @param {string} filename - 檔案名稱（支援部分匹配）\n   * @returns {Promise<Array>}\n   */\n  async searchByFilename(filename) {\n    const allRecords = await this.list();\n    return allRecords.filter(record => \n      record.filename.toLowerCase().includes(filename.toLowerCase())\n    );\n  }\n  \n  /**\n   * 取得儲存空間使用情況\n   * @returns {Promise<Object>}\n   */\n  async getStorageInfo() {\n    const records = await this.list();\n    const totalSize = records.reduce((sum, record) => sum + record.size, 0);\n    \n    return {\n      count: records.length,\n      totalSize: totalSize,\n      totalSizeMB: (totalSize / (1024 * 1024)).toFixed(2),\n      records: records\n    };\n  }\n  \n  /**\n   * 清空所有錄音\n   * @returns {Promise<number>} 刪除的數量\n   */\n  async clear() {\n    await this.initialize();\n    \n    return new Promise((resolve, reject) => {\n      const transaction = this.db.transaction([this.storeName], 'readwrite');\n      const store = transaction.objectStore(this.storeName);\n      \n      // 先取得數量\n      const countRequest = store.count();\n      \n      countRequest.onsuccess = () => {\n        const count = countRequest.result;\n        \n        // 清空儲存區\n        const clearRequest = store.clear();\n        \n        clearRequest.onsuccess = () => {\n          resolve(count);\n        };\n        \n        clearRequest.onerror = () => {\n          reject(new Error(`Failed to clear recordings: ${clearRequest.error}`));\n        };\n      };\n      \n      countRequest.onerror = () => {\n        reject(new Error(`Failed to count recordings: ${countRequest.error}`));\n      };\n    });\n  }\n  \n  /**\n   * 取得瀏覽器儲存空間配額資訊（如果可用）\n   * @returns {Promise<Object|null>}\n   */\n  async getStorageEstimate() {\n    if ('storage' in navigator && 'estimate' in navigator.storage) {\n      try {\n        const estimate = await navigator.storage.estimate();\n        return {\n          usage: estimate.usage,\n          quota: estimate.quota,\n          usageMB: (estimate.usage / (1024 * 1024)).toFixed(2),\n          quotaMB: (estimate.quota / (1024 * 1024)).toFixed(2),\n          usagePercent: ((estimate.usage / estimate.quota) * 100).toFixed(2)\n        };\n      } catch (error) {\n        console.warn('Failed to get storage estimate:', error);\n        return null;\n      }\n    }\n    return null;\n  }\n  \n  /**\n   * 關閉資料庫連接\n   */\n  close() {\n    if (this.db) {\n      this.db.close();\n      this.db = null;\n    }\n  }\n}\n\nexport default IndexedDBAdapter;\n","/**\n * PlatformDetector - 平台偵測工具\n * 自動偵測當前運行環境（Browser/Electron/Capacitor）\n */\n\nexport class PlatformDetector {\n  /**\n   * 偵測當前平台\n   * @returns {string} 'browser' | 'electron' | 'capacitor'\n   */\n  static detect() {\n    // 檢查是否為 Electron\n    if (typeof window !== 'undefined' && window.electronAPI) {\n      return 'electron';\n    }\n    \n    // 檢查是否為 Electron（另一種方式）\n    if (typeof process !== 'undefined' && process.versions && process.versions.electron) {\n      return 'electron';\n    }\n    \n    // 檢查是否為 Capacitor\n    if (typeof window !== 'undefined' && window.Capacitor) {\n      return 'capacitor';\n    }\n    \n    // 預設為瀏覽器\n    return 'browser';\n  }\n  \n  /**\n   * 檢查是否為 Electron 環境\n   * @returns {boolean}\n   */\n  static isElectron() {\n    return this.detect() === 'electron';\n  }\n  \n  /**\n   * 檢查是否為 Capacitor 環境\n   * @returns {boolean}\n   */\n  static isCapacitor() {\n    return this.detect() === 'capacitor';\n  }\n  \n  /**\n   * 檢查是否為瀏覽器環境\n   * @returns {boolean}\n   */\n  static isBrowser() {\n    return this.detect() === 'browser';\n  }\n  \n  /**\n   * 檢查是否為移動裝置\n   * @returns {boolean}\n   */\n  static isMobile() {\n    if (typeof window === 'undefined' || !window.navigator) {\n      return false;\n    }\n    \n    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(\n      window.navigator.userAgent\n    );\n  }\n  \n  /**\n   * 檢查是否支援 AudioWorklet\n   * @returns {boolean}\n   */\n  static supportsAudioWorklet() {\n    if (typeof window === 'undefined' || !window.AudioContext) {\n      return false;\n    }\n    \n    const AudioContextClass = window.AudioContext || window.webkitAudioContext;\n    return 'audioWorklet' in AudioContextClass.prototype;\n  }\n  \n  /**\n   * 檢查是否支援 OffscreenCanvas\n   * @returns {boolean}\n   */\n  static supportsOffscreenCanvas() {\n    return typeof OffscreenCanvas !== 'undefined';\n  }\n  \n  /**\n   * 取得平台資訊\n   * @returns {Object}\n   */\n  static getInfo() {\n    return {\n      platform: this.detect(),\n      isElectron: this.isElectron(),\n      isCapacitor: this.isCapacitor(),\n      isBrowser: this.isBrowser(),\n      isMobile: this.isMobile(),\n      supportsAudioWorklet: this.supportsAudioWorklet(),\n      supportsOffscreenCanvas: this.supportsOffscreenCanvas(),\n      userAgent: typeof navigator !== 'undefined' ? navigator.userAgent : 'unknown'\n    };\n  }\n}\n\nexport default PlatformDetector;\n","/**\n * ServerAdapter - 伺服器儲存適配器\n * 支援 PHP/Node.js 等後端儲存方案\n */\n\nimport { StorageAdapter } from './StorageAdapter.js';\n\nexport class ServerAdapter extends StorageAdapter {\n  /**\n   * 建構函數\n   * @param {Object} config - 配置選項\n   * @param {string} config.baseURL - 基礎 URL\n   * @param {string} config.saveEndpoint - 上傳端點\n   * @param {string} config.loadEndpoint - 下載端點\n   * @param {string} config.deleteEndpoint - 刪除端點\n   * @param {string} config.listEndpoint - 列表端點（可選）\n   */\n  constructor(config = {}) {\n    super();\n    this.baseURL = config.baseURL || '';\n    this.saveEndpoint = config.saveEndpoint || '/backend/save.php';\n    this.loadEndpoint = config.loadEndpoint || '/public/uploads/';\n    this.deleteEndpoint = config.deleteEndpoint || '/backend/delete.php';\n    this.listEndpoint = config.listEndpoint || '/api/recordings';\n    this.headers = config.headers || {};\n  }\n  \n  /**\n   * 儲存音訊檔案\n   * @param {Blob} blob - 音訊 Blob\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據\n   * @returns {Promise<string>} 檔案名稱\n   */\n  async save(blob, filename, metadata = {}) {\n    const formData = new FormData();\n    formData.append('audio-blob', blob);\n    formData.append('audio-filename', filename);\n    \n    if (metadata && Object.keys(metadata).length > 0) {\n      formData.append('metadata', JSON.stringify(metadata));\n    }\n    \n    try {\n      const response = await fetch(this.baseURL + this.saveEndpoint, {\n        method: 'POST',\n        body: formData,\n        headers: this.headers\n      });\n      \n      if (!response.ok) {\n        throw new Error(`Upload failed: ${response.status} ${response.statusText}`);\n      }\n      \n      const result = await response.text();\n      \n      // 檢查 PHP 端點的回應（通常是 'success'）\n      if (result.toLowerCase().includes('success')) {\n        return filename;\n      } else {\n        throw new Error(`Server error: ${result}`);\n      }\n    } catch (error) {\n      console.error('Save error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 載入音訊檔案\n   * @param {string} filename - 檔案名稱\n   * @returns {Promise<Blob>}\n   */\n  async load(filename) {\n    try {\n      const url = this.baseURL + this.loadEndpoint + filename;\n      const response = await fetch(url, {\n        headers: this.headers\n      });\n      \n      if (!response.ok) {\n        throw new Error(`Load failed: ${response.status} ${response.statusText}`);\n      }\n      \n      return await response.blob();\n    } catch (error) {\n      console.error('Load error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 刪除音訊檔案\n   * @param {string} filename - 檔案名稱\n   * @returns {Promise<boolean>}\n   */\n  async delete(filename) {\n    try {\n      const response = await fetch(this.baseURL + this.deleteEndpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          ...this.headers\n        },\n        body: JSON.stringify({ filename })\n      });\n      \n      if (!response.ok) {\n        throw new Error(`Delete failed: ${response.status} ${response.statusText}`);\n      }\n      \n      const result = await response.text();\n      return result.toLowerCase().includes('success');\n    } catch (error) {\n      console.error('Delete error:', error);\n      throw error;\n    }\n  }\n  \n  /**\n   * 列出所有檔案\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    try {\n      const response = await fetch(this.baseURL + this.listEndpoint, {\n        headers: this.headers\n      });\n      \n      if (!response.ok) {\n        throw new Error(`List failed: ${response.status} ${response.statusText}`);\n      }\n      \n      const data = await response.json();\n      return Array.isArray(data) ? data : [];\n    } catch (error) {\n      console.error('List error:', error);\n      // 如果後端不支援 list 操作，返回空陣列\n      return [];\n    }\n  }\n  \n  /**\n   * 使用 XMLHttpRequest 上傳（帶進度回調）\n   * @param {Blob} blob - 音訊 Blob\n   * @param {string} filename - 檔案名稱\n   * @param {Object} metadata - 元數據\n   * @param {Function} onProgress - 進度回調 (percent)\n   * @returns {Promise<string>}\n   */\n  async saveWithProgress(blob, filename, metadata = {}, onProgress = null) {\n    return new Promise((resolve, reject) => {\n      const formData = new FormData();\n      formData.append('audio-blob', blob);\n      formData.append('audio-filename', filename);\n      \n      if (metadata && Object.keys(metadata).length > 0) {\n        formData.append('metadata', JSON.stringify(metadata));\n      }\n      \n      const xhr = new XMLHttpRequest();\n      \n      // 進度事件\n      if (onProgress) {\n        xhr.upload.addEventListener('progress', (e) => {\n          if (e.lengthComputable) {\n            const percent = (e.loaded / e.total) * 100;\n            onProgress(percent);\n          }\n        });\n      }\n      \n      // 完成事件\n      xhr.addEventListener('load', () => {\n        if (xhr.status >= 200 && xhr.status < 300) {\n          const result = xhr.responseText;\n          if (result.toLowerCase().includes('success')) {\n            resolve(filename);\n          } else {\n            reject(new Error(`Server error: ${result}`));\n          }\n        } else {\n          reject(new Error(`Upload failed: ${xhr.status} ${xhr.statusText}`));\n        }\n      });\n      \n      // 錯誤事件\n      xhr.addEventListener('error', () => {\n        reject(new Error('Network error during upload'));\n      });\n      \n      // 取消事件\n      xhr.addEventListener('abort', () => {\n        reject(new Error('Upload cancelled'));\n      });\n      \n      // 發送請求\n      xhr.open('POST', this.baseURL + this.saveEndpoint);\n      \n      // 設定自定義 headers\n      Object.keys(this.headers).forEach(key => {\n        xhr.setRequestHeader(key, this.headers[key]);\n      });\n      \n      xhr.send(formData);\n    });\n  }\n}\n\nexport default ServerAdapter;\n","/**\n * Storage Module - 儲存模組統一入口\n * 匯出所有儲存適配器\n */\n\nexport { StorageAdapter } from './StorageAdapter.js';\nexport { IndexedDBAdapter } from './IndexedDBAdapter.js';\nexport { ServerAdapter } from './ServerAdapter.js';\nexport { ElectronAdapter } from './ElectronAdapter.js';\nexport { CapacitorAdapter } from './CapacitorAdapter.js';\n\n/**\n * StorageFactory - 儲存適配器工廠\n * 根據配置自動創建適當的儲存適配器\n */\nexport class StorageFactory {\n  /**\n   * 創建儲存適配器\n   * @param {Object} config - 配置選項\n   * @param {string} config.type - 儲存類型 ('browser'|'electron'|'capacitor'|'server'|'auto')\n   * @param {Object} config.options - 適配器特定選項\n   * @returns {StorageAdapter}\n   */\n  static create(config = {}) {\n    const type = config.type || 'auto';\n    const options = config.options || {};\n    \n    // 自動偵測\n    if (type === 'auto') {\n      return this.createAuto(options);\n    }\n    \n    // 根據類型創建\n    switch (type.toLowerCase()) {\n      case 'browser':\n      case 'indexeddb':\n        const { IndexedDBAdapter } = require('./IndexedDBAdapter.js');\n        return new IndexedDBAdapter(\n          options.dbName,\n          options.storeName,\n          options.version\n        );\n      \n      case 'electron':\n        const { ElectronAdapter } = require('./ElectronAdapter.js');\n        return new ElectronAdapter(options.savePath);\n      \n      case 'capacitor':\n        const { CapacitorAdapter } = require('./CapacitorAdapter.js');\n        return new CapacitorAdapter(options.directory);\n      \n      case 'server':\n      case 'php':\n      case 'nodejs':\n        const { ServerAdapter } = require('./ServerAdapter.js');\n        return new ServerAdapter(options);\n      \n      default:\n        throw new Error(`Unknown storage type: ${type}`);\n    }\n  }\n  \n  /**\n   * 自動創建適配器（根據環境）\n   * @param {Object} options - 選項\n   * @returns {StorageAdapter}\n   */\n  static createAuto(options = {}) {\n    // 檢查 Electron\n    if (typeof window !== 'undefined' && window.electronAPI) {\n      const { ElectronAdapter } = require('./ElectronAdapter.js');\n      return new ElectronAdapter(options.savePath);\n    }\n    \n    // 檢查 Capacitor\n    if (typeof window !== 'undefined' && window.Capacitor) {\n      const { CapacitorAdapter } = require('./CapacitorAdapter.js');\n      return new CapacitorAdapter(options.directory);\n    }\n    \n    // 預設使用 IndexedDB（瀏覽器）\n    const { IndexedDBAdapter } = require('./IndexedDBAdapter.js');\n    return new IndexedDBAdapter(\n      options.dbName,\n      options.storeName,\n      options.version\n    );\n  }\n}\n\nexport default StorageFactory;\n","/**\n * VoiceBankRecorderUI.js\n * 完整的錄音器 UI 組件 - 包含所有界面元素和交互邏輯\n * \n * @module VoiceBankRecorderUI\n * @description 提供開箱即用的錄音器界面，包含：\n * - 自動生成 UI (HTML + CSS)\n * - 錄音控制按鈕\n * - 波形顯示 (即時、累積、概覽、VU Meter)\n * - 裝置管理 (麥克風、輸出裝置)\n * - 音訊處理選項 (增益、AGC、回音消除、降噪)\n * - 播放控制\n * - 狀態日誌\n */\n\nimport { AudioEngine } from '../core/AudioEngine.js';\nimport { WaveformRenderer } from '../core/WaveformRenderer.js';\nimport { DeviceManager } from '../core/DeviceManager.js';\n\n/**\n * VoiceBankRecorderUI - 完整的錄音器 UI 組件\n */\nexport class VoiceBankRecorderUI {\n    /**\n     * @param {Object} options - 配置選項\n     * @param {HTMLElement|string} options.container - 容器元素或選擇器\n     * @param {Object} [options.theme] - 主題配置\n     * @param {boolean} [options.showAdvancedOptions=true] - 是否顯示進階選項\n     * @param {boolean} [options.showStatusLog=true] - 是否顯示狀態日誌\n     * @param {Object} [options.audioConfig] - AudioEngine 配置\n     * @param {Object} [options.waveformConfig] - WaveformRenderer 配置\n     */\n    constructor(options = {}) {\n        this.options = {\n            showAdvancedOptions: true,\n            showStatusLog: true,\n            theme: {\n                primaryColor: '#667eea',\n                secondaryColor: '#764ba2',\n                successColor: '#10b981',\n                errorColor: '#ef4444',\n                warningColor: '#f59e0b'\n            },\n            ...options\n        };\n        \n        // 獲取容器\n        if (typeof options.container === 'string') {\n            this.container = document.querySelector(options.container);\n        } else {\n            this.container = options.container;\n        }\n        \n        if (!this.container) {\n            throw new Error('Container element not found');\n        }\n        \n        // 核心組件\n        this.audioEngine = null;\n        this.waveformRenderer = null;\n        this.deviceManager = null;\n        \n        // UI 元素引用\n        this.elements = {};\n        \n        // 播放器\n        this.audioPlayer = null;\n        this.recordedBlob = null;\n        this.recordedUrl = null;\n        \n        // 初始化狀態\n        this.isInitialized = false;\n    }\n    \n    /**\n     * 初始化 UI - 生成 HTML 和綁定事件\n     */\n    async initialize() {\n        if (this.isInitialized) {\n            console.warn('VoiceBankRecorderUI already initialized');\n            return;\n        }\n        \n        // 生成 UI\n        this._generateHTML();\n        this._injectStyles();\n        this._cacheElements();\n        \n        // 初始化音訊引擎\n        await this._initializeAudioEngine();\n        \n        // 初始化波形渲染器\n        await this._initializeWaveformRenderer();\n        \n        // 綁定事件\n        this._bindEvents();\n        \n        // 初始化裝置列表\n        await this._initializeDevices();\n        \n        this.isInitialized = true;\n        this._log('✓ VoiceBank Recorder UI 初始化完成', 'success');\n    }\n    \n    /**\n     * 生成 HTML 結構\n     * @private\n     */\n    _generateHTML() {\n        this.container.innerHTML = `\n            <div class=\"voicebank-recorder-ui\">\n                <!-- 錄音控制按鈕 -->\n                <div class=\"vbr-controls\">\n                    <button class=\"vbr-btn vbr-btn-record\" data-action=\"record\">\n                        <span class=\"vbr-icon\">🎙️</span>\n                        <span class=\"vbr-text\">開始錄音</span>\n                    </button>\n                    <button class=\"vbr-btn vbr-btn-stop\" data-action=\"stop\" disabled>\n                        <span class=\"vbr-icon\">⏹️</span>\n                        <span class=\"vbr-text\">停止錄音</span>\n                    </button>\n                </div>\n                \n                <!-- 波形顯示區 -->\n                <div class=\"vbr-waveforms\">\n                    <!-- 即時波形 -->\n                    <div class=\"vbr-waveform-section\">\n                        <h3 class=\"vbr-section-title\">即時波形</h3>\n                        <canvas class=\"vbr-canvas\" data-canvas=\"live\" width=\"800\" height=\"120\"></canvas>\n                    </div>\n                    \n                    <!-- VU Meter -->\n                    <div class=\"vbr-waveform-section\">\n                        <h3 class=\"vbr-section-title\">音量表 (VU Meter)</h3>\n                        <canvas class=\"vbr-canvas\" data-canvas=\"vu\" width=\"800\" height=\"50\"></canvas>\n                    </div>\n                    \n                    <!-- 累積波形 -->\n                    <div class=\"vbr-waveform-section\">\n                        <h3 class=\"vbr-section-title\">累積波形（可拖曳平移、滾輪縮放、點擊定位）</h3>\n                        <canvas class=\"vbr-canvas\" data-canvas=\"accumulated\" width=\"800\" height=\"200\"></canvas>\n                        <div class=\"vbr-toolbar\">\n                            <button class=\"vbr-toolbar-btn\" data-action=\"zoom-in\" disabled>\n                                <span>🔍+</span>\n                            </button>\n                            <button class=\"vbr-toolbar-btn\" data-action=\"zoom-out\" disabled>\n                                <span>🔍-</span>\n                            </button>\n                            <button class=\"vbr-toolbar-btn\" data-action=\"zoom-reset\" disabled>\n                                <span>🔄 重置視圖</span>\n                            </button>\n                            <button class=\"vbr-toolbar-btn\" data-action=\"pan-left\" disabled>\n                                <span>◀ 向左</span>\n                            </button>\n                            <button class=\"vbr-toolbar-btn\" data-action=\"pan-right\" disabled>\n                                <span>向右 ▶</span>\n                            </button>\n                            <label class=\"vbr-checkbox-label\">\n                                <input type=\"checkbox\" data-check=\"auto-scroll\" checked>\n                                <span>自動捲動</span>\n                            </label>\n                        </div>\n                    </div>\n                    \n                    <!-- 概覽波形 -->\n                    <div class=\"vbr-waveform-section\">\n                        <h3 class=\"vbr-section-title\">概覽波形（點擊或拖曳可快速導航）</h3>\n                        <canvas class=\"vbr-canvas\" data-canvas=\"overview\" width=\"800\" height=\"80\"></canvas>\n                    </div>\n                </div>\n                \n                <!-- 設定區 -->\n                <div class=\"vbr-settings\">\n                    <!-- 裝置設定 -->\n                    <div class=\"vbr-settings-section\">\n                        <h3 class=\"vbr-settings-title\">裝置設定</h3>\n                        <div class=\"vbr-device-row\">\n                            <label class=\"vbr-label\">麥克風：</label>\n                            <div class=\"vbr-device-select-group\">\n                                <select class=\"vbr-select\" data-select=\"microphone\" disabled>\n                                    <option>載入中...</option>\n                                </select>\n                                <button class=\"vbr-refresh-btn\" data-action=\"refresh-mic\" title=\"重新整理麥克風清單\">🔄</button>\n                            </div>\n                            <small class=\"vbr-hint\" data-hint=\"microphone\">選擇要使用的麥克風裝置</small>\n                        </div>\n                        <div class=\"vbr-device-row\">\n                            <label class=\"vbr-label\">輸出裝置：</label>\n                            <div class=\"vbr-device-select-group\">\n                                <select class=\"vbr-select\" data-select=\"output\" disabled>\n                                    <option value=\"default\">系統預設輸出</option>\n                                </select>\n                                <button class=\"vbr-refresh-btn\" data-action=\"refresh-output\" title=\"重新整理輸出裝置清單\">🔄</button>\n                            </div>\n                            <small class=\"vbr-hint\" data-hint=\"output\">部分瀏覽器需 HTTPS 才可切換輸出裝置</small>\n                        </div>\n                    </div>\n                    \n                    <!-- 進階選項 -->\n                    ${this.options.showAdvancedOptions ? `\n                    <div class=\"vbr-settings-section\">\n                        <h3 class=\"vbr-settings-title\">進階選項</h3>\n                        <div class=\"vbr-slider-row\">\n                            <label class=\"vbr-label\">麥克風增益：</label>\n                            <input type=\"range\" class=\"vbr-slider\" data-slider=\"gain\" min=\"1\" max=\"6\" step=\"0.1\" value=\"1.0\">\n                            <span class=\"vbr-slider-value\" data-value=\"gain\">1.0x</span>\n                        </div>\n                        <div class=\"vbr-checkbox-row\">\n                            <label class=\"vbr-checkbox-label\">\n                                <input type=\"checkbox\" data-check=\"agc\">\n                                <span>自動增益控制 (AGC)</span>\n                            </label>\n                            <label class=\"vbr-checkbox-label\">\n                                <input type=\"checkbox\" data-check=\"echo-cancel\">\n                                <span>回音消除</span>\n                            </label>\n                            <label class=\"vbr-checkbox-label\">\n                                <input type=\"checkbox\" data-check=\"noise-suppress\">\n                                <span>背景降噪</span>\n                            </label>\n                        </div>\n                    </div>\n                    ` : ''}\n                    \n                    <!-- 錄音資訊 -->\n                    <div class=\"vbr-info-section\" data-section=\"recording-info\" style=\"display: none;\">\n                        <h3 class=\"vbr-settings-title\">錄音資訊</h3>\n                        <div class=\"vbr-info-grid\">\n                            <div>時長：<span data-info=\"duration\">00:00.000</span></div>\n                            <div>樣本數：<span data-info=\"samples\">0</span></div>\n                            <div>採樣率：<span data-info=\"samplerate\">48000</span> Hz</div>\n                            <div>檔案大小：<span data-info=\"filesize\">0</span> KB</div>\n                        </div>\n                    </div>\n                </div>\n                \n                <!-- 播放控制 -->\n                <div class=\"vbr-playback\">\n                    <button class=\"vbr-btn vbr-btn-play\" data-action=\"play\" disabled>\n                        <span class=\"vbr-icon\">▶</span>\n                        <span class=\"vbr-text\">播放</span>\n                    </button>\n                    <button class=\"vbr-btn vbr-btn-pause\" data-action=\"pause\" disabled>\n                        <span class=\"vbr-icon\">⏸</span>\n                        <span class=\"vbr-text\">暫停</span>\n                    </button>\n                    <button class=\"vbr-btn vbr-btn-download\" data-action=\"download\" disabled>\n                        <span class=\"vbr-icon\">💾</span>\n                        <span class=\"vbr-text\">下載錄音</span>\n                    </button>\n                </div>\n                \n                <!-- 狀態日誌 -->\n                ${this.options.showStatusLog ? `\n                <div class=\"vbr-status-log\" data-log=\"status\">\n                    <div class=\"vbr-log-entry\">\n                        <span class=\"vbr-log-time\">[${this._getTimeString()}]</span>\n                        <span class=\"vbr-log-text\">準備就緒</span>\n                    </div>\n                </div>\n                ` : ''}\n            </div>\n        `;\n    }\n    \n    /**\n     * 注入 CSS 樣式\n     * @private\n     */\n    _injectStyles() {\n        const styleId = 'voicebank-recorder-ui-styles';\n        if (document.getElementById(styleId)) return;\n        \n        const style = document.createElement('style');\n        style.id = styleId;\n        style.textContent = this._getStyles();\n        document.head.appendChild(style);\n    }\n    \n    /**\n     * 獲取 CSS 樣式\n     * @private\n     * @returns {string}\n     */\n    _getStyles() {\n        const theme = this.options.theme;\n        \n        return `\n            .voicebank-recorder-ui {\n                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n                line-height: 1.6;\n                color: #333;\n                max-width: 900px;\n                margin: 0 auto;\n            }\n            \n            /* 錄音控制按鈕 */\n            .vbr-controls {\n                display: flex;\n                gap: 15px;\n                justify-content: center;\n                margin-bottom: 30px;\n                padding: 20px;\n                background: #f9fafb;\n                border-radius: 10px;\n            }\n            \n            .vbr-btn {\n                display: flex;\n                align-items: center;\n                gap: 8px;\n                font-size: 16px;\n                padding: 12px 30px;\n                border: none;\n                border-radius: 8px;\n                cursor: pointer;\n                transition: all 0.3s ease;\n                font-weight: 600;\n                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n            }\n            \n            .vbr-btn:disabled {\n                opacity: 0.5;\n                cursor: not-allowed;\n            }\n            \n            .vbr-btn-record {\n                background: ${theme.errorColor};\n                color: white;\n            }\n            \n            .vbr-btn-record:hover:not(:disabled) {\n                background: #dc2626;\n                transform: translateY(-2px);\n                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);\n            }\n            \n            .vbr-btn-stop {\n                background: #9ca3af;\n                color: white;\n            }\n            \n            .vbr-btn-stop:hover:not(:disabled) {\n                background: #6b7280;\n                transform: translateY(-2px);\n                box-shadow: 0 4px 12px rgba(156, 163, 175, 0.3);\n            }\n            \n            .vbr-btn-play {\n                background: ${theme.primaryColor};\n                color: white;\n            }\n            \n            .vbr-btn-play:hover:not(:disabled) {\n                background: #5568d3;\n                transform: translateY(-2px);\n            }\n            \n            .vbr-btn-pause {\n                background: ${theme.warningColor};\n                color: white;\n            }\n            \n            .vbr-btn-pause:hover:not(:disabled) {\n                background: #d97706;\n                transform: translateY(-2px);\n            }\n            \n            .vbr-btn-download {\n                background: ${theme.primaryColor};\n                color: white;\n            }\n            \n            .vbr-btn-download:hover:not(:disabled) {\n                background: #5568d3;\n                transform: translateY(-2px);\n            }\n            \n            /* 波形區域 */\n            .vbr-waveforms {\n                margin-bottom: 30px;\n            }\n            \n            .vbr-waveform-section {\n                margin-bottom: 20px;\n            }\n            \n            .vbr-section-title {\n                font-size: 14px;\n                font-weight: 600;\n                color: #555;\n                margin-bottom: 8px;\n            }\n            \n            .vbr-canvas {\n                display: block;\n                width: 100%;\n                border: 2px solid #e5e7eb;\n                border-radius: 8px;\n                background: #f9fafb;\n            }\n            \n            .vbr-toolbar {\n                display: flex;\n                gap: 10px;\n                margin-top: 10px;\n                flex-wrap: wrap;\n                align-items: center;\n            }\n            \n            .vbr-toolbar-btn {\n                padding: 8px 16px;\n                border: 1px solid #d0d0d0;\n                border-radius: 6px;\n                background: white;\n                cursor: pointer;\n                font-size: 13px;\n                font-weight: 500;\n                color: #555;\n                transition: all 0.2s ease;\n            }\n            \n            .vbr-toolbar-btn:hover:not(:disabled) {\n                border-color: ${theme.primaryColor};\n                color: ${theme.primaryColor};\n                background: #f0f4ff;\n            }\n            \n            .vbr-toolbar-btn:disabled {\n                opacity: 0.4;\n                cursor: not-allowed;\n            }\n            \n            .vbr-checkbox-label {\n                display: flex;\n                align-items: center;\n                gap: 5px;\n                font-size: 13px;\n                color: #555;\n                cursor: pointer;\n            }\n            \n            /* 設定區域 */\n            .vbr-settings {\n                margin-bottom: 30px;\n            }\n            \n            .vbr-settings-section {\n                background: #f9fafb;\n                padding: 20px;\n                border-radius: 10px;\n                margin-bottom: 20px;\n            }\n            \n            .vbr-settings-title {\n                font-size: 16px;\n                font-weight: 600;\n                color: ${theme.primaryColor};\n                margin-bottom: 15px;\n            }\n            \n            .vbr-device-row {\n                margin-bottom: 15px;\n            }\n            \n            .vbr-label {\n                display: block;\n                font-size: 14px;\n                font-weight: 500;\n                color: #555;\n                margin-bottom: 5px;\n            }\n            \n            .vbr-device-select-group {\n                display: flex;\n                gap: 10px;\n            }\n            \n            .vbr-select {\n                flex: 1;\n                padding: 8px;\n                border: 1px solid #d0d0d0;\n                border-radius: 6px;\n                font-size: 14px;\n            }\n            \n            .vbr-refresh-btn {\n                padding: 8px 12px;\n                background: ${theme.primaryColor};\n                color: white;\n                border: none;\n                border-radius: 6px;\n                cursor: pointer;\n                font-size: 13px;\n            }\n            \n            .vbr-hint {\n                display: block;\n                color: #666;\n                font-size: 12px;\n                margin-top: 5px;\n            }\n            \n            .vbr-slider-row {\n                display: flex;\n                align-items: center;\n                gap: 10px;\n                margin-bottom: 15px;\n            }\n            \n            .vbr-slider {\n                flex: 1;\n            }\n            \n            .vbr-slider-value {\n                min-width: 50px;\n                font-weight: 600;\n            }\n            \n            .vbr-checkbox-row {\n                display: flex;\n                flex-wrap: wrap;\n                gap: 15px;\n            }\n            \n            .vbr-info-section {\n                background: #f0f4ff;\n                padding: 20px;\n                border-radius: 10px;\n                border-left: 4px solid ${theme.primaryColor};\n            }\n            \n            .vbr-info-grid {\n                display: grid;\n                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n                gap: 10px;\n                font-size: 14px;\n            }\n            \n            .vbr-info-grid span {\n                font-weight: 600;\n                color: ${theme.primaryColor};\n            }\n            \n            /* 播放控制 */\n            .vbr-playback {\n                display: flex;\n                gap: 15px;\n                justify-content: center;\n                margin-bottom: 30px;\n            }\n            \n            /* 狀態日誌 */\n            .vbr-status-log {\n                background: #1f2937;\n                color: ${theme.successColor};\n                padding: 20px;\n                border-radius: 10px;\n                font-family: 'Courier New', monospace;\n                font-size: 13px;\n                line-height: 1.8;\n                max-height: 200px;\n                overflow-y: auto;\n            }\n            \n            .vbr-log-entry {\n                margin-bottom: 5px;\n            }\n            \n            .vbr-log-time {\n                color: #6b7280;\n                margin-right: 10px;\n            }\n            \n            .vbr-log-error {\n                color: ${theme.errorColor};\n            }\n            \n            .vbr-log-warning {\n                color: ${theme.warningColor};\n            }\n            \n            .vbr-log-success {\n                color: ${theme.successColor};\n            }\n        `;\n    }\n    \n    /**\n     * 快取 DOM 元素引用\n     * @private\n     */\n    _cacheElements() {\n        const root = this.container.querySelector('.voicebank-recorder-ui');\n        \n        // 按鈕\n        this.elements.recordBtn = root.querySelector('[data-action=\"record\"]');\n        this.elements.stopBtn = root.querySelector('[data-action=\"stop\"]');\n        this.elements.playBtn = root.querySelector('[data-action=\"play\"]');\n        this.elements.pauseBtn = root.querySelector('[data-action=\"pause\"]');\n        this.elements.downloadBtn = root.querySelector('[data-action=\"download\"]');\n        \n        // 波形工具列按鈕\n        this.elements.zoomInBtn = root.querySelector('[data-action=\"zoom-in\"]');\n        this.elements.zoomOutBtn = root.querySelector('[data-action=\"zoom-out\"]');\n        this.elements.zoomResetBtn = root.querySelector('[data-action=\"zoom-reset\"]');\n        this.elements.panLeftBtn = root.querySelector('[data-action=\"pan-left\"]');\n        this.elements.panRightBtn = root.querySelector('[data-action=\"pan-right\"]');\n        this.elements.autoScrollCheck = root.querySelector('[data-check=\"auto-scroll\"]');\n        \n        // Canvas\n        this.elements.liveCanvas = root.querySelector('[data-canvas=\"live\"]');\n        this.elements.vuCanvas = root.querySelector('[data-canvas=\"vu\"]');\n        this.elements.accumulatedCanvas = root.querySelector('[data-canvas=\"accumulated\"]');\n        this.elements.overviewCanvas = root.querySelector('[data-canvas=\"overview\"]');\n        \n        // 裝置選擇\n        this.elements.micSelect = root.querySelector('[data-select=\"microphone\"]');\n        this.elements.outputSelect = root.querySelector('[data-select=\"output\"]');\n        this.elements.refreshMicBtn = root.querySelector('[data-action=\"refresh-mic\"]');\n        this.elements.refreshOutputBtn = root.querySelector('[data-action=\"refresh-output\"]');\n        \n        // 進階選項\n        if (this.options.showAdvancedOptions) {\n            this.elements.gainSlider = root.querySelector('[data-slider=\"gain\"]');\n            this.elements.gainValue = root.querySelector('[data-value=\"gain\"]');\n            this.elements.agcCheck = root.querySelector('[data-check=\"agc\"]');\n            this.elements.echoCancelCheck = root.querySelector('[data-check=\"echo-cancel\"]');\n            this.elements.noiseSuppressCheck = root.querySelector('[data-check=\"noise-suppress\"]');\n        }\n        \n        // 錄音資訊\n        this.elements.recordingInfo = root.querySelector('[data-section=\"recording-info\"]');\n        this.elements.durationInfo = root.querySelector('[data-info=\"duration\"]');\n        this.elements.samplesInfo = root.querySelector('[data-info=\"samples\"]');\n        this.elements.samplerateInfo = root.querySelector('[data-info=\"samplerate\"]');\n        this.elements.filesizeInfo = root.querySelector('[data-info=\"filesize\"]');\n        \n        // 狀態日誌\n        if (this.options.showStatusLog) {\n            this.elements.statusLog = root.querySelector('[data-log=\"status\"]');\n        }\n    }\n    \n    /**\n     * 初始化音訊引擎\n     * @private\n     */\n    async _initializeAudioEngine() {\n        const audioConfig = {\n            sampleRate: 48000,\n            echoCancellation: false,\n            noiseSuppression: false,\n            autoGainControl: false,\n            autoManageDevices: true,\n            ...this.options.audioConfig\n        };\n        \n        this.audioEngine = new AudioEngine(audioConfig);\n        await this.audioEngine.initialize();\n        this.deviceManager = this.audioEngine.deviceManager;\n        \n        this._log('音訊引擎初始化完成', 'info');\n    }\n    \n    /**\n     * 初始化波形渲染器\n     * @private\n     */\n    async _initializeWaveformRenderer() {\n        const waveformConfig = {\n            liveCanvas: this.elements.liveCanvas,\n            vuMeterCanvas: this.elements.vuCanvas,\n            accumulatedCanvas: this.elements.accumulatedCanvas,\n            overviewCanvas: this.elements.overviewCanvas,\n            audioEngine: this.audioEngine,\n            useWorker: false,\n            showClipMarks: true,\n            ...this.options.waveformConfig\n        };\n        \n        this.waveformRenderer = new WaveformRenderer(waveformConfig);\n        await this.waveformRenderer.initialize();\n        \n        this._log('波形渲染器初始化完成', 'info');\n    }\n    \n    /**\n     * 綁定所有事件\n     * @private\n     */\n    _bindEvents() {\n        // 錄音控制\n        this.elements.recordBtn.addEventListener('click', () => this._handleRecord());\n        this.elements.stopBtn.addEventListener('click', () => this._handleStop());\n        \n        // 播放控制\n        this.elements.playBtn.addEventListener('click', () => this._handlePlay());\n        this.elements.pauseBtn.addEventListener('click', () => this._handlePause());\n        this.elements.downloadBtn.addEventListener('click', () => this._handleDownload());\n        \n        // 波形工具列\n        this.elements.zoomInBtn.addEventListener('click', () => this._handleZoomIn());\n        this.elements.zoomOutBtn.addEventListener('click', () => this._handleZoomOut());\n        this.elements.zoomResetBtn.addEventListener('click', () => this._handleZoomReset());\n        this.elements.panLeftBtn.addEventListener('click', () => this._handlePanLeft());\n        this.elements.panRightBtn.addEventListener('click', () => this._handlePanRight());\n        this.elements.autoScrollCheck.addEventListener('change', (e) => this._handleAutoScrollChange(e));\n        \n        // 裝置選擇\n        this.elements.micSelect.addEventListener('change', (e) => this._handleMicChange(e));\n        this.elements.outputSelect.addEventListener('change', (e) => this._handleOutputChange(e));\n        this.elements.refreshMicBtn.addEventListener('click', () => this._refreshMicrophones());\n        this.elements.refreshOutputBtn.addEventListener('click', () => this._refreshOutputDevices());\n        \n        // 進階選項\n        if (this.options.showAdvancedOptions) {\n            this.elements.gainSlider.addEventListener('input', (e) => this._handleGainChange(e));\n            this.elements.agcCheck.addEventListener('change', (e) => this._handleAGCChange(e));\n            this.elements.echoCancelCheck.addEventListener('change', (e) => this._handleEchoCancelChange(e));\n            this.elements.noiseSuppressCheck.addEventListener('change', (e) => this._handleNoiseSuppressChange(e));\n        }\n    }\n    \n    /**\n     * 初始化裝置列表\n     * @private\n     */\n    async _initializeDevices() {\n        if (!this.deviceManager) {\n            this._log('❌ DeviceManager 尚未初始化', 'error');\n            return;\n        }\n        \n        await this._refreshMicrophones();\n        await this._refreshOutputDevices();\n    }\n    \n    /**\n     * 重新整理麥克風列表\n     * @private\n     */\n    async _refreshMicrophones() {\n        if (!this.deviceManager) {\n            this._log('❌ DeviceManager 尚未初始化', 'error');\n            this.elements.micSelect.innerHTML = '<option>初始化失敗</option>';\n            this.elements.micSelect.disabled = true;\n            return;\n        }\n        \n        try {\n            this._log('🔍 正在列舉麥克風裝置...', 'info');\n            const microphones = await this.deviceManager.enumerateMicrophones();\n            \n            this.elements.micSelect.innerHTML = '';\n            \n            if (microphones.length === 0) {\n                this.elements.micSelect.innerHTML = '<option>未偵測到麥克風</option>';\n                this.elements.micSelect.disabled = true;\n                this._log('⚠️ 未偵測到麥克風裝置', 'warning');\n                return;\n            }\n            \n            microphones.forEach((device, index) => {\n                const option = document.createElement('option');\n                option.value = device.deviceId;\n                option.textContent = device.label || `麥克風 ${index + 1}`;\n                this.elements.micSelect.appendChild(option);\n            });\n            \n            // 恢復上次選擇\n            const savedId = this.deviceManager.getSelectedMicrophoneId();\n            if (savedId && this.deviceManager.isDeviceAvailable(savedId, 'microphone')) {\n                this.elements.micSelect.value = savedId;\n            } else if (microphones.length > 0) {\n                this.deviceManager.selectMicrophone(microphones[0].deviceId, true);\n                this.elements.micSelect.value = microphones[0].deviceId;\n            }\n            \n            this.elements.micSelect.disabled = false;\n            this._log(`✅ 找到 ${microphones.length} 個麥克風裝置`, 'success');\n        } catch (error) {\n            this._log(`❌ 列舉麥克風失敗: ${error.message}`, 'error');\n            console.error('列舉麥克風詳細錯誤:', error);\n            this.elements.micSelect.innerHTML = '<option>需要麥克風權限</option>';\n            this.elements.micSelect.disabled = true;\n        }\n    }\n    \n    /**\n     * 重新整理輸出裝置列表\n     * @private\n     */\n    async _refreshOutputDevices() {\n        if (!this.deviceManager) {\n            this._log('❌ DeviceManager 尚未初始化', 'error');\n            this.elements.outputSelect.innerHTML = '<option value=\"default\">系統預設輸出</option>';\n            this.elements.outputSelect.disabled = true;\n            return;\n        }\n        \n        if (!this.deviceManager.isSupported()) {\n            this.elements.outputSelect.innerHTML = '<option value=\"default\">系統預設輸出</option>';\n            this.elements.outputSelect.disabled = true;\n            this._log('ℹ️ 此瀏覽器不支援輸出裝置切換', 'info');\n            return;\n        }\n        \n        try {\n            this._log('🔍 正在列舉輸出裝置...', 'info');\n            const outputs = await this.deviceManager.enumerateOutputDevices();\n            \n            this.elements.outputSelect.innerHTML = '<option value=\"default\">系統預設輸出</option>';\n            \n            if (outputs.length === 0) {\n                this.elements.outputSelect.disabled = true;\n                this._log('ℹ️ 未偵測到輸出裝置', 'info');\n                return;\n            }\n            \n            this.elements.outputSelect.disabled = false;\n            outputs.forEach((device, index) => {\n                const option = document.createElement('option');\n                option.value = device.deviceId;\n                option.textContent = device.label || `揚聲器 ${index + 1}`;\n                this.elements.outputSelect.appendChild(option);\n            });\n            \n            // 恢復上次選擇\n            const savedId = this.deviceManager.getSelectedOutputDeviceId();\n            if (savedId && savedId !== 'default') {\n                this.elements.outputSelect.value = savedId;\n            }\n            \n            this._log(`✅ 找到 ${outputs.length} 個輸出裝置`, 'success');\n        } catch (error) {\n            this._log(`❌ 列舉輸出裝置失敗: ${error.message}`, 'error');\n            console.error('列舉輸出裝置詳細錯誤:', error);\n        }\n    }\n    \n    /**\n     * 處理錄音按鈕點擊\n     * @private\n     */\n    async _handleRecord() {\n        try {\n            this._log('開始錄音...', 'info');\n            \n            await this.audioEngine.startRecording();\n            \n            this.elements.recordBtn.disabled = true;\n            this.elements.stopBtn.disabled = false;\n            \n            // 停用波形工具列\n            this.elements.zoomInBtn.disabled = true;\n            this.elements.zoomOutBtn.disabled = true;\n            this.elements.zoomResetBtn.disabled = true;\n            this.elements.panLeftBtn.disabled = true;\n            this.elements.panRightBtn.disabled = true;\n            \n            this._log('✓ 錄音已開始', 'success');\n        } catch (error) {\n            this._log(`❌ 錄音失敗: ${error.message}`, 'error');\n            console.error('Recording Error:', error);\n        }\n    }\n    \n    /**\n     * 處理停止按鈕點擊\n     * @private\n     */\n    async _handleStop() {\n        try {\n            this._log('停止錄音...', 'info');\n            \n            const blob = await this.audioEngine.stopRecording();\n            \n            this.elements.recordBtn.disabled = false;\n            this.elements.stopBtn.disabled = true;\n            this.elements.playBtn.disabled = false;\n            this.elements.downloadBtn.disabled = false;\n            \n            // 啟用波形工具列\n            this.elements.zoomInBtn.disabled = false;\n            this.elements.zoomOutBtn.disabled = false;\n            this.elements.zoomResetBtn.disabled = false;\n            this.elements.panLeftBtn.disabled = false;\n            this.elements.panRightBtn.disabled = false;\n            \n            this._log(`✓ 錄音已停止 - ${(blob.size / 1024).toFixed(2)} KB`, 'success');\n            \n            // 更新錄音資訊\n            this._updateRecordingInfo(blob);\n            \n            // 清理舊的音訊資源\n            if (this.audioPlayer) {\n                this.audioPlayer.pause();\n                this.audioPlayer.src = '';\n                this.audioPlayer = null;\n            }\n            if (this.recordedUrl) {\n                URL.revokeObjectURL(this.recordedUrl);\n            }\n            \n            // 保存新的 blob\n            this.recordedBlob = blob;\n            this.recordedUrl = URL.createObjectURL(blob);\n            \n        } catch (error) {\n            this._log(`❌ 停止失敗: ${error.message}`, 'error');\n            console.error('Stop Error:', error);\n        }\n    }\n    \n    /**\n     * 處理播放按鈕點擊\n     * @private\n     */\n    async _handlePlay() {\n        try {\n            if (!this.recordedUrl) {\n                this._log('❌ 沒有可播放的錄音', 'error');\n                return;\n            }\n            \n            this._log('播放錄音...', 'info');\n            \n            // 每次播放都重新創建音訊播放器\n            if (this.audioPlayer) {\n                this.audioPlayer.pause();\n                this.audioPlayer.src = '';\n                this.audioPlayer = null;\n            }\n            \n            this.audioPlayer = new Audio(this.recordedUrl);\n            \n            this.audioPlayer.addEventListener('ended', () => {\n                this.elements.playBtn.disabled = false;\n                this.elements.pauseBtn.disabled = true;\n                this._log('✓ 播放完成', 'info');\n            });\n            \n            // 設置輸出裝置\n            if (this.deviceManager) {\n                try {\n                    await this.deviceManager.setAudioOutputDevice(this.audioPlayer);\n                } catch (err) {\n                    console.warn('設置輸出裝置失敗:', err);\n                }\n            }\n            \n            await this.audioPlayer.play();\n            this.elements.playBtn.disabled = true;\n            this.elements.pauseBtn.disabled = false;\n            this._log('✓ 播放中', 'info');\n            \n        } catch (error) {\n            this._log(`❌ 播放失敗: ${error.message}`, 'error');\n            console.error('Play Error:', error);\n        }\n    }\n    \n    /**\n     * 處理暫停按鈕點擊\n     * @private\n     */\n    _handlePause() {\n        try {\n            if (!this.audioPlayer) {\n                this._log('❌ 沒有正在播放的音訊', 'error');\n                return;\n            }\n            \n            this._log('暫停播放...', 'info');\n            this.audioPlayer.pause();\n            this.elements.playBtn.disabled = false;\n            this.elements.pauseBtn.disabled = true;\n            this._log('✓ 已暫停', 'info');\n            \n        } catch (error) {\n            this._log(`❌ 暫停失敗: ${error.message}`, 'error');\n            console.error('Pause Error:', error);\n        }\n    }\n    \n    /**\n     * 處理下載按鈕點擊\n     * @private\n     */\n    _handleDownload() {\n        try {\n            if (!this.recordedBlob) {\n                this._log('❌ 沒有可下載的錄音', 'error');\n                return;\n            }\n            \n            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);\n            const filename = `voicebank-recording-${timestamp}.wav`;\n            \n            const a = document.createElement('a');\n            a.href = this.recordedUrl;\n            a.download = filename;\n            a.click();\n            \n            this._log(`💾 已下載: ${filename}`, 'success');\n            \n        } catch (error) {\n            this._log(`❌ 下載失敗: ${error.message}`, 'error');\n            console.error('Download Error:', error);\n        }\n    }\n    \n    /**\n     * 處理放大按鈕點擊\n     * @private\n     */\n    _handleZoomIn() {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            this.waveformRenderer.accumulatedWaveform.zoomBySteps(1, 0.5);\n            this._log('🔍 放大波形', 'info');\n        }\n    }\n    \n    /**\n     * 處理縮小按鈕點擊\n     * @private\n     */\n    _handleZoomOut() {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            this.waveformRenderer.accumulatedWaveform.zoomBySteps(-1, 0.5);\n            this._log('🔍 縮小波形', 'info');\n        }\n    }\n    \n    /**\n     * 處理重置視圖按鈕點擊\n     * @private\n     */\n    _handleZoomReset() {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            this.waveformRenderer.accumulatedWaveform.setZoom(1);\n            this.waveformRenderer.accumulatedWaveform.isAutoScroll = true;\n            this.elements.autoScrollCheck.checked = true;\n            this._log('🔄 重置視圖', 'info');\n        }\n    }\n    \n    /**\n     * 處理向左平移按鈕點擊\n     * @private\n     */\n    _handlePanLeft() {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            const info = this.waveformRenderer.accumulatedWaveform.getVisibleSamples();\n            this.waveformRenderer.accumulatedWaveform.panBySamples(-Math.floor(info.visible * 0.2));\n            this._log('◀ 向左移動', 'info');\n        }\n    }\n    \n    /**\n     * 處理向右平移按鈕點擊\n     * @private\n     */\n    _handlePanRight() {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            const info = this.waveformRenderer.accumulatedWaveform.getVisibleSamples();\n            this.waveformRenderer.accumulatedWaveform.panBySamples(Math.floor(info.visible * 0.2));\n            this._log('▶ 向右移動', 'info');\n        }\n    }\n    \n    /**\n     * 處理自動捲動開關改變\n     * @private\n     */\n    _handleAutoScrollChange(e) {\n        if (this.waveformRenderer && this.waveformRenderer.accumulatedWaveform) {\n            this.waveformRenderer.accumulatedWaveform.isAutoScroll = e.target.checked;\n            this._log(e.target.checked ? '✓ 啟用自動捲動' : '✗ 停用自動捲動', 'info');\n        }\n    }\n    \n    /**\n     * 處理麥克風選擇改變\n     * @private\n     */\n    _handleMicChange(e) {\n        const deviceId = e.target.value;\n        const deviceLabel = e.target.options[e.target.selectedIndex].text;\n        \n        this.deviceManager.selectMicrophone(deviceId, true);\n        this._log(`🎤 已選擇麥克風: ${deviceLabel}`, 'info');\n    }\n    \n    /**\n     * 處理輸出裝置選擇改變\n     * @private\n     */\n    _handleOutputChange(e) {\n        const deviceId = e.target.value;\n        const deviceLabel = e.target.options[e.target.selectedIndex].text;\n        \n        this.deviceManager.selectOutputDevice(deviceId, true);\n        this._log(`🔊 已選擇輸出裝置: ${deviceLabel}`, 'info');\n    }\n    \n    /**\n     * 處理麥克風增益改變\n     * @private\n     */\n    _handleGainChange(e) {\n        const gain = parseFloat(e.target.value);\n        this.elements.gainValue.textContent = gain.toFixed(1) + 'x';\n        \n        if (this.audioEngine && this.audioEngine.setMicGain) {\n            this.audioEngine.setMicGain(gain);\n            this._log(`🎚️ 增益調整為 ${gain.toFixed(1)}x`, 'info');\n        }\n    }\n    \n    /**\n     * 處理 AGC 開關改變\n     * @private\n     */\n    _handleAGCChange(e) {\n        this._log(`AGC ${e.target.checked ? '已啟用' : '已停用'}（將在下次錄音時生效）`, 'info');\n        // Note: 需要重新開始錄音才會生效\n    }\n    \n    /**\n     * 處理回音消除開關改變\n     * @private\n     */\n    _handleEchoCancelChange(e) {\n        this._log(`回音消除 ${e.target.checked ? '已啟用' : '已停用'}（將在下次錄音時生效）`, 'info');\n        // Note: 需要重新開始錄音才會生效\n    }\n    \n    /**\n     * 處理背景降噪開關改變\n     * @private\n     */\n    _handleNoiseSuppressChange(e) {\n        this._log(`背景降噪 ${e.target.checked ? '已啟用' : '已停用'}（將在下次錄音時生效）`, 'info');\n        // Note: 需要重新開始錄音才會生效\n    }\n    \n    /**\n     * 更新錄音資訊\n     * @private\n     */\n    _updateRecordingInfo(blob) {\n        const duration = (this.audioEngine.recordStopTime - this.audioEngine.recordStartTime) / 1000;\n        const samples = this.audioEngine.pcmTotalSamples || 0;\n        const sampleRate = this.audioEngine.audioContext.sampleRate;\n        \n        this.elements.durationInfo.textContent = this._formatDuration(duration);\n        this.elements.samplesInfo.textContent = samples.toLocaleString();\n        this.elements.samplerateInfo.textContent = sampleRate.toLocaleString();\n        this.elements.filesizeInfo.textContent = (blob.size / 1024).toFixed(2);\n        \n        this.elements.recordingInfo.style.display = 'block';\n    }\n    \n    /**\n     * 格式化時長\n     * @private\n     */\n    _formatDuration(seconds) {\n        const mins = Math.floor(seconds / 60);\n        const secs = Math.floor(seconds % 60);\n        const ms = Math.floor((seconds % 1) * 1000);\n        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}.${String(ms).padStart(3, '0')}`;\n    }\n    \n    /**\n     * 獲取當前時間字串\n     * @private\n     */\n    _getTimeString() {\n        const now = new Date();\n        return `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;\n    }\n    \n    /**\n     * 記錄日誌\n     * @private\n     */\n    _log(message, type = 'info') {\n        if (!this.options.showStatusLog || !this.elements.statusLog) return;\n        \n        const entry = document.createElement('div');\n        entry.className = 'vbr-log-entry';\n        \n        const time = document.createElement('span');\n        time.className = 'vbr-log-time';\n        time.textContent = `[${this._getTimeString()}]`;\n        \n        const text = document.createElement('span');\n        text.className = `vbr-log-text vbr-log-${type}`;\n        text.textContent = message;\n        \n        entry.appendChild(time);\n        entry.appendChild(text);\n        \n        this.elements.statusLog.appendChild(entry);\n        this.elements.statusLog.scrollTop = this.elements.statusLog.scrollHeight;\n    }\n    \n    /**\n     * 銷毀 UI 和所有資源\n     */\n    destroy() {\n        // 停止錄音\n        if (this.audioEngine && this.audioEngine.isRecording) {\n            this.audioEngine.stopRecording();\n        }\n        \n        // 停止播放\n        if (this.audioPlayer) {\n            this.audioPlayer.pause();\n            this.audioPlayer.src = '';\n            this.audioPlayer = null;\n        }\n        \n        // 釋放 blob URL\n        if (this.recordedUrl) {\n            URL.revokeObjectURL(this.recordedUrl);\n            this.recordedUrl = null;\n        }\n        \n        // 銷毀波形渲染器\n        if (this.waveformRenderer) {\n            this.waveformRenderer.destroy();\n            this.waveformRenderer = null;\n        }\n        \n        // 銷毀音訊引擎\n        if (this.audioEngine) {\n            this.audioEngine.destroy();\n            this.audioEngine = null;\n        }\n        \n        // 清空 UI\n        this.container.innerHTML = '';\n        \n        this.isInitialized = false;\n        this._log('VoiceBank Recorder UI 已銷毀', 'info');\n    }\n}\n"],"names":["DeviceManager","constructor","options","this","micStorageKey","outputStorageKey","autoLoadPreferences","autoRequestPermission","microphoneDevices","outputDevices","selectedMicDeviceId","selectedOutputDeviceId","_eventListeners","devicechange","micchange","outputchange","_deviceChangeListener","loadPreferences","console","log","savedMicId","localStorage","getItem","savedOutputId","error","warn","savePreference","type","deviceId","setItem","isSupported","navigator","mediaDevices","enumerateDevices","requestMicrophonePermission","getUserMedia","Error","audio","getTracks","forEach","track","stop","message","enumerateMicrophones","requestPermission","devices","filter","device","kind","enumerateOutputDevices","enumerateAllDevices","microphones","outputs","Promise","all","selectMicrophone","save","_emit","selectOutputDevice","getSelectedMicrophoneId","getSelectedOutputDeviceId","getSelectedMicrophone","find","getSelectedOutputDevice","getMicrophoneConstraints","additionalConstraints","constraints","video","exact","setAudioOutputDevice","audioElement","targetDeviceId","setSinkId","isDeviceAvailable","some","startDeviceChangeMonitoring","async","addEventListener","stopDeviceChangeMonitoring","removeEventListener","on","event","callback","push","off","index","indexOf","splice","data","destroy","AudioEngine","config","sampleRate","autoGainControl","undefined","echoCancellation","noiseSuppression","micGain","workletPath","preferWorklet","autoManageDevices","deviceManager","_ownDeviceManager","audioContext","analyser","preGainNode","mediaDest","analyserSilencer","workletSupported","workletLoaded","pcmCollectorNode","usingWorklet","pcmChunks","pcmTotalSamples","recorder","_pcmCaptureInterval","micStream","isRecording","isPaused","isInitialized","recordStartTime","recordStopTime","recordWallStartMs","recordWallStopMs","latestBlob","latestUrl","initialize","AudioContextClass","window","AudioContext","webkitAudioContext","createAnalyser","fftSize","createGain","gain","value","createMediaStreamDestination","connect","destination","audioWorklet","AudioWorkletNode","addModule","path","state","resume","stage","startRecording","_stopMicrophone","_captureMicrophone","URL","revokeObjectURL","Date","now","performance","useWorklet","_startWorkletRecording","_startRecordRTCRecording","timestamp","mode","stopRecording","blob","_stopWorkletRecording","_stopRecordRTCRecording","createObjectURL","duration","url","samples","pauseRecording","resumeRecording","getLatestRecording","getPcmWindow","start","count","length","total","Float32Array","end","Math","min","out","offset","passed","i","chunk","cStart","cEnd","segStart","max","segEnd","localStart","slice","subarray","set","getAnalyser","getAudioContext","microphoneStream","setMicGain","dispose","catch","_stopPcmCapture","close","handler","selectedId","JSON","stringify","_applyIOSMicGainAdjustment","createMediaStreamSource","usedDeviceId","audioTracks","getAudioTracks","actualDevice","label","name","ua","userAgent","test","abs","port","onmessage","pcmData","totalSamples","disconnect","merged","wavBuffer","_buildWavFromFloat32Mono","Blob","resolve","reject","RecordRTC","recordStream","stream","mimeType","recorderType","StereoAudioRecorder","numberOfAudioChannels","bufferSize","timeSlice","ondataavailable","_startPcmCapture","getBlob","bufferLength","dataArray","setInterval","getFloatTimeDomainData","pcmChunk","clearInterval","float32Data","numSamples","buffer","ArrayBuffer","view","DataView","_writeString","setUint32","setUint16","sample","int16","setInt16","string","setUint8","charCodeAt","err","WaveformRenderer","workerPath","useWorker","showClipMarks","audioEngine","liveWaveform","vuMeter","accumulatedWaveform","overviewWaveform","isVerticalMode","_overviewUpdateScheduled","_setupAudioEngineListeners","stopLive","appendPCM","liveCanvas","vuMeterCanvas","accumulatedCanvas","overviewCanvas","analyserNode","LiveWaveform","VUMeter","AccumulatedWaveform","OverviewWaveform","startLive","append","requestAnimationFrame","draw","reset","clear","canvasContext","clearRect","width","height","setVerticalMode","isVertical","_worker","postMessage","verticalMode","resize","canvas","terminate","getContext","mediaStreamSource","animationId","isRunning","amplification","_lastDataArray","_verticalScrollOffset","hasAudioContext","hasAnalyser","self","contextReady","then","e","Uint8Array","cancelAnimationFrame","getByteTimeDomainData","scrollSpeed","fillStyle","fillRect","lineWidth","strokeStyle","beginPath","sliceHeight","y","x","moveTo","lineTo","stroke","sliceWidth","ctx","timeData","levelDb","peakDb","holdPeakDb","lastPeakTime","peakHoldMillis","fallRateDbPerSec","minDb","maxDb","lastClipTime","clipHoldMillis","_lastLogTime","_computeLevels","rmsDb","required","sumSquares","peak","clipped","v","absV","rms","sqrt","log10","Infinity","currentDb","w","h","grd","createLinearGradient","addColorStop","norm","barGrad","barWidth","round","db","posNorm","xPos","toString","font","textAlign","textBaseline","fillText","restore","minus10Norm","minus10X","holdNorm","holdX","txt","toFixed","badgeW","badgeH","update","levels","elapsed","fallSeconds","fallAmount","loop","targetSampleRate","sourceSampleRate","decimationFactor","sampleMin","sampleMax","sampleCount","zoomFactor","viewStart","isAutoScroll","_panRemainder","playbackPosition","isPlaying","playbackStartTime","playbackStartSample","rawZoomMode","rawViewStart","rawVisibleRaw","_useWorker","_appendBatchMin","_appendBatchMax","_appendFlushScheduled","lastDetail","lastDensity","transferControlToOffscreen","Worker","ev","msg","detail","density","_setupMouseInteraction","isDragging","dragStartX","dragStartViewStart","offsetX","style","cursor","deltaX","samplesPerPixel","getVisibleSamples","visible","sampleDelta","_enforceViewBounds","preventDefault","rect","getBoundingClientRect","anchorRatio","clientX","left","zoomSteps","deltaY","zoomBySteps","info","clickRatio","clickedSample","floor","CustomEvent","time","dispatchEvent","audioSamples","factor","appendedMin","appendedMax","_lastAppendLog","blockSum","blockCount","j","blockMean","blockMin","blockMax","k","centeredSample","scrollToLatest","flush","_flushAppendBatch","setTimeout","minArr","maxArr","centerY","lineJoin","lineCap","hasFirstPoint","minVis","_getMinVisibleSamples","maxStart","setZoom","targetZoom","anchorSample","maxZoom","oldInfo","newInfo","desiredStart","stepCount","newZoom","pow","panBySamples","panByPixels","pixelDelta","totalDelta","intDelta","resetView","setSourceSampleRate","_getSamplePair","setPlaybackPosition","sampleIndex","setRawZoomMode","enabled","startPlayback","startSample","sr","updatePosition","rawSamples","decimatedPos","stopPlayback","_updatePlaybackPosition","_workerRef","_warnedNoData","_lastTotal","dragClickedSample","dragVisibleSamples","acc","viewStartX","offsetInView","targetViewStartX","newViewStart","maxViewStart","clampedViewStart","_handleSeek","clickX","targetSample","currentZoom","visibleSamples","halfVisible","hasAcc","visibleStart","visibleEnd","canvasWidth","canvasHeight","yMin","yMax","viewEndX","viewWidth","strokeRect","StorageAdapter","filename","metadata","load","id","delete","list","exists","files","file","VoiceBankRecorder","mergeOptions","initialized","storage","createStorageAdapter","currentBlob","container","initializeUI","defaults","layout","theme","channels","agc","waveform","showOverview","showAccumulated","showLive","decimation","colors","selection","playback","callbacks","onRecordStart","onRecordStop","onRecordPause","onRecordResume","onPlayStart","onPlayStop","onError","deepMerge","target","source","result","key","Object","Array","isArray","storageConfig","StorageFactory","require","create","play","saveRecording","blobToSave","filenameToUse","loadRecording","deleteRecording","listRecordings","recordings","getCurrentBlob","VERSION","BUILD_INFO","version","date","toISOString","directory","super","Capacitor","Filesystem","Directory","Plugins","readdir","Documents","mkdir","recursive","base64Data","blobToBase64","writeFile","keys","metadataWithDefaults","size","encoding","readFile","base64ToBlob","deleteFile","audioFiles","f","endsWith","map","metaResult","parse","sort","a","b","getUri","uri","reader","FileReader","onloadend","base64","split","onerror","readAsDataURL","byteCharacters","atob","byteNumbers","byteArray","getStorageInfo","totalSize","reduce","sum","r","totalSizeMB","savePath","electronAPI","arrayBuffer","from","success","filePath","uint8Array","openFile","saveAs","defaultFilename","showInFolder","dbName","storeName","request","indexedDB","open","onsuccess","onupgradeneeded","objectStoreNames","contains","store","createObjectStore","keyPath","autoIncrement","createIndex","unique","transaction","objectStore","record","add","String","get","Number","getAll","records","searchByFilename","toLowerCase","includes","countRequest","clearRequest","getStorageEstimate","estimate","usage","quota","usageMB","quotaMB","usagePercent","detect","process","versions","electron","isElectron","isCapacitor","isBrowser","isMobile","supportsAudioWorklet","prototype","supportsOffscreenCanvas","OffscreenCanvas","getInfo","platform","baseURL","saveEndpoint","loadEndpoint","deleteEndpoint","listEndpoint","headers","formData","FormData","response","fetch","method","body","ok","status","statusText","text","json","saveWithProgress","onProgress","xhr","XMLHttpRequest","upload","lengthComputable","percent","loaded","responseText","setRequestHeader","send","createAuto","IndexedDBAdapter","ElectronAdapter","CapacitorAdapter","ServerAdapter","showAdvancedOptions","showStatusLog","primaryColor","secondaryColor","successColor","errorColor","warningColor","document","querySelector","waveformRenderer","elements","audioPlayer","recordedBlob","recordedUrl","_generateHTML","_injectStyles","_cacheElements","_initializeAudioEngine","_initializeWaveformRenderer","_bindEvents","_initializeDevices","_log","innerHTML","_getTimeString","styleId","getElementById","createElement","textContent","_getStyles","head","appendChild","root","recordBtn","stopBtn","playBtn","pauseBtn","downloadBtn","zoomInBtn","zoomOutBtn","zoomResetBtn","panLeftBtn","panRightBtn","autoScrollCheck","vuCanvas","micSelect","outputSelect","refreshMicBtn","refreshOutputBtn","gainSlider","gainValue","agcCheck","echoCancelCheck","noiseSuppressCheck","recordingInfo","durationInfo","samplesInfo","samplerateInfo","filesizeInfo","statusLog","audioConfig","waveformConfig","_handleRecord","_handleStop","_handlePlay","_handlePause","_handleDownload","_handleZoomIn","_handleZoomOut","_handleZoomReset","_handlePanLeft","_handlePanRight","_handleAutoScrollChange","_handleMicChange","_handleOutputChange","_refreshMicrophones","_refreshOutputDevices","_handleGainChange","_handleAGCChange","_handleEchoCancelChange","_handleNoiseSuppressChange","disabled","option","savedId","_updateRecordingInfo","pause","src","Audio","replace","href","download","click","checked","deviceLabel","selectedIndex","parseFloat","_formatDuration","toLocaleString","display","seconds","mins","secs","ms","padStart","getHours","getMinutes","getSeconds","entry","className","scrollTop","scrollHeight"],"mappings":"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"}