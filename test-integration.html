<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoiceBank Recorder - æ•´åˆæ¸¬è©¦</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    
    .test-section {
      margin-bottom: 40px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }
    
    .test-section h2 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 1.3em;
    }
    
    .test-section.pass {
      border-color: #10b981;
      background: #f0fdf4;
    }
    
    .test-section.fail {
      border-color: #ef4444;
      background: #fef2f2;
    }
    
    .test-section.pending {
      border-color: #f59e0b;
      background: #fffbeb;
    }
    
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    
    .test-result.pass {
      background: #d1fae5;
      color: #065f46;
    }
    
    .test-result.fail {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .test-result.info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
      transition: all 0.3s ease;
    }
    
    button.primary {
      background: #667eea;
      color: white;
    }
    
    button.primary:hover {
      background: #5568d3;
    }
    
    button.danger {
      background: #ef4444;
      color: white;
    }
    
    button.danger:hover {
      background: #dc2626;
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .summary {
      background: #f9fafb;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }
    
    .summary h2 {
      color: #333;
      margin-bottom: 15px;
    }
    
    .summary-stats {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    
    .stat-box {
      flex: 1;
      min-width: 150px;
      padding: 15px;
      border-radius: 5px;
      text-align: center;
    }
    
    .stat-box.pass {
      background: #d1fae5;
    }
    
    .stat-box.fail {
      background: #fee2e2;
    }
    
    .stat-box.pending {
      background: #fef3c7;
    }
    
    .stat-box .number {
      font-size: 2em;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .stat-box .label {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ª VoiceBank Recorder æ•´åˆæ¸¬è©¦</h1>
    <p class="subtitle">é©—è­‰æ‰€æœ‰æ¨¡çµ„æ•´åˆ</p>
    
    <!-- æ¸¬è©¦æ‘˜è¦ -->
    <div class="summary">
      <h2>æ¸¬è©¦æ‘˜è¦</h2>
      <div class="summary-stats">
        <div class="stat-box pass">
          <div class="number" id="pass-count">0</div>
          <div class="label">é€šé</div>
        </div>
        <div class="stat-box fail">
          <div class="number" id="fail-count">0</div>
          <div class="label">å¤±æ•—</div>
        </div>
        <div class="stat-box pending">
          <div class="number" id="pending-count">0</div>
          <div class="label">å¾…æ¸¬è©¦</div>
        </div>
      </div>
    </div>
    
    <!-- æ¸¬è©¦ 1: æ¨¡çµ„è¼‰å…¥ -->
    <div class="test-section" id="test-module-loading">
      <h2>1ï¸âƒ£ æ¨¡çµ„è¼‰å…¥æ¸¬è©¦</h2>
      <button class="primary" onclick="runModuleLoadingTests()">åŸ·è¡Œæ¸¬è©¦</button>
      <div id="module-loading-results"></div>
    </div>
    
    <!-- æ¸¬è©¦ 2: AudioEngine -->
    <div class="test-section" id="test-audioengine">
      <h2>2ï¸âƒ£ AudioEngine æ¸¬è©¦</h2>
      <button class="primary" onclick="runAudioEngineTests()">åŸ·è¡Œæ¸¬è©¦</button>
      <div id="audioengine-results"></div>
    </div>
    
    <!-- æ¸¬è©¦ 3: WaveformRenderer -->
    <div class="test-section" id="test-waveform">
      <h2>3ï¸âƒ£ WaveformRenderer æ¸¬è©¦</h2>
      <button class="primary" onclick="runWaveformTests()">åŸ·è¡Œæ¸¬è©¦</button>
      <div id="waveform-results"></div>
    </div>
    
    <!-- æ¸¬è©¦ 4: RecorderUI -->
    <div class="test-section" id="test-recorderui">
      <h2>4ï¸âƒ£ RecorderUI æ¸¬è©¦</h2>
      <button class="primary" onclick="runRecorderUITests()">åŸ·è¡Œæ¸¬è©¦</button>
      <div id="recorderui-results"></div>
    </div>
    
    <!-- æ¸¬è©¦ 5: æ•´åˆæ¸¬è©¦ -->
    <div class="test-section" id="test-integration">
      <h2>5ï¸âƒ£ æ•´åˆæ¸¬è©¦</h2>
      <button class="primary" onclick="runIntegrationTests()">åŸ·è¡Œæ¸¬è©¦</button>
      <div id="integration-results"></div>
    </div>
    
    <!-- å…¨éƒ¨åŸ·è¡Œ -->
    <div style="text-align: center; margin-top: 30px;">
      <button class="primary" style="font-size: 1.2em; padding: 15px 40px;" onclick="runAllTests()">
        ğŸš€ åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
      </button>
    </div>
  </div>
  
  <!-- è¼‰å…¥å»ºç½®å¾Œçš„åº« -->
  <script src="./dist/voicebank-recorder.js"></script>
  
  <script>
    // æ¸¬è©¦çµ±è¨ˆ
    let stats = {
      pass: 0,
      fail: 0,
      pending: 5
    };
    
    // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
    function updateStats() {
      document.getElementById('pass-count').textContent = stats.pass;
      document.getElementById('fail-count').textContent = stats.fail;
      document.getElementById('pending-count').textContent = stats.pending;
    }
    
    // æ¸¬è©¦çµæœè¼”åŠ©å‡½æ•¸
    function addTestResult(containerId, message, status) {
      const container = document.getElementById(containerId);
      const result = document.createElement('div');
      result.className = `test-result ${status}`;
      result.textContent = message;
      container.appendChild(result);
      return status === 'pass';
    }
    
    function setTestStatus(sectionId, status) {
      const section = document.getElementById(sectionId);
      section.className = 'test-section ' + status;
      if (status === 'pass') {
        stats.pass++;
        stats.pending--;
      } else if (status === 'fail') {
        stats.fail++;
        stats.pending--;
      }
      updateStats();
    }
    
    // æ¸¬è©¦ 1: æ¨¡çµ„è¼‰å…¥
    function runModuleLoadingTests() {
      const containerId = 'module-loading-results';
      document.getElementById(containerId).innerHTML = '';
      
      let allPassed = true;
      
      // æª¢æŸ¥å…¨å±€è®Šæ•¸
      if (typeof VoiceBankRecorder !== 'undefined') {
        addTestResult(containerId, 'âœ“ VoiceBankRecorder å…¨å±€è®Šæ•¸å·²å®šç¾©', 'pass');
      } else {
        addTestResult(containerId, 'âœ— VoiceBankRecorder å…¨å±€è®Šæ•¸æœªå®šç¾©', 'fail');
        allPassed = false;
      }
      
      // æª¢æŸ¥å„å€‹æ¨¡çµ„
      const modules = ['AudioEngine', 'WaveformRenderer', 'RecorderUI', 'StorageFactory'];
      modules.forEach(moduleName => {
        if (VoiceBankRecorder[moduleName]) {
          addTestResult(containerId, `âœ“ ${moduleName} æ¨¡çµ„å·²è¼‰å…¥`, 'pass');
        } else {
          addTestResult(containerId, `âœ— ${moduleName} æ¨¡çµ„æœªè¼‰å…¥`, 'fail');
          allPassed = false;
        }
      });
      
      // æª¢æŸ¥å„²å­˜é©é…å™¨
      const adapters = ['IndexedDBAdapter', 'ServerAdapter'];
      adapters.forEach(adapterName => {
        if (VoiceBankRecorder[adapterName]) {
          addTestResult(containerId, `âœ“ ${adapterName} å·²è¼‰å…¥`, 'pass');
        } else {
          addTestResult(containerId, `âœ— ${adapterName} æœªè¼‰å…¥`, 'fail');
          allPassed = false;
        }
      });
      
      setTestStatus('test-module-loading', allPassed ? 'pass' : 'fail');
    }
    
    // æ¸¬è©¦ 2: AudioEngine
    async function runAudioEngineTests() {
      const containerId = 'audioengine-results';
      document.getElementById(containerId).innerHTML = '';
      
      let allPassed = true;
      
      try {
        // å‰µå»ºå¯¦ä¾‹
        const engine = new VoiceBankRecorder.AudioEngine({
          audioWorklet: false,  // æ¸¬è©¦ç”¨ç¦ç”¨ AudioWorklet
          sampleRate: 48000
        });
        addTestResult(containerId, 'âœ“ AudioEngine å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'pass');
        
        // æª¢æŸ¥æ–¹æ³•
        const methods = ['startRecording', 'stopRecording', 'on', 'off', 'once'];
        methods.forEach(method => {
          if (typeof engine[method] === 'function') {
            addTestResult(containerId, `âœ“ ${method}() æ–¹æ³•å­˜åœ¨`, 'pass');
          } else {
            addTestResult(containerId, `âœ— ${method}() æ–¹æ³•ä¸å­˜åœ¨`, 'fail');
            allPassed = false;
          }
        });
        
        // æª¢æŸ¥äº‹ä»¶ç³»çµ±
        let eventFired = false;
        engine.once('test-event', () => { eventFired = true; });
        engine.emit('test-event');
        
        if (eventFired) {
          addTestResult(containerId, 'âœ“ äº‹ä»¶ç³»çµ±æ­£å¸¸é‹ä½œ', 'pass');
        } else {
          addTestResult(containerId, 'âœ— äº‹ä»¶ç³»çµ±ç•°å¸¸', 'fail');
          allPassed = false;
        }
        
      } catch (error) {
        addTestResult(containerId, `âœ— AudioEngine æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
        allPassed = false;
      }
      
      setTestStatus('test-audioengine', allPassed ? 'pass' : 'fail');
    }
    
    // æ¸¬è©¦ 3: WaveformRenderer
    function runWaveformTests() {
      const containerId = 'waveform-results';
      document.getElementById(containerId).innerHTML = '';
      
      let allPassed = true;
      
      try {
        // å‰µå»ºæ¸¬è©¦ç”¨ Canvas
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 200;
        
        // å‰µå»ºå‡çš„ AudioEngine
        const fakeEngine = {
          on: () => {},
          off: () => {},
          once: () => {},
          emit: () => {}
        };
        
        // å‰µå»ºå¯¦ä¾‹
        const renderer = new VoiceBankRecorder.WaveformRenderer({
          liveCanvas: canvas,
          audioEngine: fakeEngine,
          useWorker: false
        });
        addTestResult(containerId, 'âœ“ WaveformRenderer å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'pass');
        
        // æª¢æŸ¥æ–¹æ³•
        const methods = ['start', 'stop', 'reset', 'resize', 'setVerticalMode'];
        methods.forEach(method => {
          if (typeof renderer[method] === 'function') {
            addTestResult(containerId, `âœ“ ${method}() æ–¹æ³•å­˜åœ¨`, 'pass');
          } else {
            addTestResult(containerId, `âœ— ${method}() æ–¹æ³•ä¸å­˜åœ¨`, 'fail');
            allPassed = false;
          }
        });
        
      } catch (error) {
        addTestResult(containerId, `âœ— WaveformRenderer æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
        allPassed = false;
      }
      
      setTestStatus('test-waveform', allPassed ? 'pass' : 'fail');
    }
    
    // æ¸¬è©¦ 4: RecorderUI
    async function runRecorderUITests() {
      const containerId = 'recorderui-results';
      document.getElementById(containerId).innerHTML = '';
      
      let allPassed = true;
      
      try {
        // å‰µå»ºæ¸¬è©¦å®¹å™¨
        const testContainer = document.createElement('div');
        testContainer.id = 'test-ui-container';
        testContainer.style.display = 'none';
        document.body.appendChild(testContainer);
        
        // å‰µå»ºå‡çš„æ ¸å¿ƒæ¨¡çµ„
        const fakeEngine = {
          on: () => {},
          off: () => {},
          once: () => {},
          emit: () => {}
        };
        
        const fakeRenderer = {
          start: () => {},
          stop: () => {},
          reset: () => {},
          resize: () => {},
          setVerticalMode: () => {}
        };
        
        // å‰µå»º RecorderUI å¯¦ä¾‹
        const ui = new VoiceBankRecorder.RecorderUI(testContainer, {
          audioEngine: fakeEngine,
          waveformRenderer: fakeRenderer
        });
        addTestResult(containerId, 'âœ“ RecorderUI å¯¦ä¾‹å‰µå»ºæˆåŠŸ', 'pass');
        
        // æª¢æŸ¥æ–¹æ³•
        const methods = ['initialize', 'getState', 'setOptions', 'destroy'];
        methods.forEach(method => {
          if (typeof ui[method] === 'function') {
            addTestResult(containerId, `âœ“ ${method}() æ–¹æ³•å­˜åœ¨`, 'pass');
          } else {
            addTestResult(containerId, `âœ— ${method}() æ–¹æ³•ä¸å­˜åœ¨`, 'fail');
            allPassed = false;
          }
        });
        
        // æ¸¬è©¦åˆå§‹åŒ–
        await ui.initialize();
        addTestResult(containerId, 'âœ“ UI åˆå§‹åŒ–æˆåŠŸ', 'pass');
        
        // æª¢æŸ¥ DOM æ˜¯å¦æ¸²æŸ“
        if (testContainer.querySelector('.voicebank-recorder')) {
          addTestResult(containerId, 'âœ“ UI DOM çµæ§‹å·²æ¸²æŸ“', 'pass');
        } else {
          addTestResult(containerId, 'âœ— UI DOM çµæ§‹æœªæ¸²æŸ“', 'fail');
          allPassed = false;
        }
        
        // æ¸…ç†
        ui.destroy();
        document.body.removeChild(testContainer);
        
      } catch (error) {
        addTestResult(containerId, `âœ— RecorderUI æ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
        allPassed = false;
      }
      
      setTestStatus('test-recorderui', allPassed ? 'pass' : 'fail');
    }
    
    // æ¸¬è©¦ 5: æ•´åˆæ¸¬è©¦
    async function runIntegrationTests() {
      const containerId = 'integration-results';
      document.getElementById(containerId).innerHTML = '';
      
      let allPassed = true;
      
      try {
        addTestResult(containerId, 'â„¹ï¸ é–‹å§‹æ•´åˆæ¸¬è©¦...', 'info');
        
        // å‰µå»ºå®Œæ•´çš„å †ç–Š
        const engine = new VoiceBankRecorder.AudioEngine({
          audioWorklet: false,
          sampleRate: 48000
        });
        
        const canvas = document.createElement('canvas');
        canvas.width = 800;
        canvas.height = 200;
        
        const renderer = new VoiceBankRecorder.WaveformRenderer({
          liveCanvas: canvas,
          audioEngine: engine,
          useWorker: false
        });
        
        const testContainer = document.createElement('div');
        testContainer.style.display = 'none';
        document.body.appendChild(testContainer);
        
        const ui = new VoiceBankRecorder.RecorderUI(testContainer, {
          audioEngine: engine,
          waveformRenderer: renderer
        });
        
        await ui.initialize();
        
        addTestResult(containerId, 'âœ“ æ‰€æœ‰æ¨¡çµ„æˆåŠŸæ•´åˆ', 'pass');
        
        // æ¸¬è©¦äº‹ä»¶æµ
        let eventReceived = false;
        engine.once('recording-start', () => {
          eventReceived = true;
        });
        
        engine.emit('recording-start');
        
        if (eventReceived) {
          addTestResult(containerId, 'âœ“ æ¨¡çµ„é–“äº‹ä»¶é€šä¿¡æ­£å¸¸', 'pass');
        } else {
          addTestResult(containerId, 'âœ— æ¨¡çµ„é–“äº‹ä»¶é€šä¿¡ç•°å¸¸', 'fail');
          allPassed = false;
        }
        
        // æ¸…ç†
        ui.destroy();
        document.body.removeChild(testContainer);
        
        addTestResult(containerId, 'âœ“ æ•´åˆæ¸¬è©¦å®Œæˆ', 'pass');
        
      } catch (error) {
        addTestResult(containerId, `âœ— æ•´åˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'fail');
        console.error('Integration test error:', error);
        allPassed = false;
      }
      
      setTestStatus('test-integration', allPassed ? 'pass' : 'fail');
    }
    
    // åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
    async function runAllTests() {
      stats = { pass: 0, fail: 0, pending: 5 };
      updateStats();
      
      runModuleLoadingTests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runAudioEngineTests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      runWaveformTests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runRecorderUITests();
      await new Promise(resolve => setTimeout(resolve, 500));
      
      await runIntegrationTests();
    }
    
    // åˆå§‹åŒ–çµ±è¨ˆ
    updateStats();
  </script>
</body>
</html>
